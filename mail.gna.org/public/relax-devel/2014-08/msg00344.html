<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: r25330 &#45; /trunk/specific_analyses/relax_disp/estimate_r2eff.py -->
<!--X-From-R13: "Sqjneq q'Ohiretar" &#60;rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Thu, 28 Aug 2014 13:47:23 +0200 -->
<!--X-Message-Id: CAED9pY9nvDCxWxbNQAqHzsquTh&#45;NPLE=mCiN5+FBm0zOd6=4=Q@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: E1XMZXh&#45;0004wj&#45;12@subversion.gna.org -->
<!--X-Reference: CAED9pY&#45;Ce=3nJx3xyHdreWyhXQEgwUuKWK9oF8OVMnYSR8bapQ@mail.gmail.com -->
<!--X-Reference: CA+CBx2PDoMJpdnmMMYTunmnxnGio8ctST2zg_n1QmZarY1KpfA@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: r25330 - /trunk/specific_analyses/relax_disp/estimate_r2eff.py -- August 28, 2014 - 13:47</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: r25330 - /trunk/specific_analyses/relax_disp/estimate_r2eff.py</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00344" class="tabs">Index by Date</a> | <a href="threads.html#00344" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00343.html">Date Prev</a>] [<a href="msg00345.html">Date Next</a>] [<a href="msg00316.html">Thread Prev</a>] [<a href="msg00345.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Thu, 28 Aug 2014 13:46:52 +0200</li>
<li class="menuitem">
<em>Cc</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:date:message-id:subject :from:to:cc:content-type:content-transfer-encoding; bh=eE6lPV2DShNGuf6/kRJwJ2bQtZcraXJWGGDJDzOdc1w=; b=HpoTRJcdcldyVSmVV21ZQsgDz2JWUbi7Vs3l+Pwki+tBegvesmf/KVCNrFVqOLoifz Yqf5Zlya90nIKyJAEtJ7J/Bu+Ax8dsCr/FfpxHZQgzurbE07v5vuRRgGMjGOtWE6JFyR zWT5X9RAxA78MsmfTRZcM5A+tgatklFbWoOzulhIDdAjg4TvGLYVNxlU6DImMLo8wCO8 nkGw/QNeXUnx3dXu7Rd5rfGcVhMFXHJnw6LkBQn5vvgEscpvYzYyz27IoZuqsS26VeV6 BDbjKzeyp0feYzzbspAQhYIYwahgGYsI03S9tN3rezu5DYOvPNg2zJdLWXAhmxbE3Kyv vZbA==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;CAED9pY9nvDCxWxbNQAqHzsquTh-NPLE=mCiN5+FBm0zOd6=4=Q@mail.gmail.com&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;E1XMZXh-0004wj-12@subversion.gna.org&gt; &lt;CAED9pY-Ce=3nJx3xyHdreWyhXQEgwUuKWK9oF8OVMnYSR8bapQ@mail.gmail.com&gt; &lt;<a href="msg00316.html">CA+CBx2PDoMJpdnmMMYTunmnxnGio8ctST2zg_n1QmZarY1KpfA@mail.gmail.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on August 28, 2014 - 13:47:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi,

What happens if you construct the covariance matrix as:

    covar = (J^T.X.J)^-1 ,

Where X is a square matrix of dimension n, the number of data points
(here time points).  All elements of X are zero except for the
diagonal which is equal to the intensity errors squared.  I.e. this is
the peak intensity covariance matrix, where the covariances are zero
as the peak intensity errors are not dependent on each other and
diagonal is simply the peak errors squared or the variances.  This is
from 
<a  rel="nofollow" href="https://en.wikipedia.org/wiki/Propagation_of_uncertainty#Non-linear_combinations">https://en.wikipedia.org/wiki/Propagation_of_uncertainty#Non-linear_combinations</a>
:

    cov(f) = J.cov(x).J^T.

The J matrices might be transposed in Wikipedia's definition compared
to ours.  Maybe this would solve the problem of the errors being too
high?

Regards,

Edward



On 27 August 2014 11:41, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Edward.

There is no scaling involved when calculating.

What I meant with scaling is correction to the co-variance matrix.
Related to errors, or similar.

But I haven't figured it out yet.


Best
Troels

2014-08-27 11:33 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Does it give the same small result?  Try turning off parameter scaling.

Regards,

Edward

On 27 August 2014 11:29,  &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Author: tlinnet
Date: Wed Aug 27 11:29:24 2014
New Revision: 25330

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=25330&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=25330&amp;view=rev</a>
Log:
Tried to implement the Jacobian from C-code.

This though also report errors which are to small.

Maybe some scaling is wrong.

task #7822(<a  rel="nofollow" href="https://web.archive.org/web/https://gna.org/task/index.php?7822">https://gna.org/task/index.php?7822</a>): Implement user function 
to estimate R2eff and associated errors for exponential curve fitting.

Modified:
    trunk/specific_analyses/relax_disp/estimate_r2eff.py

Modified: trunk/specific_analyses/relax_disp/estimate_r2eff.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/trunk/specific_analyses/relax_disp/estimate_r2eff.py?rev=25330&amp;r1=25329&amp;r2=25330&amp;view=diff">http://svn.gna.org/viewcvs/relax/trunk/specific_analyses/relax_disp/estimate_r2eff.py?rev=25330&amp;r1=25329&amp;r2=25330&amp;view=diff</a>
==============================================================================
--- trunk/specific_analyses/relax_disp/estimate_r2eff.py        (original)
+++ trunk/specific_analyses/relax_disp/estimate_r2eff.py        Wed Aug 
27 11:29:24 2014
@@ -42,7 +42,7 @@
 from specific_analyses.relax_disp.variables import MODEL_R2EFF
 from specific_analyses.relax_fit.optimisation import func_wrapper, 
dfunc_wrapper, d2func_wrapper
 from target_functions.chi2 import chi2_rankN
-from target_functions.relax_fit import setup
+from target_functions.relax_fit import jacobian, setup


 # Scipy installed.
@@ -734,7 +734,7 @@
     E.set_settings_minfx(min_algor=min_algor)

     # Do C code
-    do_C = False
+    do_C = True

     if do_C:
         # Initialise the function to minimise.
@@ -766,19 +766,27 @@
     param_vector, chi2, iter_count, f_count, g_count, h_count, warning = 
results_minfx

     # Get the Jacobian.
-    # First make a call to the Jacobian function, which store it in the 
class.
-    E.func_exp_grad(params=param_vector)
-    jacobian_matrix = deepcopy(E.jacobian_matrix)
-
+    if do_C:
+        # First make a call to the Jacobian function, which store it in 
the class.
+        jacobian_matrix = transpose(asarray( jacobian(param_vector) ) )
+
+        # Compare with python code.
+        #E.func_exp_grad(params=param_vector)
+        #jacobian_matrix2 = deepcopy(E.jacobian_matrix)
+        #print jacobian_matrix
+        #print &quot; &quot;
+        #print jacobian_matrix2
+    else:
+        jacobian_matrix = deepcopy(E.jacobian_matrix)
+
+    # Get the co-variance
+    pcov = E.multifit_covar(J=jacobian_matrix)
+
+    # To compute one standard deviation errors on the parameters, take 
the square root of the diagonal covariance.
+    param_vector_error = sqrt(diag(pcov))
     # Set error to inf.
     #param_vector_error = [inf, inf]

-    # Get the co-variance
-    pcov = E.multifit_covar(J=jacobian_matrix)
-
-    # To compute one standard deviation errors on the parameters, take 
the square root of the diagonal covariance.
-    param_vector_error = sqrt(diag(pcov))
-
     # Pack to list.
     results = [param_vector, param_vector_error, chi2, iter_count, 
f_count, g_count, h_count, warning]



_______________________________________________
relax (<a  rel="nofollow" href="/">http://www.nmr-relax.com</a>)

This is the relax-commits mailing list
relax-commits@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="/mail.gna.org/listinfo/relax-commits">https://mail.gna.org/listinfo/relax-commits</a>
</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
relax (<a  rel="nofollow" href="/">http://www.nmr-relax.com</a>)

This is the relax-devel mailing list
relax-devel@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="/mail.gna.org/listinfo/relax-devel">https://mail.gna.org/listinfo/relax-devel</a>
</pre></blockquote></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00345" href="msg00345.html">Re: r25330 - /trunk/specific_analyses/relax_disp/estimate_r2eff.py</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00315" href="msg00315.html">Re: r25330 - /trunk/specific_analyses/relax_disp/estimate_r2eff.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00316" href="msg00316.html">Re: r25330 - /trunk/specific_analyses/relax_disp/estimate_r2eff.py</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Thu Aug 28 14:00:15 2014</div>  
</body>
</html>
