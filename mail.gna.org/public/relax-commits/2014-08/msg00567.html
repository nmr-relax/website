<!-- MHonArc v2.6.18 -->
<!--X-Subject: r25433 &#45; /trunk/specific_analyses/relax_disp/estimate_r2eff.py -->
<!--X-From-R13: gyvaargNaze&#45;erynk.pbz -->
<!--X-Date: Fri, 29 Aug 2014 15:09:13 +0200 -->
<!--X-Message-Id: E1XNLvU&#45;0006Gy&#45;Q9@subversion.gna.org -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>r25433 - /trunk/specific_analyses/relax_disp/estimate_r2eff.py -- August 29, 2014 - 15:09</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />r25433 - /trunk/specific_analyses/relax_disp/estimate_r2eff.py</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00567" class="tabs">Index by Date</a> | <a href="threads.html#00567" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00566.html">Date Prev</a>] [<a href="msg00568.html">Date Next</a>] [<a href="msg00566.html">Thread Prev</a>] [<a href="msg00568.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: relax-commits@xxxxxxx</li>
<li class="menuitem">
<em>Date</em>: Fri, 29 Aug 2014 13:09:12 -0000</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00567.html">E1XNLvU-0006Gy-Q9@subversion.gna.org</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>tlinnet</strong> on August 29, 2014 - 15:09:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Author: tlinnet
Date: Fri Aug 29 15:09:12 2014
New Revision: 25433

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=25433&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=25433&amp;view=rev</a>
Log:
Tried implementing getting the chi2 gradient, using 
target_function.chi2.dchi2().

The output seem equal.

task #7822(<a  rel="nofollow" href="https://web.archive.org/web/https://gna.org/task/index.php?7822">https://gna.org/task/index.php?7822</a>): Implement user function to 
estimate R2eff and associated errors for exponential curve fitting.

Modified:
    trunk/specific_analyses/relax_disp/estimate_r2eff.py

Modified: trunk/specific_analyses/relax_disp/estimate_r2eff.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/trunk/specific_analyses/relax_disp/estimate_r2eff.py?rev=25433&amp;r1=25432&amp;r2=25433&amp;view=diff">http://svn.gna.org/viewcvs/relax/trunk/specific_analyses/relax_disp/estimate_r2eff.py?rev=25433&amp;r1=25432&amp;r2=25433&amp;view=diff</a>
==============================================================================
--- trunk/specific_analyses/relax_disp/estimate_r2eff.py        (original)
+++ trunk/specific_analyses/relax_disp/estimate_r2eff.py        Fri Aug 29 
15:09:12 2014
@@ -24,7 +24,7 @@
 
 # Python module imports.
 from copy import deepcopy
-from numpy import absolute, any, array, asarray, diag, dot, exp, eye, inf, 
log, multiply, ones, spacing, sqrt, sum, transpose, zeros
+from numpy import absolute, allclose, any, array, asarray, diag, dot, exp, 
eye, inf, log, multiply, ones, spacing, sqrt, sum, transpose, zeros
 from numpy.linalg import cond, inv, qr
 from minfx.generic import generic_minimise
 from re import match, search
@@ -42,7 +42,7 @@
 from specific_analyses.relax_disp.data import average_intensity, 
loop_exp_frq_offset_point, loop_frq, loop_time, return_param_key_from_data
 from specific_analyses.relax_disp.parameters import disassemble_param_vector
 from specific_analyses.relax_disp.variables import MODEL_R2EFF
-from target_functions.chi2 import chi2_rankN
+from target_functions.chi2 import chi2_rankN, dchi2
 
 # C modules.
 if C_module_exp_fn:
@@ -622,8 +622,36 @@
         # Define Jacobian as m rows with function derivatives and n columns 
of parameters.
         sum_jacobian_matrix_exp_chi2 = transpose(array( [sum_d_chi2_d_r2eff 
, sum_d_chi2_d_i0] ) )
 
+        ######### Try with lib function.
+
+        # Get the back calc.
+        back_calc = self.func_exp(params=params, times=times)
+
+        # Get the Jacobian, with partial derivative, with respect to r2eff 
and i0.
+        exp_grad = func_exp_grad(params=params, times=times, values=values, 
errors=errors)
+
+        # Transpose back, to get rows.
+        exp_grad_t = transpose(exp_grad)
+
+        # n is number of fitted parameters.
+        n = len(params)
+
+        # Define array to update parameters in.
+        sum_jacobian_matrix_exp_chi2_minfx = zeros([2])
+
+        # Update value elements.        
+        dchi2(dchi2=sum_jacobian_matrix_exp_chi2_minfx, M=n, data=values, 
back_calc_vals=back_calc, back_calc_grad=exp_grad_t, errors=errors)
+
+        # Make test of two methods.
+        test_eq = allclose(sum_jacobian_matrix_exp_chi2, 
sum_jacobian_matrix_exp_chi2_minfx, rtol=1e-15, atol=1e-15)
+
+        if not test_eq:
+            print(&quot;Chi2 gradient are not equal.&quot;)
+            print(asd)
+
+
         # Return Jacobian matrix.
-        return sum_jacobian_matrix_exp_chi2
+        return sum_jacobian_matrix_exp_chi2_minfx
 
 
 def estimate_r2eff(method='minfx', min_algor='simplex', c_code=True, 
constraints=False, chi2_jacobian=False, spin_id=None, ftol=1e-15, xtol=1e-15, 
maxfev=10000000, factor=100.0, verbosity=1):



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Fri Aug 29 15:20:02 2014</div>  
</body>
</html>
