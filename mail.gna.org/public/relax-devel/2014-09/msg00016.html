<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: r25491 &#45; /trunk/specific_analyses/relax_disp/data.py -->
<!--X-From-R13: "Sqjneq q'Ohiretar" &#60;rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Mon, 01 Sep 2014 12:12:26 +0200 -->
<!--X-Message-Id: CAED9pY9UMGw4woF8n1zN5DxiVPn79A=Lt2wTDMeEtNwM+iXh&#45;g@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: E1XOCxK&#45;0005G6&#45;QP@subversion.gna.org -->
<!--X-Reference: CAED9pY9tUVfXCr4aSQ85JeCSKeDr_FVUNUfCPULcd3VmPZ1RnA@mail.gmail.com -->
<!--X-Reference: CA+CBx2PSiaureGzky19iDjU3Lhi7QhdpnuMgeKK&#45;vxf__JfmBQ@mail.gmail.com -->
<!--X-Reference: CAED9pY92R2yukkgVzjcsTFL11QAMx4Ze_7MNeYenzM8pHHTkyA@mail.gmail.com -->
<!--X-Reference: CA+CBx2OTVM=624Y=+3y_ZkmtOW9RQxnqjJ0gbTLc0MjCagChCQ@mail.gmail.com -->
<!--X-Reference: CAED9pY8O&#45;jO5uqpLjWRySojsUBxDgpUifNo7ryo0QUubr5VAyQ@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: r25491 - /trunk/specific_analyses/relax_disp/data.py -- September 01, 2014 - 12:12</title>
<link rel="stylesheet" type="text/css" href="/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="https://gna.org/images/gna.theme/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: r25491 - /trunk/specific_analyses/relax_disp/data.py</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00016" class="tabs">Index by Date</a> | <a href="threads.html#00016" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00015.html">Date Prev</a>] [<a href="msg00017.html">Date Next</a>] [<a href="msg00015.html">Thread Prev</a>] [<a href="msg00018.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Mon, 1 Sep 2014 12:11:55 +0200</li>
<li class="menuitem">
<em>Cc</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:date:message-id:subject :from:to:cc:content-type:content-transfer-encoding; bh=mTqzDkajG9ePxZQB4CTUF7P9lvIUN7Ac3+aO/kEJooc=; b=d0IyRJZdnmUYiK4nrj/VeM8L8gDgZtNQeh8ITGWt+iiOnbAHV/soAPgoVpyRNRrBAY e+41GW7645wuCP6Xo3U9SDboV2JZ+Y6eGFaR6ErXqvL8K4Aa/sAo7P0OLDY8t4Gb0L4i WMDNB2BszOBns8JyX0ZlHaH+RVtNKnqqTukeZBY7mgiwO4nw9Ieq8sFu9Qqqon2XtIXi 45d1SXB7PZ7mUipdIalLaEZwIBiDusmXem/Mi2m2qzidfxFv79oF6jvi+Gg+Vo0vCCHV 8bIHoHnSL1d8dBp3EZkbFGvd/rvt8qkF5h+mZ7HJ4CQf/P/oMnW1sA4lb1aySvb3Dtxo GpUA==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;CAED9pY9UMGw4woF8n1zN5DxiVPn79A=Lt2wTDMeEtNwM+iXh-g@mail.gmail.com&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;E1XOCxK-0005G6-QP@subversion.gna.org&gt; &lt;<a href="msg00002.html">CAED9pY9tUVfXCr4aSQ85JeCSKeDr_FVUNUfCPULcd3VmPZ1RnA@mail.gmail.com</a>&gt; &lt;<a href="msg00003.html">CA+CBx2PSiaureGzky19iDjU3Lhi7QhdpnuMgeKK-vxf__JfmBQ@mail.gmail.com</a>&gt; &lt;<a href="msg00006.html">CAED9pY92R2yukkgVzjcsTFL11QAMx4Ze_7MNeYenzM8pHHTkyA@mail.gmail.com</a>&gt; &lt;CA+CBx2OTVM=624Y=+3y_ZkmtOW9RQxnqjJ0gbTLc0MjCagChCQ@mail.gmail.com&gt; &lt;<a href="msg00015.html">CAED9pY8O-jO5uqpLjWRySojsUBxDgpUifNo7ryo0QUubr5VAyQ@mail.gmail.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on September 01, 2014 - 12:12:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi,

I forgot to mention, for these symbol derivations, you should apply
trigonometric simplifications.  I don't know how sympy does this, but
I always use these simplification functions in wxMaxima (or
FullSimplify[] in Mathematica).  It will significantly simplify the
equations and make them faster to calculate.  And when implementing
these, you should always check against a numeric example.  Here
Numdifftools is very useful.  You can pass dfunc_DPL94 into
Numdifftools and then hardcode the numeric gradient and Hessian into a
unit test.  The Jacobian requires a different input function.

Regards,

Edward



On 1 September 2014 12:07, Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,

For the DPL model, the symbolic gradient, Hessian, and Jacobian
matrices are very basic.  These could be added to
lib.dispersion.dpl94.  And then maybe as the target function class
methods dfunc_DPL94(), d2func_DPL94(), and jacobian_DPL94().  For a
permanent reference, it would be great to have these added to the
relax manual.  Maybe as a new section in Chapter 14, &quot;Optimisation of
relaxation data - values, gradients, and Hessians&quot;.  The symbolic
derivatives for all other analytic models should also not be too
complicated, I hope.  Anyway, if you are interested in having this
functionality we can incorporate Numdifftools into relax to provide
slow numerical estimates for the other dispersion models
(<a  rel="nofollow" href="https://code.google.com/p/numdifftools/">https://code.google.com/p/numdifftools/</a>).  One day I might
incorporate this into minfx as well, so that minfx can use numerical
gradients and Hessians automatically for optimisation when the user
does not provide them themselves.

Cheers,

Edward



On 1 September 2014 11:49, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt; 
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Edward.

I think you dont randomize for R1.

This should be a bug.
Ugh.

Do you submit this?


If R1 is fitted, then one can just take the fitted values.

I have just made the Jacobian and Hessian for DPL94.
wiki.nmr-relax.com/DPL94_derivatives

When the Jacobians are defined like this, the only thing necessary is:
-------------------------------------------------
    def func_chi2_grad(self, params=None, times=None, values=None, 
errors=None):
        &quot;&quot;&quot;Target function for the gradient (Jacobian matrix) to
minfx, for exponential fit .

        @param params:  The vector of parameter values.
        @type params:   numpy rank-1 float array
        @keyword times: The time points.
        @type times:    numpy array
        @param values:  The measured values.
        @type values:   numpy array
        @param errors:  The standard deviation of the measured
intensity values per time point.
        @type errors:   numpy array
        @return:        The Jacobian matrix with 'm' rows of function
derivatives per 'n' columns of parameters, which have been summed
together.
        @rtype:         numpy array
        &quot;&quot;&quot;

        # Get the back calc.
        back_calc = self.func(params=params)

        # Get the Jacobian, with partial derivative, with respect to
r2eff and i0.
        grad = self.func_grad(params=params)

        # Transpose back, to get rows.
        grad_t = transpose(grad)

        # n is number of fitted parameters.
        n = len(params)

        # Define array to update parameters in.
        jacobian_chi2_minfx = zeros([n])

        # Update value elements.
        dchi2(dchi2=jacobian_chi2_minfx, M=n, data=values,
back_calc_vals=back_calc, back_calc_grad=grad_t, errors=errors)

        # Return Jacobian matrix.
        return jacobian_chi2_minfx
----------------------------------------------------




2014-09-01 10:51 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,

Please see below:

On 1 September 2014 10:20, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt; 
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Yes.

That was a seriously hard bug to find.

Especially when you consider the MC simulations as the &quot;Golden Standard&quot;.
And then the  &quot;Golden Standard&quot; is wrong...

Ouch.
</pre></blockquote><pre style="margin: 0em;">

True!  But there are bugs everywhere and you should never assume that
parts of relax, or any software in general is bug free.  Never trust
black-boxes!  This is a good lesson ;)  All software has bugs, and
this will not be the last in relax.


</pre><blockquote class="blockquote"><pre style="margin: 0em;">Should we set the GUI to have exp_sim = -1?
There is no assumption, that 100000 simulations of exponential fits
are better than the co-variance.
</pre></blockquote><pre style="margin: 0em;">

Just in case someone has much harder to optimise peak intensity data,
for example if the data is extremely noisy or if it is not exactly
mono-exponential, then this is not a good idea.  It is better to spend
time to obtain the best result rather than obtaining a quick result
which in most cases works, but is known to theoretically fail.  You
don't want to be in that theoretical failure group and not know about
it.  So the user can set it themselves but they should compare it to
MC simulations anyway to be sure.

Note that the curvature of the optimisation space for the dispersion
models is far more complicated than the 2-parameter exponential
curves.  For the dispersion models, the covariance matrix approach
will not be anywhere near as good.  For these models, most big names
in the field would never consider the covariance matrix approach.
Many people are wary of the edge-case failures of this technique.  For
the best results you would always pick the best technique which, by
statistical theory, is Monte Carlo simulations by far.


</pre><blockquote class="blockquote"><pre style="margin: 0em;">Btw.

Can we check Monte-Carlo simulations for the dispersion models?
</pre></blockquote><pre style="margin: 0em;">

That's a great idea!  This is probably also untested in the test
suite.  The covariance matrix approach is perfect for checking that
the Monte Carlo results are reasonable.  However you do require the
Jacobian matrix which is not derived for any dispersion model.  There
are no gradients derived, though it could be done numerically in the
test_suite/shared_data/dispersion directories using the very useful
Numdifftools package (<a  rel="nofollow" href="https://pypi.python.org/pypi/Numdifftools">https://pypi.python.org/pypi/Numdifftools</a>).

Or an even better way would be to create the
error_analysis.covariance_matrix user function which, like the
pipe_control.monte_carlo module, uses the specific API to obtain, in
this case the Jacobian and weighting matrix via one new method, calls
lib.statistics.multifit_covar() to create the covariance matrix, and
then calls the API again to set the errors via the already existing
api.set_error() API method.  Then you can use the covariance matrix
approach for all the dispersion models.  Due to the licencing of
Numdifftools, we could even bundle that with relax in the extern
package and use numerical Jacobian integration so that even the
numeric dispersion models can have a covariance matrix.


</pre><blockquote class="blockquote"><pre style="margin: 0em;">Where is that performed?
</pre></blockquote><pre style="margin: 0em;">

The specific analysis API.  See the functions in the
pipe_control.monte_carlo module.  The API object is obtained as:

    # The specific analysis API object.
    api = return_api()

Then you can see the methods called in
specific_analyses.relax_disp.api as, for example in the
pipe_control.monte_carlo module:

        # Create the Monte Carlo data.
        if method == 'back_calc':
            data = api.create_mc_data(data_index)

You will therefore find the create_mc_data() method in the dispersion
API module.  If you search for all of the api.*() calls, then you'll
find all those methods in the API object (or the default with a
RelaxImplementError in the API base class).  It's rather simple.


</pre><blockquote class="blockquote"><pre style="margin: 0em;">Do you randomize only R1rho' or do you also include randomize for R1?
</pre></blockquote><pre style="margin: 0em;">

This is performed in the pipe_control.monte_carlo.create_data()
function.  See if you can trace the API method calls back and find the
source of this!  It would be good if you check as well.

Cheers,

Edward
</pre></blockquote></blockquote></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00018" href="msg00018.html">Re: r25491 - /trunk/specific_analyses/relax_disp/data.py</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00002" href="msg00002.html">Re: r25491 - /trunk/specific_analyses/relax_disp/data.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00003" href="msg00003.html">Re: r25491 - /trunk/specific_analyses/relax_disp/data.py</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00006" href="msg00006.html">Re: r25491 - /trunk/specific_analyses/relax_disp/data.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00013" href="msg00013.html">Re: r25491 - /trunk/specific_analyses/relax_disp/data.py</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00015" href="msg00015.html">Re: r25491 - /trunk/specific_analyses/relax_disp/data.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer">You are on the <a href="http://gna.org">Gna!</a> mail server.</div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Mon Sep 01 12:40:10 2014</div>  
</body>
</html>
