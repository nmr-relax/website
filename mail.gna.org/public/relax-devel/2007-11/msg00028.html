<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: Pickling problems with the relax data storage singleton. -->
<!--X-From-R13: "Sqjneq q'Ohiretar" <rqjneq.qnhiretarNtznvy.pbz> -->
<!--X-Date: Mon, 26 Nov 2007 11:37:34 +0100 -->
<!--X-Message-Id: 7f080ed10711260237s2c9d9a59w75f1b8f7ab79c66e@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 7f080ed10711201001s59a00533pf3c0ee3f88a79edb@mail.gmail.com -->
<!--X-Reference: 474543CC.50505@bmb.leeds.ac.uk -->
<!--X-Reference: 7f080ed10711220106t543aade7o54657f5cced18858@mail.gmail.com -->
<!--X-Reference: 474552DE.9090007@bmb.leeds.ac.uk -->
<!--X-Reference: 7f080ed10711220830s56faf4d8v1941fa6c61052f35@mail.gmail.com -->
<!--X-Reference: 47468BE4.7000804@bmb.leeds.ac.uk -->
<!--X-Reference: 3b3f50350711251832k469e45a5r247696eaf3e83952@mail.gmail.com -->
<!--X-Reference: f001463a0711260039r791233b0r25f0c4e63a63092@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: Pickling problems with the relax data storage singleton. -- November 26, 2007 - 11:37</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: Pickling problems with the relax data storage singleton.</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00028" class="tabs">Index by Date</a> | <a href="threads.html#00028" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00027.html">Date Prev</a>] [<a href="msg00029.html">Date Next</a>] [<a href="msg00026.html">Thread Prev</a>] [<a href="msg00029.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;gary thompson&quot; &lt;garyt.and.sarahb@xxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Mon, 26 Nov 2007 11:37:26 +0100</li>
<li class="menuitem">
<em>Cc</em>: relax-devel@xxxxxxx</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00028.html">7f080ed10711260237s2c9d9a59w75f1b8f7ab79c66e@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;7f080ed10711201001s59a00533pf3c0ee3f88a79edb@xxxxxxxxxxxxxx&gt;	&lt;474543CC.50505@xxxxxxxxxxxxxxx&gt;	&lt;7f080ed10711220106t543aade7o54657f5cced18858@xxxxxxxxxxxxxx&gt;	&lt;474552DE.9090007@xxxxxxxxxxxxxxx&gt;	&lt;7f080ed10711220830s56faf4d8v1941fa6c61052f35@xxxxxxxxxxxxxx&gt;	&lt;47468BE4.7000804@xxxxxxxxxxxxxxx&gt;	&lt;3b3f50350711251832k469e45a5r247696eaf3e83952@xxxxxxxxxxxxxx&gt;	&lt;f001463a0711260039r791233b0r25f0c4e63a63092@xxxxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on November 26, 2007 - 11:37:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">On Nov 26, 2007 9:39 AM, gary thompson &lt;garyt.and.sarahb@xxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">




On Nov 26, 2007 2:32 AM, Chris MacRaild &lt;macraild@xxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">

On Nov 23, 2007 7:14 PM, Gary Thompson &lt;garyt@xxxxxxxxxxxxxxx&gt; wrote:

</pre></blockquote></blockquote><pre style="margin: 0em;">

[snip]

</pre><blockquote class="blockquote"><blockquote class="blockquote"><pre style="margin: 0em;">Another (better?) option would be to do saving and restoring state at
a lower level. So instead of simply pickling the whole Data object, we
have save and restore methods of the Data class that do the pickling
in a more controled way. This seems to me more true to the intent of
the singleton pattern, avoiding the complications Gary refers to. Also
the control over what gets saved and how might be useful.

A quick sketch of the sort of thing I'm thinking:

class Data(dict):
   ...
   def _save(file):
       P = Pickler(file)
       dont_save = [] # a list of attributes that don't need saving,
eg. methods
       for name,  attr in self.__dict__.items():
           if not name in dont_save:
               P.dump((name,attr))

   def _restore(file):
       P = Unpickler(file)
       while True:
           try:
               name, attr = U.load()
           except EOFError:
               break
           setAttr(self, name, attr)

Then the user commands save_state and restore_state are just
front-ends to Data._save and Data._restore. Pickle needn't wory itself
with our unusual namespace, because only attributes of Data are
pickled, not Data itself. Save and restore functions are mehtods of
the Singleton object, so there is no risk of breaking the Singleton
pattern. Finally, we have the basis of a mechanism there to control
what gets saved/restored and how.

Cheers,

Chris





</pre></blockquote><pre style="margin: 0em;">This seems good but have some other possibly  interesting questions

1. should data be a singleton? what happens if i need to load two data
hierachies for example for comparison between two runs (If i am barking up
the wrong tree about the current design here please disregard this)
</pre></blockquote><pre style="margin: 0em;">

The data storage singleton can handle this.  It is a DictionaryType
object, its keys corresponding to individual PipeContainer objects.
These PipeContainers are the data pipes, the embodiment of the morphed
'runs' concept.  So the change was to put everything into a
PipeContainer and the comparisons will be between the data contents of
any sets of PipeContainers.  As relax runs, the contents of each data
pipe is modified and molded.  The links between these pipes include
functions for switching between them, copying data between them, and
merging the contents together and placing the result into a new pipe
(e.g. model selection, hybridisation, etc.).  These are just very
basic plumbing concepts ;)


</pre><blockquote class="blockquote"><pre style="margin: 0em;">2. we have to  be careful we don't pickle any python state (what is python
state can change between versions) How do we identify what is python state,
create an empty object?
</pre></blockquote><pre style="margin: 0em;">

The saved states are not very portable.  I'm hoping the unit tests
will pull out these issues, as there will be a few saved states in the
shared data directory you created.


</pre><blockquote class="blockquote"><pre style="margin: 0em;">3. Chris's  will add an extra requirement for maintenance in the future as
all new fields have to be registered for saving
</pre></blockquote><pre style="margin: 0em;">

That is true.  Hopefully when new objects are added, a corresponding
unit test is created to catch it.  But yes, this is a danger.  So
rather than having a white list of object to include a black list of
objects to exclude will be better, as then new objects will
automatically be saved.


</pre><blockquote class="blockquote"><pre style="margin: 0em;">4. what are the implications for cross version compatability, this may not
be a requirement, but if it is then we will have impliment code to shim old
formats into newer ones
</pre></blockquote><pre style="margin: 0em;">

The save state is a temporary construct.  Portability sucks!  It's
awful.  Again hopefully the unit tests I have already written (and
future state unit tests) will catch and identify the issues.  The
results file is the way to go with portability.  It should contain all
the contents of a given PipeContainer.  And then loading the results
file should restore the PipeContainer.  The only issue is the PDB
object files (Scientific, etc) which are not saved in the results
file.  Btw, your unit test framework is awesome for debugging!!!  It
appears to be catching all my typos and mistakes.  And for coding it's
great as well.  Just write the unit tests first to cover all the
behavior of the functions, and then code until the tests pass.  Its
making my life so easy (and much more bug free).


</pre><blockquote class="blockquote"><pre style="margin: 0em;"> 5. If you put an XP hat on you would go with the simple but crude method
for the moment and put in place a more complicated methodology if and whn we
need it (could we design an interface that could deal with both and then
impliment the more complicated stratergy if and when we need it?
</pre></blockquote><pre style="margin: 0em;">

Unfortunately I couldn't make the first simple method work.

Regards,

Edward


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00021" href="msg00021.html">Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00022" href="msg00022.html">Re: Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> Gary Thompson</li></ul></li>
<li><strong><a name="00023" href="msg00023.html">Re: Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00024" href="msg00024.html">Re: Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> Gary Thompson</li></ul></li>
<li><strong><a name="00025" href="msg00025.html">Re: Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> Chris MacRaild</li></ul></li>
<li><strong><a name="00026" href="msg00026.html">Re: Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> gary thompson</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Tue Nov 27 00:24:44 2007</div>  
</body>
</html>
