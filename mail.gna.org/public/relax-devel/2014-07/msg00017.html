<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: r24336 &#45; /branches/disp_spin_speed/target_functions/relax_disp.py -->
<!--X-From-R13: Febryf Szgrxæe Zvaarg &#60;gyvaargNaze&#45;erynk.pbz> -->
<!--X-Date: Tue, 22 Jul 2014 18:04:43 +0200 -->
<!--X-Message-Id: CA+CBx2O1CtXF5CX+yzAhyCUs_xxR_Nt5iK7OPvRhFrNann45_g@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: E1X0TrL&#45;0006Xp&#45;7j@subversion.gna.org -->
<!--X-Reference: CAED9pY&#45;QqN=4oKMs9XZDXgtX+Tm6UuSsJUgxv2oUPh3A=xfy5g@mail.gmail.com -->
<!--X-Reference: CA+CBx2MHqmZ4G0031FDO9CRo9D_z940aL1AawQbBu3sDPGK25w@mail.gmail.com -->
<!--X-Reference: CAED9pY_HKaRXm9V9DPEPS4TJUq1nqgbgMp_cgBZ&#45;+o+b5XcEDg@mail.gmail.com -->
<!--X-Reference: CA+CBx2P9OmoM&#45;fsqYkQsuKYQhJ8kOGJ4R6qEYNP5CWj2w7eqpw@mail.gmail.com -->
<!--X-Reference: CAED9pY&#45;tKbZWpg1=8nBPG8FTid6LDsy9za9Ac+&#45;mKnzVRGGieQ@mail.gmail.com -->
<!--X-Reference: CAED9pY_yH74iguRTqjErusy4KXsxQy1_i&#45;eGS07fY18cj6qjyw@mail.gmail.com -->
<!--X-Reference: CAED9pY96drNKz=CGivycTFSmrK=Ok+G8n4KVqvEbL=wmsyfrXg@mail.gmail.com -->
<!--X-Reference: CAED9pY8DfT5p30f8C7X81dY_&#45;amzyeq07WrczFoj2mRwNF7gkw@mail.gmail.com -->
<!--X-Reference: CAED9pY&#45;iosRR4DjG1jAbGdJyBgnbFwVus3JPOq&#45;sb=QJvyssKg@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: r24336 - /branches/disp_spin_speed/target_functions/relax_disp.py -- July 22, 2014 - 18:04</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: r24336 - /branches/disp_spin_speed/target_functions/relax_disp.py</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00017" class="tabs">Index by Date</a> | <a href="threads.html#00017" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00016.html">Date Prev</a>] [<a href="msg00018.html">Date Next</a>] [<a href="msg00022.html">Thread Prev</a>] [<a href="msg00019.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;Edward d'Auvergne&quot; &lt;edward@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Tue, 22 Jul 2014 18:03:51 +0200</li>
<li class="menuitem">
<em>Cc</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:from:date:message-id :subject:to:cc:content-type:content-transfer-encoding; bh=55Gbq1d26ZW4MBHYaIi/fylxZaYiRvPRUNK4Gru/sNE=; b=rstoFs8SQSYjK+1L1SshWVdpyi40HBZrDfknY+ex8tacdzeapaRhD1hKt3s0cTXaEC L42dKuvopFkH7vOw6OyzZmXOKQXT65W0deoONeTJ34JFBcHEqMaPd0IArwObMOjsAuJo RKlEm4XbmDYid/39RD1ZnPlXVSdMkm1PsFmqx5Ab2cUGDmFNmvb/grvx54iUd8Exls0V gRNRXaJS6tnlo7FBsmLMF+pdW6vPisfifjiIyQE/rduu0UlYAN9CQ/Cj7bXuNhlgYDrZ H5MVeUUn+zel1aqLBH0zXQpajEGdnU2Rj0Wg7NB2CiSiC1POqN+yE2WwUhQOUyOERmPW YAIw==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00017.html">CA+CBx2O1CtXF5CX+yzAhyCUs_xxR_Nt5iK7OPvRhFrNann45_g@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;E1X0TrL-0006Xp-7j@subversion.gna.org&gt; &lt;CAED9pY-QqN=4oKMs9XZDXgtX+Tm6UuSsJUgxv2oUPh3A=xfy5g@mail.gmail.com&gt; &lt;CA+CBx2MHqmZ4G0031FDO9CRo9D_z940aL1AawQbBu3sDPGK25w@mail.gmail.com&gt; &lt;CAED9pY_HKaRXm9V9DPEPS4TJUq1nqgbgMp_cgBZ-+o+b5XcEDg@mail.gmail.com&gt; &lt;CA+CBx2P9OmoM-fsqYkQsuKYQhJ8kOGJ4R6qEYNP5CWj2w7eqpw@mail.gmail.com&gt; &lt;CAED9pY-tKbZWpg1=8nBPG8FTid6LDsy9za9Ac+-mKnzVRGGieQ@mail.gmail.com&gt; &lt;CAED9pY_yH74iguRTqjErusy4KXsxQy1_i-eGS07fY18cj6qjyw@mail.gmail.com&gt; &lt;CAED9pY96drNKz=CGivycTFSmrK=Ok+G8n4KVqvEbL=wmsyfrXg@mail.gmail.com&gt; &lt;CAED9pY8DfT5p30f8C7X81dY_-amzyeq07WrczFoj2mRwNF7gkw@mail.gmail.com&gt; &lt;CAED9pY-iosRR4DjG1jAbGdJyBgnbFwVus3JPOq-sb=QJvyssKg@mail.gmail.com&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Troels Emtekær Linnet</strong> on July 22, 2014 - 18:04:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi Ed.

I wont change anymore.

This development line is way overdue.

Best
Troels

2014-06-27 18:03 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Here is one more point.  For the DPL94 model, the denominator is
&quot;kex**2 + spin_lock_fields**2&quot;.  This can only be zero when kex is
zero, and then there should be no exchange.  Therefore we can add a
kex == 0 check at the start to return R1_R2 and then delete the
mask_denom_zero logic.  This should slightly speed things up by
removing one 'if' statement.  Also, kex**2 is not a repetitive
operation.

Cheers,

Edward


On 27 June 2014 17:33, Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">There are also a number of double spacing issues.  You can find these
by running:

$ ./devel_scripts/code_validator lib/dispersion/b14.py
$ ./devel_scripts/code_validator lib/dispersion/cr72.py

Etc.  Some things can be ignored, like the capitals in the function
name and double spacing or trailing spacing for equations in
docstrings.  This script will identify most formatting problems
remaining.

Cheers,

Edward



On 27 June 2014 17:28, Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Also the documentation in the get_back_calc() method of the target
function needs a little polish - it is not a float that is returned.
So, the running list:

- Some modules have &quot;=&quot; operators outside of functions that need
spaces around them.

- Trailing whitespace, most of it is in the trunk, but there are some
new ones.  Just run:  grep &quot; $&quot; lib/dispersion/* | grep -v &quot;\\\\ &quot;

- There are some empty lines straight after a 'for' loop in many places.

- Your copyright in the tsmfk01.py file needs to be extended to 2014.

- There are some FIXME comments in the lib.dispersion package.

- In some places, comment lines require empty lines before them (in
target_functions.relax_disp and lib.dispersion).

- Not very important, but the target function calc_ns_mmq_3site_chi2()
can have the &quot;Once off parameter conversions&quot; shifted into the
lib.dispersion module to simplify this.

- The newline spacing between target function methods needs some fixes.

- The 'chi2_sum' initialisation in func_ns_mmq_2site() should go.

- The get_back_calc() method of the target function needs a little
polish - it is not a float that is returned.

Cheers,

Edward



On 27 June 2014 17:26, Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">To add to the list of trivialities to fix:

- The 'chi2_sum' initialisation in func_ns_mmq_2site() should go.

Cheers,

Edward



On 27 June 2014 17:23, Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Let me see.  You've covered most of the running list, there's just one
or two things left.  I'll add a few more trivial things as well.

- Some modules have &quot;=&quot; operators outside of functions that need
spaces around them.

- Trailing whitespace, most of it is in the trunk, but there are some
new ones.  Just run:  grep &quot; $&quot; lib/dispersion/* | grep -v &quot;\\\\ &quot;

- There are some empty lines straight after a 'for' loop in many places.

- Your copyright in the tsmfk01.py file needs to be extended to 2014.

- There are some FIXME comments in the lib.dispersion package.

- In some places, comment lines require empty lines before them (in
target_functions.relax_disp and lib.dispersion).

- Not very important, but the target function calc_ns_mmq_3site_chi2()
can have the &quot;Once off parameter conversions&quot; shifted into the
lib.dispersion module to simplify this.

- The newline spacing between target function methods needs some fixes.


I'll keep looking.  I'm guessing you will not be tackling the numeric
models to speed them up to match 'NS CPMG 2-site expanded' model via
the ultimate solution of brute-force expansion
(<a  rel="nofollow" href="http://www.mail-archive.com/relax-users@xxxxxxx/msg01641.html">http://www.mail-archive.com/relax-users@xxxxxxx/msg01641.html</a>) any
time soon.  This will have a similar effect as the ultimate speed up
at <a  rel="nofollow" href="http://www.mail-archive.com/relax-devel%40gna.org/msg05691.html">http://www.mail-archive.com/relax-devel%40gna.org/msg05691.html</a>
which you have so successfully achieved in this branch.  Can you
remember if there were any other changes required?  I will create a
new timings file just before tagging the relax release.

Cheers,

Edward

On 27 June 2014 16:53, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt; 
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">This sounds good.

What is needed to be done, to merge disp_spin_speed in trunk now?

Best
Troels

2014-06-27 15:53 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hmmm:

$ grep -c &quot;out=\|einsum&quot; lib/dispersion/*
lib/dispersion/b14.py:0
lib/dispersion/cr72.py:2
lib/dispersion/dpl94.py:0
lib/dispersion/__init__.py:0
lib/dispersion/it99.py:0
lib/dispersion/lm63_3site.py:0
lib/dispersion/lm63.py:0
lib/dispersion/m61b.py:0
lib/dispersion/m61.py:0
lib/dispersion/matrix_exponential.py:5
lib/dispersion/matrix_power.py:0
lib/dispersion/mmq_cr72.py:0
lib/dispersion/mp05.py:0
lib/dispersion/ns_cpmg_2site_3d.py:6
lib/dispersion/ns_cpmg_2site_expanded.py:0
lib/dispersion/ns_cpmg_2site_star.py:3
lib/dispersion/ns_matrices.py:0
lib/dispersion/ns_mmq_2site.py:12
lib/dispersion/ns_mmq_3site.py:12
lib/dispersion/ns_r1rho_2site.py:3
lib/dispersion/ns_r1rho_3site.py:3
lib/dispersion/tap03.py:0
lib/dispersion/tp02.py:0
lib/dispersion/tsmfk01.py:0
lib/dispersion/two_point.py:0


What do you think of the idea of making this a hard dependency:

&quot;&quot;&quot;
Index: dep_check.py
===================================================================
--- dep_check.py        (revision 24343)
+++ dep_check.py        (working copy)
@@ -37,6 +37,9 @@
 # numpy.
 try:
     import numpy
+    if float(numpy.version.version[:3]) &lt; 1.6:
+        sys.stderr.write(&quot;Version %s of the 'numpy' dependency is not
supported, numpy &gt;= 1.6 is required.\n&quot; % numpy.version.version)
+        sys.exit()
 except ImportError:
     sys.stderr.write(&quot;The dependency 'numpy' has not been 
installed.\n&quot;)
     sys.exit()
&quot;&quot;&quot;

This might be the easiest way, just forcing users to upgrade.  I've
used the out argument a lot with the frame order analysis as well and
plan to use it more often, so maybe we just have to put our foot down
and make this a hard dependency.  That will make everyone's life
easier, and simplify what we as developers have to do to handle this.
I can apply this to the trunk and release relax 3.2.3 with all the
current fixes and this hard numpy version dependency, and then in a
few weeks when you are ready, merge the disp_spin_speed branch and
release relax 3.2.4.  What do you think?

Regards,

Edward





On 27 June 2014 14:40, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt; 
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Ed.

You can just grep for &quot;out&quot; or &quot;einsum&quot; in lib/dispersion.

Best
Troels

2014-06-27 14:15 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Troels,

I think if would be better if we caught this earlier, specifically 
the
select_model() method of the specific_analyses.relax_disp.uf module 
if
the user chooses a model which is not supported by their numpy
version.  Such a check with a RelaxError would only be two lines of
code, plus a comment (which could include the current version in
numpy.version.version).  It would be very useful to add the models 
to
a list variable in specific_analyses.relax_disp.variables so that I
can replicate the checks in the GUI.  Even better would be to add 
the
2 line check to a function in specific_analyses.relax_disp.checks to
allow for consistent checking in all user interfaces.  There could
even be two separate tests, one for the numpy.einsum and one for the
numpy out argument, each with their own model lists, if you wish.

Cheers,

Edward






On 27 June 2014 12:58,  &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Author: tlinnet
Date: Fri Jun 27 12:58:22 2014
New Revision: 24336

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=24336&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=24336&amp;view=rev</a>
Log:
Added to target function that experiment_type_setup() should not 
be initiated, if numpy.einsum is missing.

Task #7807 (<a  rel="nofollow" href="https://web.archive.org/web/https://gna.org/task/index.php?7807">https://gna.org/task/index.php?7807</a>): Speed-up of 
dispersion models for Clustered analysis.

Modified:
    branches/disp_spin_speed/target_functions/relax_disp.py

Modified: branches/disp_spin_speed/target_functions/relax_disp.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/disp_spin_speed/target_functions/relax_disp.py?rev=24336&amp;r1=24335&amp;r2=24336&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/disp_spin_speed/target_functions/relax_disp.py?rev=24336&amp;r1=24335&amp;r2=24336&amp;view=diff</a>
==============================================================================
--- branches/disp_spin_speed/target_functions/relax_disp.py     
(original)
+++ branches/disp_spin_speed/target_functions/relax_disp.py     
Fri Jun 27 12:58:22 2014
@@ -365,8 +365,10 @@
         # This is to make sure, that the chi2 values is not 
affected by missing values.
         self.mask_replace_blank = masked_equal(self.missing, 1.0)

-        # Check the experiment types, simplifying the data 
structures as needed.
-        self.experiment_type_setup()
+        # Check if eisum is available for numerical models.
+        if dep_check.einsum_module:
+            # Check the experiment types, simplifying the data 
structures as needed.
+            self.experiment_type_setup()

         # Scaling initialisation.
         self.scaling_flag = False


_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-commits mailing list
relax-commits@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="http://www.nmr-relax.com/mail.gna.org/listinfo/relax-commits">https://mail.gna.org/listinfo/relax-commits</a>
</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-devel mailing list
relax-devel@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="http://www.nmr-relax.com/mail.gna.org/listinfo/relax-devel">https://mail.gna.org/listinfo/relax-devel</a>
</pre></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Tue Jul 22 18:40:13 2014</div>  
</body>
</html>
