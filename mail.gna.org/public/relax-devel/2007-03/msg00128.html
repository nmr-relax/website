<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: how to parallelise model_free minimise -->
<!--X-From-R13: "Unel E. Fubzcfba" <tnelgNozo.yrrqf.np.hx> -->
<!--X-Date: Mon, 26 Mar 2007 18:12:08 +0200 -->
<!--X-Message-Id: 4607F0AB.6000807@bmb.leeds.ac.uk -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 7f080ed10703191030h79036e06w56912aa1d9130f48@mail.gmail.com -->
<!--X-Reference: 45FF0E84.1060007@bmb.leeds.ac.uk -->
<!--X-Reference: 1174384147.29205.20.camel@pc172&#45;31&#45;2&#45;63.biochem.unimelb.edu.au -->
<!--X-Reference: 45FFEC5C.7060205@bmb.leeds.ac.uk -->
<!--X-Reference: 7f080ed10703200727l5fad8e72if4cf9aff74bc21@mail.gmail.com -->
<!--X-Reference: 45FFF714.7070903@bmb.leeds.ac.uk -->
<!--X-Reference: 7f080ed10703200813x323ec212l471796641855a7ff@mail.gmail.com -->
<!--X-Reference: 4603EA08.60801@bmb.leeds.ac.uk -->
<!--X-Reference: 7f080ed10703252217x7db43e6bxfe7324ad0379c778@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: how to parallelise model_free minimise -- March 26, 2007 - 18:12</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: how to parallelise model_free minimise</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00128" class="tabs">Index by Date</a> | <a href="threads.html#00128" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00127.html">Date Prev</a>] [<a href="msg00129.html">Date Next</a>] [<a href="msg00126.html">Thread Prev</a>] [<a href="msg00129.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Mon, 26 Mar 2007 17:11:23 +0100</li>
<li class="menuitem">
<em>Cc</em>: relax-devel@xxxxxxx</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00128.html">4607F0AB.6000807@bmb.leeds.ac.uk</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;<a href="msg00092.html">7f080ed10703191030h79036e06w56912aa1d9130f48@mail.gmail.com</a>&gt;	&lt;<a href="msg00093.html">45FF0E84.1060007@bmb.leeds.ac.uk</a>&gt;	&lt;<a href="msg00097.html">1174384147.29205.20.camel@pc172-31-2-63.biochem.unimelb.edu.au</a>&gt;	&lt;<a href="msg00107.html">45FFEC5C.7060205@bmb.leeds.ac.uk</a>&gt;	&lt;<a href="msg00110.html">7f080ed10703200727l5fad8e72if4cf9aff74bc21@mail.gmail.com</a>&gt;	&lt;<a href="msg00112.html">45FFF714.7070903@bmb.leeds.ac.uk</a>&gt;	&lt;<a href="msg00114.html">7f080ed10703200813x323ec212l471796641855a7ff@mail.gmail.com</a>&gt;	&lt;<a href="msg00124.html">4603EA08.60801@bmb.leeds.ac.uk</a>&gt;	&lt;<a href="msg00126.html">7f080ed10703252217x7db43e6bxfe7324ad0379c778@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>User-agent</em>: Mozilla Thunderbird 1.0.8 (X11/20060411)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Gary S. Thompson</strong> on March 26, 2007 - 18:12:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<tt>Edward d'Auvergne wrote:
</tt><blockquote class="blockquote"><tt>On 3/24/07, Gary S. Thompson &lt;garyt@xxxxxxxxxxxxxxx&gt; wrote:
</tt><blockquote class="blockquote"><pre style="margin: 0em;">Dear Ed and all
    I have started looking at how to parallelise the calls to
model_free.minimise as discussed in our previous message but am having
some problems with the function....</pre><br>
<pre style="margin: 0em;">The first is that it is huge and seems to have a large amount of special
casing and checking built in.
</pre></blockquote><pre style="margin: 0em;"><br>Yep, it is quite complex.  However this code complexity simplifies the
execution of model-free minimisations and grid searches.</pre><br>
<br>
<blockquote class="blockquote"><pre style="margin: 0em;">The second one is to work out how many different modes it can be called
in. From waht I can see I need to look for param_set and only
paralellise if self.param_set is one of mf or local_mf (diff and alle
being either to trivial or too hard to optimise respectivley ;-)
</pre></blockquote><pre style="margin: 0em;"><br>There is no need as this param_set is handled by the code to produce
the main loop of that model-free 'minimise()' function.  The part to
parallelise of this function is this main loop over the minimisation
instances.  You can find the loop on line 2118 of
'specific_fns/model_free.py' of the 'multi_processor' branch (or
search for the comment &quot;# Loop over the minimisation instances.&quot;).</pre><br>
<br>
<blockquote class="blockquote"><pre style="margin: 0em;">Then there comes the parameters passed</pre><br>
<pre style="margin: 0em;"> first there is Mf  and generic_minimse which seem to take a huge number
orf parameters:</pre><br>
<pre style="margin: 0em;">           self.mf = Mf(init_params=self.param_vector,
param_set=self.param_set, diff_type=diff_type,
                         diff_params=diff_params,
scaling_matrix=self.scaling_matrix, num_res=num_res,
                         equations=equations, param_types=param_types,
param_values=param_values,
                         relax_data=relax_data, errors=relax_error,
bond_length=r, csa=csa, num_frq=num_frq,
                         frq=frq, num_ri=num_ri,
remap_table=remap_table, noe_r1_table=noe_r1_table,
                         ri_labels=ri_labels, gx=self.relax.data.gx,
gh=self.relax.data.gh,
                         g_ratio=self.relax.data.g_ratio,
h_bar=self.relax.data.h_bar,
                         mu0=self.relax.data.mu0, num_params=num_params,
vectors=xh_unit_vectors)</pre><br>
<pre style="margin: 0em;">and generic</pre><br>
<pre style="margin: 0em;">                results = generic_minimise(func=self.mf.func,
dfunc=self.mf.dfunc, d2func=self.mf.d2func, args=(),
                                           x0=self.param_vector,
min_algor=min_algor, min_options=min_options,
                                           func_tol=func_tol,
grad_tol=grad_tol, maxiter=max_iterations,
                                           full_output=1,
print_flag=print_flag, A=A, b=b)
</pre></blockquote><pre style="margin: 0em;"><br>If it is the main loop over the minimisation instances which is
parallelised for MPI, etc., then this code won't need modification.</pre><br>
<blockquote class="blockquote"><pre style="margin: 0em;">The questions here are</pre><br>
<pre style="margin: 0em;">1. that are all these parameters either I misreading thing or else not
undertanding because i couldn't find definitions for every thing
</pre></blockquote><pre style="margin: 0em;"><br>All of the arguments for the instantiation of the Mf class are setup
at the start of the main minimisation loop, i.e. between lines 2119
and 2324.  This is most of the code of the 'minimise()' function.</pre><br>
</blockquote><tt>indeed but I am not clear in all cases as to what they contain...
</tt><blockquote class="blockquote"><blockquote class="blockquote"><pre style="margin: 0em;">2. what is going to change between runs or even over runs of the relax
program.
</pre></blockquote><tt><br>For each iteration of the main loop, these arguments and parameters 
will change.</tt><br>
<br>
</blockquote><tt>Not necessarily? certainly things such as remap_table, ri_labels, etc do 
not seem to change between passes through the loop</tt><br>
<br>
<blockquote class="blockquote"><br>
<blockquote class="blockquote"><pre style="margin: 0em;">clearly some things don't change at all and it could even be asked why
for example h_bar is a parameter to Mf  (ther maybe something deep I am
missing here?)
</pre></blockquote><pre style="margin: 0em;"><br>h_bar in the new 1.3 code need not be sent in.  I have created the
module 'physical_constants' from which it can be imported.  Every
argument to the Mf instantiation, except for h_bar and mu0, will be
different for each minimisation 'instance'.
</pre></blockquote><tt>thats good
</tt><blockquote class="blockquote"><pre style="margin: 0em;"><br>For example if the
param_set is 'all', then the 'relax_data' argument will be the
relaxation data of all selected spin systems.  If param_set is 'mf',
then 'relax_data' will be the relaxation data of a single spin.</pre><br>
</blockquote><br>
<blockquote class="blockquote"><br>
<blockquote class="blockquote"><pre style="margin: 0em;">some other things may only change at  specific points in the program For
example the vectors of the molecules should only change when the vecors
function of structure or pdb is called
other things are per residue but which of them???
</pre></blockquote><pre style="margin: 0em;"><br>All but h_bar and mu0.</pre><br>
<blockquote class="blockquote"><tt>and other things are differing by type of model and minimisation....
</tt></blockquote><pre style="margin: 0em;"><br>Yep, see above.</pre><br>
<blockquote class="blockquote"><tt>as a note typical input parameters for a local tm calculation are<br>
-#-initialise Mf residue - 3 LEU<br>
-#--------------<br>
-#-<br>
-#-init_params [ 1000.]<br>
-#-param_se local_tm<br>
-#-diff_type sphere<br>
-#-diff_params None<br>
-#-scaling_matrix [ [  1.00000000e-12]]<br>
-#-num_res 1<br>
-#-equations ['mf_orig']<br>
-#-param_types [['local_tm']]<br>
-#-param_values None<br>
-#-relax_data [array([  0.8293,  12.85  ,   0.9528,  12.57  ,   
0.0983])]<br>
-#-errors [array([ 0.023 ,  0.13  ,  0.0253,  0.171 ,  0.0278])]<br>
-#-bond_length [1.0200000000000001e-10]<br>
-#-csa= [-0.00017199999999999998]<br>
-#-num_frq [2]<br>
-#-frq [[750800000.0, 599.71900000000005]]<br>
-#-num_ri [5]<br>
-#-remap_table [[0, 0, 1, 1, 1]]<br>
-#-noe_r1_table [[None, None, None, None, 2]]<br>
-#-ri_labels [['R1', 'R2', 'R1', 'R2', 'NOE']]<br>
-#-gx -27126000.0<br>
-#-gh 267522212.0<br>
-#-g_ratio -9.862206444<br>
-#-h_bar 1.05457159642e-34<br>
-#-mu0 1.25663706144e-06<br>
-#-num_params [1]<br>
-#-vectors [None]<br>
-#-<br>
-#-generic minimisation residue - 3 LEU<br>
-#-----------------------------<br>
-#-<br>
-#-constraints 1<br>
-#-func &lt;bound method Mf.func_local_tm of &lt;maths_fns.mf.Mf instance at<br>
0x4079fc0c&gt;&gt; -#-dfunc &lt;bound method Mf.dfunc_local_tm of<br>
&lt;maths_fns.mf.Mf instance a<br>
t 0x4079fc0c&gt;&gt;<br>
-#-d2func &lt;bound method Mf.d2func_local_tm of &lt;maths_fns.mf.Mf instance<br>
at 0x4079fc0c&gt;&gt;<br>
-#-args ()<br>
-#-print x0 [ 1000.]<br>
-#-print min_algor Method of Multipliers<br>
-#-min_options ('newton',)<br>
-#-func_tol 1e-25<br>
-#-grad_tol None<br>
-#-maxiter 10000000<br>
-#-full_output 1<br>
-#-print_flag 1<br>
-#-constrained<br>
-#-A [[ 1.]<br>
-#-b [      0. -200000.]</tt><br>
<br>
<pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;">As an aside when the redesign of the spin_loops and minimise /model
loops cuts in it would be a good idea 9from the paralle point of view)
to have the spin loop  running faster than the minimse/model loop
</pre></blockquote><br>
</blockquote><tt>Sorry I wasn't quite clear here, its not comuptational speed I am 
talking about but the speed of the 'loop counter'</tt><br>
<br>
<pre style="margin: 0em;">e.g.it would be nice to have</pre><br>
<pre style="margin: 0em;">for residue in  all residues:
   for model in models:
            do_stuff-(tm)</pre><br>
<pre style="margin: 0em;"><br>as opposed to</pre><br>
<pre style="margin: 0em;">for model in models: #currently at the user level
   for residue in  all residues:
            do_stuff-(tm)</pre><br>
<pre style="margin: 0em;">now that might need something of the form</pre><br>
<tt>       # Set the run names (also the names of preset model-free models).<br>
       if local_tm:<br>
           self.runs = ['tm0', 'tm1', 'tm2', 'tm3', 'tm4', 'tm5', 
'tm6', 'tm7', 'tm8', 'tm9']<br>
       else:<br>
           self.runs = ['m0', 'm1', 'm2', 'm3', 'm4', 'm5', 'm6', 'm7', 
'm8', 'm9']</tt><br>
<br>
<tt>run.create_composite('super')<br>
for name in self.runs:<br>
  
   run.create(name, 'mf')<br>
   composite_add('super',name)<br>
   minimise('newton', run='super')</tt><br>
<br>
<pre style="margin: 0em;"><br>which would minimise all runs in parallel...</pre><br>
<pre style="margin: 0em;">and I understand from chris that we are planning to do</pre><br>
<tt><br>      # Set the run names (also the names of preset model-free models).<br>
       if local_tm:<br>
           self.runs = ['tm0', 'tm1', 'tm2', 'tm3', 'tm4', 'tm5', 
'tm6', 'tm7', 'tm8', 'tm9']<br>
       else:<br>
           self.runs = ['m0', 'm1', 'm2', 'm3', 'm4', 'm5', 'm6', 'm7', 
'm8', 'm9']</tt><br>
<br>
<tt> 
    minimise('newton', runs=self.runs)</tt><br>
<br>
<pre style="margin: 0em;"><br>which would also work</pre><br>
<pre style="margin: 0em;"><br>now comes the tricky bit</pre><br>
<tt><br>all the minimisations etc would now become rfnctions to setup 
minimsations and say submit them to a queue with a suitable object to 
allow the results to be sorted out later.</tt><br>
<br>
<tt>then at the end of minimise('newton', runs=self.runs) you would collect 
in all the results from all calculations and complete the calculation so 
we have something like</tt><br>
<br>
<pre style="margin: 0em;">for residue
   for run in runs:
      calculation-instance = setup-calculation(residue,run)
      queue.submit(calculation-instance)
while(queue.not_complete()):
   result.queue.get_result()
   result.record(self.reax.data)</pre><br>
<tt>This will allow the maximum numer of calculations to be conducted in 
parallel and will intrisically load balance as well as we can get
</tt><blockquote class="blockquote"><pre style="margin: 0em;">That's guaranteed.  The speed of the spin loop (the spin_loop()
function of the 'generic_fns.selection' module of the 1.3 line) will
be limited by the internal Python looping speed.  The main loop of the
minimise() function is limited by the call to generic_minimise() which
should be many orders of magnitude slower.</pre><br>
<br>
<blockquote class="blockquote"><pre style="margin: 0em;">so you could split by residue for prallelising but send of all the
required model minimisations for each model at the same time which would
give implicicit load balancing and coarser gains on homogeouds parallel
computers:
</pre></blockquote><pre style="margin: 0em;"><br>The minimise() main loop does all of this.  Splitting by residue only
makes sense for the 'mf' and 'local_tm' param_set values.  All
residues are involved in the diffusion tensor optimisation 'diff' and
the complete optimisation 'all'.</pre><br>
<br>
<blockquote class="blockquote"><pre style="margin: 0em;">i.e for six residues and 3 nodes</pre><br>
<pre style="margin: 0em;">node 1 calculates
res 1 [m1 m2 m3...]
res 2 [[m1 m2 m3..]</pre><br>
<pre style="margin: 0em;">node 2 calculates
res 3 [m1 m2 m3...]
res 4 [[m1 m2 m3..]</pre><br>
<pre style="margin: 0em;">node 3 calculates
res 5 [m1 m2 m3...]
res 6 [[m1 m2 m3..]</pre><br>
<tt>this obviously places some limitations of the design of the 
minimisation function as it might needs to have a set and tear down 
region that cope with this batched data....
</tt></blockquote><pre style="margin: 0em;"><br>The minimise() main loop is the finest grain parallelisation you can
get without writing a specific parallelised optimisation algorithm.</pre><br>
</blockquote><tt><br>actually what i was aiming for was as coarse grained and well load 
balanced a set of calculations as possible (i.e. minimum of 
communication overhead (i.e. bigger chunks of data with similar 
computations times going over the wire))</tt><br>
<br>
<pre style="margin: 0em;"><br>regards
gary
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Cheers,</pre><br>
<pre style="margin: 0em;">Edward</pre><br>
<pre style="margin: 0em;">.</pre><br>
</blockquote><pre style="margin: 0em;"><br>just as another comment (or two)</pre><br>
<pre style="margin: 0em;">1. why does do we send no arguments to the fucntions e.g.
-#-num_frq [2]
-#-frq [[750800000.0, 599.71900000000005]]</pre><br>
<tt>2. how does the data return from minimisation work (specifically why is 
param_vector  a  instance vaiable of  Model_free<br>
e.g. we have</tt><br>
<br>
<pre style="margin: 0em;">self.param_vector, self.func, iter, fc, gc, hc, self.warning = results</pre><br>
<pre style="margin: 0em;">....</pre><br>
<pre style="margin: 0em;"># Disassemble the parameter vector.
self.disassemble_param_vector(index=index, sim_index=sim_index)</pre><br>
<pre style="margin: 0em;"><br></pre><br>
<tt>inside a tight loop. So even though self.param_vector is an instance 
variable it doesn't contain state for a Model_free object it just keeps 
being overwritten by the latest contents of the result</tt><br>
<br>
<pre style="margin: 0em;">so why not</pre><br>
<pre style="margin: 0em;">param_vector, self.func, iter, fc, gc, hc, self.warning = results</pre><br>
<pre style="margin: 0em;">....</pre><br>
<tt># Disassemble the parameter vector.<br>
self.disassemble_param_vector(param_vector, index=index, 
sim_index=sim_index)</tt><br>
<br>
<pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;">regards
gary</pre><br>
<pre style="margin: 0em;">--
-------------------------------------------------------------------
Dr Gary Thompson
Astbury Centre for Structural Molecular Biology,
University of Leeds, Astbury Building,
Leeds, LS2 9JT, West-Yorkshire, UK Tel. +44-113-3433024
email: garyt@xxxxxxxxxxxxxxx Fax +44-113-2331407
-------------------------------------------------------------------</pre><br>
<pre style="margin: 0em;"><br></pre><br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00130" href="msg00130.html">Re: how to parallelise model_free minimise</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00129" href="msg00129.html">Re: how to parallelise model_free minimise</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00092" href="msg00092.html">relax and Grid computing.</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00093" href="msg00093.html">Re: relax and Grid computing.</a></strong>
<ul><li><em>From:</em> Gary S. Thompson</li></ul></li>
<li><strong><a name="00097" href="msg00097.html">relax, MPI, and Grid computing.</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00107" href="msg00107.html">Re: relax, MPI, and Grid computing.</a></strong>
<ul><li><em>From:</em> Gary S. Thompson</li></ul></li>
<li><strong><a name="00110" href="msg00110.html">Re: relax, MPI, and Grid computing.</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00112" href="msg00112.html">Re: relax, MPI, and Grid computing.</a></strong>
<ul><li><em>From:</em> Gary S. Thompson</li></ul></li>
<li><strong><a name="00114" href="msg00114.html">Re: relax, MPI, and Grid computing.</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00124" href="msg00124.html">how to parallelise model_free minimise</a></strong>
<ul><li><em>From:</em> Gary S. Thompson</li></ul></li>
<li><strong><a name="00126" href="msg00126.html">Re: how to parallelise model_free minimise</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Mon Mar 26 19:40:56 2007</div>  
</body>
</html>
