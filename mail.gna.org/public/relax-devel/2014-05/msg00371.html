<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: r23220 &#45; /branches/disp_speed/lib/dispersion/b14.py -->
<!--X-From-R13: "Sqjneq q'Ohiretar" &#60;rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Mon, 19 May 2014 14:10:40 +0200 -->
<!--X-Message-Id: CAED9pY8Cz7DCPj3w3rEbcmS00zH0DCo3e+kZNimpwmAGxQO0xg@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: E1Wm9vM&#45;0003Wj&#45;HM@subversion.gna.org -->
<!--X-Reference: CAED9pY8vraA9XL+85YuEoDGcvJtvEC32r=uBzAry_Pg9kpFRAQ@mail.gmail.com -->
<!--X-Reference: CA+CBx2O&#45;_162TSHiNW4a&#45;t24ybaPTjTrjdBb2Jx_t80dnu32rw@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: r23220 - /branches/disp_speed/lib/dispersion/b14.py -- May 19, 2014 - 14:10</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: r23220 - /branches/disp_speed/lib/dispersion/b14.py</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00371" class="tabs">Index by Date</a> | <a href="threads.html#00371" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00370.html">Date Prev</a>] [<a href="msg00372.html">Date Next</a>] [<a href="msg00363.html">Thread Prev</a>] [<a href="msg00372.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Mon, 19 May 2014 14:09:49 +0200</li>
<li class="menuitem">
<em>Cc</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:date:message-id:subject :from:to:cc:content-type:content-transfer-encoding; bh=q2TrIyHLGSgm92YnyXbrF2P+NAwz2odU/LfYzt7a5uM=; b=dGfd7hRSqIQCqt0H8uUYx2NHQ6m/xRAhA86OCaCyfmpR3ZaW+eyutZPVyCGvRrXCo6 z46R0ve6pkLhDUKBnNf4BsKU12YSkxXPd3D+5L2lMIWYmuJDW0SmRGRjDZ9sC7ujl7/3 MsnsoHev8zRXFEb0vDiH9PzSn9jSbuy55juuqJ12jpbbRmOqQK1Tk8Rwe/GY2nkbACql PkPx0fMWfY1equXQtCILJplFTj7UEZrgwSfl6W8SdE4C8Bxi8w/6yz4iBiLwKL0J9bAh oFbYN3MUmEHO5uu69oUtNoRZr+VbvkrnqM7btQIcECNA2tcTL2VGy/1cQY9F89WwzN9k e6KA==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00371.html">CAED9pY8Cz7DCPj3w3rEbcmS00zH0DCo3e+kZNimpwmAGxQO0xg@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;E1Wm9vM-0003Wj-HM@subversion.gna.org&gt; &lt;CAED9pY8vraA9XL+85YuEoDGcvJtvEC32r=uBzAry_Pg9kpFRAQ@mail.gmail.com&gt; &lt;<a href="msg00363.html">CA+CBx2O-_162TSHiNW4a-t24ybaPTjTrjdBb2Jx_t80dnu32rw@mail.gmail.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on May 19, 2014 - 14:10:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">:)  Well, actually there is often only one failure point and I have
identified those in most lib.dispersion.* modules for you already ;)
I have spent a lot of time running these models, not only in the
system tests but also in the test_suite/shared_data/dispersion/
directories, finding exactly what these failure points are!  Therefore
just look at the lib.dispersion.* modules in the relax trunk, and you
will see the exact tests needed.  I spend a lot of time and effort
identifying and creating these.  This hard work has been deleted in
your disp_speed branch, but you can reintroduce it in a fast way.
Most will be of the form &quot;if x[i] == 0.0&quot; which, for your branch, can
be converted to &quot;if numpy.min(numpy.abs(x)) == 0.0&quot;, replacing the &quot;if
not numpy.isfinite()&quot; checks you have introduced.

The isfinite() checks are too late in the calculation, hence you see a
numpy warning.  The &quot;== 0.0&quot; check catches the problem before the
numpy calculation which generates the values of infinity, so
reintroducing these will solve the numpy problems that often confuse
users.  I have already done the hard part for you :)

Regards,

Edward



On 19 May 2014 13:15, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Ed.

The problem is, that 2-4 lines of code in a lib file can trigger a
math domain error.

To figure out what each function is &quot;sad&quot; about, one would need a
little inspection per lib file, and
the code would get full of checkings and handlings. That slows it down...

It should be, that in 95 percent of the time, the minimise function is
just happy and calculating.
Only at boundaries values, the math domain errors can get triggered.

Rather that 5% of the time, it calculates to much, that 95% is full of 
checking.

Best
Troels




2014-05-19 10:18 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Troels,

There is actually a better way that is just as fast.  That is to catch
the value prior to the divide by zero, or what ever operation creates
the Inf values.  Then you can fill back_calc with 1e100 and return.
That way the test will pass when running with --numpy-raise, and the
user will not see all the numpy warning messages.  Having the check
earlier might even be a tiny bit faster.

Regards,

Edward




On 19 May 2014 00:51,  &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Author: tlinnet
Date: Mon May 19 00:51:20 2014
New Revision: 23220

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=23220&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=23220&amp;view=rev</a>
Log:
Huge speed-up of model B14.

task #7793: (<a  rel="nofollow" href="https://web.archive.org/web/https://gna.org/task/?7793">https://gna.org/task/?7793</a>) Speed-up of dispersion models.

Time test for systemtests:

test_baldwin_synthetic
2.626s -&gt; 1.990s

test_baldwin_synthetic_full
18.326s -&gt; 13.742s

This is won by not checking single values in the R2eff array for math 
domain
errors, but calculating all steps, and in one single round check for 
finite values.
If just one non-finite value is found, the whole array is returned with a 
large
penalty of 1e100.

This makes all calculations be the fastest numpy array way.

Modified:
    branches/disp_speed/lib/dispersion/b14.py

Modified: branches/disp_speed/lib/dispersion/b14.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/disp_speed/lib/dispersion/b14.py?rev=23220&amp;r1=23219&amp;r2=23220&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/disp_speed/lib/dispersion/b14.py?rev=23220&amp;r1=23219&amp;r2=23220&amp;view=diff</a>
==============================================================================
--- branches/disp_speed/lib/dispersion/b14.py   (original)
+++ branches/disp_speed/lib/dispersion/b14.py   Mon May 19 00:51:20 2014
@@ -110,8 +110,7 @@
 &quot;&quot;&quot;

 # Python module imports.
-import numpy
-from numpy import arccosh, array, cos, cosh, in1d, log, nonzero, sin, 
sinh, sqrt, power
+from numpy import arccosh, array, cos, cosh, isfinite, log, power, sin, 
sinh, sqrt, sum

 # Repetitive calculations (to speed up calculations).
 g_fact = 1/sqrt(2)
@@ -216,70 +215,31 @@
     # Real. The v_1c in paper.
     v1c = F0 * cosh(E0) - F2 * cos(E2)

-    # Catch devision with zero in y, when v3 = 0. v3 is 0, when v1c = 1.
-    # If no 1.0, perform normally.
-    if not in1d(1.0, v1c):
-        # Exact result for v2v3.
-        v3 = sqrt(v1c**2 - 1.)
-
-        y = power( (v1c - v3) / (v1c + v3), ncyc)
-
-        Tog = 0.5 * (1. + y) + (1. - y) * v5 / (2. * v3 * N )
-
-        # Find where Tog has negative values.
-        neg_index = nonzero(Tog.real &lt; 0.0)[0]
-
-        # Do normal calculation
-        if len(neg_index) == 0:
-            ## -1/Trel * log(LpreDyn).
-            # Rpre = (r20a + r20b + kex) / 2.0
-
-            ## Carver and Richards (1972)
-            # R2eff_CR72 = Rpre - inv_tcpmg * ncyc *  arccosh(v1c.real)
-
-            ## Baldwin final.
-            # Estimate R2eff. relax_time = Trel = 1/inv_tcpmg.
-            # R2eff = R2eff_CR72 - inv_tcpmg * log(Tog.real)
-
-            # Fastest calculation.
-            R2eff = (r20a + r20b + kex) / 2.0  - inv_tcpmg * ( ncyc *  
arccosh(v1c.real) + log(Tog.real) )
-
-            # Loop over the time points, back calculating the R2eff 
values.
-            for i in range(num_points):
-
-                # Put values back.
-                back_calc[i] = R2eff[i]
-
-        else:
-            # Loop over each point.
-            for i in range(num_points):
-
-                # Return large value
-                if i in neg_index:
-                    back_calc[i] = 1e100
-
-                else:
-                    v3 = sqrt(v1c[i]**2 - 1.)
-                    y = power( (v1c[i] - v3) / (v1c[i] + v3), ncyc[i])
-                    Tog = 0.5 * (1. + y) + (1. - y) * v5[i] / (2. * v3 * 
N )
-                    R2eff = (r20a + r20b + kex) / 2.0  - inv_tcpmg * ( 
ncyc[i] *  arccosh(v1c[i].real) + log(Tog.real) )
-                    back_calc[i] = R2eff
-
-    # This section is for catching math domain errors.
-    else:
-        # Find index where
-        one_indexes = nonzero(v1c == 1.0)[0]
-
-        # Loop over each point.
-        for i in range(num_points):
-
-            # Return large value
-            if i in one_indexes:
-                back_calc[i] = 1e100
-
-            else:
-                v3 = sqrt(v1c[i]**2 - 1.)
-                y = power( (v1c[i] - v3) / (v1c[i] + v3), ncyc[i])
-                Tog = 0.5 * (1. + y) + (1. - y) * v5[i] / (2. * v3 * N )
-                R2eff = (r20a + r20b + kex) / 2.0  - inv_tcpmg * ( 
ncyc[i] *  arccosh(v1c[i].real) + log(Tog.real) )
-                back_calc[i] = R2eff
+    # Exact result for v2v3.
+    v3 = sqrt(v1c**2 - 1.)
+
+    y = power( (v1c - v3) / (v1c + v3), ncyc)
+
+    Tog = 0.5 * (1. + y) + (1. - y) * v5 / (2. * v3 * N )
+
+    ## -1/Trel * log(LpreDyn).
+    # Rpre = (r20a + r20b + kex) / 2.0
+
+    ## Carver and Richards (1972)
+    # R2eff_CR72 = Rpre - inv_tcpmg * ncyc *  arccosh(v1c.real)
+
+    ## Baldwin final.
+    # Estimate R2eff. relax_time = Trel = 1/inv_tcpmg.
+    # R2eff = R2eff_CR72 - inv_tcpmg * log(Tog.real)
+
+    # Fastest calculation.
+    R2eff = (r20a + r20b + kex) / 2.0  - inv_tcpmg * ( ncyc *  
arccosh(v1c.real) + log(Tog.real) )
+
+    # Catch errors, taking a sum over array is the fastest way to check 
for
+    # +/- inf (infinity) and nan (not a number).
+    if not isfinite(sum(R2eff)):
+        R2eff = array([1e100]*num_points)
+
+    # Parse back the value to update the back_calc class object.
+    for i in range(num_points):
+        back_calc[i] = R2eff[i]


_______________________________________________
relax (<a  rel="nofollow" href="/">http://www.nmr-relax.com</a>)

This is the relax-commits mailing list
relax-commits@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="/mail.gna.org/listinfo/relax-commits">https://mail.gna.org/listinfo/relax-commits</a>
</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
relax (<a  rel="nofollow" href="/">http://www.nmr-relax.com</a>)

This is the relax-devel mailing list
relax-devel@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="/mail.gna.org/listinfo/relax-devel">https://mail.gna.org/listinfo/relax-devel</a>
</pre></blockquote></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00372" href="msg00372.html">Re: r23220 - /branches/disp_speed/lib/dispersion/b14.py</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00348" href="msg00348.html">Re: r23220 - /branches/disp_speed/lib/dispersion/b14.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00363" href="msg00363.html">Re: r23220 - /branches/disp_speed/lib/dispersion/b14.py</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Mon May 19 14:20:16 2014</div>  
</body>
</html>
