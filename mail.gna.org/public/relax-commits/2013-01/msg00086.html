<!-- MHonArc v2.6.16 -->
<!--X-Subject: r18259 &#45; in /branches/frame_order_testing: ./ data/ generic_fns/	specific_fns/ test_suite/system_tests/ -->
<!--X-From-R13: rqjneqNaze&#45;erynk.pbz -->
<!--X-Date: Tue, 22 Jan 2013 11:28:44 +0100 -->
<!--X-Message-Id: E1Txb5w&#45;0002Q4&#45;Gm@subversion.gna.org -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>r18259 - in /branches/frame_order_testing: ./ data/ generic_fns/	specific_fns/ test_suite/system_tests/ -- January 22, 2013 - 11:28</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />r18259 - in /branches/frame_order_testing: ./ data/ generic_fns/	specific_fns/ test_suite/system_tests/</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00086" class="tabs">Index by Date</a> | <a href="threads.html#00086" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00085.html">Date Prev</a>] [<a href="msg00087.html">Date Next</a>] [<a href="msg00085.html">Thread Prev</a>] [<a href="msg00087.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: relax-commits@xxxxxxx</li>
<li class="menuitem">
<em>Date</em>: Tue, 22 Jan 2013 10:28:44 -0000</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00086.html">E1Txb5w-0002Q4-Gm@subversion.gna.org</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>edward</strong> on January 22, 2013 - 11:28:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Author: bugman
Date: Tue Jan 22 11:28:44 2013
New Revision: 18259

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=18259&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=18259&amp;view=rev</a>
Log:
Merged revisions 18249-18258 via svnmerge from 
svn+ssh://bugman@xxxxxxxxxxx/svn/relax/trunk

........
  r18249 | bugman | 2013-01-21 21:30:10 +0100 (Mon, 21 Jan 2013) | 5 lines
  
  Modified the N_state_model.test_mc_sim_failure to demonstrate a failure in 
paramagnetic centre code.
  
  The failure is for the combination of paramagnetic centre optimisation and 
Monte Carlo simulations.
........
  r18250 | bugman | 2013-01-21 21:33:40 +0100 (Mon, 21 Jan 2013) | 5 lines
  
  Fix for the N-state model _minimise_setup_atomic_pos() method for the 
paramagnetic centre.
  
  The cdp.paramagnetic_centre_sim may not exist prior to Monte Carlo 
simulations.
........
  r18251 | bugman | 2013-01-21 21:36:42 +0100 (Mon, 21 Jan 2013) | 3 lines
  
  Modified the paramag.centre user function printouts for the 'fix' flag.
........
  r18252 | bugman | 2013-01-21 21:37:08 +0100 (Mon, 21 Jan 2013) | 3 lines
  
  Fix for the recent changes to the N_state_model.test_mc_sim_failure system 
test.
........
  r18253 | bugman | 2013-01-21 21:41:29 +0100 (Mon, 21 Jan 2013) | 6 lines
  
  The alignment tensor objects in the relax data store now support sequential 
Monte Carlo analyses.
  
  The AlignTensorData.set_sim_num() method was preventing a second Monte 
Carlo error analysis from
  being performed by throwing a RelaxError.  The check for previous 
simulations has been killed.
........
  r18254 | bugman | 2013-01-21 22:37:54 +0100 (Mon, 21 Jan 2013) | 5 lines
  
  Fix for the Monte Carlo initialisation of the paramagnetic centre position 
in the N-state model.
  
  The simulation positions are now initialised to the optimised position.
........
  r18255 | bugman | 2013-01-21 23:37:09 +0100 (Mon, 21 Jan 2013) | 3 lines
  
  Fix for the N-state model Monte Carlo simulations for when the paramagnetic 
centre is fixed.
........
  r18256 | bugman | 2013-01-22 09:56:39 +0100 (Tue, 22 Jan 2013) | 6 lines
  
  Added checks to the N-state model for the paramagnetic centre optimisation.
  
  Only simplex optimisation without constraints is allowed for the 
paramagnetic centre position as the
  PCS gradients and Hessians are not yet implemented for the coordinate 
parameters.
........
  r18257 | bugman | 2013-01-22 10:32:14 +0100 (Tue, 22 Jan 2013) | 6 lines
  
  Improved the RDC and PCS Q factor calculation warnings to be more 
informative.
  
  These warnings sometimes appear at the end of the N-state model 
optimisation, but it is not clear
  where they come from.
........
  r18258 | bugman | 2013-01-22 11:11:01 +0100 (Tue, 22 Jan 2013) | 5 lines
  
  Fix for a recently introduced breakage of the 
N_state_model.test_mc_sim_failure system test.
  
  Newton optimisation is now not allowed for optimising the paramagnetic 
centre position.
........

Modified:
    branches/frame_order_testing/   (props changed)
    branches/frame_order_testing/data/align_tensor.py
    branches/frame_order_testing/generic_fns/paramag.py
    branches/frame_order_testing/generic_fns/pcs.py
    branches/frame_order_testing/generic_fns/rdc.py
    branches/frame_order_testing/specific_fns/n_state_model.py
    branches/frame_order_testing/test_suite/system_tests/n_state_model.py

Propchange: branches/frame_order_testing/
------------------------------------------------------------------------------
--- svnmerge-integrated (original)
+++ svnmerge-integrated Tue Jan 22 11:28:44 2013
@@ -1,1 +1,1 @@
-/trunk:1-18247
+/trunk:1-18258

Modified: branches/frame_order_testing/data/align_tensor.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/frame_order_testing/data/align_tensor.py?rev=18259&amp;r1=18258&amp;r2=18259&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/frame_order_testing/data/align_tensor.py?rev=18259&amp;r1=18258&amp;r2=18259&amp;view=diff</a>
==============================================================================
--- branches/frame_order_testing/data/align_tensor.py (original)
+++ branches/frame_order_testing/data/align_tensor.py Tue Jan 22 11:28:44 2013
@@ -1328,10 +1328,6 @@
         @type sim_number:       int
         &quot;&quot;&quot;
 
-        # Check if not already set.
-        if self._sim_num != None:
-            raise RelaxError(&quot;The number of simulations has already been 
set.&quot;)
-
         # Store the value.
         self.__dict__['_sim_num'] = sim_number
 

Modified: branches/frame_order_testing/generic_fns/paramag.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/frame_order_testing/generic_fns/paramag.py?rev=18259&amp;r1=18258&amp;r2=18259&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/frame_order_testing/generic_fns/paramag.py?rev=18259&amp;r1=18258&amp;r2=18259&amp;view=diff</a>
==============================================================================
--- branches/frame_order_testing/generic_fns/paramag.py (original)
+++ branches/frame_order_testing/generic_fns/paramag.py Tue Jan 22 11:28:44 
2013
@@ -70,9 +70,9 @@
 
     # The fixed flag.
     if fix:
-        print(&quot;The paramagnetic centre will be fixed during optimisation.&quot;)
+        print(&quot;The paramagnetic centre position will be fixed during 
optimisation.&quot;)
     else:
-        print(&quot;The paramagnetic centre will be optimised.&quot;)
+        print(&quot;The paramagnetic centre position will be optimised.&quot;)
     cdp.paramag_centre_fixed = fix
 
     # Position is supplied.

Modified: branches/frame_order_testing/generic_fns/pcs.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/frame_order_testing/generic_fns/pcs.py?rev=18259&amp;r1=18258&amp;r2=18259&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/frame_order_testing/generic_fns/pcs.py?rev=18259&amp;r1=18258&amp;r2=18259&amp;view=diff</a>
==============================================================================
--- branches/frame_order_testing/generic_fns/pcs.py (original)
+++ branches/frame_order_testing/generic_fns/pcs.py Tue Jan 22 11:28:44 2013
@@ -522,13 +522,13 @@
 
         # Warnings (and then exit).
         if not spin_count:
-            warn(RelaxWarning(&quot;No spins have been used in the calculation.&quot;))
+            warn(RelaxWarning(&quot;No spins have been used in the calculation, 
skipping the PCS Q factor calculation.&quot;))
             return
         if not pcs_data:
-            warn(RelaxWarning(&quot;No PCS data can be found for the alignment ID 
'%s'.&quot; % align_id))
+            warn(RelaxWarning(&quot;No PCS data can be found for the alignment ID 
'%s', skipping the PCS Q factor calculation for this alignment.&quot; % align_id))
             continue
         if not pcs_bc_data:
-            warn(RelaxWarning(&quot;No back-calculated PCS data can be found for 
the alignment ID '%s'.&quot; % align_id))
+            warn(RelaxWarning(&quot;No back-calculated PCS data can be found for 
the alignment ID '%s', skipping the PCS Q factor calculation for this 
alignment.&quot; % align_id))
             continue
 
     # The total Q-factor.

Modified: branches/frame_order_testing/generic_fns/rdc.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/frame_order_testing/generic_fns/rdc.py?rev=18259&amp;r1=18258&amp;r2=18259&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/frame_order_testing/generic_fns/rdc.py?rev=18259&amp;r1=18258&amp;r2=18259&amp;view=diff</a>
==============================================================================
--- branches/frame_order_testing/generic_fns/rdc.py (original)
+++ branches/frame_order_testing/generic_fns/rdc.py Tue Jan 22 11:28:44 2013
@@ -465,13 +465,13 @@
 
         # Warnings (and then exit).
         if not interatom_count:
-            warn(RelaxWarning(&quot;No interatomic data containers have been used 
in the calculation.&quot;))
+            warn(RelaxWarning(&quot;No interatomic data containers have been used 
in the calculation, skipping the RDC Q factor calculation.&quot;))
             return
         if not rdc_data:
-            warn(RelaxWarning(&quot;No RDC data can be found for the alignment ID 
'%s'.&quot; % align_id))
+            warn(RelaxWarning(&quot;No RDC data can be found for the alignment ID 
'%s', skipping the RDC Q factor calculation for this alignment.&quot; % align_id))
             continue
         if not rdc_bc_data:
-            warn(RelaxWarning(&quot;No back-calculated RDC data can be found for 
the alignment ID '%s'.&quot; % align_id))
+            warn(RelaxWarning(&quot;No back-calculated RDC data can be found for 
the alignment ID '%s', skipping the RDC Q factor calculation for this 
alignment.&quot; % align_id))
             continue
 
         # Normalisation factor of 2Da^2(4 + 3R)/5.

Modified: branches/frame_order_testing/specific_fns/n_state_model.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/frame_order_testing/specific_fns/n_state_model.py?rev=18259&amp;r1=18258&amp;r2=18259&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/frame_order_testing/specific_fns/n_state_model.py?rev=18259&amp;r1=18258&amp;r2=18259&amp;view=diff</a>
==============================================================================
--- branches/frame_order_testing/specific_fns/n_state_model.py (original)
+++ branches/frame_order_testing/specific_fns/n_state_model.py Tue Jan 22 
11:28:44 2013
@@ -898,8 +898,8 @@
         # The paramagnetic centre.
         if not hasattr(cdp, 'paramagnetic_centre'):
             paramag_centre = zeros(3, float64)
-        elif sim_index != None:
-            if cdp.paramagnetic_centre_sim[sim_index] == None:
+        elif sim_index != None and not cdp.paramag_centre_fixed:
+            if not hasattr(cdp, 'paramagnetic_centre_sim') or 
cdp.paramagnetic_centre_sim[sim_index] == None:
                 paramag_centre = zeros(3, float64)
             else:
                 paramag_centre = 
array(cdp.paramagnetic_centre_sim[sim_index])
@@ -2083,6 +2083,13 @@
             min_options = (min_algor,) + min_options
             min_algor = 'Method of Multipliers'
 
+        # Only allow simplex optimisation for the paramagnetic centre 
position optimisation (the PCS gradients and Hessians are not yet 
implemented).
+        if hasattr(cdp, 'paramag_centre_fixed') and not 
cdp.paramag_centre_fixed:
+            if min_algor != 'simplex':
+                raise RelaxError(&quot;For the paramagnetic centre position, only 
simplex optimisation is allowed as the PCS gradients and Hessians are not yet 
implemented.&quot;)
+            if constraints:
+                raise RelaxError(&quot;For the paramagnetic centre position, 
constrains are not allowed as the PCS gradients and Hessians are not yet 
implemented.&quot;)
+
         # Linear constraints.
         if constraints:
             A, b = self._linear_constraints(data_types=data_types, 
scaling_matrix=scaling_matrix)
@@ -2507,6 +2514,11 @@
                     # Append None to fill the structure.
                     sim_object.append(None)
 
+            # Set the simulation paramagnetic centre positions to the 
optimised values.
+            if hasattr(cdp, 'paramag_centre_fixed') and not 
cdp.paramag_centre_fixed:
+                for j in range(cdp.sim_number):
+                    cdp.paramagnetic_centre_sim[j] = 
deepcopy(cdp.paramagnetic_centre)
+
 
     def sim_pack_data(self, data_id, sim_data):
         &quot;&quot;&quot;Pack the Monte Carlo simulation data.

Modified: 
branches/frame_order_testing/test_suite/system_tests/n_state_model.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/frame_order_testing/test_suite/system_tests/n_state_model.py?rev=18259&amp;r1=18258&amp;r2=18259&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/frame_order_testing/test_suite/system_tests/n_state_model.py?rev=18259&amp;r1=18258&amp;r2=18259&amp;view=diff</a>
==============================================================================
--- branches/frame_order_testing/test_suite/system_tests/n_state_model.py 
(original)
+++ branches/frame_order_testing/test_suite/system_tests/n_state_model.py Tue 
Jan 22 11:28:44 2013
@@ -521,6 +521,14 @@
         self.interpreter.minimise('newton', constraints=False)
         self.interpreter.monte_carlo.error_analysis()
 
+        # Activate the optimisation of the paramagnetic centre position and 
try again.
+        self.interpreter.paramag.centre(fix=False)
+        self.interpreter.monte_carlo.setup(number=3)
+        self.interpreter.monte_carlo.create_data()
+        self.interpreter.monte_carlo.initial_values()
+        self.interpreter.minimise('simplex', constraints=False, max_iter=100)
+        self.interpreter.monte_carlo.error_analysis()
+
 
     def test_metal_pos_opt(self):
         &quot;&quot;&quot;Test a certain algorithm for the optimisation of the lanthanide 
position using RDCs and PCSs (with missing data).&quot;&quot;&quot;



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Tue Jan 22 20:20:05 2013</div>  
</body>
</html>
