<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: Tutorial for adding relaxation dispersion models to relax. -->
<!--X-From-R13: "Sqjneq q'Ohiretar" <rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Fri, 11 Oct 2013 18:18:40 +0200 -->
<!--X-Message-Id: CAED9pY_3U=QsttZGvFpwMDkTMDVUZPvCXHCXTH5dgt3pLAg0_w@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: CAED9pY&#45;E2Q1gDUJ+iYf50_9Lx9TfeqB4UUyU2b26oEfOVFALOw@mail.gmail.com -->
<!--X-Reference: CAED9pY_oGzRkHenFG6upSqRw0QK5L06SzPC7KZXoWt6A_CqZMw@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: Tutorial for adding relaxation dispersion models to relax. -- October 11, 2013 - 18:18</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: Tutorial for adding relaxation dispersion models to relax.</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00033" class="tabs">Index by Date</a> | <a href="threads.html#00033" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00032.html">Date Prev</a>] [<a href="msg00034.html">Date Next</a>] [<a href="msg00031.html">Thread Prev</a>] [<a href="msg00034.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Fri, 11 Oct 2013 18:18:07 +0200</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113;	h=mime-version:sender:in-reply-to:references:date:message-id:subject	:from:to:content-type;	bh=mb9Q9KZ+MD4L2MQlv84CqN+VeBXTs4KRoORWTFh1gC8=;	b=Z9m007Jv8eq473czk5W6OP9vg5bFgOFoTJTe1S3YXnSnCRaDls0CEFATGv5+75bIzx	Kq9WSBIjjGwvcitoiaIZUrUu3SboEoxtHPV6ZCvg5wVmDBg34JpE8yj6WCAT5TnHN4hL	BN275he5U4ALpja4dxiMYrRR6oKbxI5ZKZofFEXU/CePWxICgnfyY5iprclglAXbvWNj	NCVwNDep7QyebsF2zs7x05DmMMMWgdZWgwGGHtoNf8d2UpFJ1HO8qReKiL6nzfO1k/Cv	YmL/OuztZyZZFKUjQw5/k3wXzqcjUQrojHT8ZhJAg9ZfjIgvmrc+f4eUTIi3lYorXWQs	/ysg==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00033.html">CAED9pY_3U=QsttZGvFpwMDkTMDVUZPvCXHCXTH5dgt3pLAg0_w@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;CAED9pY-E2Q1gDUJ+iYf50_9Lx9TfeqB4UUyU2b26oEfOVFALOw@xxxxxxxxxxxxxx&gt;	&lt;CAED9pY_oGzRkHenFG6upSqRw0QK5L06SzPC7KZXoWt6A_CqZMw@xxxxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on October 11, 2013 - 18:18:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">If you have found this tutorial for adding relaxation dispersion
models in one of the relax mailing list archives, please note that up
to date instructions are now located on the relax wiki at
<a  rel="nofollow" href="http://wiki.nmr-relax.com/Tutorial_for_adding_relaxation_dispersion_models_to_relax">http://wiki.nmr-relax.com/Tutorial_for_adding_relaxation_dispersion_models_to_relax</a>.

Regards,

Edward


On 7 June 2013 16:49, Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">For future reference, this post is archived in the following locations:

<a  rel="nofollow" href="http://thread.gmane.org/gmane.science.nmr.relax.devel/3907">http://thread.gmane.org/gmane.science.nmr.relax.devel/3907</a>
<a  rel="nofollow" href="http://www.mail-archive.com/relax-devel%40gna.org/msg03825.html">http://www.mail-archive.com/relax-devel%40gna.org/msg03825.html</a>
<a  rel="nofollow" href="http://marc.info/?l=relax-devel&amp;m=137059460702378&amp;w=2">http://marc.info/?l=relax-devel&amp;m=137059460702378&amp;w=2</a>
<a  rel="nofollow" href="/mail.gna.org/public/relax-devel/2013-06/msg00016.html">https://mail.gna.org/public/relax-devel/2013-06/msg00016.html</a>

Regards,

Edward




On 7 June 2013 10:42, Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">The following is a tutorial for adding new relaxation dispersion
models for either CPMG-type or R1rho-type experiments to relax.  This
includes both the models based on the analytical, closed-form
expressions as well as the models involving numerical integration of
the Bloch-McConnell equations.

The tutorial will follow the example of the addition of the 'M61'
model already present within relax, pointing to the relevant commits
for reference.  To see the commit message and the code changes in
colour, click on the links found within these commit messages.  This
specific case is the Meiboom 1961 analytic model for 2-site fast
exchange equation for R1rho-type experiments.


1)  Adding the model to the list.

Reference commit:  
<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.scm/17611">http://article.gmane.org/gmane.science.nmr.relax.scm/17611</a>

Firstly the model should be added to the lists of the
specific_analyses.relax_disp.variables module.  The model name is
stored in a special variable which will be used throughout relax.


2)  The relax_disp.select_model user function front end.

Reference commit:  
<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.scm/17612">http://article.gmane.org/gmane.science.nmr.relax.scm/17612</a>

The next step is to add the model, its description, the equations for
the analytic models, and all references to the relax_disp.select_model
user function front end.  When the relaxation dispersion chapter of
the relax manual is created (this will be the
docs/latex/relax_disp.tex file), then the same description should be
added there as well.


3)  The relax library.

Reference commit:  
<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.scm/17615">http://article.gmane.org/gmane.science.nmr.relax.scm/17615</a>

Now the dispersion function needs to be added to the relax library (in
the lib.relax_disp package).  This should be designed as a simple
Python function which takes the dispersion parameters and experimental
variables, and calculates the R2eff/R1rho values.  The module can
contain auxiliary functions for the calculation.  Some auxiliary
functions, if not specific to relaxation dispersion, may be better
placed in other locations within the relax library.

The relaxation dispersion functions in the library currently take as
an argument a data structure for the back-calculated R2eff/R1rho
values and populate this structure.  This design is not essential if
the target function, described in the next point, handles the library
function appropriately.  Just look at the files in lib/dispersion to
get an idea of the design used.

The dispersion code in the relax library must be robust.  This
involves identifying parameter values or combinations which would
cause failures in the mathematical operations (numerical issues not
present in the mathematics must be considered).  Note that parameter
values of 0 are common within a grid search.  It should be decided if
the R2eff/R1rho value should be set to zero, to another value, or to
something large (e.g. 1e100).  For example:

Divisions - always catch zeros in the denominator with if statements,
even if you believe that this will never be encountered.
Square roots - make sure that the value inside is always &gt; 0.
Trigonometric functions - these should be tested for where they are
not defined or where the software implementation can no longer handle
certain values.  For example try cosh(1000) in Python.

In the reference example, the M61 model code was copied from the LM63
module and modified appropriately.


4)  The target function.

Reference commits:

<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.scm/17616">http://article.gmane.org/gmane.science.nmr.relax.scm/17616</a>
<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.scm/17660">http://article.gmane.org/gmane.science.nmr.relax.scm/17660</a>
<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.scm/17661">http://article.gmane.org/gmane.science.nmr.relax.scm/17661</a>

The target function is used in optimisation and is a class method
which takes as a single argument the parameter vector.  This list is
changed by the minimisation algorithm during optimisation.  The target
function should then return a single floating point number - the
chi-squared value.

Again in this example, the code for the M61 is copied from the LM63
model and then modified.


5)  Adding support for the parameters.

Reference commit:  
<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.scm/17573">http://article.gmane.org/gmane.science.nmr.relax.scm/17573</a>

This is needed to enable the model.  This example is for the CR72
model implementation as the parameters required for the M61 model
match those of the preexisting LM63 model.


6)  The relax_disp.select_model back end.

Reference commit:  
<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.scm/17622">http://article.gmane.org/gmane.science.nmr.relax.scm/17622</a>

Now the back end of the relax_disp.select_model user function for the
model can be added.  This involved identifying the model and
constructing the parameter list.


7)  The test suite.

Reference commits:

<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.scm/17647">http://article.gmane.org/gmane.science.nmr.relax.scm/17647</a>
<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.scm/17648">http://article.gmane.org/gmane.science.nmr.relax.scm/17648</a>
<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.scm/17649">http://article.gmane.org/gmane.science.nmr.relax.scm/17649</a>
<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.scm/17662">http://article.gmane.org/gmane.science.nmr.relax.scm/17662</a>
<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.scm/17663">http://article.gmane.org/gmane.science.nmr.relax.scm/17663</a>

This step is normally performed as step number 1.  This is the most
important part that makes sure that the code not only works now, but
will continue working for the entire lifetime of the relax project.

The idea is that synthetic data (here for example as Sparky peak
lists) is created for the model and added to the test suite directory
test_suite/shared_data/dispersion/.  This is then used in a system
test to check that the code in relax can reproduce the data.  It is
very important that the code added to the relax library is not used to
create the synthetic data!


8)  Comparing to other software.

It can happen that a bug present in the lib.dispersion package code is
also replicated in the synthetic data.  This is not uncommon.
Therefore it is very useful to use other software with the test data
from step 7 to see if the original parameters can be found.  A good
example can be seen in the test_suite/shared_data/dispersion/Hansen
which contains Dr. Flemming Hansen's CPMG data (see the README file)
and the results from different programs including NESSY, relax,
CPMGFit, and ShereKhan.  The comparison is in the file
'software_comparison'.

Once the relax code is able to find identical or better results than
the dispersion softwares, then the values found in the test suite
optimisation can be locked in.  The assertEqual() and
assertAlmostEqual() methods can be used to only allow the test to pass
when the correct values are found.


9)  Debugging.

This step should not require an explanation.  It goes hand-in-hand
with steps 7) and 8).
</pre></blockquote></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Mon Oct 14 20:40:09 2013</div>  
</body>
</html>
