<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: r23216 &#45; /branches/disp_speed/lib/dispersion/cr72.py -->
<!--X-From-R13: Febryf Szgrxæe Zvaarg &#60;gyvaargNaze&#45;erynk.pbz> -->
<!--X-Date: Mon, 19 May 2014 13:06:13 +0200 -->
<!--X-Message-Id: CA+CBx2NoUmfTwNP2iPEpPJoeSqLfTMXoizFD2Qkm8CVGPD+nQQ@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: E1Wm8kg&#45;0005WI&#45;L8@subversion.gna.org -->
<!--X-Reference: CAED9pY8vtMdD0T58D3=Z_gPLhg4OP8J4oWCenVoDAHFY+g+_QQ@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: r23216 - /branches/disp_speed/lib/dispersion/cr72.py -- May 19, 2014 - 13:06</title>
<link rel="stylesheet" type="text/css" href="/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="https://gna.org/images/gna.theme/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: r23216 - /branches/disp_speed/lib/dispersion/cr72.py</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00362" class="tabs">Index by Date</a> | <a href="threads.html#00362" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00361.html">Date Prev</a>] [<a href="msg00363.html">Date Next</a>] [<a href="msg00346.html">Thread Prev</a>] [<a href="msg00369.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;Edward d'Auvergne&quot; &lt;edward@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Mon, 19 May 2014 13:05:02 +0200</li>
<li class="menuitem">
<em>Cc</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:from:date:message-id :subject:to:cc:content-type:content-transfer-encoding; bh=UGsxFEINrNrDNkA+7RXdoc9fJaSMRbbryQP2TRUcKwE=; b=QOd0mgJvM3B7YIQNqRhMHZFWSEyDRNMio4MnHDIJ55dRejpuUz/hOCZsJyDbWLve5r oopZpWE7aAkFJicoet+wTAAGapPuUXRuespES8wtY7mg7fErHG7NhWj80KHJshgY/NZe 3AwxSGy1l8iB9U3AMOPx8hIFUj543gPBj8f29GoDTRhibN/TxtJPdJPdwXv+66xg2CWV epoSM06kWjY/bq59WwZajLH7PafEhxSzLnpiCT8tNtWnbX4LC+7dWgB1z8r1Szar6TqO 7yGgGUXHHeN4R+4105xohsyrz/Foz6phm0wCfER9SwnpSMhpr9zIRVJEIXlekVaKnZr9 NE5w==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00362.html">CA+CBx2NoUmfTwNP2iPEpPJoeSqLfTMXoizFD2Qkm8CVGPD+nQQ@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;E1Wm8kg-0005WI-L8@subversion.gna.org&gt; &lt;CAED9pY8vtMdD0T58D3=Z_gPLhg4OP8J4oWCenVoDAHFY+g+_QQ@mail.gmail.com&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Troels Emtekær Linnet</strong> on May 19, 2014 - 13:06:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi Ed.

I have been playing with this.

I really like the --numpy-raise option.

But then I need to also turn this off when I know I have handled the 
exception.

I have been looking at:
numpy.seterr
<a  rel="nofollow" href="http://docs.scipy.org/doc/numpy/reference/generated/numpy.seterr.html#numpy-seterr">http://docs.scipy.org/doc/numpy/reference/generated/numpy.seterr.html#numpy-seterr</a>

Putting this is in:
import numpy as np
old_settings = np.seterr()
old_settings2 = np.geterr()

print &quot;old settings&quot;
print old_settings
np.seterr(all='ignore')
print &quot;new settings&quot;
print np.seterr()

print &quot;bla bla bla code with math domain errors, but handled.&quot;

# Go back to original
np.seterr(over=old_settings['over'])
np.seterr(divide=old_settings['divide'])
np.seterr(invalid=old_settings['invalid'])
np.seterr(under=old_settings['under'])

print &quot;back to normal&quot;
print np.seterr()

2014-05-19 10:02 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Troels,

When making such important changes, for debugging you should try
running the test suite as:

$ ./relax -s Relax_disp --numpy-raise
Echoing of user function calls has been enabled.


=============================
= System / functional tests =
=============================

EE.EEEEEEEE...EE.EEEEEEEEEEEEE.EEEEEEEEEEEEEEEEEEE...EEEEEEEEEEE...
======================================================================

This will quickly uncover the places where we need to have checks in
the code.  It will also uncover many places in the trunk does not have
checks, so don't worry about the huge number of errors.  This is the
code from all of the contributors on the paper:

    - Morin, S., Linnet, T. E., Lescanne, M., Schanda, P., Thompson,
G. S., Tollinger, M., Teilum, K., Gagné, S., Marion, D., Griesinger,
C., Blackledge, M., and d'Auvergne, E. J. (2014). relax: the analysis
of biomolecular kinetics and thermodynamics using NMR relaxation
dispersion data. Bioinformatics.
(<a  rel="nofollow" href="http://dx.doi.org/10.1093/bioinformatics/btu166">http://dx.doi.org/10.1093/bioinformatics/btu166</a>).

And as it comes from many groups, the error checking is not consistent
or perfected yet.

Regards,

Edward





On 18 May 2014 23:36,  &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Author: tlinnet
Date: Sun May 18 23:36:14 2014
New Revision: 23216

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=23216&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=23216&amp;view=rev</a>
Log:
Huge speed-up for model CR72.

task #7793: (<a  rel="nofollow" href="https://gna.org/task/?7793">https://gna.org/task/?7793</a>) Speed-up of dispersion models.

Systemtest Relax_disp.test_cpmg_synthetic_cr72_full_noise_cluster
changes from 7 seconds to 4.5 seconds.

This is won by not checking single values in the R2eff array for math 
domain
errors, but calculating all steps, and in one single round check for 
finite values.
If just one non-finite value is found, the whole array is returned with a 
large
penalty of 1e100.

This makes all calculations be the fastest numpy array way.

Modified:
    branches/disp_speed/lib/dispersion/cr72.py

Modified: branches/disp_speed/lib/dispersion/cr72.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/disp_speed/lib/dispersion/cr72.py?rev=23216&amp;r1=23215&amp;r2=23216&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/disp_speed/lib/dispersion/cr72.py?rev=23216&amp;r1=23215&amp;r2=23216&amp;view=diff</a>
==============================================================================
--- branches/disp_speed/lib/dispersion/cr72.py  (original)
+++ branches/disp_speed/lib/dispersion/cr72.py  Sun May 18 23:36:14 2014
@@ -92,8 +92,10 @@
 &quot;&quot;&quot;

 # Python module imports.
-from numpy import arccosh, cos, cosh, sqrt
+from numpy import arccosh, array, cos, cosh, isfinite, sqrt, sum

+# Repetitive calculations (to speed up calculations).
+eta_scale = 2.0**(-3.0/2.0)

 def r2eff_CR72(r20a=None, r20b=None, pA=None, dw=None, kex=None, 
cpmg_frqs=None, back_calc=None, num_points=None):
     &quot;&quot;&quot;Calculate the R2eff values for the CR72 model.
@@ -146,26 +148,17 @@
     Dneg = 0.5 * (-1.0 + D_part)

     # Partial eta+/- values.
-    eta_scale = 2.0**(-3.0/2.0)
-    etapos_part = eta_scale * sqrt(Psi + sqrt_psi2_zeta2)
-    etaneg_part = eta_scale * sqrt(-Psi + sqrt_psi2_zeta2)
+    etapos = eta_scale * sqrt(Psi + sqrt_psi2_zeta2) / cpmg_frqs
+    etaneg = eta_scale * sqrt(-Psi + sqrt_psi2_zeta2) / cpmg_frqs

-    # Loop over the time points, back calculating the R2eff values.
+    # Calculate R2eff.
+    R2eff = r20_kex - cpmg_frqs * arccosh( Dpos * cosh(etapos) - Dneg * 
cos(etaneg) )
+
+    # Catch errors, taking a sum over array is the fastest way to check 
for
+    # +/- inf (infinity) and nan (not a number).
+    if not isfinite(sum(R2eff)):
+        R2eff = array([1e100]*num_points)
+
+    # Parse back the value to update the back_calc class object.
     for i in range(num_points):
-        # The full eta+/- values.
-        etapos = etapos_part / cpmg_frqs[i]
-        etaneg = etaneg_part / cpmg_frqs[i]
-
-        # Catch large values of etapos going into the cosh function.
-        if etapos &gt; 100:
-            back_calc[i] = 1e100
-            continue
-
-        # The arccosh argument - catch invalid values.
-        fact = Dpos * cosh(etapos) - Dneg * cos(etaneg)
-        if fact &lt; 1.0:
-            back_calc[i] = r20_kex
-            continue
-
-        # The full formula.
-        back_calc[i] = r20_kex - cpmg_frqs[i] * arccosh(fact)
+        back_calc[i] = R2eff[i]


_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-commits mailing list
relax-commits@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="https://mail.gna.org/listinfo/relax-commits">https://mail.gna.org/listinfo/relax-commits</a>
</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-devel mailing list
relax-devel@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="https://mail.gna.org/listinfo/relax-devel">https://mail.gna.org/listinfo/relax-devel</a>
</pre></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00369" href="msg00369.html">Re: r23216 - /branches/disp_speed/lib/dispersion/cr72.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00346" href="msg00346.html">Re: r23216 - /branches/disp_speed/lib/dispersion/cr72.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer">You are on the <a href="http://gna.org">Gna!</a> mail server.</div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Mon May 19 14:00:15 2014</div>  
</body>
</html>
