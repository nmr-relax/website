<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: Speed up suggestion for task #7807. -->
<!--X-From-R13: "Sqjneq q'Ohiretar" &#60;rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Tue, 10 Jun 2014 22:05:10 +0200 -->
<!--X-Message-Id: CAED9pY8f31jq7qr2z9Rh50Pjw8pZ8Md=HoZdKY1nSLRbWk=kAw@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: CAED9pY9X1spCUHgEHcy7+pQ+DkX96nG&#45;kuO6UTY2V8Whve9JSw@mail.gmail.com -->
<!--X-Reference: CAED9pY9FbjcKFjsdFEko_z6gFSZHtS==seJZn7T=VQztV9LJWw@mail.gmail.com -->
<!--X-Reference: CA+CBx2O7nzcvKoZqth32WyG=CjZ_7yEhim7G0kp+AscYmEfH6A@mail.gmail.com -->
<!--X-Reference: CAED9pY8NmuDBnCKOyDZGipg=MHw3XC=MbBT_hAYqCPTzDwaSJQ@mail.gmail.com -->
<!--X-Reference: CA+CBx2PYO9+jqmQTdaweQCav&#45;K2aVTMGMgScQT+yHBZqdG1mFA@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: Speed up suggestion for task #7807. -- June 10, 2014 - 22:05</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: Speed up suggestion for task #7807.</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00138" class="tabs">Index by Date</a> | <a href="threads.html#00138" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00137.html">Date Prev</a>] [<a href="msg00139.html">Date Next</a>] [<a href="msg00135.html">Thread Prev</a>] [<a href="msg00119.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Tue, 10 Jun 2014 22:04:37 +0200</li>
<li class="menuitem">
<em>Cc</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:date:message-id:subject :from:to:cc:content-type; bh=eahEhkQjxRDgL4ZuI/1YQQ7hnOwFdE64dv9TwZ98DWM=; b=UC6SS7Qy7gCrLS5ZEHKOCpzjelY/7QetK63jZAQWDc65d9NHcyTCmBGsD6NYfsqoDA OhQO7HLjqhbVcus53/v4OoXhp7tnxXXJSPptc31DQO8ga9co0C0VHe210MJOmOBRxhaZ a9+O4krUBsn5H73QImm6J/kke7eLDP93TrBUEXkxoCNww8js612HkpkbrlpmtilbEamT BEi9sM2yJ2F6z2vBqWDpr/zYOcw1DhrouhBmpiPYY9LNnaO9E3CMJJ+CxWdkISPszuTI MKwGja0x++g4eC/GyPVNvqH5pRQ/IIXFRLV01CvxyxJHs1MaGyd0l5a/+aChoxuxL9AN 5cMA==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;CAED9pY8f31jq7qr2z9Rh50Pjw8pZ8Md=HoZdKY1nSLRbWk=kAw@mail.gmail.com&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;<a href="msg00117.html">CAED9pY9X1spCUHgEHcy7+pQ+DkX96nG-kuO6UTY2V8Whve9JSw@mail.gmail.com</a>&gt; &lt;CAED9pY9FbjcKFjsdFEko_z6gFSZHtS==seJZn7T=VQztV9LJWw@mail.gmail.com&gt; &lt;CA+CBx2O7nzcvKoZqth32WyG=CjZ_7yEhim7G0kp+AscYmEfH6A@mail.gmail.com&gt; &lt;CAED9pY8NmuDBnCKOyDZGipg=MHw3XC=MbBT_hAYqCPTzDwaSJQ@mail.gmail.com&gt; &lt;<a href="msg00135.html">CA+CBx2PYO9+jqmQTdaweQCav-K2aVTMGMgScQT+yHBZqdG1mFA@mail.gmail.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on June 10, 2014 - 22:05:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi,

See below:

</pre><blockquote class="blockquote"><pre style="margin: 0em;">The problem is, that if you make multiply with [300], to a numpy
array, it will expand the last axis.

Reshaping that into a usable form is the problem.

I spent many many many hours, to get to this:
# Reshape dw to per experiment and nr spins. Or for R20A per
experiment, spin and frequency.
[300] -&gt; [1, 300]    :     [300] -&gt; [1, 100, 3]

# Expand axis
[1, 300] -&gt; [1, 300, 1, 1, 1] : [1, 100, 3]-&gt; [1, 100, 3, 1, 1]

# Then tile to dimensions
[1, 300, 1, 1, 1] -&gt; [1, 300, 3, 1, 22]      :     [1, 100, 3, 1, 22]

This is a very logic build up of the shapes.
The add or multiply would multiply to the last axis.

The only thing I could do, was to create newaxis.
And then tile up!

--------- Example code to play with.
import numpy as np
s = [1, 100, 3, 1, 22]
print &quot;dw&quot;
dw = np.asarray(range(100))
print dw.shape
dw1 = dw.reshape( (s[0], s[1]) )
print dw1.shape
dw2 = dw1[:,:,None,None,None]
print dw2.shape
dw3 = np.tile(dw2, (1, 1, s[2], s[3], s[4]))
print dw3.shape

print &quot;r20&quot;
r = np.asarray(range(300))
print r.shape
r1 = r.reshape( (s[0], s[1], s[2]) )
print r1.shape
r2 = r1[:,:,:,None,None]
print r2.shape
r3 = np.tile(r2, (1, 1, 1, s[3], s[4]))
print r3.shape
-------------------


With this, I think I am done!
</pre></blockquote><pre style="margin: 0em;">

With the code example I gave
(<a  rel="nofollow" href="http://thread.gmane.org/gmane.science.nmr.relax.devel/6135/focus=6154">http://thread.gmane.org/gmane.science.nmr.relax.devel/6135/focus=6154</a>),
all of this logic can be replaced.  I hope the example is enough for
both dw and R20 structure creation.  Despite reintroducing a loop -
note that the loop does not involve calls to the lib.dispersion
functions so it does not have anywhere near the same cost as the loops
you eliminated - this solution will speed things up by avoiding
automatic Python data structure creation and deletion.


</pre><blockquote class="blockquote"><pre style="margin: 0em;">I really would like to wrap this up and continue with my own stuff.
So, what needs to be done, before you can accept this?

I will:
Expand to other CPMG models, which are analytical
Include R1rho.
</pre></blockquote><pre style="margin: 0em;">

That should be rather easy now with your infrastructure.  I would
recommend the dw and R20 speed ups first, as that will make the target
functions far simpler and quicker to upgrade to the new design.


</pre><blockquote class="blockquote"><pre style="margin: 0em;">I cannot do for numerical, do to the looping.
</pre></blockquote><pre style="margin: 0em;">

To keep the API clean, the looping needs to be shifted to be inside
the lib.dispersion functions.  That should be easy enough.


</pre><blockquote class="blockquote"><pre style="margin: 0em;">Should I add unit tests for each?
</pre></blockquote><pre style="margin: 0em;">

You probably saw how useful the unit tests were when you were making
the changes to the 'disp_spin_speed' branch.  Feel free to add tests
as you wish.  I don't think we have universal coverage of all models
yet, though I could be wrong with that.

Additional points would be to clean up the code and comments (for
example there are quite a few '##' that should be '#', and a few
trivial whitespace issues).  Then I can check it and give feedback for
anything else that needs to be done.  I can then merge the branch back
to trunk and release it with a new version of relax.

Cheers!

Edward


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00117" href="msg00117.html">Speed up suggestion for task #7807.</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00120" href="msg00120.html">Re: Speed up suggestion for task #7807.</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00132" href="msg00132.html">Re: Speed up suggestion for task #7807.</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00133" href="msg00133.html">Re: Speed up suggestion for task #7807.</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00135" href="msg00135.html">Re: Speed up suggestion for task #7807.</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Tue Jun 10 22:40:11 2014</div>  
</body>
</html>
