<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: CST branch -->
<!--X-From-R13: "Sqjneq q'Ohiretar" <rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Fri, 22 Oct 2010 19:46:33 +0200 -->
<!--X-Message-Id: AANLkTi=vSTA2B&#45;jpTzShJab84W=&#45;z1YBzvhW10wTXg_P@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: p2l6052a51004080823g94a64268lf8af8d3e332c2a03@mail.gmail.com -->
<!--X-Reference: j2i7f080ed11004120000r80bba9bch9556be67b0c1707@mail.gmail.com -->
<!--X-Reference: g2v6052a51004131048sb5c01509sfc9a77045ad33310@mail.gmail.com -->
<!--X-Reference: r2g7f080ed11004131113mb209905eh63ff1eb61c171fee@mail.gmail.com -->
<!--X-Reference: l2q6052a51004301221h9ad09886ha016465129beb516@mail.gmail.com -->
<!--X-Reference: g2m7f080ed11005050153y2ad8b4bfjb4eb8191b0efd0cc@mail.gmail.com -->
<!--X-Reference: AANLkTin4nzkkOCxs94vUKCpT00R7ak22gLaL5rK&#45;VjPN@mail.gmail.com -->
<!--X-Reference: AANLkTinF4yNXoJQS&#45;rd81VBi3keRURUNeb&#45;_GdkxqqsG@mail.gmail.com -->
<!--X-Reference: AANLkTinibyBQvsoG1&#45;0vmzOXFmRJxD95VMF3eGxzSMMB@mail.gmail.com -->
<!--X-Reference: AANLkTimFT0&#45;Kbgdz_U5LeOW5Ln22mPBZBC8FL68n6CeF@mail.gmail.com -->
<!--X-Reference: AANLkTikhknBoHTc7B7GCRULkrEnxSx+PpqPP=x6KrDOH@mail.gmail.com -->
<!--X-Reference: AANLkTim0B&#45;E6kMW9Nn47o+u+atxrm38540u1Xhaoe6j0@mail.gmail.com -->
<!--X-Reference: AANLkTi=m5S08Nd1F5VDnMGTOu2s+j2Euz1t&#45;ytw0zOAf@mail.gmail.com -->
<!--X-Reference: AANLkTinxUWLu2N19dc3eaPgh22igv_SGy=6qmVnJN=Qj@mail.gmail.com -->
<!--X-Reference: AANLkTik0K3B7huKE8hJtAkXL_yzJmNa9BFxfczu8Sfx9@mail.gmail.com -->
<!--X-Reference: AANLkTin1JfUtMoVqR4c&#45;5dRHTf58N&#45;FAcv4_bc=LpH2b@mail.gmail.com -->
<!--X-Reference: AANLkTimBsSm504qysJd8&#45;e0O_thUdcwvciKrNhMTdoQW@mail.gmail.com -->
<!--X-Reference: AANLkTikf&#45;g23EPV+R2&#45;7inSpXbT5fqv5vDO8nL+DZrwA@mail.gmail.com -->
<!--X-Reference: AANLkTikNh5FTMmeQPqkSiX8ieG5oUw5UcuG83k8PeAiM@mail.gmail.com -->
<!--X-Reference: AANLkTimADCpNAJG4Pg02_UukH5hFW5eQfr&#45;SymzqXrc=@mail.gmail.com -->
<!--X-Reference: AANLkTi=8_288HiMhVQDwpFUCqMp+aBotECez44s44q7z@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: CST branch -- October 22, 2010 - 19:46</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: CST branch</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00015" class="tabs">Index by Date</a> | <a href="threads.html#00015" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00014.html">Date Prev</a>] [<a href="msg00016.html">Date Next</a>] [<a href="msg00014.html">Thread Prev</a>] [<a href="msg00016.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: Pavel Kaderavek &lt;pavel.kaderavek@xxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Fri, 22 Oct 2010 19:46:16 +0200</li>
<li class="menuitem">
<em>Cc</em>: relax-devel@xxxxxxx</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00015.html">AANLkTi=vSTA2B-jpTzShJab84W=-z1YBzvhW10wTXg_P@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;p2l6052a51004080823g94a64268lf8af8d3e332c2a03@xxxxxxxxxxxxxx&gt;	&lt;j2i7f080ed11004120000r80bba9bch9556be67b0c1707@xxxxxxxxxxxxxx&gt;	&lt;g2v6052a51004131048sb5c01509sfc9a77045ad33310@xxxxxxxxxxxxxx&gt;	&lt;r2g7f080ed11004131113mb209905eh63ff1eb61c171fee@xxxxxxxxxxxxxx&gt;	&lt;l2q6052a51004301221h9ad09886ha016465129beb516@xxxxxxxxxxxxxx&gt;	&lt;g2m7f080ed11005050153y2ad8b4bfjb4eb8191b0efd0cc@xxxxxxxxxxxxxx&gt;	&lt;AANLkTin4nzkkOCxs94vUKCpT00R7ak22gLaL5rK-VjPN@xxxxxxxxxxxxxx&gt;	&lt;AANLkTinF4yNXoJQS-rd81VBi3keRURUNeb-_GdkxqqsG@xxxxxxxxxxxxxx&gt;	&lt;AANLkTinibyBQvsoG1-0vmzOXFmRJxD95VMF3eGxzSMMB@xxxxxxxxxxxxxx&gt;	&lt;AANLkTimFT0-Kbgdz_U5LeOW5Ln22mPBZBC8FL68n6CeF@xxxxxxxxxxxxxx&gt;	&lt;AANLkTikhknBoHTc7B7GCRULkrEnxSx+PpqPP=x6KrDOH@xxxxxxxxxxxxxx&gt;	&lt;AANLkTim0B-E6kMW9Nn47o+u+atxrm38540u1Xhaoe6j0@xxxxxxxxxxxxxx&gt;	&lt;AANLkTi=m5S08Nd1F5VDnMGTOu2s+j2Euz1t-ytw0zOAf@xxxxxxxxxxxxxx&gt;	&lt;AANLkTinxUWLu2N19dc3eaPgh22igv_SGy=6qmVnJN=Qj@xxxxxxxxxxxxxx&gt;	&lt;AANLkTik0K3B7huKE8hJtAkXL_yzJmNa9BFxfczu8Sfx9@xxxxxxxxxxxxxx&gt;	&lt;AANLkTin1JfUtMoVqR4c-5dRHTf58N-FAcv4_bc=LpH2b@xxxxxxxxxxxxxx&gt;	&lt;AANLkTimBsSm504qysJd8-e0O_thUdcwvciKrNhMTdoQW@xxxxxxxxxxxxxx&gt;	&lt;AANLkTikf-g23EPV+R2-7inSpXbT5fqv5vDO8nL+DZrwA@xxxxxxxxxxxxxx&gt;	&lt;AANLkTikNh5FTMmeQPqkSiX8ieG5oUw5UcuG83k8PeAiM@xxxxxxxxxxxxxx&gt;	&lt;AANLkTimADCpNAJG4Pg02_UukH5hFW5eQfr-SymzqXrc=@xxxxxxxxxxxxxx&gt;	&lt;AANLkTi=8_288HiMhVQDwpFUCqMp+aBotECez44s44q7z@xxxxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on October 22, 2010 - 19:46:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi,

This is a good idea.  First I would suggest putting this into 2
patches, as this is easier to check and apply.  Don't worry about
breaking the code at this point - it is in your own special branch so
as long as it works in the end, you can smash it into a million pieces
and put it back together again if you like.  Commits to the repository
are better when they are many small ones, as they can be more easily
managed.  For example if something is found to be designed not
ideally, or there is a fatal bug, that patch/commit can be reverted
and then new code can be worked on.  And small patches make it much
easier for the other relax developers to read and catch potential
hidden bugs or design issues.

This is an intriguing problem, as the data flow hits a fork here.
ri_prime is the correct target for the merging of the data from all
the interactions, as this needs to occur before the calculation of the
NOE using sigma_noe and the R1.  The relaxation rates R1, R2, and
sigma_noe add.  However the NOE does not.  I just thought I'd explain
the logic for others to follow ;)

I would suggest we store ri_prime somewhere else.  What I can do is to
apply a patch for the first change to accommodate for the multiple
relaxation interactions.  Then I could make a change myself, creating
a special Python object for 'data[i]'.  We can store the ri_prime data
this special object.  Essentially, it will be like the current code
base.  We could have specific interaction data in say:

self.data[10][0].jw  (or self.data[0].jw if data = self.data[i])

This is new.  But as before we could have:

self.data[10].ri_prime (or data.ri_prime if data = self.data[i])

So the forking can all be managed within the self.data[i] data
structures.  What do you think?  Also, we will have to work out how to
modify or replace func_ri_prime and func_ri_prime_rex in the
maths_fns.ri_prime module.  This is where the merging of data streams
currently occurs.  Maybe Rex needs to be considered as its own
interaction, as this is added to produce ri_prime?

Regards,

Edward


P. S.  I just talked to Kathleen Hall and she seemed very interested
in what you are doing here!



On 22 October 2010 18:26, Pavel Kaderavek &lt;pavel.kaderavek@xxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,
I am continuing in the discussion started in my post
<a  rel="nofollow" href="https://mail.gna.org/public/relax-devel/2010-09/msg00020.html">https://mail.gna.org/public/relax-devel/2010-09/msg00020.html</a>
It covers changes of functions func_mf.py, func_local_tm , func_diff,
func_all and their equivalents for a first and second derivatives (class Mf,
file maths_fns/mf.py).

I would like to include into next patch also treatment of the fact, that it
is necessary to sum together contributions of all interactions. It seems to
me that the most suitable way is to do that by the modification just revised
functions (func_mf.py, func_local_tm ...)
I would suggest to initialize ri_prime before loop over interactions and
then step by step add the contributions into the ri_prime:

        data = self.data[i]                                  # the cases
when `i` is replaced by `0` were discussed in your last mail
        ri_prime=0


        for j in xrange(self.num_interactions[i]):

              ...
              ...

              # Calculate the R1, R2, and sigma_noe values.
              ri_prime = ri_prime + data[j].create_ri_prime(data[j])

         data[0].ri_prime = ri_prime


When the loop over interactions is finished the accumulated relaxation rate
is copied into the data storage of the first interaction. Then it is
possible to call functions, where total ri_prime is needed:

        # Calculate the NOE values.
        data[0].ri = data[0].ri_prime * 1.0
        for m in xrange(data[0].num_ri):
            if data[0].create_ri[m]:
                data[0].create_ri[m](data[0], m, data[0].remap_table[m],
data[0].get_r1, params)

        # Calculate the chi-squared value.
        data[0].chi2 = chi2(data[0].relax_data, data[0].ri, data[0].errors)

Regards,
Pavel

On 19 October 2010 13:49, Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">

Hi,

Sorry for the delay, I just came back from a 2 week holiday.  This is
correct, the func_mf, func_local_tm, etc. methods are working on a
single spin.  This is stored in self.data[0].  The other functions
work on multiple spin data located in self.data[0], self.data[1], etc.

Regards,

Edward



On 14 October 2010 19:38, Pavel Kaderavek &lt;pavel.kaderavek@xxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,

I would like to announce a small clarification of my previous mail about
changes in functions func_mf, func_local_tm, func_diff, func_all, and
their
derivatives (class Mf, file maths_fns/mf.py). Loop suggested in my last
post:

<a  rel="nofollow" href="https://mail.gna.org/public/relax-devel/2010-09/msg00020.html">https://mail.gna.org/public/relax-devel/2010-09/msg00020.html</a>

is valid just for the functions func_diff, func_all, and their
equivalents
for a first and second derivatives.
While for the functions  func_mf, func_local_tm, and corresponding
derivatives the index of self.num_interactions should be set to `0`
instead
of index `i`

        for j in xrange(self.num_interactions[0]):

(The rest of the loop remains the same)
That comes from the fact that these functions (func_mf, func_local_tm,
...
) are called for each spin separately. As it is indicated by the
preceding
statement:

        data = self.data[0]

Regards,
Pavel

On 29 September 2010 10:53, Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">

Hi,

This is the perfect approach.  It will abstract the calculations so
that we will not need to touch many of maths_fns modules.  With this
code in place, I would aim at then making the test suite pass again by
having the correct data structures pass into maths_fns.mf.  The last
step would be to input CSA tensors and the multi-dipole interactions
via user functions.  If you make a patch for all of the func_*(),
dfunc_*(), and d2func_*() methods, I can check and apply it quickly.

Regards,

Edward


On 28 September 2010 12:07, Pavel Kaderavek &lt;pavel.kaderavek@xxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,
we were thinking about next necessary changes in the CST branch.

Now we need to break through the problem, which implies the fact we
split
the relaxation rate calculation into contributions of individual
interactions. Each of them has its own data class to store its
parameters
(so far called data[i][j], where the [i] was a spin index and [j] was
the
interaction index).

It seems to us, that it the best way to deal with it is to edit
functions:
func_mf, func_local_tm , func_diff, func_all and their equivalents
for a
first and second derivatives (defined in mf.py file).

Within these functions the calculations of direction cosines,
diffusion
tensor weight calculations, components of the spectral densities and
so
on
are performed. All these must be calculated for each interaction
separately,
because each interaction has its own data storage (which replaced
previously
used one data class container for the whole IS spin system).

Instead of:


        # Direction cosine calculations.
        if self.diff_data.calc_di:
            self.diff_data.calc_di(data, self.diff_data)

        # Diffusion tensor weight calculations.
        self.diff_data.calc_ci(data, self.diff_data)

        # Diffusion tensor correlation times.
        self.diff_data.calc_ti(data, self.diff_data)

        # Calculate the components of the spectral densities.
        if data.calc_jw_comps:
            data.calc_jw_comps(data, params)

        # Calculate the R1, R2, and sigma_noe values.
        data.ri_prime = data.create_ri_prime(data)


we would suggest to introduce a loop over interacations
        for j in xrange(self.num_interactions[i]):
            # Direction cosine calculations.
            if self.diff_data.calc_di:
                self.diff_data.calc_di(data[j], self.diff_data)

            # Diffusion tensor weight calculations.
            self.diff_data.calc_ci(data[j], self.diff_data)

            # Diffusion tensor correlation times.
            self.diff_data.calc_ti(data[j], self.diff_data)

            # Calculate the components of the spectral densities.
            if data.calc_jw_comps:
                data.calc_jw_comps(data[j], params)

            # Calculate the R1, R2, and sigma_noe components.
            data.ri_prime = data.create_ri_prime(data[j])


It must be accompanied in the next step by a change the ri_prime
function so
that it just calculate only a product of specific interaction
constant
and
corresponding linear combination of spectral densities. While the
final
sumation over all interactions should be done in a separate step.

Moreover it will be also necessary to distinguish within the function
setup_equation the type of equation used for contribution of
individual
interactions according to their type.

Best
Pavel


On 10 September 2010 15:43, Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">

Hi Pavel,

I missed it in the patches, but there were tab characters '\t'
causing
problems.  These are now fixed.  relax requires that a tab is
replaced
by 4 spaces.  I have also added you to the copyright notices
(<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?view=rev&amp;revision=11543">http://svn.gna.org/viewcvs/relax?view=rev&amp;revision=11543</a>) of the
files you have modified.

Regards,

Edward

On 10 September 2010 15:36, Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,

I've carefully checked the patches and committed them with the
messages you wrote.  Sorry again for the delays.  It should be
faster
now that I am no longer in the tropical wilderness of far north
Australia.

Regards,

Edward


On 6 September 2010 13:23, Edward d'Auvergne
&lt;edward@xxxxxxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Pavel,

Sorry for the delayed response.  I was at the ICMRBS conference
in
Australia and then travelled through the tropical north end of
Australia afterwards.  I came back yesterday out of the remote
wilderness and can soon start looking at this patches.

Regards,

Edward


On 31 August 2010 18:00, Pavel Kaderavek
&lt;pavel.kaderavek@xxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,

some time ago, we submitted two patches regarding CST branch. We
are
not
sure if we should wait for some additional comment from your
side,
or
we can
continue with introducing further changes in the code.
Next step would be a splitting of the relaxation equation so
that
contribution to the relaxation due to the individual types of
interaction
(dipole-dipole, CSA) can be calculated separately.


Regars,

Pavel, Petr

</pre></blockquote><pre style="margin: 0em;">

</pre></blockquote><pre style="margin: 0em;">

</pre></blockquote></blockquote><pre style="margin: 0em;">


</pre></blockquote></blockquote><pre style="margin: 0em;">


</pre></blockquote></blockquote><pre style="margin: 0em;">


</pre></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00016" href="msg00016.html">Re: CST branch</a></strong>
<ul><li><em>From:</em> Pavel Kaderavek</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00005" href="msg00005.html">Re: CST branch</a></strong>
<ul><li><em>From:</em> Pavel Kaderavek</li></ul></li>
<li><strong><a name="00007" href="msg00007.html">Re: CST branch</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00014" href="msg00014.html">Re: CST branch</a></strong>
<ul><li><em>From:</em> Pavel Kaderavek</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Wed Oct 27 21:00:29 2010</div>  
</body>
</html>
