<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: Why does one have to loop over the dispersion points? -->
<!--X-From-R13: "Sqjneq q'Ohiretar" &#60;rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Fri, 09 May 2014 15:57:36 +0200 -->
<!--X-Message-Id: CAED9pY86VciFVj5F0ZOcUOUTqy+gQbX6F67RswNbeJWdJoM3RQ@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: CA+CBx2MkmjbAbk0zn5Wj0jf5A6kBqg=sMQW&#45;ATxTdjTS7+M8AQ@mail.gmail.com -->
<!--X-Reference: CAED9pY8ZfvZefM9zN_eJzNV2BmDN2J2StBmQ=baWPxi&#45;14RxZg@mail.gmail.com -->
<!--X-Reference: CA+CBx2NgPVtEXyHqSJO8ChAPGFg=a_u93GT6fz6d&#45;ETZG2g+7Q@mail.gmail.com -->
<!--X-Reference: CAED9pY8suh6NjnU5HfQAwZNEhh6Y7vg5&#45;uYDdBGDZ0xv7Zaeow@mail.gmail.com -->
<!--X-Reference: CA+CBx2OvwrdmmHs1QtA7GdzjiREdSbz&#45;COzDQESbpDh=LRNszw@mail.gmail.com -->
<!--X-Reference: CAED9pY8Zb35J7m=2_0Mj4_7aBAaD_61SUQN5ZeBwAcsS27yiOg@mail.gmail.com -->
<!--X-Reference: CA+CBx2NH94oA3BXGtqRR&#45;KM6CTtoNK6vKJ_CMRG4=ZbYKCb31Q@mail.gmail.com -->
<!--X-Reference: CAED9pY&#45;UmmVLzaq_xrFdAGw9M1omN6FRX0=gSJD7p5GhEx0JKg@mail.gmail.com -->
<!--X-Reference: CA+CBx2NXt23YHqtb&#45;G6Mp0V5fDO2ctQc6fH=xkPHMp67FqaKkA@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: Why does one have to loop over the dispersion points? -- May 09, 2014 - 15:57</title>
<link rel="stylesheet" type="text/css" href="/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="https://gna.org/images/gna.theme/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: Why does one have to loop over the dispersion points?</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00275" class="tabs">Index by Date</a> | <a href="threads.html#00275" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00274.html">Date Prev</a>] [<a href="msg00276.html">Date Next</a>] [<a href="msg00282.html">Thread Prev</a>] [<a href="msg00134.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Fri, 9 May 2014 15:56:41 +0200</li>
<li class="menuitem">
<em>Cc</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:date:message-id:subject :from:to:cc:content-type; bh=DgmkphPdlu37HMpLgZ0Sn9IURDVRztv9lu3P+be4fDU=; b=m6I+RKJT49PN3KBR8c40UYGz2DnukHLYQvxxbZkMhD1lS5jfU0YLyvbD19tvpK1sSU SKfZolxpcKklS7nBhlL0sGY0PHLuIiCX9lnUbGwLEf7AIN7Tlh6E3d5NSOVf0xWitOqJ PNPdl2jXfn0sKNNHD3RwvVYsSg36yL0r5Ark/nixen3/T92OFlmU8y+y4WXAQwE3ojpK sXL4IrbVLHOUur4E/hfRgpA8yfLEJR73bqv1O44z38ooRAP5DW5KEwnWkYj811rfjRRc 9pvSmHumAUlPXDbB6TjbvQP5bYNdIAlYeKMqKRVfsilQD4tUQzL+6XcH3vuXfSMReUPW AiyQ==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00275.html">CAED9pY86VciFVj5F0ZOcUOUTqy+gQbX6F67RswNbeJWdJoM3RQ@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;CA+CBx2MkmjbAbk0zn5Wj0jf5A6kBqg=sMQW-ATxTdjTS7+M8AQ@mail.gmail.com&gt; &lt;CAED9pY8ZfvZefM9zN_eJzNV2BmDN2J2StBmQ=baWPxi-14RxZg@mail.gmail.com&gt; &lt;CA+CBx2NgPVtEXyHqSJO8ChAPGFg=a_u93GT6fz6d-ETZG2g+7Q@mail.gmail.com&gt; &lt;<a href="msg00128.html">CAED9pY8suh6NjnU5HfQAwZNEhh6Y7vg5-uYDdBGDZ0xv7Zaeow@mail.gmail.com</a>&gt; &lt;CA+CBx2OvwrdmmHs1QtA7GdzjiREdSbz-COzDQESbpDh=LRNszw@mail.gmail.com&gt; &lt;CAED9pY8Zb35J7m=2_0Mj4_7aBAaD_61SUQN5ZeBwAcsS27yiOg@mail.gmail.com&gt; &lt;CA+CBx2NH94oA3BXGtqRR-KM6CTtoNK6vKJ_CMRG4=ZbYKCb31Q@mail.gmail.com&gt; &lt;CAED9pY-UmmVLzaq_xrFdAGw9M1omN6FRX0=gSJD7p5GhEx0JKg@mail.gmail.com&gt; &lt;CA+CBx2NXt23YHqtb-G6Mp0V5fDO2ctQc6fH=xkPHMp67FqaKkA@mail.gmail.com&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on May 09, 2014 - 15:57:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<blockquote class="blockquote"><pre style="margin: 0em;">I really think for my case, that 25 speed up is a deal breaker !
I have so much data to crunch, that 25 speed is absolutely perfect.
</pre></blockquote><pre style="margin: 0em;">

Note that with the CR72 model, there are still a number of
optimisations which can be performed which will probably give a lot
more speed than this 25%.  In addition, there is a good chance that
the math domain error checking will mean that this 25% speed up might
not happen.  You may only get 1.05 ;)  That really depends on how the
checks are constructed.  Anyway, you can give it a go if you wish.
But try to optimise CR72 first.


</pre><blockquote class="blockquote"><pre style="margin: 0em;">I would only optimise this for CR72, and TSMFK01, since these are the
ones I need now.
And the change of code is only 3-5 lines?
</pre></blockquote><pre style="margin: 0em;">

Well, the math domain checking which sets &quot;back_calc[i] = 1e100&quot; or
&quot;back_calc[i] = r20_kex&quot; in the CR72 model would have to be rethought.
 The TSMF01 too.

Note though that this changes the logic of the
target_functions.relax_disp to lib.dispersion API interface.  This is
a big deal!  The interface must all be one or the other - either all
lib.dispersion modules return back-calculated R2eff arrays or the all
accept R2eff arrays and pack them with data.  There can be no zero
compromise with an important API interface such as this.  A mixture
cannot be accepted.  That being said, if you manage the change in one
model, then you won't find it difficult to change it in others.

Note that there is also another optimisation target which is the
'missing' data structure.  A redesign of that might give you a 50% or
more speed up as well.


</pre><blockquote class="blockquote"><pre style="margin: 0em;">And i was thinking of one thing more.

CR72 always go over loop.

-----------
    # Loop over the time points, back calculating the R2eff values.
    for i in range(num_points):
        # The full eta+/- values.
        etapos = etapos_part / cpmg_frqs[i]
        etaneg = etaneg_part / cpmg_frqs[i]

        # Catch large values of etapos going into the cosh function.
        if etapos &gt; 100:
            back_calc[i] = 1e100
            continue

        # The arccosh argument - catch invalid values.
        fact = Dpos * cosh(etapos) - Dneg * cos(etaneg)
        if fact &lt; 1.0:
            back_calc[i] = r20_kex
            continue

        # The full formula.
        back_calc[i] = r20_kex - cpmg_frqs[i] * arccosh(fact)
------------
I would rather do:
etapos = etapos_part / cpmg_frqs

And then check for nan values.
If any of these are there, just return the whole array with 1e100,
instead of single values.
That would replace a loop with a check.
</pre></blockquote><pre style="margin: 0em;">

This is a great idea - it'd be awesome if it worked.  You should make
such optimisations to the CR72 model first.  Note though that there
will be no NaN values - the cpmg_frqs array should be a reasonable set
of values and never contain 0.0 (that should be caught and prevented
by the specific_analyses.relax_disp code).  You have to check for
values &gt; 100 to avoid in numpy.cosh() (&quot;if numpy.max(etapos) &gt; 100:&quot;).

You could then also calculate 'fact' outside of the loop.  But then
check for values &lt; 1.0 (&quot;if numpy.min(fact) &lt; 1.0&quot;), as arccosh is
only defined for values &gt;= 1.0.  Then calculate &quot;values = r20_kex -
cpmg_frqs * arccosh(fact)&quot;, again out of the loop.  I think you'll be
impressed by the speed ups this gives.

Then finally have the code:

    # Loop over the time points, packing the R2eff values into the array.
    for i in range(num_points):
        back_calc[i] = values[i]

Timings for such a change, possibly from a system test, would be great
to have.  Once CR72 is fully optimised, then you should consider
creating a branch for changing the target_functions.relax_disp to
lib.dispersion API.  And if you manage to make such optimisation so
that all models end in these three lines, then it would be very quick
to change the entire API.

Regards,

Edward


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00122" href="msg00122.html">Why does one have to loop over the dispersion points?</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00126" href="msg00126.html">Re: Why does one have to loop over the dispersion points?</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00127" href="msg00127.html">Re: Why does one have to loop over the dispersion points?</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00128" href="msg00128.html">Re: Why does one have to loop over the dispersion points?</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00129" href="msg00129.html">Re: Why does one have to loop over the dispersion points?</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00130" href="msg00130.html">Re: Why does one have to loop over the dispersion points?</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00271" href="msg00271.html">Re: Why does one have to loop over the dispersion points?</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00272" href="msg00272.html">Re: Why does one have to loop over the dispersion points?</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00273" href="msg00273.html">Re: Why does one have to loop over the dispersion points?</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer">You are on the <a href="http://gna.org">Gna!</a> mail server.</div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Fri May 09 17:20:13 2014</div>  
</body>
</html>
