<!-- MHonArc v2.6.16 -->
<!--X-Subject: Pickling problems with the relax data storage singleton. -->
<!--X-From-R13: "Quevf [npDnvyq" <znpenvyqNjruv.rqh.nh> -->
<!--X-Date: Tue, 27 Nov 2007 00:17:39 +0100 -->
<!--X-Message-Id: 3b3f50350711261517h5da6f85dj6ed837742eb8505e@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 7f080ed10711201001s59a00533pf3c0ee3f88a79edb@mail.gmail.com -->
<!--X-Reference: 474543CC.50505@bmb.leeds.ac.uk -->
<!--X-Reference: 7f080ed10711220106t543aade7o54657f5cced18858@mail.gmail.com -->
<!--X-Reference: 474552DE.9090007@bmb.leeds.ac.uk -->
<!--X-Reference: 7f080ed10711220830s56faf4d8v1941fa6c61052f35@mail.gmail.com -->
<!--X-Reference: 47468BE4.7000804@bmb.leeds.ac.uk -->
<!--X-Reference: 3b3f50350711251832k469e45a5r247696eaf3e83952@mail.gmail.com -->
<!--X-Reference: f001463a0711260039r791233b0r25f0c4e63a63092@mail.gmail.com -->
<!--X-Reference: 7f080ed10711260237s2c9d9a59w75f1b8f7ab79c66e@mail.gmail.com -->
<!--X-Reference: 3b3f50350711261516t64cb704elc16875e77e3d546c@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Pickling problems with the relax data storage singleton. -- November 27, 2007 - 00:17</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Pickling problems with the relax data storage singleton.</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00029" class="tabs">Index by Date</a> | <a href="threads.html#00029" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00028.html">Date Prev</a>] [<a href="msg00030.html">Date Next</a>] [<a href="msg00028.html">Thread Prev</a>] [<a href="msg00031.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: relax-devel@xxxxxxx</li>
<li class="menuitem">
<em>Date</em>: Tue, 27 Nov 2007 10:17:15 +1100</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00029.html">3b3f50350711261517h5da6f85dj6ed837742eb8505e@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;7f080ed10711201001s59a00533pf3c0ee3f88a79edb@xxxxxxxxxxxxxx&gt;	&lt;474543CC.50505@xxxxxxxxxxxxxxx&gt;	&lt;7f080ed10711220106t543aade7o54657f5cced18858@xxxxxxxxxxxxxx&gt;	&lt;474552DE.9090007@xxxxxxxxxxxxxxx&gt;	&lt;7f080ed10711220830s56faf4d8v1941fa6c61052f35@xxxxxxxxxxxxxx&gt;	&lt;47468BE4.7000804@xxxxxxxxxxxxxxx&gt;	&lt;3b3f50350711251832k469e45a5r247696eaf3e83952@xxxxxxxxxxxxxx&gt;	&lt;f001463a0711260039r791233b0r25f0c4e63a63092@xxxxxxxxxxxxxx&gt;	&lt;7f080ed10711260237s2c9d9a59w75f1b8f7ab79c66e@xxxxxxxxxxxxxx&gt;	&lt;3b3f50350711261516t64cb704elc16875e77e3d546c@xxxxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Chris MacRaild</strong> on November 27, 2007 - 00:17:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">On Nov 26, 2007 9:37 PM, Edward d'Auvergne &lt;edward.dauvergne@xxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">On Nov 26, 2007 9:39 AM, gary thompson &lt;garyt.and.sarahb@xxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">




On Nov 26, 2007 2:32 AM, Chris MacRaild &lt;macraild@xxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">

On Nov 23, 2007 7:14 PM, Gary Thompson &lt;garyt@xxxxxxxxxxxxxxx&gt; wrote:

</pre></blockquote></blockquote><pre style="margin: 0em;">

[snip]


</pre><blockquote class="blockquote"><blockquote class="blockquote"><pre style="margin: 0em;">Another (better?) option would be to do saving and restoring state at
a lower level. So instead of simply pickling the whole Data object, we
have save and restore methods of the Data class that do the pickling
in a more controled way. This seems to me more true to the intent of
the singleton pattern, avoiding the complications Gary refers to. Also
the control over what gets saved and how might be useful.

A quick sketch of the sort of thing I'm thinking:

class Data(dict):
   ...
   def _save(file):
       P = Pickler(file)
       dont_save = [] # a list of attributes that don't need saving,
eg. methods
       for name,  attr in self.__dict__.items():
           if not name in dont_save:
               P.dump((name,attr))

   def _restore(file):
       P = Unpickler(file)
       while True:
           try:
               name, attr = U.load()
           except EOFError:
               break
           setAttr(self, name, attr)

Then the user commands save_state and restore_state are just
front-ends to Data._save and Data._restore. Pickle needn't wory itself
with our unusual namespace, because only attributes of Data are
pickled, not Data itself. Save and restore functions are mehtods of
the Singleton object, so there is no risk of breaking the Singleton
pattern. Finally, we have the basis of a mechanism there to control
what gets saved/restored and how.

Cheers,

Chris





</pre></blockquote><pre style="margin: 0em;">This seems good but have some other possibly  interesting questions

1. should data be a singleton? what happens if i need to load two data
hierachies for example for comparison between two runs (If i am barking up
the wrong tree about the current design here please disregard this)
</pre></blockquote><pre style="margin: 0em;">

The data storage singleton can handle this.  It is a DictionaryType
object, its keys corresponding to individual PipeContainer objects.
These PipeContainers are the data pipes, the embodiment of the morphed
'runs' concept.  So the change was to put everything into a
PipeContainer and the comparisons will be between the data contents of
any sets of PipeContainers.  As relax runs, the contents of each data
pipe is modified and molded.  The links between these pipes include
functions for switching between them, copying data between them, and
merging the contents together and placing the result into a new pipe
(e.g. model selection, hybridisation, etc.).  These are just very
basic plumbing concepts ;)


</pre><blockquote class="blockquote"><pre style="margin: 0em;">2. we have to  be careful we don't pickle any python state (what is python
state can change between versions) How do we identify what is python 
state,
create an empty object?
</pre></blockquote><pre style="margin: 0em;">

The saved states are not very portable.  I'm hoping the unit tests
will pull out these issues, as there will be a few saved states in the
shared data directory you created.

</pre></blockquote><pre style="margin: 0em;">

Pickling can do nothing other than save python state, which is why
pickle-based saved states are not portable. In principle we could try
to ensure that we only pickle 'standard library' python state (ie.
only objects that are defined in the standard library). Then saved
states would be portable between relax versions (but not necessarily
python versions, or architectures I suspect). This would require a
much more complicated and high-maintenance save/restore code that
recursed down the attributes of the Data object and reduced them to
standard library objects. Better, I think, to accept that saved state
is not the right tool for portable data storage, and therefore not
care too much about pickling state that might change in future relax
(or python) versions.

</pre><blockquote class="blockquote"><pre style="margin: 0em;">

</pre><blockquote class="blockquote"><pre style="margin: 0em;">3. Chris's  will add an extra requirement for maintenance in the future as
all new fields have to be registered for saving
</pre></blockquote><pre style="margin: 0em;">

That is true.  Hopefully when new objects are added, a corresponding
unit test is created to catch it.  But yes, this is a danger.  So
rather than having a white list of object to include a black list of
objects to exclude will be better, as then new objects will
automatically be saved.

</pre></blockquote><pre style="margin: 0em;">

No. I proposed registering attributes that need *not* be saved,
precisely to avoid this issue. Also keep in mind that the status quo
is to pickle the entire Data object, so even if we do forget to
exclude attributes, we are in no worse position that we currently are.

Chris


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00031" href="msg00031.html">Re: Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00021" href="msg00021.html">Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00022" href="msg00022.html">Re: Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> Gary Thompson</li></ul></li>
<li><strong><a name="00023" href="msg00023.html">Re: Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00024" href="msg00024.html">Re: Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> Gary Thompson</li></ul></li>
<li><strong><a name="00025" href="msg00025.html">Re: Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> Chris MacRaild</li></ul></li>
<li><strong><a name="00026" href="msg00026.html">Re: Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> gary thompson</li></ul></li>
<li><strong><a name="00028" href="msg00028.html">Re: Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Tue Nov 27 09:41:47 2007</div>  
</body>
</html>
