<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: r23219 &#45; /branches/disp_speed/lib/dispersion/tsmfk01.py -->
<!--X-From-R13: "Sqjneq q'Ohiretar" &#60;rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Mon, 19 May 2014 10:13:50 +0200 -->
<!--X-Message-Id: CAED9pY&#45;SMZCOV10DcS_UEQP_c9L&#45;&#45;g7fw985WCcCZUG9+mPHZw@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: E1Wm9vK&#45;0003WP&#45;Ty@subversion.gna.org -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: r23219 - /branches/disp_speed/lib/dispersion/tsmfk01.py -- May 19, 2014 - 10:13</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: r23219 - /branches/disp_speed/lib/dispersion/tsmfk01.py</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00347" class="tabs">Index by Date</a> | <a href="threads.html#00347" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00346.html">Date Prev</a>] [<a href="msg00348.html">Date Next</a>] [<a href="msg00346.html">Thread Prev</a>] [<a href="msg00348.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Mon, 19 May 2014 10:12:59 +0200</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:date:message-id:subject :from:to:content-type; bh=sSQeNB4wNgxgcxmWSXs2GfP9c5qfKorhZdZH79kpgYo=; b=vnQxriKuB2Bdo3+w7RXBXSAO7iYNVyAWwErvYtvpYJFhRMwXjyYtMrViYe+uKW5urx t1UrDjXdDipDZAj2MXT/Pv6lRyQEraoNOfxv3dJMHp8/E500ksPSIKAL17pY1lKhiwKP +m2y0n2s4ob54McEl5vxNkpJVQQsxt9DJR3bK2hg7wvLKCh99spl1iqGlF9NEsEyPJo3 BvxYAEkO/D+WtiJfIW86KZ/VZAnnBBLWfP9wq4ZUc1zWJXsOhzbAc6GiUb1a0IPZXofG 2KL9cmrUsZV36hPj4cUnpoHvW/1D3ddbrmSNYBRq6idQQeGxxUNjfKF9Ghb0C1Ng/UKC 7Apg==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00347.html">CAED9pY-SMZCOV10DcS_UEQP_c9L--g7fw985WCcCZUG9+mPHZw@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;E1Wm9vK-0003WP-Ty@subversion.gna.org&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on May 19, 2014 - 10:13:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi Troels,

For even faster code , have a look at:

<a  rel="nofollow" href="https://stackoverflow.com/questions/6431973/how-to-copy-data-from-a-numpy-array-to-another">https://stackoverflow.com/questions/6431973/how-to-copy-data-from-a-numpy-array-to-another</a>

Regards,

Edward


On 19 May 2014 00:51,  &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Author: tlinnet
Date: Mon May 19 00:51:18 2014
New Revision: 23219

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=23219&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=23219&amp;view=rev</a>
Log:
Speed-up of model TSMFK01.

task #7793: (<a  rel="nofollow" href="https://web.archive.org/web/https://gna.org/task/?7793">https://gna.org/task/?7793</a>) Speed-up of dispersion models.

This is won by not checking single values in the R2eff array for math domain
errors, but calculating all steps, and in one single round check for finite 
values.
If just one non-finite value is found, the whole array is returned with a 
large
penalty of 1e100.

This makes all calculations be the fastest numpy array way.

Modified:
    branches/disp_speed/lib/dispersion/tsmfk01.py

Modified: branches/disp_speed/lib/dispersion/tsmfk01.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/disp_speed/lib/dispersion/tsmfk01.py?rev=23219&amp;r1=23218&amp;r2=23219&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/disp_speed/lib/dispersion/tsmfk01.py?rev=23219&amp;r1=23218&amp;r2=23219&amp;view=diff</a>
==============================================================================
--- branches/disp_speed/lib/dispersion/tsmfk01.py       (original)
+++ branches/disp_speed/lib/dispersion/tsmfk01.py       Mon May 19 00:51:18 
2014
@@ -67,7 +67,7 @@
 &quot;&quot;&quot;

 # Python module imports.
-from math import sin
+from numpy import sin, isfinite, sum


 def r2eff_TSMFK01(r20a=None, dw=None, k_AB=None, tcp=None, back_calc=None, 
num_points=None):
@@ -90,24 +90,20 @@
     @type num_points:       int
     &quot;&quot;&quot;

-    # Loop over the time points, back calculating the R2eff values.
+    # Denominator.
+    denom = dw * tcp
+
+    # The numerator.
+    numer = sin(denom)
+
+    # Calculate R2eff.
+    R2eff = r20a + k_AB - k_AB * numer / denom
+
+    # Catch errors, taking a sum over array is the fastest way to check for
+    # +/- inf (infinity) and nan (not a number).
+    if not isfinite(sum(R2eff)):
+        R2eff = array([1e100]*num_points)
+
+    # Parse back the value to update the back_calc class object.
     for i in range(num_points):
-        # Denominator.
-        denom = dw * tcp[i]
-
-        # The numerator.
-        numer = sin(denom)
-
-        # Catch zeros (to avoid pointless mathematical operations).
-        if numer == 0.0:
-            back_calc[i] = r20a + k_AB
-            continue
-
-        # Avoid divide by zero.
-        if denom == 0.0:
-            back_calc[i] = 1e100
-            continue
-
-        # The full formula.
-        else:
-            back_calc[i] = r20a + k_AB - k_AB * numer / denom
+        back_calc[i] = R2eff[i]


_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-commits mailing list
relax-commits@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="https://mail.gna.org/listinfo/relax-commits">https://mail.gna.org/listinfo/relax-commits</a>
</pre></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Mon May 19 14:20:16 2014</div>  
</body>
</html>
