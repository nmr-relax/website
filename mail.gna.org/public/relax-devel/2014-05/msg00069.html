<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: r22940 &#45; /trunk/lib/dispersion/b14.py -->
<!--X-From-R13: "Sqjneq q'Ohiretar" &#60;rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Sun, 04 May 2014 10:52:26 +0200 -->
<!--X-Message-Id: CAED9pY9_VrhnSjO9RiFjKGBXjiZ9=QtL6tRAZ2mO=KN&#45;b&#45;0g5w@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: E1WgfiI&#45;0005G3&#45;7P@subversion.gna.org -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: r22940 - /trunk/lib/dispersion/b14.py -- May 04, 2014 - 10:52</title>
<link rel="stylesheet" type="text/css" href="/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="https://gna.org/images/gna.theme/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: r22940 - /trunk/lib/dispersion/b14.py</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00069" class="tabs">Index by Date</a> | <a href="threads.html#00069" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00068.html">Date Prev</a>] [<a href="msg00070.html">Date Next</a>] [<a href="msg00064.html">Thread Prev</a>] [<a href="msg00070.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Sun, 4 May 2014 10:51:35 +0200</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:date:message-id:subject :from:to:content-type:content-transfer-encoding; bh=pQIREKLtjJIgZ3CurOD8ELcACKm5PqKKn8/MNcmqR/k=; b=NrSU5hXegfscDy/rLGR6ADx/AJy4Pn+LmgQU/l3+M1mKofQhx+18mcK5SBPIedwzMY uFbDCX8C2i1ReKtdH6JhPzYfQ8b5CJ3lKhYnV5CTXLKwbjEkvaEfNmIp9sRuoF8XH9VS +EErdJJy71WB6KDA/GgeoFzhxqaUE94R+WGduQnzqPCoQP3DdVp7U+Jt2pf9idnbKHjv aaJVGdFhFbFMpf0x99lGq429mhSbklO4pSplhEptZMutGsGBmN6D24cbkOcnwO13EJej YU4A4aMV8/+Gg/IzIdTszXhdIh00nTSMKPbMirgf4TxMQ6pxux0uRr6FLrgLIYoc959I WqyQ==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;CAED9pY9_VrhnSjO9RiFjKGBXjiZ9=QtL6tRAZ2mO=KN-b-0g5w@mail.gmail.com&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;E1WgfiI-0005G3-7P@subversion.gna.org&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on May 04, 2014 - 10:52:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi Troels,

If you need tips for hugely optimising this code, just ask ;)  There
is quite a lot that can be done.  There are also a lot of changes
which can be made to make the code fit better into relax - using the
same parameter and variable naming conventions as in the other
lib.dispersion modules, spacing around Python operators, spacing after
commas (as the 2to3 program insists on), importing the numpy functions
rather than using the module directly, etc.

Regards,

Edward




On 3 May 2014 21:35,  &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Author: tlinnet
Date: Sat May  3 21:35:09 2014
New Revision: 22940

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=22940&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=22940&amp;view=rev</a>
Log:
Implemented model B14 in the relax library.

sr #3154: (<a  rel="nofollow" href="https://gna.org/support/?3154">https://gna.org/support/?3154</a>) Implementation of Baldwin (2014) 
B14 model - 2-site exact solution model for all time scales.

This follows the tutorial for adding relaxation dispersion models at:
Tutorial_for_adding_relaxation_dispersion_models_to_relax#The_relax_library

The code is raw implemented, with no optimisation.

This is merely to test, that the spin parameters that created R2eff data, 
can be found again after
grid searh and minimisation.

The B14 model is explained in: <a  rel="nofollow" href="http://wiki.nmr-relax.com/B14">http://wiki.nmr-relax.com/B14</a>.

Modified:
    trunk/lib/dispersion/b14.py

Modified: trunk/lib/dispersion/b14.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/trunk/lib/dispersion/b14.py?rev=22940&amp;r1=22939&amp;r2=22940&amp;view=diff">http://svn.gna.org/viewcvs/relax/trunk/lib/dispersion/b14.py?rev=22940&amp;r1=22939&amp;r2=22940&amp;view=diff</a>
==============================================================================
--- trunk/lib/dispersion/b14.py (original)
+++ trunk/lib/dispersion/b14.py Sat May  3 21:35:09 2014
@@ -43,32 +43,32 @@
 The equation used is::

             R2A0 + R2B0 + kex      Ncyc                      1      ( 1+y  
          1-y                          )
-    R2eff = ------------------ -  ------ * cosh^-1 * v1c - ------ ln( --- 
+ ------------------ * (v2 + 2*kAB*pD ) )
+    R2eff = ------------------ -  ------ * cosh^-1 * v1c - ------ ln( --- 
+ ------------------ * (v2 + 2*kAB*pD ) ) ,
                   2                Trel                     Trel    (  2   
 2*sqrt(v1c^2 -1 )                     )

                             1      ( 1+y            1-y                    
      )
-          = R2eff(CR72) - ------ ln( --- + ------------------ * (v2 + 
2*kAB*pD ) )
+          = R2eff(CR72) - ------ ln( --- + ------------------ * (v2 + 
2*kAB*pD ) ) ,
                            Trel    (  2    2*sqrt(v1c^2 -1 )               
      )

 Which have these following definitions::

-    v1c = F0 * cosh(tauCP * E0)- F2 * cosh(tauCP * E2)
-    v1s = F0 * sinh(tauCP * E0)- F2 * sinh(tauCP * E2)
-    v2*N = v1s * (OB-OA) + 4OB * F1^a * sinh(tauCP * E1)
-    pD N = v1s + (F1^a + F1^b) * sinh(tauCP * E1)
-    v3 = ( v2^2 + 4 * kBA * kAB * pD^2 )^1/2
-    y = ( (v1c-v3)/(v1c+v3) )^NCYC
+    v1c = F0 * cosh(tauCP * E0)- F2 * cosh(tauCP * E2) ,
+    v1s = F0 * sinh(tauCP * E0)- F2 * sinh(tauCP * E2) ,
+    v2*N = v1s * (OB-OA) + 4OB * F1^a * sinh(tauCP * E1) ,
+    pD N = v1s + (F1^a + F1^b) * sinh(tauCP * E1) ,
+    v3 = ( v2^2 + 4 * kBA * kAB * pD^2 )^1/2 ,
+    y = ( (v1c-v3)/(v1c+v3) )^NCYC ,

 Note, E2 is complex. If |x| denotes the complex modulus::

-    cosh(tauCP * E2) = cos(tauCP * |E2|)
-    sinh(tauCP * E2) = i sin(tauCP * |E2|)
+    cosh(tauCP * E2) = cos(tauCP * |E2|) ,
+    sinh(tauCP * E2) = i sin(tauCP * |E2|) ,

 The term pD is based on product of the off diagonal elements in the CPMG 
propagator (Supplementary Section 3).

 It is interesting to consider the region of validity of the Carver 
Richards result.  The two results are equal when the correction is zero, 
which is true when::

-    sqrt(v1c^2-1) ~ v2 + 2*kAB * pD
+    sqrt(v1c^2-1) ~ v2 + 2*kAB * pD ,

 This occurs when 2*kAB * pD tends to zero, and so v2=v3.  Setting &quot;kAB * 
pD&quot; to zero, amounts to neglecting magnetisation that starts on the ground 
state ensemble and end on the excited state ensemble and vice versa.  This 
will be a good approximation when pA &gt;&gt; p_B.

@@ -98,11 +98,87 @@
 &quot;&quot;&quot;

 # Python module imports.
-from numpy import arccosh, cos, cosh, sqrt
+import numpy
+from math import cos,sin,atan2


-def r2eff_B14(r20a=None, r20b=None, pA=None, dw=None, kex=None, 
cpmg_frqs=None, back_calc=None, num_points=None):
-    &quot;&quot;&quot;
+def r2eff_B14(r20a=None, r20b=None, pA=None, dw=None, kex=None, 
power=None, relax_time=None, tcp=None, back_calc=None, num_points=None):
+    &quot;&quot;&quot;Calculate the R2eff values for the CR72 model.
+
+    See the module docstring for details.
+
+
+    @keyword r20a:          The R20 parameter value of state A (R2 with no 
exchange).
+    @type r20a:             float
+    @keyword r20b:          The R20 parameter value of state B (R2 with no 
exchange).
+    @type r20b:             float
+    @keyword pA:            The population of state A.
+    @type pA:               float
+    @keyword dw:            The chemical exchange difference between 
states A and B in rad/s.
+    @type dw:               float
+    @keyword kex:           The kex parameter value (the exchange rate in 
rad/s).
+    @type kex:              float
+    @keyword power:         The matrix exponential power array. The number 
of CPMG blocks.
+    @type power:            numpy int16, rank-1 array
+    @keyword relax_time:    The total relaxation time period (in seconds).
+    @type relax_time:       float
+    @keyword tcp:           The tau_CPMG times (1 / 4.nu1).
+    @type tcp:              numpy rank-1 float array
+    @keyword back_calc:     The array for holding the back calculated 
R2eff values.  Each element corresponds to one of the CPMG nu1 frequencies.
+    @type back_calc:        numpy rank-1 float array
+    @keyword num_points:    The number of points on the dispersion curve, 
equal to the length of the cpmg_frqs and back_calc arguments.
+    @type num_points:       int
     &quot;&quot;&quot;

-    return None
+    # Conversion from relax parameters, to the exact code of Baldwin.
+    pb = 1 - pA
+    R2e = r20b
+    R2g = r20a
+    Trel = relax_time
+    ncyc = power
+
+    
#########################################################################
+    ##### Baldwins code.
+    
#########################################################################
+    pa=(1-pb)
+    keg=kex*(1-pb)
+    kge=kex*pb
+    deltaR2=R2e-R2g
+    #  This is not used
+    #nu_cpmg=ncyc/Trel
+    #tcp=Trel/(4.0*ncyc)  #time for one free precession element
+
+    
#########################################################################
+    #get the real and imaginary components of the exchange induced shift
+    g1=2*dw*(deltaR2+keg-kge)                   #same as carver richards 
zeta
+    g2=(deltaR2+keg-kge)**2.0+4*keg*kge-dw**2   #same as carver richards 
psi
+    g3=cos(0.5*atan2(g1,g2))*(g1**2.0+g2**2.0)**(1/4.0)   #trig faster 
than square roots
+    g4=sin(0.5*atan2(g1,g2))*(g1**2.0+g2**2.0)**(1/4.0)   #trig faster 
than square roots
+    
#########################################################################
+    #time independent factors
+    N=complex(kge+g3-kge,g4)            #N=oG+oE
+    NNc=(g3**2.+g4**2.)
+    f0=(dw**2.+g3**2.)/(NNc)              #f0
+    f2=(dw**2.-g4**2.)/(NNc)              #f2
+    #t1=(-dw+g4)*(complex(-dw,-g3))/(NNc) #t1
+    t2=(dw+g4)*(complex(dw,-g3))/(NNc) #t2
+    t1pt2=complex(2*dw**2.,-g1)/(NNc)     #t1+t2
+    oGt2=complex((deltaR2+keg-kge-g3),(dw-g4))*t2  #-2*oG*t2
+    Rpre=(R2g+R2e+kex)/2.0   #-1/Trel*log(LpreDyn)
+    E0= 2.0*tcp*g3  #derived from relaxation       #E0=-2.0*tcp*(f00R-f11R)
+    E2= 2.0*tcp*g4  #derived from chemical shifts  
#E2=complex(0,-2.0*tcp*(f00I-f11I))
+    E1=(complex(g3,-g4))*tcp    #mixed term (complex) (E0-iE2)/2
+    ex0b=(f0*numpy.cosh(E0)-f2*numpy.cos(E2))               #real
+    ex0c=(f0*numpy.sinh(E0)-f2*numpy.sin(E2)*complex(0,1.)) #complex
+    ex1c=(numpy.sinh(E1))                                   #complex
+    v3=numpy.sqrt(ex0b**2.-1)  #exact result for v2v3
+    y=numpy.power((ex0b-v3)/(ex0b+v3),ncyc)
+    v2pPdN=(( complex(deltaR2+kex,dw) )*ex0c+(-oGt2-kge*t1pt2)*2*ex1c)     
   #off diagonal common factor. sinh fuctions
+    Tog=(((1+y)/2+(1-y)/(2*v3)*(v2pPdN)/N))
+    
Minty=Rpre-ncyc/(Trel)*numpy.arccosh((ex0b).real)-1/Trel*numpy.log((Tog.real))
  #estimate R2eff
+
+    # Loop over the time points, back calculating the R2eff values.
+    for i in range(num_points):
+
+        # The full formula.
+        back_calc[i] = Minty[i]


_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-commits mailing list
relax-commits@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="https://mail.gna.org/listinfo/relax-commits">https://mail.gna.org/listinfo/relax-commits</a>
</pre></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer">You are on the <a href="http://gna.org">Gna!</a> mail server.</div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Sun May 04 11:20:09 2014</div>  
</body>
</html>
