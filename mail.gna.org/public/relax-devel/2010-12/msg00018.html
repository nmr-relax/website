<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: CST branch -->
<!--X-From-R13: "Sqjneq q'Ohiretar" <rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Mon, 06 Dec 2010 19:10:24 +0100 -->
<!--X-Message-Id: AANLkTimthyxNok+Fsv94fnF8JVdia6VXJ6M0sDQYAAzT@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: p2l6052a51004080823g94a64268lf8af8d3e332c2a03@mail.gmail.com -->
<!--X-Reference: j2i7f080ed11004120000r80bba9bch9556be67b0c1707@mail.gmail.com -->
<!--X-Reference: g2v6052a51004131048sb5c01509sfc9a77045ad33310@mail.gmail.com -->
<!--X-Reference: r2g7f080ed11004131113mb209905eh63ff1eb61c171fee@mail.gmail.com -->
<!--X-Reference: l2q6052a51004301221h9ad09886ha016465129beb516@mail.gmail.com -->
<!--X-Reference: g2m7f080ed11005050153y2ad8b4bfjb4eb8191b0efd0cc@mail.gmail.com -->
<!--X-Reference: AANLkTin4nzkkOCxs94vUKCpT00R7ak22gLaL5rK&#45;VjPN@mail.gmail.com -->
<!--X-Reference: AANLkTinF4yNXoJQS&#45;rd81VBi3keRURUNeb&#45;_GdkxqqsG@mail.gmail.com -->
<!--X-Reference: AANLkTinibyBQvsoG1&#45;0vmzOXFmRJxD95VMF3eGxzSMMB@mail.gmail.com -->
<!--X-Reference: AANLkTimFT0&#45;Kbgdz_U5LeOW5Ln22mPBZBC8FL68n6CeF@mail.gmail.com -->
<!--X-Reference: AANLkTikhknBoHTc7B7GCRULkrEnxSx+PpqPP=x6KrDOH@mail.gmail.com -->
<!--X-Reference: AANLkTim0B&#45;E6kMW9Nn47o+u+atxrm38540u1Xhaoe6j0@mail.gmail.com -->
<!--X-Reference: AANLkTi=m5S08Nd1F5VDnMGTOu2s+j2Euz1t&#45;ytw0zOAf@mail.gmail.com -->
<!--X-Reference: AANLkTinxUWLu2N19dc3eaPgh22igv_SGy=6qmVnJN=Qj@mail.gmail.com -->
<!--X-Reference: AANLkTik0K3B7huKE8hJtAkXL_yzJmNa9BFxfczu8Sfx9@mail.gmail.com -->
<!--X-Reference: AANLkTin1JfUtMoVqR4c&#45;5dRHTf58N&#45;FAcv4_bc=LpH2b@mail.gmail.com -->
<!--X-Reference: AANLkTimBsSm504qysJd8&#45;e0O_thUdcwvciKrNhMTdoQW@mail.gmail.com -->
<!--X-Reference: AANLkTikf&#45;g23EPV+R2&#45;7inSpXbT5fqv5vDO8nL+DZrwA@mail.gmail.com -->
<!--X-Reference: AANLkTikNh5FTMmeQPqkSiX8ieG5oUw5UcuG83k8PeAiM@mail.gmail.com -->
<!--X-Reference: AANLkTimADCpNAJG4Pg02_UukH5hFW5eQfr&#45;SymzqXrc=@mail.gmail.com -->
<!--X-Reference: AANLkTi=8_288HiMhVQDwpFUCqMp+aBotECez44s44q7z@mail.gmail.com -->
<!--X-Reference: AANLkTi=vSTA2B&#45;jpTzShJab84W=&#45;z1YBzvhW10wTXg_P@mail.gmail.com -->
<!--X-Reference: AANLkTikXiEtqtDWOycdJdyYSG+KfxAARiXhtDwrQm_v+@mail.gmail.com -->
<!--X-Reference: AANLkTinWS1m+j069Y+sTXrae&#45;J5DamkkNTp&#45;Wx8u7OTX@mail.gmail.com -->
<!--X-Reference: AANLkTinNsF7fA3Va=&#45;63bYBE3EoOeZ21OOO8ZYunU0uR@mail.gmail.com -->
<!--X-Reference: AANLkTinw8sg3staDqr+=mBGqLgB0joQwKzKbFNGY_5sF@mail.gmail.com -->
<!--X-Reference: AANLkTi=aZJDUcj0+p_0Or_P1v3xwSvk=7=s=+DjHFRcA@mail.gmail.com -->
<!--X-Reference: AANLkTinB0kczjTRe5etQtviQ0p9sxu&#45;fmeh3FJ&#45;Lx6Pg@mail.gmail.com -->
<!--X-Reference: AANLkTikwqUH6Z&#45;NmxNmj02ysSaYYAQ_cuS5&#45;kJ6K4U5u@mail.gmail.com -->
<!--X-Reference: AANLkTikZXALuxeob=_YvJjE5&#45;ZyRrLTNqG&#45;wTf_nxgqf@mail.gmail.com -->
<!--X-Reference: AANLkTi=o2jzDfj+Y=WMMBTL=YpOT++n2X0sN=G4_S25+@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: CST branch -- December 06, 2010 - 19:10</title>
<link rel="stylesheet" type="text/css" href="/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="https://gna.org/images/gna.theme/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: CST branch</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00018" class="tabs">Index by Date</a> | <a href="threads.html#00018" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00017.html">Date Prev</a>] [<a href="msg00019.html">Date Next</a>] [<a href="msg00017.html">Thread Prev</a>] [<a href="msg00001.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: Pavel Kaderavek &lt;pavel.kaderavek@xxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Mon, 6 Dec 2010 19:10:12 +0100</li>
<li class="menuitem">
<em>Cc</em>: relax-devel@xxxxxxx</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=gamma;	h=domainkey-signature:mime-version:received:sender:received	:in-reply-to:references:date:x-google-sender-auth:message-id:subject	:from:to:cc:content-type:content-transfer-encoding;	bh=cnoeQcLRx+pvMX0TvKAS7VFnTopp0EeyFlq/7IAZ9Vg=;	b=VyPu2JGuyzOIILMlIL0b1B0x/Ew/Vx0SIyUY49R+JDXayVZ4bdz0Kh9jWLFeeC2XWq	hxcpGl2Qu77MMtmOtdHUvU82DAkk1OWrCck2O8tL9T+7ESwuX3Qshl0bptkO9RFKyOJo	XpsnXVvLI2BBuizBVwcL/QQ/8SE7xjUq8ZFkw=</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00018.html">AANLkTimthyxNok+Fsv94fnF8JVdia6VXJ6M0sDQYAAzT@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;p2l6052a51004080823g94a64268lf8af8d3e332c2a03@xxxxxxxxxxxxxx&gt;	&lt;j2i7f080ed11004120000r80bba9bch9556be67b0c1707@xxxxxxxxxxxxxx&gt;	&lt;g2v6052a51004131048sb5c01509sfc9a77045ad33310@xxxxxxxxxxxxxx&gt;	&lt;r2g7f080ed11004131113mb209905eh63ff1eb61c171fee@xxxxxxxxxxxxxx&gt;	&lt;l2q6052a51004301221h9ad09886ha016465129beb516@xxxxxxxxxxxxxx&gt;	&lt;g2m7f080ed11005050153y2ad8b4bfjb4eb8191b0efd0cc@xxxxxxxxxxxxxx&gt;	&lt;AANLkTin4nzkkOCxs94vUKCpT00R7ak22gLaL5rK-VjPN@xxxxxxxxxxxxxx&gt;	&lt;AANLkTinF4yNXoJQS-rd81VBi3keRURUNeb-_GdkxqqsG@xxxxxxxxxxxxxx&gt;	&lt;AANLkTinibyBQvsoG1-0vmzOXFmRJxD95VMF3eGxzSMMB@xxxxxxxxxxxxxx&gt;	&lt;AANLkTimFT0-Kbgdz_U5LeOW5Ln22mPBZBC8FL68n6CeF@xxxxxxxxxxxxxx&gt;	&lt;AANLkTikhknBoHTc7B7GCRULkrEnxSx+PpqPP=x6KrDOH@xxxxxxxxxxxxxx&gt;	&lt;AANLkTim0B-E6kMW9Nn47o+u+atxrm38540u1Xhaoe6j0@xxxxxxxxxxxxxx&gt;	&lt;AANLkTi=m5S08Nd1F5VDnMGTOu2s+j2Euz1t-ytw0zOAf@xxxxxxxxxxxxxx&gt;	&lt;AANLkTinxUWLu2N19dc3eaPgh22igv_SGy=6qmVnJN=Qj@xxxxxxxxxxxxxx&gt;	&lt;AANLkTik0K3B7huKE8hJtAkXL_yzJmNa9BFxfczu8Sfx9@xxxxxxxxxxxxxx&gt;	&lt;AANLkTin1JfUtMoVqR4c-5dRHTf58N-FAcv4_bc=LpH2b@xxxxxxxxxxxxxx&gt;	&lt;AANLkTimBsSm504qysJd8-e0O_thUdcwvciKrNhMTdoQW@xxxxxxxxxxxxxx&gt;	&lt;AANLkTikf-g23EPV+R2-7inSpXbT5fqv5vDO8nL+DZrwA@xxxxxxxxxxxxxx&gt;	&lt;AANLkTikNh5FTMmeQPqkSiX8ieG5oUw5UcuG83k8PeAiM@xxxxxxxxxxxxxx&gt;	&lt;AANLkTimADCpNAJG4Pg02_UukH5hFW5eQfr-SymzqXrc=@xxxxxxxxxxxxxx&gt;	&lt;AANLkTi=8_288HiMhVQDwpFUCqMp+aBotECez44s44q7z@xxxxxxxxxxxxxx&gt;	&lt;AANLkTi=vSTA2B-jpTzShJab84W=-z1YBzvhW10wTXg_P@xxxxxxxxxxxxxx&gt;	&lt;AANLkTikXiEtqtDWOycdJdyYSG+KfxAARiXhtDwrQm_v+@xxxxxxxxxxxxxx&gt;	&lt;AANLkTinWS1m+j069Y+sTXrae-J5DamkkNTp-Wx8u7OTX@xxxxxxxxxxxxxx&gt;	&lt;AANLkTinNsF7fA3Va=-63bYBE3EoOeZ21OOO8ZYunU0uR@xxxxxxxxxxxxxx&gt;	&lt;AANLkTinw8sg3staDqr+=mBGqLgB0joQwKzKbFNGY_5sF@xxxxxxxxxxxxxx&gt;	&lt;AANLkTi=aZJDUcj0+p_0Or_P1v3xwSvk=7=s=+DjHFRcA@xxxxxxxxxxxxxx&gt;	&lt;AANLkTinB0kczjTRe5etQtviQ0p9sxu-fmeh3FJ-Lx6Pg@xxxxxxxxxxxxxx&gt;	&lt;AANLkTikwqUH6Z-NmxNmj02ysSaYYAQ_cuS5-kJ6K4U5u@xxxxxxxxxxxxxx&gt;	&lt;AANLkTikZXALuxeob=_YvJjE5-ZyRrLTNqG-wTf_nxgqf@xxxxxxxxxxxxxx&gt;	&lt;AANLkTi=o2jzDfj+Y=WMMBTL=YpOT++n2X0sN=G4_S25+@xxxxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on December 06, 2010 - 19:10:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi,

The patch applied correctly, and I have committed it at r11705.  There
is a small bug with missing ':' character.  Again sorry for the mix up
and the delay due to the website hacking and downtime.

Regards,

Edward



On 6 December 2010 18:59, Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Ah, sorry I missed that.  I downloaded the file attached to the last
comment, and that was patch00003.  I didn't see that there was another
file in the listing at the bottom.

Cheers,

Edward



On 6 December 2010 18:21, Pavel Kaderavek &lt;pavel.kaderavek@xxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,
excuse me, but it seems to me that you looked at the patch00003, while we
uploaded patch00004. Changes introduced in patch00003 are already included
in the code when I apply &quot;svn up&quot; (I believe I did &quot;svn up&quot; before I 
created
patch00004).
Regards,
Pavel

On 3 December 2010 10:54, Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">

Hi,

The Gna! infrastructure is finally back.  It looks like nothing was
cracked.  So I can now apply your patch.  However there is a problem:

[edau@localhost cst]$ patch -p0 &lt; patch00003.bin
patching file maths_fns/mf.py
Reversed (or previously applied) patch detected!  Assume -R? [n] y
Hunk #1 succeeded at 40 (offset 1 line).
Hunk #2 FAILED at 56.
Hunk #3 FAILED at 253.
2 out of 3 hunks FAILED -- saving rejects to file maths_fns/mf.py.rej
[edau@localhost cst]$ svn st
?       patch00003.bin
?       svnmerge-commit-message.txt
?       .sconsign.dblite
?       maths_fns/mf.py.orig
?       maths_fns/relax_fit.so
?       maths_fns/mf.py.rej
M       maths_fns/mf.py
[edau@localhost cst]$ svn info
Path: .
URL: svn+ssh://bugman@xxxxxxxxxxx/svn/relax/branches/cst
Repository Root: svn+ssh://bugman@xxxxxxxxxxx/svn/relax
Repository UUID: b7916896-f9f9-0310-9fe5-b3996d8957d5
Revision: 11699
Node Kind: directory
Schedule: normal
Last Changed Author: bugman
Last Changed Rev: 11695
Last Changed Date: 2010-11-23 11:30:42 +0100 (Tue, 23 Nov 2010)

[edau@localhost cst]$

This looks like the patch is for an earlier revision of the branch.
Would you be able to 'svn up' and attach a new patch to the task
(<a  rel="nofollow" href="https://gna.org/task/?6397">https://gna.org/task/?6397</a>).

Cheers,

Edward




On 30 November 2010 18:21, Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,

I'll have to look at this patch later.  The Gna! website
(<a  rel="nofollow" href="http://gna.org">http://gna.org</a>) looks like it has been hacked, so I can't reach the
task to download the patch :S  Hopefully I can have it applied
tomorrow, but the next 2 days will be almost impossible for me due to
a day long meeting.

Cheers,

Edward



On 29 November 2010 23:28, Pavel Kaderavek &lt;pavel.kaderavek@xxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">This change is related to the task #6397 (<a  rel="nofollow" href="https://gna.org/task/?6397">https://gna.org/task/?6397</a>)

kada _at_ chemi _dot_ muni _dot_ cz

<a  rel="nofollow" href="https://mail.gna.org/public/relax-devel/2010-11/msg00001.html">https://mail.gna.org/public/relax-devel/2010-11/msg00001.html</a>
<a  rel="nofollow" href="https://gna.org/task/download.php?file_id=11449">https://gna.org/task/download.php?file_id=11449</a>

This patch includes change in  func_mf, func_local_tm, func_diff,
func_all,
dfunc_mf, dfunc_local_tm, dfunc_diff, dfunc_all, d2func_mf,
d2func_local_tm,
d2func_diff, d2func_all functions of class Mf in a file
maths_fns/mf.py.
Functions were modified in order to handle data for more interactions.

On 27 November 2010 09:25, Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">

Hi,

First make a backup copy just in case, then simply perform an 'svn up'
and then 'svn diff'.  This should work without clashes.  If there is a
clash, this is a normal part of software development.  This really
shouldn't be necessary.  But if you need to resolve a clash, you need
to edit the file and find the '&lt;&lt;&lt;&lt;&lt;', '=====', and '&gt;&gt;&gt;&gt;&gt;' marks.
This separates code from the old file and the new file for you to
manually edit and merge.  If it's too confusing, just ask again.

Cheers,

Edward


On 25 November 2010 19:25, Pavel Kaderavek &lt;pavel.kaderavek@xxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,

We prepared another set of changes according to discussion in:
<a  rel="nofollow" href="https://mail.gna.org/public/relax-devel/2010-11/msg00001.html">https://mail.gna.org/public/relax-devel/2010-11/msg00001.html</a>
and previous.

Normally, we use command &quot;svn diff&quot; to create a patch by comparing
new
code
and code of our branch in the repository. As the current changes are
applied
on the already patched version of the code (not present in the
current
repository revision of our branch obtained by &quot;svn up&quot;), we would
like
to
ask you how the patch should be created.

Regards,
Pavel


On 15 November 2010 19:21, Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">

Hi,

I'm now back from a few weeks holidays.  This is correct, a double
looping will be required.  I think this will still be efficient as
the
&quot;for k in xrange(self.num_interactions[0])&quot; loops are not very
expensive.  The alternative is to bring the &quot;for j in
xrange(data.total_num_params):&quot; loop, but this would duplicate
calculations and hence be even more expensive.  This will also be
required in the d2func_* methods as well.

On a different note, as the code is becoming more complex, I would
recommend for a future patch that &quot;data = self.data[0]&quot; so that we
always use &quot;self.data[0][k].dri_prime[j]&quot; for each element rather
than
&quot;data..dri_prime[j]&quot;.  This will help with debugging in the future
as
we could end up mixing the self.data elements.

Also for the Rex interaction, there are plans for the future to
allow
for it to be non-quadratic for situations closer to slow exchange
or
intermediate.  For slow exchange the interaction is then linear
with
field strength, and the value ranges from linear (alpha=1) to
quadratic (alpha=2).  So the alpha value between 1 and 2 might
become
an optimisable parameter and hence this interaction type will
become
more complex and require its own code paths.  So if this branch
separates out the Rex interaction, this would be of benefit to the
rest of relax.  Though the separation might be essential for the
powerful code restructuring currently anyway.

Cheers,

Edward




On 27 October 2010 20:45, Pavel Kaderavek
&lt;pavel.kaderavek@xxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,
sorry for a late response. Your suggestions seem reasonable. I
would
add
just a two comments.
1) We should keep as before not only ri_prime but probably also
chi2,
dchi2
and d2chi2 as well.
.
2)The consideration of Rex as an additional interaction is a one
of
the
suitable approaches and it fits the general idea. We have to
consider
that
it requires to add new interaction into the list of the
interactions
(
__init__ function in class Mf, file maths_fns/mf.py).
It might be done just within the __init__ function (class Mf,
file
maths_fns/mf.py). It will be based on the presence of Rex term
within
the
loaded variable param_types. The other possibility is to do it
before
calling this __init__ function (number of interactions is one of
its
arguments).

Then I address to discussion one additional problem related to
the
patch
in
the preparation. Within the  functions related to the
derivations:
dfunc_mf,
dfunc_local_tm, dfunc_all, dfunc_diff (class Mf, maths_fns/mf.py)
there
is a
small complication. It will be illustrated using  &quot;dfunc_mf&quot;
function
as
an
example. The original code is following:

        data = self.data[0]

        # Calculate the spectral density gradient components.
        if data.calc_djw_comps:
            data.calc_djw_comps(data, params)

        # Diffusion tensor correlation times.
        self.diff_data.calc_dti(data, self.diff_data)

        # Loop over the gradient.
        for j in xrange(data.total_num_params):
            # Calculate the spectral density gradients.
            if data.calc_djw[j]:
                data.djw = data.calc_djw[j](data, params, j)
            else:
                data.djw = data.djw * 0.0

            # Calculate the relaxation gradient components.
            data.create_dri_comps(data, params)

            # Calculate the R1, R2, and sigma_noe gradients.
            data.dri_prime[j] = data.create_dri_prime[j](data)

            # Loop over the relaxation values and modify the NOE
gradients.
            data.dri[j] = data.dri_prime[j]
            for m in xrange(data.num_ri):
                if data.create_dri[m]:
                    data.create_dri[m](data, m,
data.remap_table[m],
data.get_dr1, params, j)

            # Calculate the chi-squared gradient.
            data.dchi2[j] = dchi2_element(data.relax_data,
data.ri,
data.dri[j], data.errors)

If  the loop over interactions is incorporated, it is necessary
to do
it
before &quot;data.calc_djw_comps&quot; is calculated. However then we get
into
the
conflict with calculation of &quot;modification of NOE gradients&quot; and
also
calculation of &quot;dchi2&quot;. These quantities can be calculated only
when
contributions from all interactions has been already evaluated
(it is
similar to already discussed ri_prime). In this case it is
complicated
by
the presence of loop over fitted parameters. The possible
solution
would
be
to make the loop over the interactions the inner one. However
this
seems
to
require repeating the loop over interactions twice within the
code:

        data = self.data[0]

        # Loop over the interactions
        for k in xrange(self.num_interactions[0]):
            # Calculate the spectral density gradient components.
            if data[k].calc_djw_comps:
                data[k].calc_djw_comps(data[k], params)

            # Diffusion tensor correlation times.
            self.diff_data.calc_dti(data[k], self.diff_data)

        # Loop over the gradient.
        for j in xrange(data.total_num_params):
            # Loop over the interactions
            for k in xrange(self.num_interactions[0])
                # Calculate the spectral density gradients.
                if data[k].calc_djw[j]:
                    data[k].djw = data[k].calc_djw[j](data[k],
params,
j)
                else:
                    data[k].djw = data[k].djw * 0.0

                    # Calculate the relaxation gradient
components.
                    data[k].create_dri_comps(data[k], params)

                # Calculate the R1, R2, and sigma_noe gradients.
                data[k].dri_prime[j] =
data[k].create_dri_prime[j](data[k])
#
later
data[k].dri_prime[j] will be replaced by data.dri_prime[j]

                                                   # but you
suggest
not
to
include both changes into the following patch together


            # Loop over the relaxation values and modify the NOE
gradients.
            data.dri[j] = data.dri_prime[j]
            for m in xrange(data.num_ri):
                if data.create_dri[m]:
                    data.create_dri[m](data, m,
data.remap_table[m],
data.get_dr1, params, j)

                # Calculate the chi-squared gradient.
                data.dchi2[j] = dchi2_element(data.relax_data,
data.ri,
data.dri[j], data.errors)

Additionally I would notify that variable &quot;total_num_params&quot;
needs to
be
kept at the position self.data[0] (similar to your suggestion in
your
last
mail, concerning ri_prime)
What do you think about this?
Regards
Pavel

On 22 October 2010 19:46, Edward d'Auvergne
&lt;edward@xxxxxxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">

Hi,

This is a good idea.  First I would suggest putting this into 2
patches, as this is easier to check and apply.  Don't worry
about
breaking the code at this point - it is in your own special
branch
so
as long as it works in the end, you can smash it into a million
pieces
and put it back together again if you like.  Commits to the
repository
are better when they are many small ones, as they can be more
easily
managed.  For example if something is found to be designed not
ideally, or there is a fatal bug, that patch/commit can be
reverted
and then new code can be worked on.  And small patches make it
much
easier for the other relax developers to read and catch
potential
hidden bugs or design issues.

This is an intriguing problem, as the data flow hits a fork
here.
ri_prime is the correct target for the merging of the data from
all
the interactions, as this needs to occur before the calculation
of
the
NOE using sigma_noe and the R1.  The relaxation rates R1, R2,
and
sigma_noe add.  However the NOE does not.  I just thought I'd
explain
the logic for others to follow ;)

I would suggest we store ri_prime somewhere else.  What I can do
is
to
apply a patch for the first change to accommodate for the
multiple
relaxation interactions.  Then I could make a change myself,
creating
a special Python object for 'data[i]'.  We can store the
ri_prime
data
this special object.  Essentially, it will be like the current
code
base.  We could have specific interaction data in say:

self.data[10][0].jw  (or self.data[0].jw if data = self.data[i])

This is new.  But as before we could have:

self.data[10].ri_prime (or data.ri_prime if data = self.data[i])

So the forking can all be managed within the self.data[i] data
structures.  What do you think?  Also, we will have to work out
how
to
modify or replace func_ri_prime and func_ri_prime_rex in the
maths_fns.ri_prime module.  This is where the merging of data
streams
currently occurs.  Maybe Rex needs to be considered as its own
interaction, as this is added to produce ri_prime?

Regards,

Edward


P. S.  I just talked to Kathleen Hall and she seemed very
interested
in what you are doing here!



On 22 October 2010 18:26, Pavel Kaderavek
&lt;pavel.kaderavek@xxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,
I am continuing in the discussion started in my post
<a  rel="nofollow" href="https://mail.gna.org/public/relax-devel/2010-09/msg00020.html">https://mail.gna.org/public/relax-devel/2010-09/msg00020.html</a>
It covers changes of functions func_mf.py, func_local_tm ,
func_diff,
func_all and their equivalents for a first and second
derivatives
(class
Mf,
file maths_fns/mf.py).

I would like to include into next patch also treatment of the
fact,
that
it
is necessary to sum together contributions of all
interactions. It
seems
to
me that the most suitable way is to do that by the
modification
just
revised
functions (func_mf.py, func_local_tm ...)
I would suggest to initialize ri_prime before loop over
interactions
and
then step by step add the contributions into the ri_prime:

        data = self.data[i]                                  #
the
cases
when `i` is replaced by `0` were discussed in your last mail
        ri_prime=0


        for j in xrange(self.num_interactions[i]):

              ...
              ...

              # Calculate the R1, R2, and sigma_noe values.
              ri_prime = ri_prime +
data[j].create_ri_prime(data[j])

         data[0].ri_prime = ri_prime


When the loop over interactions is finished the accumulated
relaxation
rate
is copied into the data storage of the first interaction. Then
it
is
possible to call functions, where total ri_prime is needed:

        # Calculate the NOE values.
        data[0].ri = data[0].ri_prime * 1.0
        for m in xrange(data[0].num_ri):
            if data[0].create_ri[m]:
                data[0].create_ri[m](data[0], m,
data[0].remap_table[m],
data[0].get_r1, params)

        # Calculate the chi-squared value.
        data[0].chi2 = chi2(data[0].relax_data, data[0].ri,
data[0].errors)

Regards,
Pavel

On 19 October 2010 13:49, Edward d'Auvergne
&lt;edward@xxxxxxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">

Hi,

Sorry for the delay, I just came back from a 2 week holiday.
 This
is
correct, the func_mf, func_local_tm, etc. methods are working
on
a
single spin.  This is stored in self.data[0].  The other
functions
work on multiple spin data located in self.data[0],
self.data[1],
etc.

Regards,

Edward



On 14 October 2010 19:38, Pavel Kaderavek
&lt;pavel.kaderavek@xxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,

I would like to announce a small clarification of my
previous
mail
about
changes in functions func_mf, func_local_tm, func_diff,
func_all,
and
their
derivatives (class Mf, file maths_fns/mf.py). Loop
suggested in
my
last
post:


<a  rel="nofollow" href="https://mail.gna.org/public/relax-devel/2010-09/msg00020.html">https://mail.gna.org/public/relax-devel/2010-09/msg00020.html</a>

is valid just for the functions func_diff, func_all, and
their
equivalents
for a first and second derivatives.
While for the functions  func_mf, func_local_tm, and
corresponding
derivatives the index of self.num_interactions should be
set to
`0`
instead
of index `i`

        for j in xrange(self.num_interactions[0]):

(The rest of the loop remains the same)
That comes from the fact that these functions (func_mf,
func_local_tm,
...
) are called for each spin separately. As it is indicated
by
the
preceding
statement:

        data = self.data[0]

Regards,
Pavel

On 29 September 2010 10:53, Edward d'Auvergne
&lt;edward@xxxxxxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">

Hi,

This is the perfect approach.  It will abstract the
calculations
so
that we will not need to touch many of maths_fns modules.
 With
this
code in place, I would aim at then making the test suite
pass
again
by
having the correct data structures pass into maths_fns.mf.
 The
last
step would be to input CSA tensors and the multi-dipole
interactions
via user functions.  If you make a patch for all of the
func_*(),
dfunc_*(), and d2func_*() methods, I can check and apply
it
quickly.

Regards,

Edward


On 28 September 2010 12:07, Pavel Kaderavek
&lt;pavel.kaderavek@xxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,
we were thinking about next necessary changes in the CST
branch.

Now we need to break through the problem, which implies
the
fact
we
split
the relaxation rate calculation into contributions of
individual
interactions. Each of them has its own data class to
store
its
parameters
(so far called data[i][j], where the [i] was a spin
index
and
[j]
was
the
interaction index).

It seems to us, that it the best way to deal with it is
to
edit
functions:
func_mf, func_local_tm , func_diff, func_all and their
equivalents
for a
first and second derivatives (defined in mf.py file).

Within these functions the calculations of direction
cosines,
diffusion
tensor weight calculations, components of the spectral
densities
and
so
on
are performed. All these must be calculated for each
interaction
separately,
because each interaction has its own data storage (which
replaced
previously
used one data class container for the whole IS spin
system).

Instead of:


        # Direction cosine calculations.
        if self.diff_data.calc_di:
            self.diff_data.calc_di(data, self.diff_data)

        # Diffusion tensor weight calculations.
        self.diff_data.calc_ci(data, self.diff_data)

        # Diffusion tensor correlation times.
        self.diff_data.calc_ti(data, self.diff_data)

        # Calculate the components of the spectral
densities.
        if data.calc_jw_comps:
            data.calc_jw_comps(data, params)

        # Calculate the R1, R2, and sigma_noe values.
        data.ri_prime = data.create_ri_prime(data)


we would suggest to introduce a loop over interacations
        for j in xrange(self.num_interactions[i]):
            # Direction cosine calculations.
            if self.diff_data.calc_di:
                self.diff_data.calc_di(data[j],
self.diff_data)

            # Diffusion tensor weight calculations.
            self.diff_data.calc_ci(data[j],
self.diff_data)

            # Diffusion tensor correlation times.
            self.diff_data.calc_ti(data[j],
self.diff_data)

            # Calculate the components of the spectral
densities.
            if data.calc_jw_comps:
                data.calc_jw_comps(data[j], params)

            # Calculate the R1, R2, and sigma_noe
components.
            data.ri_prime =
data.create_ri_prime(data[j])


It must be accompanied in the next step by a change the
ri_prime
function so
that it just calculate only a product of specific
interaction
constant
and
corresponding linear combination of spectral densities.
While
the
final
sumation over all interactions should be done in a
separate
step.

Moreover it will be also necessary to distinguish within
the
function
setup_equation the type of equation used for
contribution of
individual
interactions according to their type.

Best
Pavel


On 10 September 2010 15:43, Edward d'Auvergne
&lt;edward@xxxxxxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">

Hi Pavel,

I missed it in the patches, but there were tab
characters
'\t'
causing
problems.  These are now fixed.  relax requires that a
tab
is
replaced
by 4 spaces.  I have also added you to the copyright
notices

(<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?view=rev&amp;revision=11543">http://svn.gna.org/viewcvs/relax?view=rev&amp;revision=11543</a>)
of
the
files you have modified.

Regards,

Edward

On 10 September 2010 15:36, Edward d'Auvergne
&lt;edward@xxxxxxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,

I've carefully checked the patches and committed them
with
the
messages you wrote.  Sorry again for the delays.  It
should
be
faster
now that I am no longer in the tropical wilderness of
far
north
Australia.

Regards,

Edward


On 6 September 2010 13:23, Edward d'Auvergne
&lt;edward@xxxxxxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Pavel,

Sorry for the delayed response.  I was at the ICMRBS
conference
in
Australia and then travelled through the tropical
north
end
of
Australia afterwards.  I came back yesterday out of
the
remote
wilderness and can soon start looking at this
patches.

Regards,

Edward


On 31 August 2010 18:00, Pavel Kaderavek
&lt;pavel.kaderavek@xxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,

some time ago, we submitted two patches regarding
CST
branch.
We
are
not
sure if we should wait for some additional comment
from
your
side,
or
we can
continue with introducing further changes in the
code.
Next step would be a splitting of the relaxation
equation
so
that
contribution to the relaxation due to the
individual
types
of
interaction
(dipole-dipole, CSA) can be calculated separately.


Regars,

Pavel, Petr

</pre></blockquote><pre style="margin: 0em;">

</pre></blockquote><pre style="margin: 0em;">

</pre></blockquote></blockquote><pre style="margin: 0em;">


</pre></blockquote></blockquote><pre style="margin: 0em;">


</pre></blockquote></blockquote><pre style="margin: 0em;">


</pre></blockquote></blockquote><pre style="margin: 0em;">


</pre></blockquote></blockquote><pre style="margin: 0em;">


</pre></blockquote></blockquote><pre style="margin: 0em;">


</pre></blockquote><pre style="margin: 0em;">

</pre></blockquote></blockquote><pre style="margin: 0em;">


</pre></blockquote><pre style="margin: 0em;">

</pre></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00000" href="msg00000.html">Re: CST branch</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00016" href="msg00016.html">Re: CST branch</a></strong>
<ul><li><em>From:</em> Pavel Kaderavek</li></ul></li>
<li><strong><a name="00017" href="msg00017.html">Re: CST branch</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer">You are on the <a href="http://gna.org">Gna!</a> mail server.</div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Wed Dec 08 19:20:10 2010</div>  
</body>
</html>
