<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: r23272 &#45; in /branches/disp_speed: lib/dispersion/dpl94.py target_functions/relax_disp.py -->
<!--X-From-R13: "Sqjneq q'Ohiretar" &#60;rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Wed, 21 May 2014 08:45:00 +0200 -->
<!--X-Message-Id: CAED9pY_9_Cq1ngqrLDpiCvJ6k&#45;FJnU8S2jQtRhfEwmoOzJhG5Q@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: E1WmqfQ&#45;00077l&#45;6S@subversion.gna.org -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: r23272 - in /branches/disp_speed: lib/dispersion/dpl94.py target_functions/relax_disp.py -- May 21, 2014 - 08:45</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: r23272 - in /branches/disp_speed: lib/dispersion/dpl94.py target_functions/relax_disp.py</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00401" class="tabs">Index by Date</a> | <a href="threads.html#00401" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00400.html">Date Prev</a>] [<a href="msg00402.html">Date Next</a>] [<a href="msg00400.html">Thread Prev</a>] [<a href="msg00403.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Wed, 21 May 2014 08:44:09 +0200</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:date:message-id:subject :from:to:content-type:content-transfer-encoding; bh=KhKs2/kPZr5eOm3u6g8ybci1bpvexPKYDNc5Xtu4YMM=; b=MNkiuicEIaiMCiOpxJ1le4nXH6ZsNF2GhYLp630cZJqSZ2Clz2K+8cRZvT3Ev+VzRj T8yZTRQC9eVIzxLNRHYSPLdCn+5gzXA4B3Bg/xCTiUoKBIO6ZBOHmnt4DeIgapzsa1i7 WJE8CZ2dHufUigROwd5/toeoA8j46fpiFtp0hmGmyAZNOgE9bamA23EL/mNjxaFDeGtY mJ+UP5SycNfW1/iTaALm2/Me9QSpRfgdj1uGhIPlBGIM4grVXFCBIG3ihXTgKIO0x1/d uVM0NK7WTQWqHPgn4YVBuy1Wm6yE7+3fl581TLP77NZAspQNrsqtC9INoqf3+1K6oT7j w/lQ==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00401.html">CAED9pY_9_Cq1ngqrLDpiCvJ6k-FJnU8S2jQtRhfEwmoOzJhG5Q@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;E1WmqfQ-00077l-6S@subversion.gna.org&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on May 21, 2014 - 08:45:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi Troels,

In this change, you are checking if:

kex^2 + spin_lock_fields^2 == 0.0

Here kex can be zero, but the spin-lock field should not be.  Well, I
don't think so, but maybe the interpolated plotting does this.  Do we
need a check added at all?  Did you see a numpy warning?  If not, such
checks will just make the code slower.  Such an example is why it
would have been useful to separate out the API change from the math
domain error checking change.

Regards,

Edward





On 20 May 2014 22:29,  &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Author: tlinnet
Date: Tue May 20 22:29:43 2014
New Revision: 23272

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=23272&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=23272&amp;view=rev</a>
Log:
Math-domain catching for model DPL94.

task #7793: (<a  rel="nofollow" href="https://web.archive.org/web/https://gna.org/task/?7793">https://gna.org/task/?7793</a>) Speed-up of dispersion models.

This is to implement catching of math domain errors, before they occur.
These can be found via the --numpy-raise function to the systemtests.

To make the code look clean, the class object &quot;back_calc&quot; is no longer
being updated per time point, but is updated in the relax_disp target 
function in
one go.

Modified:
    branches/disp_speed/lib/dispersion/dpl94.py
    branches/disp_speed/target_functions/relax_disp.py

Modified: branches/disp_speed/lib/dispersion/dpl94.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/disp_speed/lib/dispersion/dpl94.py?rev=23272&amp;r1=23271&amp;r2=23272&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/disp_speed/lib/dispersion/dpl94.py?rev=23272&amp;r1=23271&amp;r2=23272&amp;view=diff</a>
==============================================================================
--- branches/disp_speed/lib/dispersion/dpl94.py (original)
+++ branches/disp_speed/lib/dispersion/dpl94.py Tue May 20 22:29:43 2014
@@ -63,10 +63,10 @@
 &quot;&quot;&quot;

 # Python module imports.
-from numpy import array, cos, isfinite, sin, sum
+from numpy import abs, array, cos, isfinite, min, sin, sum


-def r1rho_DPL94(r1rho_prime=None, phi_ex=None, kex=None, theta=None, 
R1=0.0, spin_lock_fields2=None, back_calc=None, num_points=None):
+def r1rho_DPL94(r1rho_prime=None, phi_ex=None, kex=None, theta=None, 
R1=0.0, spin_lock_fields2=None, num_points=None):
     &quot;&quot;&quot;Calculate the R1rho values for the DPL94 model.

     See the module docstring for details.
@@ -84,9 +84,7 @@
     @type R1:                   float
     @keyword spin_lock_fields2: The R1rho spin-lock field strengths 
squared (in rad^2.s^-2).
     @type spin_lock_fields2:    numpy rank-1 float array
-    @keyword back_calc:         The array for holding the back calculated 
R1rho values.  Each element corresponds to one of the spin-lock fields.
-    @type back_calc:            numpy rank-1 float array
-    @keyword num_points:        The number of points on the dispersion 
curve, equal to the length of the spin_lock_fields and back_calc arguments.
+    @keyword num_points:        The number of points on the dispersion 
curve, equal to the length of the spin_lock_fields.
     @type num_points:           int
     &quot;&quot;&quot;

@@ -103,6 +101,13 @@
     # Denominator.
     denom = kex2 + spin_lock_fields2

+    # Catch math domain error of dividing with 0.
+    # This is when denom =0.
+    if min(abs(denom)) == 0:
+        R1rho = array([1e100]*num_points)
+
+        return R1rho
+
     # R1rho calculation.
     R1rho = R1_R2 + numer / denom

@@ -111,6 +116,4 @@
     if not isfinite(sum(R1rho)):
         R1rho = array([1e100]*num_points)

-    # Parse back the value to update the back_calc class object.
-    for i in range(num_points):
-        back_calc[i] = R1rho[i]
+    return R1rho

Modified: branches/disp_speed/target_functions/relax_disp.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/disp_speed/target_functions/relax_disp.py?rev=23272&amp;r1=23271&amp;r2=23272&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/disp_speed/target_functions/relax_disp.py?rev=23272&amp;r1=23271&amp;r2=23272&amp;view=diff</a>
==============================================================================
--- branches/disp_speed/target_functions/relax_disp.py  (original)
+++ branches/disp_speed/target_functions/relax_disp.py  Tue May 20 22:29:43 
2014
@@ -965,7 +965,7 @@
                 # Loop over the offsets.
                 for oi in range(self.num_offsets[0][si][mi]):
                     # Back calculate the R2eff values.
-                    r1rho_DPL94(r1rho_prime=R20[r20_index], 
phi_ex=phi_ex_scaled, kex=kex, theta=self.tilt_angles[0][si][mi][oi], 
R1=self.r1[si, mi], 
spin_lock_fields2=self.spin_lock_omega1_squared[0][mi][oi], 
back_calc=self.back_calc[0][si][mi][oi], 
num_points=self.num_disp_points[0][si][mi][oi])
+                    self.back_calc[0][si][mi][oi] = 
r1rho_DPL94(r1rho_prime=R20[r20_index], phi_ex=phi_ex_scaled, kex=kex, 
theta=self.tilt_angles[0][si][mi][oi], R1=self.r1[si, mi], 
spin_lock_fields2=self.spin_lock_omega1_squared[0][mi][oi], 
num_points=self.num_disp_points[0][si][mi][oi])

                     # For all missing data points, set the back-calculated 
value to the measured values so that it has no effect on the chi-squared 
value.
                     for di in range(self.num_disp_points[0][si][mi][oi]):


_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-commits mailing list
relax-commits@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="https://mail.gna.org/listinfo/relax-commits">https://mail.gna.org/listinfo/relax-commits</a>
</pre></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Wed May 21 09:00:18 2014</div>  
</body>
</html>
