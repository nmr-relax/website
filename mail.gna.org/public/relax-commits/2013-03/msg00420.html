<!-- MHonArc v2.6.16 -->
<!--X-Subject: r19002 &#45; in /trunk: auto_analyses/frame_order.py	specific_fns/frame_order.py user_functions/frame_order.py -->
<!--X-From-R13: rqjneqNaze&#45;erynk.pbz -->
<!--X-Date: Fri, 22 Mar 2013 17:34:27 +0100 -->
<!--X-Message-Id: E1UJ4vD&#45;0001uS&#45;CD@subversion.gna.org -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>r19002 - in /trunk: auto_analyses/frame_order.py	specific_fns/frame_order.py user_functions/frame_order.py -- March 22, 2013 - 17:34</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />r19002 - in /trunk: auto_analyses/frame_order.py	specific_fns/frame_order.py user_functions/frame_order.py</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00420" class="tabs">Index by Date</a> | <a href="threads.html#00420" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00419.html">Date Prev</a>] [<a href="msg00421.html">Date Next</a>] [<a href="msg00419.html">Thread Prev</a>] [<a href="msg00421.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: relax-commits@xxxxxxx</li>
<li class="menuitem">
<em>Date</em>: Fri, 22 Mar 2013 16:34:27 -0000</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00420.html">E1UJ4vD-0001uS-CD@subversion.gna.org</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>edward</strong> on March 22, 2013 - 17:34:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Author: bugman
Date: Fri Mar 22 17:34:27 2013
New Revision: 19002

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=19002&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=19002&amp;view=rev</a>
Log:
Next block of the manual merger of the frame_order_testing branch.

The commands used were:
svn merge -r18860:18861 
svn+ssh://bugman@xxxxxxxxxxx/svn/relax/branches/frame_order_testing .
svn merge -r18861:18862 
svn+ssh://bugman@xxxxxxxxxxx/svn/relax/branches/frame_order_testing .
svn merge -r18862:18863 
svn+ssh://bugman@xxxxxxxxxxx/svn/relax/branches/frame_order_testing .
svn merge -r18863:18864 
svn+ssh://bugman@xxxxxxxxxxx/svn/relax/branches/frame_order_testing .
svn merge -r18864:18865 
svn+ssh://bugman@xxxxxxxxxxx/svn/relax/branches/frame_order_testing .

The console messages were:
[edau@localhost relax-trunk]$ svn merge -r18860:18861 
svn+ssh://bugman@xxxxxxxxxxx/svn/relax/branches/frame_order_testing .
--- Merging r18861 into '.':
U    auto_analyses/frame_order.py
[edau@localhost relax-trunk]$ svn merge -r18861:18862 
svn+ssh://bugman@xxxxxxxxxxx/svn/relax/branches/frame_order_testing .
--- Merging r18862 into '.':
G    auto_analyses/frame_order.py
[edau@localhost relax-trunk]$ svn merge -r18862:18863 
svn+ssh://bugman@xxxxxxxxxxx/svn/relax/branches/frame_order_testing .
--- Merging r18863 into '.':
U    specific_fns/frame_order.py
U    user_functions/frame_order.py
[edau@localhost relax-trunk]$ svn merge -r18863:18864 
svn+ssh://bugman@xxxxxxxxxxx/svn/relax/branches/frame_order_testing .
--- Merging r18864 into '.':
G    specific_fns/frame_order.py
[edau@localhost relax-trunk]$ svn merge -r18864:18865 
svn+ssh://bugman@xxxxxxxxxxx/svn/relax/branches/frame_order_testing .
--- Merging r18865 into '.':
G    specific_fns/frame_order.py
[edau@localhost relax-trunk]$


Modified:
    trunk/auto_analyses/frame_order.py
    trunk/specific_fns/frame_order.py
    trunk/user_functions/frame_order.py

Modified: trunk/auto_analyses/frame_order.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/trunk/auto_analyses/frame_order.py?rev=19002&amp;r1=19001&amp;r2=19002&amp;view=diff">http://svn.gna.org/viewcvs/relax/trunk/auto_analyses/frame_order.py?rev=19002&amp;r1=19001&amp;r2=19002&amp;view=diff</a>
==============================================================================
--- trunk/auto_analyses/frame_order.py (original)
+++ trunk/auto_analyses/frame_order.py Fri Mar 22 17:34:27 2013
@@ -129,7 +129,7 @@
         # Execute the full protocol.
         try:
             # The nested model optimisation protocol.
-            self.optimise()
+            self.nested_models()
 
             # The final results does not already exist.
             if not self.read_results(model='final', pipe_name='final'):
@@ -148,10 +148,10 @@
                 self.interpreter.monte_carlo.error_analysis()
 
                 # Finish.
-                self.interpreter.results.write(file='results', force=True)
-
-            # Results visualisation.
-            self.visualisation()
+                self.interpreter.results.write(file='results', 
dir=self.results_dir+'final', force=True)
+
+            # Visualisation of the final results.
+            self.visualisation(model='final')
 
         # Clean up.
         finally:
@@ -159,7 +159,7 @@
             status.exec_lock.release()
 
         # Save the final program state.
-        self.interpreter.state.save('final_state', force=True)
+        self.interpreter.state.save('final_state', dir=self.results_dir, 
force=True)
 
 
     def check_vars(self):
@@ -316,7 +316,7 @@
             cdp.cone_theta_y = pipe.cone_theta
 
 
-    def optimise(self):
+    def nested_models(self):
         &quot;&quot;&quot;Protocol for the nested optimisation of the frame order models.&quot;&quot;&quot;
 
         # First optimise the rigid model using all data.
@@ -343,6 +343,9 @@
                 # Re-perform model elimination just in case.
                 self.interpreter.eliminate()
 
+                # The PDB representation of the model and visualisation 
script (in case this was not completed correctly).
+                self.visualisation(model=model)
+
                 # Skip to the next model.
                 continue
 
@@ -384,7 +387,10 @@
             self.interpreter.eliminate()
 
             # Save the results.
-            self.interpreter.results.write(dir=model, force=True)
+            self.interpreter.results.write(dir=self.results_dir+model, 
force=True)
+
+            # The PDB representation of the model and visualisation script.
+            self.visualisation(model=model)
 
 
     def optimise_rigid(self):
@@ -406,6 +412,10 @@
 
         # The results file already exists, so read its contents instead.
         if self.read_results(model=model, 
pipe_name=self.pipe_name_dict[model]):
+            # The PDB representation of the model (in case this was not 
completed correctly).
+            
self.interpreter.frame_order.pdb_model(dir=self.results_dir+model, force=True)
+
+            # Nothing more to do.
             return
 
         # Create the data pipe using the full data set, and switch to it.
@@ -439,7 +449,10 @@
         self.print_results()
 
         # Save the results.
-        self.interpreter.results.write(dir=model, force=True)
+        self.interpreter.results.write(dir=self.results_dir+model, 
force=True)
+
+        # The PDB representation of the model.
+        self.interpreter.frame_order.pdb_model(dir=self.results_dir+model, 
force=True)
 
 
     def print_results(self):
@@ -538,7 +551,7 @@
         &quot;&quot;&quot;
 
         # The file name.
-        path = model + sep + 'results.bz2'
+        path = self.results_dir + model + sep + 'results.bz2'
 
         # The file does not exist.
         if not access(path, F_OK):
@@ -557,37 +570,33 @@
         return True
 
 
-    def visualisation(self):
-        &quot;&quot;&quot;Create visual representations of the frame order results.
+    def visualisation(self, model=None):
+        &quot;&quot;&quot;Create visual representations of the frame order results for the 
given model.
 
         This includes a PDB representation of the motions (the 'cone.pdb' 
file located in each model directory) together with a relax script for 
displaying the average domain positions together with the cone/motion 
representation in PyMOL (the 'pymol_display.py' file, also created in the 
model directory).
+
+        @keyword model:     The frame order model to visualise.  This should 
match the model of the current data pipe, unless the special value of 'final' 
is used to indicate the visualisation of the final results.
+        @type model:        str
         &quot;&quot;&quot;
 
-        # Loop over all models.
-        for pipe_name in self.pipe_name_list + ['final']:
-            # Switch to the data pipe.
-            self.interpreter.pipe.switch(pipe_name)
-
-            # The directory to place files into.
-            if pipe_name == 'final':
-                results_dir = pipe_name
-            else:
-                results_dir = cdp.model
-
-            # Create a PDB file representation of the motions.
-            self.interpreter.frame_order.pdb_model(file='frame_order.pdb', 
dist_file='frame_order_distribution.pdb', dir=results_dir, force=True)
-
-            # Create the visualisation script.
-            script = open_write_file(file_name='pymol_display.py', 
dir=results_dir, force=True)
-
-            # Add a comment for the user.
-            script.write(&quot;# relax script for displaying the frame order 
results of this '%s' model in PyMOL.\n\n&quot; % results_dir)
-
-            # The script contents.
-            script.write(&quot;# PyMOL visualisation.\n&quot;)
-            script.write(&quot;pymol.view()\n&quot;)
-            script.write(&quot;pymol.command('show spheres')\n&quot;)
-            script.write(&quot;pymol.frame_order(file='frame_order.pdb', 
dist_file='frame_order_distribution.pdb')\n&quot;)
-
-            # Close the file.
-            script.close()
+        # Sanity check.
+        if model != 'final' and model != cdp.model:
+            raise RelaxError(&quot;The model '%s' does not match the model '%s' 
of the current data pipe.&quot; % (model, cdp.model))
+
+        # The PDB representation of the model.
+        self.interpreter.frame_order.pdb_model(dir=self.results_dir+model, 
force=True)
+
+        # Create the visualisation script.
+        script = open_write_file(file_name='pymol_display.py', 
dir=self.results_dir+model, force=True)
+
+        # Add a comment for the user.
+        script.write(&quot;# relax script for displaying the frame order results 
of this '%s' model in PyMOL.\n\n&quot; % model)
+
+        # The script contents.
+        script.write(&quot;# PyMOL visualisation.\n&quot;)
+        script.write(&quot;pymol.view()\n&quot;)
+        script.write(&quot;pymol.command('show spheres')\n&quot;)
+        script.write(&quot;pymol.frame_order(file='frame_order.pdb', 
dist_file='frame_order_distribution.pdb')\n&quot;)
+
+        # Close the file.
+        script.close()

Modified: trunk/specific_fns/frame_order.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/trunk/specific_fns/frame_order.py?rev=19002&amp;r1=19001&amp;r2=19002&amp;view=diff">http://svn.gna.org/viewcvs/relax/trunk/specific_fns/frame_order.py?rev=19002&amp;r1=19001&amp;r2=19002&amp;view=diff</a>
==============================================================================
--- trunk/specific_fns/frame_order.py (original)
+++ trunk/specific_fns/frame_order.py Fri Mar 22 17:34:27 2013
@@ -946,30 +946,66 @@
         return num
 
 
-    def _pdb_model(self, file=None, dist_file=None, dir=None, size=30.0, 
inc=36, force=False, neg_cone=True):
-        &quot;&quot;&quot;Create a PDB file containing a geometric object representing the 
Frame Order cone models.
-
-        @keyword file:      The name of the file of the PDB representation 
of the frame order dynamics to create.
-        @type file:         str
-        @keyword dist_file: The name of the file which will contain multiple 
models spanning the full dynamics distribution of the frame order model.
-        @type dist_file:    str
-        @keyword dir:       The name of the directory to place the PDB file 
into.
-        @type dir:          str
-        @keyword size:      The size of the geometric object in Angstroms.
-        @type size:         float
-        @keyword inc:       The number of increments for the filling of the 
cone objects.
-        @type inc:          int
-        @keyword force:     Flag which if set to True will cause any 
pre-existing file to be overwritten.
-        @type force:        bool
-        @keyword neg_cone:  A flag which if True will cause the negative 
cone to be added to the representation.
-        @type neg_cone:     bool
-        &quot;&quot;&quot;
-
-        # Test if the current data pipe exists.
-        pipes.test()
-
-        # Negative cone flag.
-        neg_cone = True
+    def _pdb_ave_pos(self, file=None, dir=None, force=False):
+        &quot;&quot;&quot;Create a PDB file of the molecule with the moving domains shifted 
to the average position.
+
+        @keyword file:  The name of the file for the average molecule 
structure.
+        @type file:     str
+        @keyword dir:   The name of the directory to place the PDB file into.
+        @type dir:      str
+        @keyword force: Flag which if set to True will cause any 
pre-existing file to be overwritten.
+        @type force:    bool
+        &quot;&quot;&quot;
+
+        # Make a copy of the structural object (so as to preserve the 
original structure).
+        structure = deepcopy(cdp.structure)
+
+        # First rotate the moving domain to the average position.
+        R = zeros((3, 3), float64)
+        if hasattr(cdp, 'ave_pos_alpha'):
+            euler_to_R_zyz(cdp.ave_pos_alpha, cdp.ave_pos_beta, 
cdp.ave_pos_gamma, R)
+        else:
+            euler_to_R_zyz(0.0, cdp.ave_pos_beta, cdp.ave_pos_gamma, R)
+        structure.rotate(R=R, origin=cdp.pivot, 
atom_id=self._domain_moving())
+
+        # Then translate the moving domain.
+        if not self._translation_fixed():
+            structure.translate(T=[cdp.ave_pos_x, cdp.ave_pos_y, 
cdp.ave_pos_z], atom_id=self._domain_moving())
+
+        # Write out the PDB file.
+        file = open_write_file(file_name=file, dir=dir, force=force)
+        structure.write_pdb(file=file)
+        file.close()
+
+
+    def _pdb_distribution(self, file=None, dir=None, force=False):
+        &quot;&quot;&quot;Create a PDB file of a distribution of positions coving the full 
dynamics of the moving domain.
+
+        @keyword file:  The name of the file which will contain multiple 
models spanning the full dynamics distribution of the frame order model.
+        @type file:     str
+        @keyword dir:   The name of the directory to place the PDB file into.
+        @type dir:      str
+        @keyword force: Flag which if set to True will cause any 
pre-existing file to be overwritten.
+        @type force:    bool
+        &quot;&quot;&quot;
+
+
+    def _pdb_geometric_rep(self, file=None, dir=None, size=30.0, inc=36, 
force=False, neg_cone=True):
+        &quot;&quot;&quot;Create a PDB file containing a geometric object representing the 
frame order dynamics.
+
+        @keyword file:          The name of the file of the PDB 
representation of the frame order dynamics to create.
+        @type file:             str
+        @keyword dir:           The name of the directory to place the PDB 
file into.
+        @type dir:              str
+        @keyword size:          The size of the geometric object in 
Angstroms.
+        @type size:             float
+        @keyword inc:           The number of increments for the filling of 
the cone objects.
+        @type inc:              int
+        @keyword force:         Flag which if set to True will cause any 
pre-existing file to be overwritten.
+        @type force:            bool
+        @keyword neg_cone:      A flag which if True will cause the negative 
cone to be added to the representation.
+        @type neg_cone:         bool
+        &quot;&quot;&quot;
 
         # Monte Carlo simulation flag.
         sim = False
@@ -1142,6 +1178,44 @@
         pdb_file = open_write_file(file, dir, force=force)
         structure.write_pdb(pdb_file)
         pdb_file.close()
+
+
+    def _pdb_model(self, ave_pos_file=&quot;ave_pos.pdb&quot;, 
rep_file=&quot;frame_order.pdb&quot;, dist_file=&quot;domain_distribution.pdb&quot;, dir=None, 
size=30.0, inc=36, force=False, neg_cone=True):
+        &quot;&quot;&quot;Create 3 different PDB files for representing the frame order 
dynamics of the system.
+
+        @keyword ave_pos_file:  The name of the file for the average 
molecule structure.
+        @type ave_pos_file:     str
+        @keyword rep_file:      The name of the file of the PDB 
representation of the frame order dynamics to create.
+        @type rep_file:         str
+        @keyword dist_file:     The name of the file which will contain 
multiple models spanning the full dynamics distribution of the frame order 
model.
+        @type dist_file:        str
+        @keyword dir:           The name of the directory to place the PDB 
file into.
+        @type dir:              str
+        @keyword size:          The size of the geometric object in 
Angstroms.
+        @type size:             float
+        @keyword inc:           The number of increments for the filling of 
the cone objects.
+        @type inc:              int
+        @keyword force:         Flag which if set to True will cause any 
pre-existing file to be overwritten.
+        @type force:            bool
+        @keyword neg_cone:      A flag which if True will cause the negative 
cone to be added to the representation.
+        @type neg_cone:         bool
+        &quot;&quot;&quot;
+
+        # Test if the current data pipe exists.
+        pipes.test()
+
+        # Create the average position structure.
+        self._pdb_ave_pos(file=ave_pos_file, dir=dir, force=force)
+
+        # Nothing more to do for the rigid model.
+        if cdp.model == 'rigid':
+            return
+
+        # Create the geometric representation.
+        self._pdb_geometric_rep(file=rep_file, dir=dir, size=size, inc=inc, 
force=force, neg_cone=neg_cone)
+
+        # Create the distribution.
+        self._pdb_distribution(file=dist_file, dir=dir, force=force)
 
 
     def _pivot(self, pivot=None, fix=None):

Modified: trunk/user_functions/frame_order.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/trunk/user_functions/frame_order.py?rev=19002&amp;r1=19001&amp;r2=19002&amp;view=diff">http://svn.gna.org/viewcvs/relax/trunk/user_functions/frame_order.py?rev=19002&amp;r1=19001&amp;r2=19002&amp;view=diff</a>
==============================================================================
--- trunk/user_functions/frame_order.py (original)
+++ trunk/user_functions/frame_order.py Fri Mar 22 17:34:27 2013
@@ -98,18 +98,28 @@
 uf.title = &quot;Create a PDB file representation of the frame order dynamics.&quot;
 uf.title_short = &quot;Frame order dynamics PDB representation.&quot;
 uf.add_keyarg(
-    name = &quot;file&quot;,
-    default = &quot;frame_order.pdb&quot;,
+    name = &quot;ave_pos_file&quot;,
+    default = &quot;ave_pos.pdb&quot;,
     py_type = &quot;str&quot;,
     arg_type = &quot;file sel&quot;,
-    desc_short = &quot;file name&quot;,
-    desc = &quot;The name of the file of the PDB representation of the frame 
order dynamics to create.&quot;,
+    desc_short = &quot;average structure file name&quot;,
+    desc = &quot;The name of the 3D structure PDB file for the molecular 
structure with the moving domains shifted to the average position.&quot;,
     wiz_filesel_wildcard = &quot;PDB files (*.pdb)|*.pdb;*.PDB&quot;,
     wiz_filesel_style = FD_SAVE
 )
 uf.add_keyarg(
+    name = &quot;rep_file&quot;,
+    default = &quot;frame_order.pdb&quot;,
+    py_type = &quot;str&quot;,
+    arg_type = &quot;file sel&quot;,
+    desc_short = &quot;PDB representation file name&quot;,
+    desc = &quot;The name of the PDB file for the geometric object representation 
of the frame order dynamics.&quot;,
+    wiz_filesel_wildcard = &quot;PDB files (*.pdb)|*.pdb;*.PDB&quot;,
+    wiz_filesel_style = FD_SAVE
+)
+uf.add_keyarg(
     name = &quot;dist_file&quot;,
-    default = &quot;frame_order_distribution.pdb&quot;,
+    default = &quot;domain_distribution.pdb&quot;,
     py_type = &quot;str&quot;,
     arg_type = &quot;file sel&quot;,
     desc_short = &quot;distribution file name&quot;,



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Fri Mar 22 17:40:02 2013</div>  
</body>
</html>
