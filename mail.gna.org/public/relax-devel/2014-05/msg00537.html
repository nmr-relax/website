<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: [task #7793] Speed&#45;up of dispersion models -->
<!--X-From-R13: Febryf Szgrxæe Zvaarg &#60;gyvaargNaze&#45;erynk.pbz> -->
<!--X-Date: Wed, 28 May 2014 13:04:19 +0200 -->
<!--X-Message-Id: CA+CBx2O5i6ZZihS4EgGTW4efqmM=oBPF3=8GpsfxTR1NhDfjjQ@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20140510&#45;164954.sv20529.59902@gna.org -->
<!--X-Reference: 20140519&#45;021026.sv20529.52272@gna.org -->
<!--X-Reference: 20140519&#45;084652.sv20529.53544@gna.org -->
<!--X-Reference: 20140520&#45;193658.sv20529.25377@gna.org -->
<!--X-Reference: 20140526&#45;234210.sv20529.39552@gna.org -->
<!--X-Reference: 20140527&#45;150113.sv20529.12143@gna.org -->
<!--X-Reference: 20140527&#45;153656.sv20529.17793@gna.org -->
<!--X-Reference: 20140527&#45;154258.sv20529.22412@gna.org -->
<!--X-Reference: 20140527&#45;173400.sv20529.75118@gna.org -->
<!--X-Reference: 20140528&#45;094937.sv2782.83458@gna.org -->
<!--X-Reference: 20140528&#45;095339.sv2782.95150@gna.org -->
<!--X-Reference: CA+CBx2NhryC8e52eJgZJBZ54eCN23KeRS8Ah8oqW&#45;atBLMfQmA@mail.gmail.com -->
<!--X-Reference: CAED9pY8WpcMefqf=6p3drbjxPDQR3TbRi6A&#45;4Q9rYYhetEtW9A@mail.gmail.com -->
<!--X-Reference: CA+CBx2N=bh+xfPEnHxJ4VTa+gOTd451N7WSkoWFFrzc0B6hHag@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: [task #7793] Speed-up of dispersion models -- May 28, 2014 - 13:04</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: [task #7793] Speed-up of dispersion models</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00537" class="tabs">Index by Date</a> | <a href="threads.html#00537" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00536.html">Date Prev</a>] [<a href="msg00538.html">Date Next</a>] [<a href="msg00533.html">Thread Prev</a>] [<a href="msg00557.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;Edward d'Auvergne&quot; &lt;edward@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Wed, 28 May 2014 13:03:07 +0200</li>
<li class="menuitem">
<em>Cc</em>: Edward d Auvergne &lt;NO-REPLY.INVALID-ADDRESS@xxxxxxx&gt;, &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:from:date:message-id :subject:to:cc:content-type:content-transfer-encoding; bh=J6N/uThLXRrnuHNGGx1FPPHGt73ceyt23yGsuwuVB/U=; b=nBWeKQmvt/ZJ9n78NIyFh+aRKU3BcxezDHkrF11Dux7TTIr6lMyD+m9yTwl3QNvAjb T63PbLG05c1CdibzY43XPV8kLcSJjtNJEukpMxeLj50BXpn8tiwl+yCkj/k/Wxr4dzdV MR8hGUG4CVx2RopbyIEqQTx1zRrltvNpRa2j1C0zBqCHKF91revLWnVB1D38+74FMEHI jKqnuWbCkVCMVt6qEpeAh+Ig2N5Ohh3hjaE20q22IAYvr0m3gvBVmDZ36rY+Qa7xmLoZ JO+Jod2YoXctAhvjDrI6J5+QMGL8+1bhVCIJ02GRPKXFAFifTOGYxNs/rTJC19Nb3LfG AKDg==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;CA+CBx2O5i6ZZihS4EgGTW4efqmM=oBPF3=8GpsfxTR1NhDfjjQ@mail.gmail.com&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;<a href="msg00299.html">20140510-164954.sv20529.59902@gna.org</a>&gt; &lt;<a href="msg00343.html">20140519-021026.sv20529.52272@gna.org</a>&gt; &lt;<a href="msg00354.html">20140519-084652.sv20529.53544@gna.org</a>&gt; &lt;<a href="msg00399.html">20140520-193658.sv20529.25377@gna.org</a>&gt; &lt;<a href="msg00490.html">20140526-234210.sv20529.39552@gna.org</a>&gt; &lt;<a href="msg00504.html">20140527-150113.sv20529.12143@gna.org</a>&gt; &lt;<a href="msg00506.html">20140527-153656.sv20529.17793@gna.org</a>&gt; &lt;<a href="msg00507.html">20140527-154258.sv20529.22412@gna.org</a>&gt; &lt;<a href="msg00513.html">20140527-173400.sv20529.75118@gna.org</a>&gt; &lt;<a href="msg00528.html">20140528-094937.sv2782.83458@gna.org</a>&gt; &lt;<a href="msg00529.html">20140528-095339.sv2782.95150@gna.org</a>&gt; &lt;<a href="msg00530.html">CA+CBx2NhryC8e52eJgZJBZ54eCN23KeRS8Ah8oqW-atBLMfQmA@mail.gmail.com</a>&gt; &lt;CAED9pY8WpcMefqf=6p3drbjxPDQR3TbRi6A-4Q9rYYhetEtW9A@mail.gmail.com&gt; &lt;CA+CBx2N=bh+xfPEnHxJ4VTa+gOTd451N7WSkoWFFrzc0B6hHag@mail.gmail.com&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Troels Emtekær Linnet</strong> on May 28, 2014 - 13:04:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">And the system tests are a gold mine of failing places.
If I set the numpy-raise on, I see:

E     0.02 s for Relax_disp.test_baldwin_synthetic
E     0.01 s for Relax_disp.test_baldwin_synthetic_full
E     0.10 s for Relax_disp.test_cpmg_synthetic_ns3d_to_b14
E     0.11 s for Relax_disp.test_hansen_cpmg_data_to_ns_cpmg_2site_star
E     0.08 s for Relax_disp.test_hansen_cpmg_data_to_ns_cpmg_2site_star_full
E     5.97 s for Relax_disp.test_ns_mmq_3site
E     5.82 s for Relax_disp.test_ns_mmq_3site_linear

Relax_disp.test_baldwin_synthetic
#############
Searching through 2197 grid nodes.
k: 0        xk: [      0.2008231,               0,             0.5,
      0.0001]    fk: 26709.2681152
k: 1        xk: [      0.2008231,    0.8333333333,             0.5,
      0.0001]    fk: 24779.5002961
k: 2        xk: [      0.2008231,     1.666666667,             0.5,
      0.0001]    fk: 23811.5470332
  File &quot;/Users/tlinnet/software/disp_speed/lib/dispersion/b14.py&quot;,
line 231, in r2eff_B14
    Tog = 0.5 * (1. + y) + (1. - y) * v5 / (2. * v3 * N )
FloatingPointError: invalid value encountered in divide

That corresponds to:
r2                            2.008231
dw                           1.666666667
pA                           0.5
kex                       1.0

The print out shows:
    print r20a 2.008231
    print r20b 2.008231
    print pA 0.5
    print pB 0.5
    print dw 3141.59265359
    print kex 1.0

So, somewhere some forbidden steps are being performed.
We need to make sure, that this is protected!

Indeed when I add to: test_suite/unit_tests/_lib/_dispersion/test_b14.py

    def test_b14_no_rex9(self):
        &quot;&quot;&quot;Test the r2eff_b14() function for weird cases&quot;&quot;&quot;

        self.r20a = 2.008231
        self.r20b = 2.008231
        self.pA = 0.5
        self.dw = 2.5
        self.kex = 1.0

        # Calculate and check the R2eff values.
        self.calc_r2eff()

It fails.

I can boil it down to:

        # Parameter reset.
        self.r20a = 2.00
        self.r20b = self.r20a
        self.pA = 0.5
        self.kex = 4.0 or under.


We need to make sure that we always survive these situations.

And I know, that you have turned of Grid search for many of the models
being tested in the test suite.
So, we don't know if they all perform well.

Best
Troels





2014-05-28 12:23 GMT+02:00 Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Edward.

The NS CPMG 2site extended is a good case.

It will make a underflow for kex as low as 1e4.

  File 
&quot;/Users/tlinnet/software/disp_speed/test_suite/unit_tests/_lib/_dispersion/test_ns_cpmg_2site_expanded.py&quot;,
line 180, in test_ns_cpmg_2site_expanded_no_rex8
    self.calc_r2eff()
  File 
&quot;/Users/tlinnet/software/disp_speed/test_suite/unit_tests/_lib/_dispersion/test_ns_cpmg_2site_expanded.py&quot;,
line 58, in calc_r2eff
    R2eff = r2eff_ns_cpmg_2site_expanded(r20=self.r20, pA=self.pA,
dw=dw_frq, k_AB=k_AB, k_BA=k_BA, relax_time=0.3, inv_relax_time=1/0.3,
tcp=self.tcp, num_points=self.num_points, num_cpmg=self.num_cpmg)
  File 
&quot;/Users/tlinnet/software/disp_speed/lib/dispersion/ns_cpmg_2site_expanded.py&quot;,
line 298, in r2eff_ns_cpmg_2site_expanded
    t28 = exp(-(t17 + k_AB_plus_k_BA_minus_t4) * half_tcp)
FloatingPointError: underflow encountered in exp

And, the test is extremely fast. So I would rather keep it, as a last
line of defence.

Best
Troels

2014-05-28 12:10 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,

Do you have an example where infinite or NaN values appear?  I think
that with the 'No Rex' checks, we now 100% avoid these.  So I believe
that all Inf and NaN values came from the parameter values dw == 0.0
or pA == 1.0 or kex == 0.0 or phi_ex = 0.0 causing a failure in the
original dispersion equations.  That is what this patch demonstrates -
for all cases in the test suite, there is no longer any Inf or NaN
values :)  At least for the models we check for no exchange
conditions.

Regards,

Edward





On 28 May 2014 12:01, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Edward.

I cannot accept the patch.

It removes all the isfinite(sum(R1rho)) tests I have put in.

Best
Troels


2014-05-28 11:53 GMT+02:00 Edward d  Auvergne
&lt;NO-REPLY.INVALID-ADDRESS@xxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Follow-up Comment #86, task #7793 (project relax):

I have modified the patch for the latest version of the disp_speed branch
(r23503).

(file #20827)
    _______________________________________________________

Additional Item Attachment:

File name: patch_check_removal2           Size:10 KB


    _______________________________________________________

Reply to this item at:

  &lt;<a  rel="nofollow" href="http://gna.org/task/?7793">http://gna.org/task/?7793</a>&gt;

_______________________________________________
  Message sent via/by Gna!
  <a  rel="nofollow" href="http://gna.org/">http://gna.org/</a>

</pre></blockquote></blockquote></blockquote></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00299" href="msg00299.html">[task #7793] Speed-up of dispersion models</a></strong>
<ul><li><em>From:</em> Troels E. Linnet</li></ul></li>
<li><strong><a name="00343" href="msg00343.html">[task #7793] Speed-up of dispersion models</a></strong>
<ul><li><em>From:</em> Troels E. Linnet</li></ul></li>
<li><strong><a name="00354" href="msg00354.html">[task #7793] Speed-up of dispersion models</a></strong>
<ul><li><em>From:</em> Troels E. Linnet</li></ul></li>
<li><strong><a name="00399" href="msg00399.html">[task #7793] Speed-up of dispersion models</a></strong>
<ul><li><em>From:</em> Troels E. Linnet</li></ul></li>
<li><strong><a name="00490" href="msg00490.html">[task #7793] Speed-up of dispersion models</a></strong>
<ul><li><em>From:</em> Troels E. Linnet</li></ul></li>
<li><strong><a name="00504" href="msg00504.html">[task #7793] Speed-up of dispersion models</a></strong>
<ul><li><em>From:</em> Troels E. Linnet</li></ul></li>
<li><strong><a name="00506" href="msg00506.html">[task #7793] Speed-up of dispersion models</a></strong>
<ul><li><em>From:</em> Troels E. Linnet</li></ul></li>
<li><strong><a name="00507" href="msg00507.html">[task #7793] Speed-up of dispersion models</a></strong>
<ul><li><em>From:</em> Troels E. Linnet</li></ul></li>
<li><strong><a name="00513" href="msg00513.html">[task #7793] Speed-up of dispersion models</a></strong>
<ul><li><em>From:</em> Troels E. Linnet</li></ul></li>
<li><strong><a name="00528" href="msg00528.html">[task #7793] Speed-up of dispersion models</a></strong>
<ul><li><em>From:</em> Edward d Auvergne</li></ul></li>
<li><strong><a name="00529" href="msg00529.html">[task #7793] Speed-up of dispersion models</a></strong>
<ul><li><em>From:</em> Edward d Auvergne</li></ul></li>
<li><strong><a name="00530" href="msg00530.html">Re: [task #7793] Speed-up of dispersion models</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00531" href="msg00531.html">Re: [task #7793] Speed-up of dispersion models</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00533" href="msg00533.html">Re: [task #7793] Speed-up of dispersion models</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Thu May 29 13:20:18 2014</div>  
</body>
</html>
