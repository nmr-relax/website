<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: R1rho RD analysis -->
<!--X-From-R13: Febryf Szgrxæe Zvaarg &#60;gyvaargNaze&#45;erynk.pbz> -->
<!--X-Date: Tue, 03 Jun 2014 18:35:31 +0200 -->
<!--X-Message-Id: CA+CBx2OcDAjy3b66ZxooDFbq6GFao8hePxzK8L&#45;VpZofL0YX7w@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: mailman.0.1400242739.20441.relax&#45;users@gna.org -->
<!--X-Reference: 537A143C.3020901@ibs.fr -->
<!--X-Reference: CAED9pY8GmeRj=HfGGb9x0Gk00bn1vBQYfYsUFDTzRmgyY7B_VA@mail.gmail.com -->
<!--X-Reference: 537E0B05.3060000@ibs.fr -->
<!--X-Reference: CAED9pY&#45;JoCffENebpEy3zPXg=dfcobrULSW&#45;SWEaGrN9nhggVg@mail.gmail.com -->
<!--X-Reference: 5385A2ED.8060605@ibs.fr -->
<!--X-Reference: CA+CBx2Nwmu_SZyQB3YPFp_icDJNZAN=f60FedmxubCeHrWsQHg@mail.gmail.com -->
<!--X-Reference: 53888CE6.5050304@ibs.fr -->
<!--X-Reference: CAED9pY9NXFU8gLO&#45;EG_uDF=yA1po==9&#45;uA=uH3u4MtERzJNBrQ@mail.gmail.com -->
<!--X-Reference: CAED9pY&#45;MQ5&#45;NM_WJoFSHGSzspW1a=QSzKOaL+p+Wdc9EHO2UuQ@mail.gmail.com -->
<!--X-Reference: 538DCD4F.2010805@ibs.fr -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: R1rho RD analysis -- June 03, 2014 - 18:35</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: R1rho RD analysis</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00002" class="tabs">Index by Date</a> | <a href="threads.html#00002" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00001.html">Date Prev</a>] [<a href="msg00003.html">Date Next</a>] [<a href="msg00001.html">Thread Prev</a>] [<a href="msg00006.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: pma &lt;Peixiang.Ma@xxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Tue, 3 Jun 2014 18:34:39 +0200</li>
<li class="menuitem">
<em>Cc</em>: &quot;relax-users@xxxxxxx&quot; &lt;relax-users@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:from:date:message-id :subject:to:cc:content-type; bh=xMyZOmO0qEg8ovHvcBh53HK73isCZ9exnhvLzmm+TJI=; b=rV6/Cs64GL/MKAUbzQDR/uBrDjOj1WG3p84+ecCH3FRfVctgXSwodoyYhLB6sZD24V 1/ulXkUj2NYYjP+ELLbD7IHG4Z7S86vNpw2or9xts0TE2l7ecmbI8LY89LVrOE0DHCBx +EGgzJNx1XOxzb0tdDGdKSpKdyy2J92Ea3AdWvKeFd4brQxAGtgzZE+zzQ2lEYosAZom ONU6EgYUaPwAYTugwelMj6e+cyEHaLpepHOt2P4pnmBjlhYBjq7bl3iJcSVpjEpfvTyJ ixKIaxU9yEG4y6XyiAmOdWbLVvoFffMMd92N5DQSfp0KEsaCRb0k8w898Rnpy9uk7jt0 t89A==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00002.html">CA+CBx2OcDAjy3b66ZxooDFbq6GFao8hePxzK8L-VpZofL0YX7w@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;mailman.0.1400242739.20441.relax-users@gna.org&gt; &lt;537A143C.3020901@ibs.fr&gt; &lt;CAED9pY8GmeRj=HfGGb9x0Gk00bn1vBQYfYsUFDTzRmgyY7B_VA@mail.gmail.com&gt; &lt;537E0B05.3060000@ibs.fr&gt; &lt;CAED9pY-JoCffENebpEy3zPXg=dfcobrULSW-SWEaGrN9nhggVg@mail.gmail.com&gt; &lt;5385A2ED.8060605@ibs.fr&gt; &lt;CA+CBx2Nwmu_SZyQB3YPFp_icDJNZAN=f60FedmxubCeHrWsQHg@mail.gmail.com&gt; &lt;53888CE6.5050304@ibs.fr&gt; &lt;CAED9pY9NXFU8gLO-EG_uDF=yA1po==9-uA=uH3u4MtERzJNBrQ@mail.gmail.com&gt; &lt;CAED9pY-MQ5-NM_WJoFSHGSzspW1a=QSzKOaL+p+Wdc9EHO2UuQ@mail.gmail.com&gt; &lt;<a href="msg00000.html">538DCD4F.2010805@ibs.fr</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Troels Emtekær Linnet</strong> on June 03, 2014 - 18:35:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi Peixiang.

I am glad to see your interest in relax.

I joined the project around a year ago, since I know that fitting
CPMG and R1rho data in our lab, can be quite a struggle for our students.

So relax has come as a relief, where the GUI can get most things done.
But it seems very much, that you would like to get to the power of the
scripting.

The combined experimental setup for an R1rho experiment can pile up.
The combined combination of:
1) relax_disp.spin_lock_field
2) relax_disp.spin_lock_offset
3) relax_disp.relax_time

can quickly extend to 70-100+ experiments.

What I intended with the tutorial, was to imagine that you had such a
directory with 50+ experiments.
<a  rel="nofollow" href="http://wiki.nmr-relax.com/Tutorial_for_Relaxation_dispersion_analysis_r1rho_fixed_time_recorded_on_varian_as_sequential_spectra#Extract_the_spectra_settings_from_Varian_procpar_file">http://wiki.nmr-relax.com/Tutorial_for_Relaxation_dispersion_analysis_r1rho_fixed_time_recorded_on_varian_as_sequential_spectra#Extract_the_spectra_settings_from_Varian_procpar_file</a>

That little bash script, will extract the different settings for each
experiment and put the settings into one column formatted settings file.
-----
# DIRN I deltadof2 dpwr2slock ncyc trim ss sfrq apod_rmsd
ldn_20120917_15N_NCBD_20mMPi_pH6c5_31C_t1rho46.fid 46 0 35 0 0.005 16
799.7773991 745.77
ldn_20120917_15N_NCBD_20mMPi_pH6c5_31C_t1rho48.fid 48 0 35 4 0.005 128
799.7773991 1274.17
ldn_20120917_15N_NCBD_20mMPi_pH6c5_31C_t1rho47.fid 47 0 35 10 0.005 16
799.7773991 732.333
....
-------

Then the idea is to measure the height of each experiment, with NMRPipe,
using seriesTab.

And as an error estimator, using just:
`showApod test.ft2 | grep &quot;REMARK Automated Noise Std Dev in Processed
Data:&quot; | awk '{print $9}'`.
This is the last column in the above example.

That should cover it.

This following would be a script I would suggest.

There are many ways how to organise this.
You could also make a list of lists in a script file, and just loop through
this.

If you look at the following example script.
Then the models are:
['R2eff', 'DPL94']

So, relax would exponential fit R2eff data from the intensities.

You already have all the R2eff data.
So here you could skip the intensities reading and the R2eff model.

You still need to set all the meta-data settings, to allow relax to match
the combinations of
data to a spectra id.

Then you need to read in the R2eff data, instead of the intensities.

I am actually a little unsure how that should be performed.

I think I will try to make to scripts, and see how far I get.
But haven't tried this before, and don't have test data for it.


Suggestion for Normal
------------------
from auto_analyses.relax_disp import Relax_disp

# Set pipe name, bundle and type.
pipe_name = 'base pipe'
pipe_bundle = 'relax_disp'
pipe_type= 'relax_disp'

# Create the data pipe.
pipe.create(pipe_name=pipe_name, bundle=pipe_bundle, pipe_type=pipe_type)

# Read the spins.
spectrum.read_spins(file='1_0_46_0_max_standard.ser',
dir=data_path+sep+'peak_lists')

# Name the isotope for field strength scaling.
spin.isotope(isotope='15N')

# Load the experiments settings file.
expfile = open(data_path+sep+'exp_parameters_sort.txt', 'r')
expfileslines = expfile.readlines()
expfile.close()

# In MHz
yOBS = 81.050
# In ppm
yCAR = 118.078
centerPPM_N15 = yCAR

## Read the chemical shift data.
chemical_shift.read(file='1_0_46_0_max_standard.ser',
dir=data_path+sep+'peak_lists')

# The lock power to field, has been found in an calibration experiment.
spin_lock_field_strengths_Hz = {'35': 431.0, '39': 651.2, '41': 800.5,
'43': 984.0, '46': 1341.11, '48': 1648.5}

# Apply spectra settings.
# Count settings
j = 0
for i in range(len(expfileslines)):
    line=expfileslines[i]
    if line[0] == &quot;#&quot;:
        continue
    else:
        # DIRN I deltadof2 dpwr2slock ncyc trim ss sfrq
        DIRN = line.split()[0]
        I = int(line.split()[1])
        deltadof2 = line.split()[2]
        dpwr2slock = line.split()[3]
        ncyc = int(line.split()[4])
        trim = float(line.split()[5])
        ss = int(line.split()[6])
        set_sfrq = float(line.split()[7])
        apod_rmsd = float(line.split()[8])
        spin_lock_field_strength = spin_lock_field_strengths_Hz[dpwr2slock]

        # Calculate spin_lock time
        time_sl = 2*ncyc*trim

        # Define file name for peak list.
        FNAME = &quot;%s_%s_%s_%s_max_standard.ser&quot;%(I, deltadof2, dpwr2slock,
ncyc)

        sp_id = &quot;%s_%s_%s_%s&quot;%(I, deltadof2, dpwr2slock, ncyc)

        # Load the peak intensities.
        spectrum.read_intensities(file=FNAME,
dir=data_path+sep+'peak_lists', spectrum_id=sp_id, int_method='height')

        # Set the peak intensity errors, as defined as the baseplane RMSD.
        spectrum.baseplane_rmsd(error=apod_rmsd, spectrum_id=sp_id)

        # Set the relaxation dispersion experiment type.
        relax_disp.exp_type(spectrum_id=sp_id, exp_type='R1rho')

        # Set The spin-lock field strength, nu1, in Hz
        relax_disp.spin_lock_field(spectrum_id=sp_id,
field=spin_lock_field_strength)

        # Calculating the spin-lock offset in ppm, from offsets values
provided in Hz.
        frq_N15_Hz = yOBS * 1E6
        offset_ppm_N15 = float(deltadof2) / frq_N15_Hz * 1E6
        omega_rf_ppm = centerPPM_N15 + offset_ppm_N15

        # Set The spin-lock offset, omega_rf, in ppm.
        relax_disp.spin_lock_offset(spectrum_id=sp_id, offset=omega_rf_ppm)

        # Set the relaxation times (in s).
        relax_disp.relax_time(spectrum_id=sp_id, time=time_sl)

        # Set the spectrometer frequency.
        spectrometer.frequency(id=sp_id, frq=set_sfrq, units='MHz')

        # Add to counter
        j += 1

# Read the R1 data
relax_data.read(ri_id='R1', ri_type='R1', frq=cdp.spectrometer_frq_list[0],
file='R1_fitted_values.txt', dir=data_path, mol_name_col=1, res_num_col=2,
res_name_col=3, spin_num_col=4, spin_name_col=5, data_col=6, error_col=7)

# Cluster residues
cluster_ids = [
&quot;:13@N&quot;,
&quot;:15@N&quot;,
&quot;:16@N&quot;,
&quot;:25@N&quot;,
&quot;:26@N&quot;,
&quot;:28@N&quot;,
&quot;:39@N&quot;,
&quot;:40@N&quot;,
&quot;:41@N&quot;,
&quot;:43@N&quot;,
&quot;:44@N&quot;,
&quot;:45@N&quot;,
&quot;:49@N&quot;,
&quot;:52@N&quot;,
&quot;:53@N&quot;]

# Cluster spins
for curspin in cluster_ids:
    print(&quot;Adding spin %s to cluster&quot;%curspin)
    relax_disp.cluster('model_cluster', curspin)

# De-select for analysis those spins who have not been clustered
for free_spin in cdp.clustering['free spins']:
    print(&quot;Deselecting free spin %s&quot;%free_spin)
    deselect.spin(spin_id=free_spin, change_all=False)

# The dispersion models.
MODELS = ['R2eff', 'DPL94']

# The grid search size (the number of increments per dimension).
GRID_INC = 21

# The number of Monte Carlo simulations to be used for error analysis at
the end of the analysis.
MC_NUM = 3

# Model selection technique.
MODSEL = 'AIC'

# Execute the auto-analysis (fast).
# Standard parameters are: func_tol=1e-25, grad_tol=None, max_iter=10000000,
OPT_FUNC_TOL = 1e-1
relax_disp.Relax_disp.opt_func_tol = OPT_FUNC_TOL
OPT_MAX_ITERATIONS = 1000
relax_disp.Relax_disp.opt_max_iterations = OPT_MAX_ITERATIONS


# Run the analysis.
Relax_disp(pipe_name=pipe_name, pipe_bundle=pipe_bundle, results_dir=None,
models=MODELS, grid_inc=GRID_INC, mc_sim_num=MC_NUM, modsel=MODSEL)
--------------------

Suggestion for r2eff_read


#.... SAME as before
for i in range(len(expfileslines)):
    line=expfileslines[i]
    if line[0] == &quot;#&quot;:
        continue
    else:
        # DIRN I deltadof2 dpwr2slock ncyc trim ss sfrq
        DIRN = line.split()[0]
        I = int(line.split()[1])
        deltadof2 = line.split()[2]
        dpwr2slock = line.split()[3]
        ncyc = int(line.split()[4])
        trim = float(line.split()[5])
        ss = int(line.split()[6])
        set_sfrq = float(line.split()[7])
        apod_rmsd = float(line.split()[8])
        spin_lock_field_strength = spin_lock_field_strengths_Hz[dpwr2slock]

        # Calculate spin_lock time
        time_sl = 2*ncyc*trim

        # Calculating the spin-lock offset in ppm, from offsets values
provided in Hz.
        frq_N15_Hz = yOBS * 1E6
        offset_ppm_N15 = float(deltadof2) / frq_N15_Hz * 1E6
        omega_rf_ppm = centerPPM_N15 + offset_ppm_N15

        # Construct ID
        part_id = = &quot;%s_%s_%s&quot;%(set_sfrq, time_sl, omega_rf_ppm)
        sp_id = &quot;%s_%s&quot;%(part_id, spin_lock_field_strength)

        # Set the relaxation dispersion experiment type.
        relax_disp.exp_type(spectrum_id=sp_id, exp_type='R1rho')

        # Set the relaxation times (in s).
        relax_disp.relax_time(spectrum_id=sp_id, time=time_sl)

        # Set The spin-lock offset, omega_rf, in ppm.
        relax_disp.spin_lock_offset(spectrum_id=sp_id, offset=omega_rf_ppm)

        # Set the spectrometer frequency.
        spectrometer.frequency(id=sp_id, frq=set_sfrq, units='MHz')

        FNAME = &quot;%s.txt&quot;%(sp_id)
        relax_disp.r2eff_read(id=part_id, file=sp_id+'.txt', dir=None,
disp_frq=spin_lock_field_strength, spin_id_col=1, mol_name_col=2,
res_num_col=3, res_name_col=4, spin_num_col=5, spin_name_col=6, data_col=7,
error_col=8)

        # Add to counter
        j += 1

#...

# The dispersion models.
MODELS = ['DPL94']

#....

# Run the analysis.
relax_disp.Relax_disp(pipe_name=pipe_name, pipe_bundle=pipe_bundle,
results_dir=None, models=MODELS, grid_inc=GRID_INC, mc_sim_num=MC_NUM,
modsel=MODSEL)







2014-06-03 15:27 GMT+02:00 pma &lt;Peixiang.Ma@xxxxxx&gt;:

</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi, Edward,

Thanks, as your instruction, I tried Gui, but I could not quit selection
relaxation dispersion models. (I just report as a bug)

1) In r2eff_read, I am not quite clear about the pop window. You said I
should load partial experiment ID string as ('%s_%s'%(id,dis_point)).
Then you have the second window to load the file. what does the file mean?
The file is the fitted R2eff or a list for all the R2eff file names?

Is that possible to load a series of files? I guess so, but do you have an
example somewhere?

2) actually, I found script is more powerful, so I just use Troels
mentioned trick. type help(relax_disp.r2eff), then I found the description
about this function.
I made one script, it is included in the log file.

I attached the log file after I run the script.You can see that it reads
all the R2eff value perfectly, but did not do the calculation there.

It is a bit strange to me. . Do you have an idea why?

Do not care too much about the value in the script, such as Grid_inc,
MC_value, they are only for test now.



Peixiang



On 05/30/2014 04:45 PM, Edward d'Auvergne wrote:

</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Peixiang,

If you do only have R2eff data, i.e. there is no original peak lists,
I'll assume that you would fit into the category of 'power user'.  In
this case in the GUI, instead of using the peak intensity wizard via
the spectra list 'Add' button, try the &quot;User
functions-&gt;relax_disp-&gt;r2eff_read&quot; or &quot;User
functions-&gt;relax_disp-&gt;r2eff_read_spin&quot; menu entries.  You will have
to deselect the 'R2eff' model.  Clicking on the 'Execute' button will
then run the analysis.

Regards,

Edward






</pre></blockquote><pre style="margin: 0em;">--

Peixiang Ma, PhD.
Institut de Biologie Structurale (IBS)
UMR 5075 - CEA - CNRS - UJF
41 rue Jules Horowitz
38027 Grenoble Cedex 1, France
Email: Peixiang.Ma@xxxxxx


_______________________________________________
relax (<a  rel="nofollow" href="/">http://www.nmr-relax.com</a>)

This is the relax-users mailing list
relax-users@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="/mail.gna.org/listinfo/relax-users">https://mail.gna.org/listinfo/relax-users</a>


</pre></blockquote><pre style="margin: 0em;">

</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00000" href="msg00000.html">Re: R1rho RD analysis</a></strong>
<ul><li><em>From:</em> pma</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Fri Jun 06 18:00:08 2014</div>  
</body>
</html>
