<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: r13249 &#45; in /branches/xyz: generic_fns/structure/main.py	prompt/structure.py test_suite/system_tests/structure.py -->
<!--X-From-R13: Vna Eha <unfhNaze.zcvocp.zct.qr> -->
<!--X-Date: Tue, 28 Jun 2011 11:14:14 +0200 -->
<!--X-Message-Id: EAF9CB69&#45;F46C&#45;4A36&#45;BB49&#45;6C80C946B134@nmr.mpibpc.mpg.de -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: E1QbTcJ&#45;0001Mm&#45;IS@subversion.gna.org -->
<!--X-Reference: BANLkTi=eOuFNPVB7JWFtbY=QMvqWuTy+xA@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: r13249 - in /branches/xyz: generic_fns/structure/main.py	prompt/structure.py test_suite/system_tests/structure.py -- June 28, 2011 - 11:14</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: r13249 - in /branches/xyz: generic_fns/structure/main.py	prompt/structure.py test_suite/system_tests/structure.py</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00246" class="tabs">Index by Date</a> | <a href="threads.html#00246" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00245.html">Date Prev</a>] [<a href="msg00247.html">Date Next</a>] [<a href="msg00245.html">Thread Prev</a>] [Thread Next]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;Edward d'Auvergne&quot; &lt;edward@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Tue, 28 Jun 2011 11:16:05 +0200</li>
<li class="menuitem">
<em>Cc</em>: relax-devel@xxxxxxx</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00246.html">EAF9CB69-F46C-4A36-BB49-6C80C946B134@nmr.mpibpc.mpg.de</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;E1QbTcJ-0001Mm-IS@xxxxxxxxxxxxxxxxxx&gt;	&lt;BANLkTi=eOuFNPVB7JWFtbY=QMvqWuTy+xA@xxxxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Han Sun</strong> on June 28, 2011 - 11:14:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
Hi Edward,

ok, thanks!

Best,
Han

On Jun 28, 2011, at 11:06 AM, Edward d'Auvergne wrote:

</pre><blockquote class="blockquote"><pre style="margin: 0em;">
Hi Han,

It looks like you accidentally had a change in the file
generic_fns/structure/main.py prior to the reversion, so that it was
included in the commit as well :S  This make things more difficult!
You'll first have to revert the new r13249 and commit.  Then try the
reversion of r13246 a second time.  This could make it interesting
when I try to bring this xyz branch back into the main line, the
svnmerge program might not quite understand what is happening.  That's
ok though, I'll be able to handle that problem if it arises.

Cheers,

Edward


On 28 June 2011 10:25,  &lt;hasu@xxxxxxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">
Author: han87
Date: Tue Jun 28 10:25:55 2011
New Revision: 13249

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=13249&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=13249&amp;view=rev</a>
Log:
Reverted r13246 as different approach will be used.

The command used was:
svn merge -r 13246:13239 .

</pre><tt>The new function vectors_xyz() in the /prompt/structure.py is not  
</tt><tt>needed. The current code will be fixed for xyz file format  
</tt><tt>suggested in <a  rel="nofollow" href="http://www.nmr-relax.com/mail.gna.org/public/relax-devel/2011-06/">https://mail.gna.org/public/relax-devel/2011-06/</a> 
</tt><tt>msg00244.html.
</tt><pre style="margin: 0em;">

Modified:
   branches/xyz/generic_fns/structure/main.py
   branches/xyz/prompt/structure.py
   branches/xyz/test_suite/system_tests/structure.py

Modified: branches/xyz/generic_fns/structure/main.py
</pre><tt>URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/xyz/generic_fns/">http://svn.gna.org/viewcvs/relax/branches/xyz/generic_fns/</a> 
</tt><tt>structure/main.py?rev=13249&amp;r1=13248&amp;r2=13249&amp;view=diff
</tt><tt>===================================================================== 
</tt><tt>=========
</tt><pre style="margin: 0em;">
--- branches/xyz/generic_fns/structure/main.py (original)
</pre><tt>+++ branches/xyz/generic_fns/structure/main.py Tue Jun 28 10:25:55  
</tt><tt>2011
</tt><pre style="margin: 0em;">
@@ -609,6 +609,140 @@
        raise RelaxError(&quot;No vectors could be extracted.&quot;)


</pre><tt>+def vectors_xyz(spin_id1=None, spin_id2=None, model=None,  
</tt><tt>verbosity=1, ave=True, unit=True):
</tt><tt>+    &quot;&quot;&quot;Extract the bond vectors from the loaded structures and  
</tt><tt>store them in the spin container.
</tt><pre style="margin: 0em;">
+
</pre><tt>+    @keyword attached:      The spin identifier string of the  
</tt><tt>atom 1.
</tt><pre style="margin: 0em;">
+    @type attached:         str
</pre><tt>+    @keyword spin_id:       The spin identifier string of the  
</tt><tt>atom 2.
</tt><pre style="margin: 0em;">
+    @type spin_id:          str
</pre><tt>+    @keyword model:         The model to extract the vector  
</tt><tt>from.  If None, all vectors will be
</tt><pre style="margin: 0em;">
+                            extracted.
+    @type model:            str
</pre><tt>+    @keyword verbosity:     The higher the value, the more  
</tt><tt>information is printed to screen.
</tt><pre style="margin: 0em;">
+    @type verbosity:        int
</pre><tt>+    @keyword ave:           A flag which if True will cause the  
</tt><tt>average of all vectors to be
</tt><pre style="margin: 0em;">
+                            extracted.
+    @type ave:              bool
</pre><tt>+    @keyword unit:          A flag which if True will cause the  
</tt><tt>function to calculate the unit
</tt><pre style="margin: 0em;">
+                            vectors.
+    @type unit:             bool
+    &quot;&quot;&quot;
+
+    # Test if the PDB file has been loaded.
+    if not hasattr(cdp, 'structure'):
+        raise RelaxPdbError
+
+    # Test if sequence data is loaded.
+    if not exists_mol_res_spin_data():
+        raise RelaxNoSequenceError
+
+    # Print out.
+    if verbosity:
+        # Number of models.
+        num_models = cdp.structure.num_models()
+
+        # Multiple models loaded.
+        if num_models &gt; 1:
+            if model:
</pre><tt>+                print((&quot;Extracting vectors for model '%s'.&quot; %  
</tt><tt>model))
</tt><pre style="margin: 0em;">
+            else:
</pre><tt>+                print((&quot;Extracting vectors for all %s models.&quot; %  
</tt><tt>num_models))
</tt><pre style="margin: 0em;">
+                if ave:
+                    print(&quot;Averaging all vectors.&quot;)
+
+        # Single model loaded.
+        else:
+            print(&quot;Extracting vectors from the single model.&quot;)
+
+        # Unit vectors.
+        if unit:
+            print(&quot;Calculating the unit vectors.&quot;)
+
+    # Loop over the spins.
+    no_vectors = True
</pre><tt>+    for spin1, mol_name1, res_num1, res_name1 in spin_loop 
</tt><tt>(selection=spin_id1, full_info=True):
</tt><pre style="margin: 0em;">
+        # Skip deselected spins.
+        if not spin.select:
+            continue
+
</pre><tt>+        # The spin identification string.  The residue name and  
</tt><tt>spin num is not included to allow molecules with point mutations  
</tt><tt>to be used as different models.
</tt><tt>+        id1 = generate_spin_id(res_num1=res_num1, res_name1=None,  
</tt><tt>spin_num1=res_num1)
</tt><pre style="margin: 0em;">
+
</pre><tt>+        # Test that the spin number or name are set (one or both  
</tt><tt>are essential for the identification of the atom).
</tt><pre style="margin: 0em;">
+        if spin.num == None and spin.name == None:
</pre><tt>+            warn(RelaxWarning(&quot;Either the spin number or name  
</tt><tt>must be set for the spin &quot; + repr(id) + &quot; to identify the  
</tt><tt>corresponding atom in the molecule.&quot;))
</tt><pre style="margin: 0em;">
+            continue
+
+        # The bond vector already exists.
+        if hasattr(spin, object_name):
+            obj = getattr(spin, object_name)
+            if obj:
</pre><tt>+                warn(RelaxWarning(&quot;The bond vector for the spin &quot;  
</tt><tt>+ repr(id) + &quot; already exists.&quot;))
</tt><pre style="margin: 0em;">
+                continue
+
+        # Get the bond info.
</pre><tt>+        bond_vectors, attached_name, warnings =  
</tt><tt>cdp.structure.bond_vectors(attached_atom=attached,  
</tt><tt>model_num=model, res_num=res_num, spin_name=spin.name,  
</tt><tt>return_name=True, return_warnings=True)
</tt><pre style="margin: 0em;">
+
+        # No attached atom.
+        if not bond_vectors:
+            # Warning messages.
+            if warnings:
</pre><tt>+                warn(RelaxWarning(warnings + &quot; (atom ID &quot; + repr 
</tt><tt>(id) + &quot;).&quot;))
</tt><pre style="margin: 0em;">
+
+            # Skip the spin.
+            continue
+
+        # Set the attached atom name.
+        if not hasattr(spin, 'attached_atom'):
+            spin.attached_atom = attached_name
+        elif spin.attached_atom != attached_name:
</pre><tt>+            raise RelaxError(&quot;The &quot; + repr(spin.attached_atom) +  
</tt><tt>&quot; atom already attached to the spin does not match the attached  
</tt><tt>atom &quot; + repr(attached_name) + &quot;.&quot;)
</tt><pre style="margin: 0em;">
+
+        # Initialise the average vector.
+        if ave:
+            ave_vector = zeros(3, float64)
+
+        # Loop over the individual vectors.
+        for i in xrange(len(bond_vectors)):
+            # Unit vector.
+            if unit:
+                # Normalisation factor.
+                norm_factor = norm(bond_vectors[i])
+
+                # Test for zero length.
+                if norm_factor == 0.0:
+                    warn(RelaxZeroVectorWarning(id))
+
+                # Calculate the normalised vector.
+                else:
+                    bond_vectors[i] = bond_vectors[i] / norm_factor
+
+            # Sum the vectors.
+            if ave:
+                ave_vector = ave_vector + bond_vectors[i]
+
+        # Average.
+        if ave:
+            vector = ave_vector / float(len(bond_vectors))
+        else:
+            vector = bond_vectors
+
+        # Set the vector.
+        setattr(spin, object_name, vector)
+
+        # We have a vector!
+        no_vectors = False
+
+        # Print out of modified spins.
+        if verbosity:
</pre><tt>+            print((&quot;Extracted &quot; + spin.name + &quot;-&quot; + attached_name  
</tt><tt>+ &quot; vectors for &quot; + repr(id) + '.'))
</tt><pre style="margin: 0em;">
+
</pre><tt>+    # Right, catch the problem of missing vectors to prevent  
</tt><tt>massive user confusion!
</tt><pre style="margin: 0em;">
+    if no_vectors:
+        raise RelaxError(&quot;No vectors could be extracted.&quot;)
+
+
 def write_pdb(file=None, dir=None, model_num=None, force=False):
    &quot;&quot;&quot;The PDB writing function.


Modified: branches/xyz/prompt/structure.py
</pre><tt>URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/xyz/prompt/">http://svn.gna.org/viewcvs/relax/branches/xyz/prompt/</a> 
</tt><tt>structure.py?rev=13249&amp;r1=13248&amp;r2=13249&amp;view=diff
</tt><tt>===================================================================== 
</tt><tt>=========
</tt><pre style="margin: 0em;">
--- branches/xyz/prompt/structure.py (original)
+++ branches/xyz/prompt/structure.py Tue Jun 28 10:25:55 2011
@@ -686,76 +686,6 @@
</pre><tt>        generic_fns.structure.main.vectors(attached=attached,  
</tt><tt>spin_id=spin_id, model=model, verbosity=verbosity, ave=ave,  
</tt><tt>unit=unit)
</tt><pre style="margin: 0em;">


</pre><tt>-    def vectors_xyz(self, spin_id1=None, spin_id2=None,  
</tt><tt>model=None, verbosity=1, ave=True, unit=True):
</tt><tt>-        &quot;&quot;&quot;Extract and store the bond vectors from the loaded  
</tt><tt>structures in the spin container.
</tt><pre style="margin: 0em;">
-
-        Keyword arguments
-        ~~~~~~~~~~~~~~~~~
-
-        spin_id1:  The spin identification string of the spin 1.
-
-        spin_id2:  The spin identification string of the spin 2.
-
</pre><tt>-        model:  The model to extract bond vectors from (which if  
</tt><tt>set to None will cause the vectors
</tt><pre style="margin: 0em;">
-        of all models to be extracted).
-
</pre><tt>-        verbosity:  The amount of information to print to  
</tt><tt>screen.  Zero corresponds to minimal
</tt><tt>-        output while higher values increase the amount of  
</tt><tt>output.  The default value is 1.
</tt><pre style="margin: 0em;">
-
</pre><tt>-        ave:  A flag which if True will cause the bond vectors  
</tt><tt>from all models to be averaged.  If
</tt><tt>-        vectors from only one model is extracted, this argument  
</tt><tt>will have no effect.
</tt><pre style="margin: 0em;">
-
</pre><tt>-        unit:  A flag which if True will cause the unit vector to  
</tt><tt>calculated rather than the full
</tt><pre style="margin: 0em;">
-        length bond vector.
-
-
-        Description
-        ~~~~~~~~~~~
-
</pre><tt>-        For a number of types of analysis, bond vectors or unit  
</tt><tt>bond vectors are required for the
</tt><tt>-        calculations.  This user function allows these vectors to  
</tt><tt>be extracted from the loaded
</tt><tt>-        structures. The bond vector will be that from the two  
</tt><tt>atoms of a xyz file loaded in relax.
</tt><pre style="margin: 0em;">
-
</pre><tt>-        The extraction of vectors can occur in a number of ways.   
</tt><tt>For example if an NMR structure
</tt><tt>-        with N models is loaded or if multiple molecules, from  
</tt><tt>any source, of the same compound are
</tt><tt>-        loaded as different models, there are three options for  
</tt><tt>extracting the bond vector.  Firstly
</tt><tt>-        the bond vector of a single model can be extracted by  
</tt><tt>setting the 'model' argument.
</tt><tt>-        Secondly the bond vectors from all models can be  
</tt><tt>extracted if 'model' is None and 'ave' is
</tt><tt>-        set to False.  Thirdly, if 'model' is None and 'ave' is  
</tt><tt>set to True, then a single vector
</tt><pre style="margin: 0em;">
-        which is the average for all models will be calculated.
-
-
-        Example
-        ~~~~~~~
-
-        To extract a vector of two atoms from xyz file, type:
-
</pre><tt>-        relax&gt; structure.vectors(spin_id1='#SSS-cluster4-new- 
</tt><tt>test_mol1@2', spin_id1='#SSS-cluster4-new-test_mol1@1')
</tt><pre style="margin: 0em;">
-        &quot;&quot;&quot;
-
-        # Function intro text.
-        if self._exec_info.intro:
-            text = self._exec_info.ps3 + &quot;structure.vectors(&quot;
-            text = text + &quot;spin_id1=&quot; + repr(spin_id1)
-            text = text + &quot;, spin_id2=&quot; + repr(spin_id2)
-            text = text + &quot;, model=&quot; + repr(model)
-            text = text + &quot;, verbosity=&quot; + repr(verbosity)
-            text = text + &quot;, ave=&quot; + repr(ave)
-            text = text + &quot;, unit=&quot; + repr(unit) + &quot;)&quot;
-            print(text)
-
-        # The argument checks.
</pre><tt>-        arg_check.is_str(spin_id1, 'spin_identification_string',  
</tt><tt>can_be_none=True)
</tt><tt>-        arg_check.is_str(spin_id2, 'spin identification string',  
</tt><tt>can_be_none=True)
</tt><pre style="margin: 0em;">
-        arg_check.is_int(model, 'model', can_be_none=True)
-        arg_check.is_int(verbosity, 'verbosity level')
-        arg_check.is_bool(ave, 'average vector flag')
-        arg_check.is_bool(unit, 'unit vector flag')
-
-        # Execute the functional code.
</pre><tt>-        generic_fns.structure.main.vectors_xyz(spin_id1=spin_id1,  
</tt><tt>spin_id2=spin_id2, model=model, verbosity=verbosity, ave=ave,  
</tt><tt>unit=unit)
</tt><pre style="margin: 0em;">
-
-
</pre><tt>    def write_pdb(self, file=None, dir=None, model_num=None,  
</tt><tt>force=False):
</tt><pre style="margin: 0em;">
        &quot;&quot;&quot;The PDB writing function.


Modified: branches/xyz/test_suite/system_tests/structure.py
</pre><tt>URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/xyz/test_suite/">http://svn.gna.org/viewcvs/relax/branches/xyz/test_suite/</a> 
</tt><tt>system_tests/structure.py?rev=13249&amp;r1=13248&amp;r2=13249&amp;view=diff
</tt><tt>===================================================================== 
</tt><tt>=========
</tt><pre style="margin: 0em;">
--- branches/xyz/test_suite/system_tests/structure.py (original)
</pre><tt>+++ branches/xyz/test_suite/system_tests/structure.py Tue Jun 28  
</tt><tt>10:25:55 2011
</tt><pre style="margin: 0em;">
@@ -685,7 +685,3 @@
        # And now all the rest of the atoms.
        self.interpreter.structure.load_spins()

-        # Extract a vector between first two spins.
</pre><tt>-        self.interpreter.structure.vectors_xyz(spin_id1='#SSS- 
</tt><tt>cluster4-new-test_mol1@1', spin_id2='#SSS-cluster4-new-test_mol1@2')
</tt><pre style="margin: 0em;">
-        print((cdp.mol[0].res[0].spin[0]))
</pre><tt>-        self.assert_(hasattr(cdp.mol[0].res[0].spin[0],  
</tt><tt>'bond_vect'))
</tt><pre style="margin: 0em;">


_______________________________________________
relax (<a  rel="nofollow" href="http://nmr-relax.com">http://nmr-relax.com</a>)

This is the relax-commits mailing list
relax-commits@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="http://www.nmr-relax.com/mail.gna.org/listinfo/relax-commits">https://mail.gna.org/listinfo/relax-commits</a>

</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
relax (<a  rel="nofollow" href="http://nmr-relax.com">http://nmr-relax.com</a>)

This is the relax-devel mailing list
relax-devel@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="http://www.nmr-relax.com/mail.gna.org/listinfo/relax-devel">https://mail.gna.org/listinfo/relax-devel</a>
</pre></blockquote><pre style="margin: 0em;">



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00245" href="msg00245.html">Re: r13249 - in /branches/xyz: generic_fns/structure/main.py	prompt/structure.py test_suite/system_tests/structure.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Tue Jun 28 12:20:16 2011</div>  
</body>
</html>
