<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: Pickling problems with the relax data storage singleton. -->
<!--X-From-R13: "tnel gubzcfba" <tnelg.naq.fnenuoNtznvy.pbz> -->
<!--X-Date: Mon, 26 Nov 2007 09:39:13 +0100 -->
<!--X-Message-Id: f001463a0711260039r791233b0r25f0c4e63a63092@mail.gmail.com -->
<!--X-Content-Type: multipart/alternative -->
<!--X-Reference: 7f080ed10711201001s59a00533pf3c0ee3f88a79edb@mail.gmail.com -->
<!--X-Reference: 474543CC.50505@bmb.leeds.ac.uk -->
<!--X-Reference: 7f080ed10711220106t543aade7o54657f5cced18858@mail.gmail.com -->
<!--X-Reference: 474552DE.9090007@bmb.leeds.ac.uk -->
<!--X-Reference: 7f080ed10711220830s56faf4d8v1941fa6c61052f35@mail.gmail.com -->
<!--X-Reference: 47468BE4.7000804@bmb.leeds.ac.uk -->
<!--X-Reference: 3b3f50350711251832k469e45a5r247696eaf3e83952@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: Pickling problems with the relax data storage singleton. -- November 26, 2007 - 09:39</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: Pickling problems with the relax data storage singleton.</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00026" class="tabs">Index by Date</a> | <a href="threads.html#00026" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00025.html">Date Prev</a>] [<a href="msg00027.html">Date Next</a>] [<a href="msg00025.html">Thread Prev</a>] [<a href="msg00028.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;Chris MacRaild&quot; &lt;macraild@xxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Mon, 26 Nov 2007 08:39:05 +0000</li>
<li class="menuitem">
<em>Cc</em>: relax-devel@xxxxxxx</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00026.html">f001463a0711260039r791233b0r25f0c4e63a63092@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;7f080ed10711201001s59a00533pf3c0ee3f88a79edb@xxxxxxxxxxxxxx&gt;	&lt;474543CC.50505@xxxxxxxxxxxxxxx&gt;	&lt;7f080ed10711220106t543aade7o54657f5cced18858@xxxxxxxxxxxxxx&gt;	&lt;474552DE.9090007@xxxxxxxxxxxxxxx&gt;	&lt;7f080ed10711220830s56faf4d8v1941fa6c61052f35@xxxxxxxxxxxxxx&gt;	&lt;47468BE4.7000804@xxxxxxxxxxxxxxx&gt;	&lt;3b3f50350711251832k469e45a5r247696eaf3e83952@xxxxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>gary thompson</strong> on November 26, 2007 - 09:39:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<br><br><div class="gmail_quote">On Nov 26, 2007 2:32 AM, Chris MacRaild &lt;<a rel="nofollow" href="mailto:macraild@xxxxxxxxxxx">macraild@xxxxxxxxxxx</a>&gt; wrote:<br><blockquote class="gmail_quote" style="border-left: 1px solid rgb(204, 204, 204); margin: 0pt 0pt 0pt 0.8ex; padding-left: 1ex;">
<div class="Ih2E3d">On Nov 23, 2007 7:14 PM, Gary Thompson &lt;<a rel="nofollow" href="mailto:garyt@xxxxxxxxxxxxxxx">garyt@xxxxxxxxxxxxxxx</a>&gt; wrote:<br><br>&gt; &gt;&gt;Hi Ed<br>&gt; &gt;&gt;<br>&gt; &gt;&gt;from looking at the error here I think the problem is that python
<br>&gt; &gt;&gt;internally thinks that Data() is still the classes constructor and is<br>&gt; &gt;&gt;suprised to find that it is a different object...<br>&gt; &gt;&gt;<br>&gt; &gt;&gt;I think the answer is on the following page
<br>&gt; &gt;&gt;<a rel="nofollow" href="http://docs.python.org/lib/pickle-inst.html" target="_blank">http://docs.python.org/lib/pickle-inst.html</a> you need to define<br>&gt; &gt;&gt;__getstate__ and __setstate__ but...<br>&gt; &gt;&gt;
<br>&gt; &gt;&gt;Its Worse than that he&#39;s Dead Jim<br>&gt; &gt;&gt;---------------------------------<br>&gt; &gt;&gt;<br>&gt; &gt;&gt;There is possibly more that you have to do here, we need to check what<br>&gt; &gt;&gt;happens if two state pickles are read in: do we get two different
<br>&gt; &gt;&gt;singletons ! What happens if we read in a pickle after already creating<br>&gt; &gt;&gt;a Data object...<br>&gt; &gt;&gt;<br><br></div>I&#39;m having problems with my computer at home, so cant test any of this
<br>properly, but have a couple of ideas<br><br>One solution is to change names just before we pickle, then change<br>back after unpickling.<br><br>saveData = Data<br>Data = ""><br>should restore sanity, and allow:
<br><br>pickle.dump(saveData, file)<br><br>It is a pretty crude hack, however, and as Gary says, raises lots of<br>questions as to what will happen if a state is loaded on top of the<br>existing, etc...<br><br></blockquote>
<div>yes this was one of my thoughts as well, crude but effective ;-)<br>&nbsp;<br></div><blockquote class="gmail_quote" style="border-left: 1px solid rgb(204, 204, 204); margin: 0pt 0pt 0pt 0.8ex; padding-left: 1ex;"><br>Another (better?) option would be to do saving and restoring state at
<br>a lower level. So instead of simply pickling the whole Data object, we<br>have save and restore methods of the Data class that do the pickling<br>in a more controled way. This seems to me more true to the intent of<br>
the singleton pattern, avoiding the complications Gary refers to. Also<br>the control over what gets saved and how might be useful.<br><br>A quick sketch of the sort of thing I&#39;m thinking:<br><br>class Data(dict):<br>
 &nbsp; &nbsp;...<br> &nbsp; &nbsp;def _save(file):<br> &nbsp; &nbsp; &nbsp; &nbsp;P = Pickler(file)<br> &nbsp; &nbsp; &nbsp; &nbsp;dont_save = [] # a list of attributes that don&#39;t need saving,<br>eg. methods<br> &nbsp; &nbsp; &nbsp; &nbsp;for name, &nbsp;attr in self.__dict__.items():<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if not name in dont_save:
<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;P.dump((name,attr))<br><br> &nbsp; &nbsp;def _restore(file):<br> &nbsp; &nbsp; &nbsp; &nbsp;P = Unpickler(file)<br> &nbsp; &nbsp; &nbsp; &nbsp;while True:<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;try:<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;name, attr = U.load()<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;except EOFError:<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;break<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;setAttr(self, name, attr)<br><br>Then the user commands save_state and restore_state are just<br>front-ends to Data._save and Data._restore. Pickle needn&#39;t wory itself<br>with our unusual namespace, because only attributes of Data are
<br>pickled, not Data itself. Save and restore functions are mehtods of<br>the Singleton object, so there is no risk of breaking the Singleton<br>pattern. Finally, we have the basis of a mechanism there to control<br>what gets saved/restored and how.
<br><br>Cheers,<br><font color="#888888"><br>Chris<br></font><div><div></div><div class="Wj3C7c"><br></div></div></blockquote><div>This seems good but have some other possibly&nbsp; interesting questions<br><br>1. should data be a singleton? what happens if i need to load two data hierachies for example for comparison between two runs (If i am barking up the wrong tree about the current design here please disregard this)
<br>2. we have to&nbsp; be careful we don&#39;t pickle any python state (what is python state can change between versions) How do we identify what is python state, create an empty object?<br>3. Chris&#39;s&nbsp; will add an extra requirement for maintenance in the future as all new fields have to be registered for saving
<br>4. what are the implications for cross version compatability, this may not be a requirement, but if it is then we will have impliment code to shim old&nbsp; formats into newer ones<br>&nbsp;5. If you put an XP hat on you would go with the simple but crude method for the moment and put in place a more complicated methodology if and whn we need it (could we design an interface that could deal with both and then impliment the more complicated stratergy if and when we need it?
<br><br><br>regards<br>gary<br></div><blockquote class="gmail_quote" style="border-left: 1px solid rgb(204, 204, 204); margin: 0pt 0pt 0pt 0.8ex; padding-left: 1ex;"><div><div class="Wj3C7c"><br>&gt; &gt;&gt;we definitley need to write some tests for these cases
<br>&gt; &gt;&gt;<br>&gt; &gt;&gt;<br>&gt; &gt;&gt;regards<br>&gt; &gt;&gt;gary<br>&gt; &gt;&gt;<br>&gt; &gt;&gt;--<br>&gt; &gt;&gt;-------------------------------------------------------------------<br>&gt; &gt;&gt;Dr Gary Thompson
<br>&gt; &gt;&gt;Astbury Centre for Structural Molecular Biology,<br>&gt; &gt;&gt;University of Leeds, Astbury Building,<br>&gt; &gt;&gt;Leeds, LS2 9JT, West-Yorkshire, UK &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tel. +44-113-3433024<br>&gt; &gt;&gt;email: 
<a rel="nofollow" href="mailto:garyt@xxxxxxxxxxxxxxx">garyt@xxxxxxxxxxxxxxx</a> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fax &nbsp;+44-113-2331407<br>&gt; &gt;&gt;-------------------------------------------------------------------<br>&gt; &gt;&gt;<br>&gt; &gt;&gt;
<br>&gt; &gt;&gt;<br>&gt; &gt;&gt;<br>&gt; &gt;&gt;<br>&gt; &gt;<br>&gt; &gt;.<br>&gt; &gt;<br>&gt; &gt;<br>&gt; &gt;<br>&gt;<br>&gt;<br>&gt; --<br>&gt; -------------------------------------------------------------------<br>
&gt; Dr Gary Thompson<br>&gt; Astbury Centre for Structural Molecular Biology,<br>&gt; University of Leeds, Astbury Building,<br>&gt; Leeds, LS2 9JT, West-Yorkshire, UK &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tel. +44-113-3433024<br>&gt; email: <a rel="nofollow" href="mailto:garyt@xxxxxxxxxxxxxxx">
garyt@xxxxxxxxxxxxxxx</a> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fax &nbsp;+44-113-2331407<br>&gt; -------------------------------------------------------------------<br>&gt;<br>&gt;<br>&gt;<br>&gt;<br>&gt; _______________________________________________
<br>&gt; relax (<a rel="nofollow" href="http://nmr-relax.com" target="_blank">http://nmr-relax.com</a>)<br>&gt;<br>&gt; This is the relax-devel mailing list<br>&gt; <a rel="nofollow" href="mailto:relax-devel@xxxxxxx">relax-devel@xxxxxxx</a><br>&gt;<br>
&gt; To unsubscribe from this list, get a password<br>&gt; reminder, or change your subscription options,<br>&gt; visit the list information page at<br>&gt; <a rel="nofollow" href="https://mail.gna.org/listinfo/relax-devel" target="_blank">
https://mail.gna.org/listinfo/relax-devel</a><br>&gt;<br><br>_______________________________________________<br>relax (<a rel="nofollow" href="http://nmr-relax.com" target="_blank">http://nmr-relax.com</a>)<br><br>This is the relax-devel mailing list
<br><a rel="nofollow" href="mailto:relax-devel@xxxxxxx">relax-devel@xxxxxxx</a><br><br>To unsubscribe from this list, get a password<br>reminder, or change your subscription options,<br>visit the list information page at<br><a rel="nofollow" href="https://mail.gna.org/listinfo/relax-devel" target="_blank">
https://mail.gna.org/listinfo/relax-devel</a><br></div></div></blockquote></div><br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00028" href="msg00028.html">Re: Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00021" href="msg00021.html">Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00022" href="msg00022.html">Re: Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> Gary Thompson</li></ul></li>
<li><strong><a name="00023" href="msg00023.html">Re: Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00024" href="msg00024.html">Re: Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> Gary Thompson</li></ul></li>
<li><strong><a name="00025" href="msg00025.html">Re: Pickling problems with the relax data storage singleton.</a></strong>
<ul><li><em>From:</em> Chris MacRaild</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Mon Nov 26 11:41:13 2007</div>  
</body>
</html>
