<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: r25347 &#45; /trunk/user_functions/relax_disp.py -->
<!--X-From-R13: "Sqjneq q'Ohiretar" &#60;rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Thu, 28 Aug 2014 08:54:21 +0200 -->
<!--X-Message-Id: CAED9pY9j8YNVOmrCavz&#45;21m49r2JbjvA6KCsFj7aiaVspKD1+w@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: E1XMhbz&#45;0002CS&#45;O0@subversion.gna.org -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: r25347 - /trunk/user_functions/relax_disp.py -- August 28, 2014 - 08:54</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: r25347 - /trunk/user_functions/relax_disp.py</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00321" class="tabs">Index by Date</a> | <a href="threads.html#00321" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00320.html">Date Prev</a>] [<a href="msg00322.html">Date Next</a>] [<a href="msg00319.html">Thread Prev</a>] [<a href="msg00334.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Thu, 28 Aug 2014 08:53:50 +0200</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:date:message-id:subject :from:to:content-type:content-transfer-encoding; bh=fNTbKv+uy/tqjnxdeENfjX71JHX/A+xmR3zZiZqL+0M=; b=cL7TA1OuZOYb2p2ZAXdpO68yL418RSH0DH/MBmH0fpXRwdqcQ1w+ThAHnbDP9JPGWT 0OguKDCQhPTkm+VtMM3SO0PKBziEkB/4bSEUoxvBRTFEI1r5N6bpo1B8nkT9vLeEnww7 09Z2x6Rzicqd0s9Sxa+7M/pXOI2OxiHxhmLW7mAvH/VxxLCjpxMQ/GEP82FyA7Vvpaqb 7zCJihJk7ZvWrHMpSp+FjA4vpAvMLc7hcqj4jfcv1K/b8GCHCYC0TokCwGKox9eLRr1o KVC054nQP1/GnB4ey66cm0sihAxfANb5OJxXh056bK9vb0jQ/3uuxj2V6ypCyhNvZ3CH yi7A==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00321.html">CAED9pY9j8YNVOmrCavz-21m49r2JbjvA6KCsFj7aiaVspKD1+w@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;E1XMhbz-0002CS-O0@subversion.gna.org&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on August 28, 2014 - 08:54:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi Troels,

Why not call this user function error_analysis.covariance_matrix?  By
using the specific analysis API, you can easily generalise this.  It
requires only a few steps, mainly just shifting your existing code
around:

1)  Rename the user function.

2)  Have a backend in the new module pipe_control.error_analysis (I
may then merge the pipe_control.monte_carlo module into it for a
general module for all error estimate techniques).  A good example of
how to get the specific analysis API and use it is the Monte Carlo
error_analysis() function
(<a  rel="nofollow" href="/api/3.2/pipe_control.monte_carlo-pysrc.html#error_analysis">http://www.nmr-relax.com/api/3.2/pipe_control.monte_carlo-pysrc.html#error_analysis</a>).

3)  Add a new API method to specific_analyses.api_base which, like
most of the others, raises a RelaxImplementError (e.g.
covariance_matrix()).  This allows each analysis type to implement it
as desired, and allows the user function to fail cleanly when used on
an analysis that doesn't support it.

4)  Shift the covariance matrix calculation code of multifit_covar()
into the relax library, maybe in the lib.statistics module.  Btw, the
docstring of this function needs a bit of work to allow the API
documentation to be compiled.

5)  Create the dispersion specific covariance_matrix() method which
obtains the Jacobian and calls the relax library function.  This would
just be the estimate_r2eff_err() function converted into a method.

This is how you add functionality to this API, and it would be a
useful learning exercise.  If you know how to control this API, it
will be very powerful when you are adding new features to relax.  In
this case, most of your code is unrelated to the dispersion analysis
and it is a perfect example of such an independent and powerful
feature.  It would be a rather simple exercise, changing the new
system tests and just shifting the current functions/methods to fit
into this infrastructure.

Note that the feature of estimating the initial exponential curve
parameters by linearisation is also partly analysis independent as it
is of benefit for the relaxation curve-fitting analysis type as well.
So it could be spun out as a separate user function (maybe
exponential_curve.linear_estimate), use the specific API, and putting
the specific_analyses/relax_disp/estimate_r2eff.py
Exp.estimate_x0_exp() method into the relax library.  This too would
be a simple code shifting exercise.

What do you think?  The specific analysis API is one of the most
important design concepts in relax, and being able to control and
extend it will allow new ideas to be added much more quickly.

Regards,

Edward


On 27 August 2014 20:06,  &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Author: tlinnet
Date: Wed Aug 27 20:06:23 2014
New Revision: 25347

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=25347&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=25347&amp;view=rev</a>
Log:
Added front-end to the new user function relax_disp.r2eff_err_estimate(), 
which will estimate the R2eff errors
from a pipe and spins with optimised values of R2eff and i0.

The co-variance matrix can be calculated from the optimised parameters, and 
the Jacobian.

Big care should be taken not to directly trust these results, since the 
errors are quite different compared to the Monte-Carlo simulations.

This implementation, will reach the exact same error estimation as 
scipy.optimize.leastsq.

But with much better control over the data, and insight into the 
calculations.

task #7822(<a  rel="nofollow" href="https://web.archive.org/web/https://gna.org/task/index.php?7822">https://gna.org/task/index.php?7822</a>): Implement user function to 
estimate R2eff and associated errors for exponential curve fitting.

Modified:
    trunk/user_functions/relax_disp.py

Modified: trunk/user_functions/relax_disp.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/trunk/user_functions/relax_disp.py?rev=25347&amp;r1=25346&amp;r2=25347&amp;view=diff">http://svn.gna.org/viewcvs/relax/trunk/user_functions/relax_disp.py?rev=25347&amp;r1=25346&amp;r2=25347&amp;view=diff</a>
==============================================================================
--- trunk/user_functions/relax_disp.py  (original)
+++ trunk/user_functions/relax_disp.py  Wed Aug 27 20:06:23 2014
@@ -40,6 +40,7 @@
 from pipe_control.mol_res_spin import get_spin_ids
 from specific_analyses.relax_disp.catia import catia_execute, catia_input
 from specific_analyses.relax_disp.cpmgfit import cpmgfit_execute, 
cpmgfit_input
+from specific_analyses.relax_disp.estimate_r2eff import estimate_r2eff_err
 from specific_analyses.relax_disp.data import cpmg_setup, insignificance, 
plot_disp_curves, plot_exp_curves, r2eff_read, r2eff_read_spin, relax_time, 
set_exp_type, r20_from_min_r2eff, spin_lock_field, spin_lock_offset, 
write_disp_curves
 from specific_analyses.relax_disp.data import INTERPOLATE_DISP, 
INTERPOLATE_OFFSET, X_AXIS_DISP, X_AXIS_W_EFF, X_AXIS_THETA, 
Y_AXIS_R2_R1RHO, Y_AXIS_R2_EFF
 from specific_analyses.relax_disp.nessy import nessy_input
@@ -627,6 +628,50 @@
 uf.gui_icon = &quot;oxygen.status.object-locked&quot;
 uf.wizard_size = (800, 500)
 uf.wizard_image = ANALYSIS_IMAGE_PATH + 'relax_disp_200x200.png'
+
+
+# The relax_disp.r2eff_err_estimate user function.
+uf = uf_info.add_uf('relax_disp.r2eff_err_estimate')
+uf.title = &quot;Estimate R2eff errors by the Jacobian matrix.&quot;
+uf.title_short = &quot;Estimate R2eff errors.&quot;
+uf.add_keyarg(
+    name = &quot;spin_id&quot;,
+    py_type = &quot;str&quot;,
+    arg_type = &quot;spin ID&quot;,
+    desc_short = &quot;spin ID to restrict value setting to&quot;,
+    desc = &quot;The spin ID string to restrict value setting to.&quot;,
+    can_be_none = True
+)
+uf.add_keyarg(
+    name = &quot;epsrel&quot;,
+    py_type = &quot;float&quot;,
+    default = 0.0,
+    desc_short = &quot;parameter to remove linear-dependent columns.&quot;,
+    desc = &quot;The parameter to remove linear-dependent columns when J is 
rank deficient.&quot;,
+    can_be_none = False
+)
+uf.add_keyarg(
+    name = &quot;verbosity&quot;,
+    default = 1,
+    py_type = &quot;int&quot;,
+    desc_short = &quot;amount of information to print.&quot;,
+    desc = &quot;The higher the value, the greater the verbosity.&quot;,
+    can_be_none = False
+)
+# Description.
+uf.desc.append(Desc_container())
+uf.desc[-1].add_paragraph(&quot;This is a new experimental feature from version 
3.3, and should only be tried out with big care.&quot;)
+uf.desc[-1].add_paragraph(&quot;This will estimate R2eff errors by using the 
exponential decay Jacobian matrix 'J' to compute the covariance matrix of 
the best-fit parameters.&quot;)
+uf.desc[-1].add_paragraph(&quot;This can be an huge time saving step, when 
performing model fitting in R1rho.  Errors of R2eff values, are normally 
estimated by time-consuming Monte-Carlo simulations.&quot;)
+uf.desc[-1].add_paragraph(&quot;This method is inspired from the GNU Scientific 
Library (GSL).&quot;)
+uf.desc[-1].add_paragraph(&quot;The covariance matrix is given by: covar = Qxx 
= (J^T J)^{-1}.&quot;)
+uf.desc[-1].add_paragraph(&quot;Qxx is computed by QR decomposition, Qxx=QR, 
Qxx^-1=R^-1 Q^T.  The columns of R which satisfy: |R_{kk}| &lt;= epsrel 
|R_{11}| are considered linearly-dependent and are excluded from the 
covariance matrix (the corresponding rows and columns of the covariance 
matrix are set to zero).&quot;)
+uf.desc[-1].add_paragraph(&quot;The parameter 'epsrel' is used to remove 
linear-dependent columns when J is rank deficient.&quot;)
+uf.backend = estimate_r2eff_err
+uf.menu_text = &quot;&amp;r2eff_err_estimate&quot;
+uf.gui_icon = &quot;relax.relax_fit&quot;
+uf.wizard_size = (800, 800)
+uf.wizard_image = ANALYSIS_IMAGE_PATH + sep + 'blank_150x150.png'


 # The relax_disp.r2eff_read user function.


_______________________________________________
relax (<a  rel="nofollow" href="/">http://www.nmr-relax.com</a>)

This is the relax-commits mailing list
relax-commits@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="/mail.gna.org/listinfo/relax-commits">https://mail.gna.org/listinfo/relax-commits</a>
</pre></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00334" href="msg00334.html">Re: r25347 - /trunk/user_functions/relax_disp.py</a></strong>
<ul><li><em>From:</em> Troels Emtek√¶r Linnet</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Thu Aug 28 10:40:17 2014</div>  
</body>
</html>
