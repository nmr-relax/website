<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: bug? previous vs. current model test in full_analysis -->
<!--X-From-R13: Rbhtynf Ybwrgva <qbhtynf.xbwrgvaNtznvy.pbz> -->
<!--X-Date: Tue, 18 Sep 2007 12:48:51 +0200 -->
<!--X-Message-Id: 7CEF67E4&#45;F7F1&#45;4CF5&#45;9779&#45;E5353133624A@gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: A4C2B7BD&#45;E757&#45;4ED2&#45;B5E3&#45;FA47EB1006E6@gmail.com -->
<!--X-Reference: 7f080ed10709170848h6cdf16c7g422a7a93d2935583@mail.gmail.com -->
<!--X-Reference: D59D0103&#45;7DFF&#45;461D&#45;84BA&#45;498817A81A2E@gmail.com -->
<!--X-Reference: 7f080ed10709171312n4dde68b9x3def15ffbe87f1f2@mail.gmail.com -->
<!--X-Reference: B222C890&#45;F078&#45;4415&#45;A297&#45;5EBDD48F7997@gmail.com -->
<!--X-Reference: 7f080ed10709180141n75825e25h3f22d635527081d9@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: bug? previous vs. current model test in full_analysis -- September 18, 2007 - 12:48</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: bug? previous vs. current model test in full_analysis</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00018" class="tabs">Index by Date</a> | <a href="threads.html#00018" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00017.html">Date Prev</a>] [<a href="msg00019.html">Date Next</a>] [<a href="msg00017.html">Thread Prev</a>] [<a href="msg00019.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: Edward d'Auvergne &lt;edward.dauvergne@xxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Tue, 18 Sep 2007 06:48:07 -0400</li>
<li class="menuitem">
<em>Cc</em>: relax-users@xxxxxxx</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00018.html">7CEF67E4-F7F1-4CF5-9779-E5353133624A@gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;A4C2B7BD-E757-4ED2-B5E3-FA47EB1006E6@xxxxxxxxx&gt;	&lt;7f080ed10709170848h6cdf16c7g422a7a93d2935583@xxxxxxxxxxxxxx&gt;	&lt;D59D0103-7DFF-461D-84BA-498817A81A2E@xxxxxxxxx&gt;	&lt;7f080ed10709171312n4dde68b9x3def15ffbe87f1f2@xxxxxxxxxxxxxx&gt;	&lt;B222C890-F078-4415-A297-5EBDD48F7997@xxxxxxxxx&gt;	&lt;7f080ed10709180141n75825e25h3f22d635527081d9@xxxxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Douglas Kojetin</strong> on September 18, 2007 - 12:48:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
Hi Edward,

</pre><tt>I forgot about the dictionary order issue.  If you want me to modify  
</tt><tt>the code as you mentioned, let me know.
</tt><pre style="margin: 0em;">

Doug


On Sep 18, 2007, at 4:41 AM, Edward d'Auvergne wrote:

</pre><blockquote class="blockquote"><pre style="margin: 0em;">
Hi,

I've reviewed the patch attached to bug #10022
(<a  rel="nofollow" href="https://web.archive.org/web/https://gna.org/bugs/?10022">https://gna.org/bugs/?10022</a>), and have found an issue.  The problem
is with the use of two dictionaries for the previous and current run.
The issue is that order in a dictionary is not guaranteed, and hence
the comparison may not work.  Maybe a simple test such as &quot;if
self.relax.data.res[run][i].model == None&quot; or its negative after
testing for the presence of the 'model' attribute, and removal of the
dictionary would remove the problem.  Significant simplifications to
the code after the comment &quot;# The test.&quot; could also be made.

As for the code in the section &quot;NOTE:  the following code has not been
extenstively tested&quot;, this does not directly address the bug itself
and it will have problems with the dictionary ordering.  I would
prefer that this section not be present in the patch.  If someone does
have different residues in two different iterations of
full_analysis.py then this error is much more severe and belongs
elsewhere other than in the convergence tests.

Cheers,

Edward



On 9/18/07, Douglas Kojetin &lt;douglas.kojetin@xxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">
Hi Edward,

I submitted this as a bug report.  I modified the full_analysis.py
file after a SVN refresh.  Unless you have a quick way of doing so, I
will test the cleaned up version (submitted as a patch to the bug
report) tomorrow.

Doug


On Sep 17, 2007, at 4:12 PM, Edward d'Auvergne wrote:

</pre><blockquote class="blockquote"><pre style="margin: 0em;">
Hi,

In your previous post
(<a  rel="nofollow" href="/mail.gna.org/public/relax-users/2007-09/msg00011.html">https://mail.gna.org/public/relax-users/2007-09/msg00011.html</a>,
</pre><tt>Message-id: &lt;59CF5ABD-2724-4547-B9E7-0F66E545F368@xxxxxxxxx&gt;) I  
</tt><tt>think
</tt><tt>you were spot on with the diagnosis.  The reading of the results  
</tt><tt>files
</tt><tt>with None in all model positions will create variables called  
</tt><tt>'model'
</tt><pre style="margin: 0em;">
with the value set to None.  Then the string comparison will fail
unless these are skipped as well.  Well done on picking up the exact
cause of the failure.  This important change will need to go into
relax before a new release with the more advanced 'full_analysis.py'
script.

If you would like to post the changes, I can add these to the
</pre><tt>repository.  I'll need to check the change carefully first  
</tt><tt>though, and
</tt><pre style="margin: 0em;">
it may only require two lines in the script to be changed.  The best
</pre><tt>way would be to attach a patch to a bug report.  If you could  
</tt><tt>create a
</tt><tt>bug report with a simple summary, that would be appreciated.   
</tt><tt>Then how
</tt><tt>you report the changes is up to you.  If you change a checked out  
</tt><tt>copy
</tt><pre style="margin: 0em;">
of the SVN repository and type 'svn diff &gt; patch', you'll get the
changes in a patch file which I can then check and commit to the
repository with your name attached.

Thanks,

Edward


On 9/17/07, Douglas Kojetin &lt;douglas.kojetin@xxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">
As a followup, my changes to full_analysis.py solved my problem.  I
will clean up my code and post it within the next day or so.  Would
</pre><tt>you prefer that I attach the script as an attachment, or inline  
</tt><tt>in an
</tt><pre style="margin: 0em;">
email, or provide a patch, or change the CVS code myself?

Doug


On Sep 17, 2007, at 11:48 AM, Edward d'Auvergne wrote:

</pre><blockquote class="blockquote"><pre style="margin: 0em;">
Hi,

The problem is likely to be due to a circular looping around very
</pre><tt>similar solutions close to the universal solution, as I have  
</tt><tt>defined
</tt><pre style="margin: 0em;">
in:

d'Auvergne EJ, Gooley PR. Set theory formulation of the model-free
problem and the diffusion seeded model-free paradigm. Mol Biosyst.
2007 Jul;3(7):483-94.

If you can't get the paper, have a look at Chapter 5 of my PhD
thesis at
<a  rel="nofollow" href="http://eprints.infodiv.unimelb.edu.au/archive/00002799/">http://eprints.infodiv.unimelb.edu.au/archive/00002799/</a>.  The
problem
is the interlinked mathematical optimisation and statistical model
</pre><tt>selection where we are trying to minimise different  
</tt><tt>quantities.  For
</tt><tt>mathematical optimisation this is the chi-squared value.  For  
</tt><tt>model
</tt><tt>selection this is the quantity known as the descrepancy.  These  
</tt><tt>can
</tt><pre style="margin: 0em;">
not be optimised together as mathematical optimisation works in a
single fixed-dimension space or universe whereas model selection
</pre><tt>operates across multiple spaces with different dimensions.  See  
</tt><tt>the
</tt><pre style="margin: 0em;">
paper for a more comprehensive description of the issue.

</pre><tt>You should be able to see this if you look at the end of  
</tt><tt>iterations.
</tt><pre style="margin: 0em;">
If you have 160 iterations, look after iteration 20 (or maybe
even 30
or further).  Until then, you will not have reached the circular
loop.
</pre><tt> After that point you will be able to exactly quatify this  
</tt><tt>circular
</tt><pre style="margin: 0em;">
loop.  You'll be able to determine its periodicity, which
residues are
</pre><tt>involved (probably only 1), and whether the diffusion tensor  
</tt><tt>changes
</tt><pre style="margin: 0em;">
as model selection changes.

I mentioned all of this already in my post at
<a  rel="nofollow" href="/mail.gna.org/public/relax-users/2007-07/msg00001.html">https://mail.gna.org/public/relax-users/2007-07/msg00001.html</a>
(Message-id:
&lt;7f080ed10707090104r60453839of0b9df58022501d2@xxxxxxxxxxxxxx&gt;)
in response to your original post
(<a  rel="nofollow" href="/mail.gna.org/public/relax-users/2007-06/msg00004.html">https://mail.gna.org/public/relax-users/2007-06/msg00004.html</a>,
Message-id: &lt;2ED509BE-FA07-4ED0-96F0-E4E612405DC7@xxxxxxxxx&gt;).

I have a few more points about the tests you have done but to
work out
what is happening with the printouts, it would be very useful to
have
your modified 'full_analysis.py' script attached.



On 9/17/07, Douglas Kojetin &lt;douglas.kojetin@xxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">
Hi,

I'm unsure if this is a bug in full_analysis.py, in the internal
</pre><tt>relax code, or user error.  The optimization of the 'sphere'  
</tt><tt>model
</tt><pre style="margin: 0em;">
will not converge, now after 160+ rounds.   The chi-squared test
has
converged (long, long ago):
</pre></blockquote><pre style="margin: 0em;">

See above.


</pre><blockquote class="blockquote"><pre style="margin: 0em;">
&quot;&quot; from output
         Chi-squared test:
             chi2 (k-1): 100.77647517006251
             chi2 (k):   100.77647517006251
             The chi-squared value has converged.
&quot;&quot;

However, the identical model-free models test does has not
converged:

&quot;&quot; from output
         Identical model-free models test:
             The model-free models have not converged.

         Identical parameter test:
             The model-free models haven't converged hence the
parameters haven't converged.
&quot;&quot;

Something that confuses me is that the output files in the
round_??/
aic directory suggest that, for example, the round_160 and
round_161
AIC model selections are equivalent.  Here are the models for the
first few residues:
</pre></blockquote><pre style="margin: 0em;">

Between these 2 rounds, are you sure that all models for all
residues
are identical?  From your data that you posted at
<a  rel="nofollow" href="/mail.gna.org/public/relax-users/2007-06/msg00017.html">https://mail.gna.org/public/relax-users/2007-06/msg00017.html</a>
(Message-id: &lt;B52B2F07-8B2C-4FAE-B270-902C2A1B3619@xxxxxxxxx&gt;), I
would guess that this is not the case and one or two residues
actually
do change in their model selections.


</pre><blockquote class="blockquote"><pre style="margin: 0em;">
&quot;&quot;
         1 None None
         2 None None
         3 None None
         4 m2 m2
         5 m2 m2
         6 m2 m2
         7 m2 m2
         8 m2 m2
         9 m4 m4
         10 m1 m1
         11 None None
         12 m2 m2
         13 m2 m2
         14 m1 m1
         15 m2 m2
         16 m3 m3
         17 m3 m3
         18 None None
&quot;&quot;

However, I modified the full_analysis.py protocol to print the
differences in the model selection, within the 'Identical model-
free
model test' section of the 'convergence' definition. Here is the
beginning of the output (which only contains differences between
the
previous and current rounds):

&quot;&quot;
         residue 1: prev=None curr=m2
         residue 2: prev=None curr=m2
         residue 3: prev=None curr=m2
         residue 6: prev=m2 curr=m4
         residue 7: prev=m2 curr=m1
         residue 9: prev=m4 curr=m2
         residue 11: prev=None curr=m2
         residue 12: prev=m2 curr=m3
         residue 13: prev=m2 curr=m3
         residue 15: prev=m2 curr=m1
         residue 16: prev=m3 curr=m2
         residue 17: prev=m3 curr=m1
         residue 18: prev=None curr=m3
&quot;&quot;
</pre></blockquote><pre style="margin: 0em;">

This output is quite strange.  I would need to see the
full_analysis.py script to do more with this.


</pre><blockquote class="blockquote"><tt>There should be no data for residues 1-3, 11 and 18 (None),  
</tt><tt>however
</tt><pre style="margin: 0em;">
the 'Identical model-free model test' seems as if it ignores
residues
for which 'None' was selected in the curr_model call in the
following
code:

&quot;&quot;
         # Create a string representation of the model-free
models of
the previous run.
         prev_models = ''
         for i in xrange(len(self.relax.data.res['previous'])):
             if hasattr(self.relax.data.res['previous'][i],
'model'):
                 #prev_models = prev_models + self.relax.data.res
['previous'][i].model
                 prev_models = prev_models + ' ' +
self.relax.data.res
['previous'][i].model

         # Create a string representation of the model-free
models of
the current run.
         curr_models = ''
         for i in xrange(len(self.relax.data.res[run])):
             if hasattr(self.relax.data.res[run][i], 'model'):
                 #curr_models = curr_models + self.relax.data.res
[run]
[i].model
                 curr_models = curr_models + ' ' +
self.relax.data.res
[run][i].model
&quot;&quot;
</pre></blockquote><pre style="margin: 0em;">

As residues 1-3, 11 and 18 are deselected, then they will not
have the
</pre><tt>attribute 'model' and hence will not be placed in the  
</tt><tt>prev_models or
</tt><pre style="margin: 0em;">
curr_models string (which are then compared).


</pre><blockquote class="blockquote"><pre style="margin: 0em;">
For what it's worth, I have residues 1,2,3,11 and 18 in the file
'unresolved' which is read by the full_analysis.py protocol.  I
created a separate sequence file (variable = SEQUENCE) that
contains
all residues (those with data and those without), instead of
using a
data file (noe data, in the default full_analysis.py file).
However,
these residues are not specified in the data (r1, r2 and noe)
files,
as I did not have data for them.  Should I add them but place
'None'
</pre><tt>in the data and error columns?  Could that be causing the  
</tt><tt>problems?
</tt><pre style="margin: 0em;">
Or should I create a bug report for this?
</pre></blockquote><pre style="margin: 0em;">

I'm not sure what you mean by the file '(variable = SEQUENCE)'
statement.  I would need to see the full_analysis.py script to
understand this.  I would assume a file called the value in the
variable 'SEQUENCE'.  In which case, this should not be a
problem.  As
the data is missing from the files containing the relaxation data,
these residues will not be used in model-free analysis.  They
will be
automatically deselected.  There is not need to add empty data for
</pre><tt>these spin systems into the relaxation data files.  As I said  
</tt><tt>before
</tt><pre style="margin: 0em;">
at the top of this message and at
<a  rel="nofollow" href="/mail.gna.org/public/relax-users/2007-07/msg00001.html">https://mail.gna.org/public/relax-users/2007-07/msg00001.html</a>
(Message-id:
&lt;7f080ed10707090104r60453839of0b9df58022501d2@xxxxxxxxxxxxxx&gt;),
</pre><tt>the problem is almost guaranteed to be a circular loop of  
</tt><tt>equivalent
</tt><pre style="margin: 0em;">
solutions circling around the universal solution - the solution
defined within the universal set (the union of all global models
</pre><tt>(diffusion tensor + all model-free models of all residues)).   
</tt><tt>If you
</tt><pre style="margin: 0em;">
have hit this circular problem, then I suggest you stop running
relax.
 What I would then do is identify the spin system (or systems)
causing
the loop, and what the differences are between all members of the
loop.  This you can do by plotting the data and maybe using the
program diff on uncompressed versions of the results files.  It's
likely that the differences are small and inconsequential.  I hope
this helps.

Regards,

Edward
</pre></blockquote><pre style="margin: 0em;">


</pre></blockquote></blockquote><pre style="margin: 0em;">


</pre></blockquote></blockquote><pre style="margin: 0em;">



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00007" href="msg00007.html">bug? previous vs. current model test in full_analysis</a></strong>
<ul><li><em>From:</em> Douglas Kojetin</li></ul></li>
<li><strong><a name="00008" href="msg00008.html">Re: bug? previous vs. current model test in full_analysis</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00012" href="msg00012.html">Re: bug? previous vs. current model test in full_analysis</a></strong>
<ul><li><em>From:</em> Douglas Kojetin</li></ul></li>
<li><strong><a name="00013" href="msg00013.html">Re: bug? previous vs. current model test in full_analysis</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00016" href="msg00016.html">Re: bug? previous vs. current model test in full_analysis</a></strong>
<ul><li><em>From:</em> Douglas Kojetin</li></ul></li>
<li><strong><a name="00017" href="msg00017.html">Re: bug? previous vs. current model test in full_analysis</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Tue Sep 18 14:01:02 2007</div>  
</body>
</html>
