<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: numerical cpmg fit -->
<!--X-From-R13: Bnhy Epunaqn <cnhy.fpunaqnNtzk.ng> -->
<!--X-Date: Tue, 16 Jul 2013 08:02:32 +0200 -->
<!--X-Message-Id: 2C4C588B&#45;0E68&#45;4FF0&#45;83B7&#45;7D349A40FA2C@gmx.at -->
<!--X-Content-Type: multipart/alternative -->
<!--X-Reference: 35036407&#45;39A6&#45;4B59&#45;B529&#45;7074D5F10DBA@gmx.at -->
<!--X-Reference: CAED9pY_zKf+1kML6UNezswM1NQtvZh7n7Jdz_Ss1H5Kn2cj5kw@mail.gmail.com -->
<!--X-Reference: CAED9pY9HUHQ1X6zQpY8CmPR3NFoSXJwgeP02Nme1Y447&#45;6U9RQ@mail.gmail.com -->
<!--X-Reference: CAED9pY_cN9pSyBX2F+ji1gYHN7RkwY72PwE4_&#45;8dEVNU&#45;4R1jg@mail.gmail.com -->
<!--X-Reference: 390EF589&#45;7B7E&#45;466A&#45;BE67&#45;021D16E7E12B@gmx.at -->
<!--X-Reference: CAED9pY8cqOqAhYDFxVCK+Sm8rJ7=p8GFPwKTHwdzg2U8DZsd_w@mail.gmail.com -->
<!--X-Reference: 0B2A8433&#45;C5BE&#45;4388&#45;A04C&#45;9AF1D365A60D@gmx.at -->
<!--X-Reference: CAED9pY9raZ6Gx8kH8+ghtWAArD9wMUeZF4ZZz=v6fDM93TjwdQ@mail.gmail.com -->
<!--X-Reference: CAED9pY_7Mq&#45;uqwXA+o7Ukzncpo2DMjfraogH0vwM_Meg8zEpuA@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: numerical cpmg fit -- July 16, 2013 - 08:02</title>
<link rel="stylesheet" type="text/css" href="/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="https://gna.org/images/gna.theme/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: numerical cpmg fit</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00037" class="tabs">Index by Date</a> | <a href="threads.html#00037" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00036.html">Date Prev</a>] [<a href="msg00038.html">Date Next</a>] [<a href="msg00034.html">Thread Prev</a>] [<a href="msg00044.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;Edward d'Auvergne&quot; &lt;edward@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Tue, 16 Jul 2013 08:01:59 +0200</li>
<li class="menuitem">
<em>Cc</em>: mathilde lescanne &lt;mathilde.lescanne@xxxxxxxxx&gt;,	&quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00037.html">2C4C588B-0E68-4FF0-83B7-7D349A40FA2C@gmx.at</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;35036407-39A6-4B59-B529-7074D5F10DBA@xxxxxx&gt;	&lt;CAED9pY_zKf+1kML6UNezswM1NQtvZh7n7Jdz_Ss1H5Kn2cj5kw@xxxxxxxxxxxxxx&gt;	&lt;CAED9pY9HUHQ1X6zQpY8CmPR3NFoSXJwgeP02Nme1Y447-6U9RQ@xxxxxxxxxxxxxx&gt;	&lt;CAED9pY_cN9pSyBX2F+ji1gYHN7RkwY72PwE4_-8dEVNU-4R1jg@xxxxxxxxxxxxxx&gt;	&lt;390EF589-7B7E-466A-BE67-021D16E7E12B@xxxxxx&gt;	&lt;CAED9pY8cqOqAhYDFxVCK+Sm8rJ7=p8GFPwKTHwdzg2U8DZsd_w@xxxxxxxxxxxxxx&gt;	&lt;0B2A8433-C5BE-4388-A04C-9AF1D365A60D@xxxxxx&gt;	&lt;CAED9pY9raZ6Gx8kH8+ghtWAArD9wMUeZF4ZZz=v6fDM93TjwdQ@xxxxxxxxxxxxxx&gt;	&lt;CAED9pY_7Mq-uqwXA+o7Ukzncpo2DMjfraogH0vwM_Meg8zEpuA@xxxxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Paul Schanda</strong> on July 16, 2013 - 08:02:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<table width="100%"><tr><td style=""><div>Yes, that's right. As one of the states is assumed to be at zero frequency, the frequency of the other state is the same as the chemical shift difference.</div><div><br></div><div>paul</div><div><br></div><br><div><div>Am 15.07.2013 um 10:56 schrieb "Edward d'Auvergne" &lt;<a rel="nofollow" href="mailto:edward@xxxxxxxxxxxxx">edward@xxxxxxxxxxxxx</a>&gt;:</div><br class="Apple-interchange-newline"><blockquote type="cite">Hi,<br><br>Could it be that the 'fg' parameter in the original code at<br><a rel="nofollow" href="http://thread.gmane.org/gmane.science.nmr.relax.devel/4132">http://thread.gmane.org/gmane.science.nmr.relax.devel/4132</a> is actually<br>the chemical shift difference? &nbsp;Is 'fe' assumed to be zero, hence 'fg<br>= fe + df', where 'df' is the chemical shift difference in rad/second?<br><br>Regards,<br><br>Edward<br><br><br>On 15 July 2013 10:01, Edward d'Auvergne &lt;<a rel="nofollow" href="mailto:edward@xxxxxxxxxxxxx">edward@xxxxxxxxxxxxx</a>&gt; wrote:<br><blockquote type="cite">Hi,<br><br><blockquote type="cite">fg is the frequency of the ground state (call it "A" or "G"), while fe is the excited state frequency.<br></blockquote><br>Is this the chemical shift in Hz? &nbsp;Or the chemical shift difference in<br>Hz? &nbsp;The code does not use the 'fe' parameter, so how is the chemical<br>shift of the excited state handled? &nbsp;Does this mean that chemical<br>shifts need to be explicitly given? &nbsp;How does this work with<br>intermediate to fast exchange where the shift of the peak is a mixture<br>of the two chemical shifts?<br><br>I'm still not sure how to handle this in relax. &nbsp;I may need to add a<br>new dispersion parameter(s) to the definitions at the start of the<br>Relax_disp class in specific_analyses/relax_disp/api.py. &nbsp;Though very<br>easy to expand, this currently only supports the following parameters<br>for chemical shifts:<br><br>phi_ex = pA.pB.dw**2 (in ppm^2)<br>padw2 = pA.dw**2 (in ppm^2)<br>dw = (in ppm)<br><br>where dw is the chemical shift difference. &nbsp;In all of the analytic<br>models, only dw is used.<br><br><br><blockquote type="cite">tcpmg is the total duration of the CPMG element. At some instances this is called Tc instead of tcpmg.<br>Not to be confused with the delay before and after each pulse, which is tcp. I.e., between two 180deg pulses there are two delays tcp.<br></blockquote><br>Thank you for the additional details. &nbsp;I have now updated the<br>lib/dispersion/ns_2site_star.py file with the details<br>(<a rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.scm/18046">http://article.gmane.org/gmane.science.nmr.relax.scm/18046</a>).<br><br><br><blockquote type="cite">I saw that you keep the convention of "G" and "E" in the functions. Is this also used in the existing functions, or do you use "A" and "B" there? It might be cleaner to have a coherent naming convention.<br></blockquote><br>I am in the process of converting. &nbsp;I think I'll use the arbitrary mapping:<br><br>G -&gt; A<br>E -&gt; B<br><br>This is for consistency within relax between this code and the<br>analytic models, as well as to minimise user confusion. &nbsp;It will also<br>allow relax to more logically support a C state for the 3-site models.<br><br><br><blockquote type="cite">Here are some comments to the function:<br><br><br>70 # Initialise some structures.<br>71 Rr = -1.0 * matrix([[r20b, 0.0],[0.0, r20a]])<br>72 Rex = -1.0 * matrix([[kge, -keg],[-kge, keg]])<br>73 RCS = complex(0.0, -1.0) * matrix([[0.0, 0.0],[0.0, fg]])<br>74 R = Rr + Rex + RCS<br>75 cR2 = conj(R) * 2.0<br>76<br>77 kex = kge + keg # conversion of kinetic rates<br>78 IGeq = keg / kex # calculate relative populations - will be used for generating the equilibrium magnetizations<br>79 IEeq = kge / kex # like preceding line, but for excited state<br>80 M0 = matrix([[IGeq], [IEeq]]) # This is a vector that contains the initial magnetizations, corresponding to ground (G) and excited (E) state transverse magnetizations<br>81<br>82 # Replicated calculations for faster operation.<br>83 inv_tcpmg = 1.0 / tcpmg<br>84<br>85 # Loop over the time points, back calculating the R2eff values.<br>86 for i in range(num_points):<br>87 # Replicated calculations for faster operation.<br>88 tcp = 0.25 / cpmg_frqs[i]<br>89 expm_R_tcp = expm(R*tcp) # This matrix is a propagator that will evolve the magnetization with the matrix R for a delay tcp<br>90<br>91 prop_2 = dot(dot(expm_R_tcp, expm(cR2*tcp)), expm_R_tcp) # This is the propagator for an element of delay tcp - 180degpulse -2 times delay tcp - 180degpulse - delay tau, i.e. for 2 times tau-180-tau<br>92<br>93 prop_total = square_matrix_power(prop_2, cpmg_frqs[i]*tcpmg) # Now create the total propagator, that will evolve the magnetization under the CPMG train, ie. it applies the above tau-180-tau-tau-180-tau so many times as required for the CPMG frequency under consideration.<br>94<br>95 Moft = prop_total * M0 # now we apply the above propagator to the initial magnetization vector - resulting in the magnetization that remains after the full CPMG pulse train. It is called M of t (t is the time after the CPMG train<br>96<br>97 Mgx = Moft[0].real / M0[0] # This and the next line calculate the R2eff, using a two-point approximation, i.e. assuming that the decay is mono-exponential.<br>98 back_calc[i]= -inv_tcpmg * log(Mgx)<br></blockquote><br>These comments are awesome!!! &nbsp;It's far better than what I could have<br>added. &nbsp;The code in lib/dispersion/ns_2site_star.py is now a perfect<br>teaching aid that can be shown directly to students. &nbsp;It will also<br>allow NMR spectroscopists who are not experts to quickly learn from<br>the code. &nbsp;I have added all of these comments and updated your<br>copyright notice appropriately.<br><br><br><blockquote type="cite">Thanks for the implementation!<br></blockquote><br>Thank you for contributing the code. &nbsp;I hope this will up and running<br>soon and, together with the tools built into relax, that the<br>calculations will even be faster.<br><br>Cheers,<br><br>Edward<br></blockquote></blockquote></div><br><div apple-content-edited="true">
<span class="Apple-style-span" style="border-collapse: separate; color: rgb(0, 0, 0); font-family: Helvetica; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium; "><span class="Apple-style-span" style="border-collapse: separate; color: rgb(0, 0, 0); font-family: Helvetica; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium; "><span class="Apple-style-span" style="border-collapse: separate; color: rgb(0, 0, 0); font-family: Helvetica; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium; "><div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; "><div><br class="Apple-interchange-newline"><br></div><div>***************************</div><div><br></div><div>Paul Schanda</div><div><a rel="nofollow" href="mailto:paul.schanda@xxxxxx">paul.schanda@xxxxxx</a></div><div><br></div></div></span><br class="Apple-interchange-newline"></span><br class="Apple-interchange-newline"></span>
</div>
<br></td></tr></table>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00044" href="msg00044.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00010" href="msg00010.html">numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Paul Schanda</li></ul></li>
<li><strong><a name="00011" href="msg00011.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00012" href="msg00012.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00017" href="msg00017.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00018" href="msg00018.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Paul Schanda</li></ul></li>
<li><strong><a name="00025" href="msg00025.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00030" href="msg00030.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Paul Schanda</li></ul></li>
<li><strong><a name="00032" href="msg00032.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00034" href="msg00034.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer">You are on the <a href="http://gna.org">Gna!</a> mail server.</div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Wed Jul 17 11:20:10 2013</div>  
</body>
</html>
