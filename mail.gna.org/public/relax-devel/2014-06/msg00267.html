<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: r23996 &#45; /branches/disp_spin_speed/target_functions/relax_disp.py -->
<!--X-From-R13: "Sqjneq q'Ohiretar" &#60;rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Tue, 17 Jun 2014 10:47:29 +0200 -->
<!--X-Message-Id: CAED9pY&#45;=P9tqYzrDZS5JfD&#45;DxWFafoRHJZDUCbg45Fm36KT2=A@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: E1WwbAg&#45;0003gY&#45;1i@subversion.gna.org -->
<!--X-Reference: CAED9pY_zv8Q41t&#45;6te+JLX1+2FygHkbx1F2p=1_FrLK+8g31AA@mail.gmail.com -->
<!--X-Reference: CA+CBx2MqZ2c86uNg7544DiGMHEh0WPK1uYzm7=xfTMBAT4Ra5Q@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: r23996 - /branches/disp_spin_speed/target_functions/relax_disp.py -- June 17, 2014 - 10:47</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: r23996 - /branches/disp_spin_speed/target_functions/relax_disp.py</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00267" class="tabs">Index by Date</a> | <a href="threads.html#00267" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00266.html">Date Prev</a>] [<a href="msg00268.html">Date Next</a>] [<a href="msg00262.html">Thread Prev</a>] [<a href="msg00263.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Tue, 17 Jun 2014 10:46:58 +0200</li>
<li class="menuitem">
<em>Cc</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:date:message-id:subject :from:to:cc:content-type:content-transfer-encoding; bh=ZXWBzQs/VnURmNQT/u4aSyFx5QrY7gu40UJspdEyIls=; b=FX9WU3kSQ+rls90RqA3ekzm+6fDdLEgZ3VwweD++zGd7KAE09pjxAIu+0Iq/dnJesz piHwwKrGeUw8LEYqCcWkKnSHYjuK4rAzKm+VOuWWhXyqYMbYQDf9qVaGcBN8nAkfyqE6 x2d3XpaMx5ECpVLGqqwSSLt0gI6CmsORG0VIPBg/0KE1el93xJj+UqCPb5tbn0+vN1eQ K2hTFAHI5FCVj2O0LvGozBVQ3Rr9j76AZJkERf2/VO+ZcGQcc2tjFL7Bj5p17IRTEJ2E 8zeXtCeSbgshTOng/d+ktpAchqacZbdFnmnSEBuQnwluf8zoeBh5O87Hma85+1awC1HM 9CHg==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;CAED9pY-=P9tqYzrDZS5JfD-DxWFafoRHJZDUCbg45Fm36KT2=A@mail.gmail.com&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;E1WwbAg-0003gY-1i@subversion.gna.org&gt; &lt;CAED9pY_zv8Q41t-6te+JLX1+2FygHkbx1F2p=1_FrLK+8g31AA@mail.gmail.com&gt; &lt;CA+CBx2MqZ2c86uNg7544DiGMHEh0WPK1uYzm7=xfTMBAT4Ra5Q@mail.gmail.com&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on June 17, 2014 - 10:47:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi,

There may be a way of handing this dw and dwH aliasing in a numpy
array design, and that would probably make relax much faster than any
other dispersion software for the MMQ models.  But I'm talking about
something different.  The dw and dwH aliasing only affect the code up
to the r2eff_mmq_cr72() function call.  All lines after this are not
affected.  Simply remove 4 spaces from all lines after
r2eff_mmq_cr72() in the func_mmq_CR72() target function:

&quot;&quot;&quot;
===================================================================
--- target_functions/relax_disp.py      (revision 24016)
+++ target_functions/relax_disp.py      (working copy)
@@ -1309,22 +1309,19 @@
             # Back calculate the R2eff values.
             r2eff_mmq_cr72(r20=r20, pA=pA, pB=pB, dw=aliased_dw,
dwH=aliased_dwH, kex=kex, k_AB=k_AB, k_BA=k_BA,
cpmg_frqs=self.cpmg_frqs[ei], inv_tcpmg=self.inv_relax_times[ei],
tcp=self.tau_cpmg[ei], back_calc=self.back_calc[ei])

-            # Clean the data for all values, which is left over at
the end of arrays.
-            self.back_calc[ei] = self.back_calc[ei]*self.disp_struct[ei]
+        # Clean the data for all values, which is left over at the
end of arrays.
+        self.back_calc = self.back_calc*self.disp_struct

-            # For all missing data points, set the back-calculated
value to the measured values so that it has no effect on the
chi-squared value.
-            if self.has_missing:
-                # Replace with values.
-                mask_replace_blank_ei = masked_equal(self.missing[ei], 1.0)
-                self.back_calc[ei][mask_replace_blank_ei.mask] =
self.values[ei][mask_replace_blank_ei.mask]
+        # For all missing data points, set the back-calculated value
to the measured values so that it has no effect on the chi-squared
value.
+        if self.has_missing:
+            # Replace with values.
+            mask_replace_blank = masked_equal(self.missing, 1.0)
+            self.back_calc[mask_replace_blank.mask] =
self.values[mask_replace_blank.mask]

-            # Calculate and return the chi-squared value.
-            chi2_sum += chi2_rankN(self.values[ei],
self.back_calc[ei], self.errors[ei])
+        # Calculate and return the chi-squared value.
+        return chi2_rankN(self.values, self.back_calc, self.errors)

-        # Return the total chi-squared value.
-        return chi2_sum
&quot;&quot;&quot;

The only effect on the test suite is that this model is slightly
faster.  The less operations inside Python loops, the better.

Regards,

Edward


On 17 June 2014 10:20, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Ed.

The problem with this, is the mixing of dw and dwH.

I havent figured out how do this efficient.
I wasted 6 hours for a first try to convert it, so this has to be step by
step.

You have still won the looping over spins and frequency.
So it should be faster.

Best
Troels


2014-06-17 10:04 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">

Hi Troels,

For this change, you have introduced the chi2_rankN() function, but it
is still calculated per experiment.  As this model is almost always
used with up to 6 different experiments, this will still be slower
than what is possible.  You should change this to match the other
target functions - shift it out of the experiment loop.  It can happen
at the very end, exactly as in the other target function func_*()
methods you have speed up.  The cleaning up of the data structure
where there are no dispersion points and the missing data handling
should also be shifted outside of the experiment loop for speed.  The
design of your new numpy array structures should handle this, as they
all have the experiment index.

Regards,

Edward




On 16 June 2014 19:58,  &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Author: tlinnet
Date: Mon Jun 16 19:58:17 2014
New Revision: 23996

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=23996&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=23996&amp;view=rev</a>
Log:
Removed looping over spin and frequencies for model MMD CR72.

Task #7807 (<a  rel="nofollow" href="https://web.archive.org/web/https://gna.org/task/index.php?7807">https://gna.org/task/index.php?7807</a>): Speed-up of dispersion
models for Clustered analysis.

Modified:
    branches/disp_spin_speed/target_functions/relax_disp.py

[This mail would be too long, it was shortened to contain the URLs
only.]

Modified: branches/disp_spin_speed/target_functions/relax_disp.py
URL:
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/disp_spin_speed/target_functions/relax_disp.py?rev=23996&amp;r1=23995&amp;r2=23996&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/disp_spin_speed/target_functions/relax_disp.py?rev=23996&amp;r1=23995&amp;r2=23996&amp;view=diff</a>


_______________________________________________
relax (<a  rel="nofollow" href="/">http://www.nmr-relax.com</a>)

This is the relax-commits mailing list
relax-commits@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="/mail.gna.org/listinfo/relax-commits">https://mail.gna.org/listinfo/relax-commits</a>
</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
relax (<a  rel="nofollow" href="/">http://www.nmr-relax.com</a>)

This is the relax-devel mailing list
relax-devel@xxxxxxx


To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="/mail.gna.org/listinfo/relax-devel">https://mail.gna.org/listinfo/relax-devel</a>
</pre></blockquote><pre style="margin: 0em;">


</pre></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00261" href="msg00261.html">Re: r23996 - /branches/disp_spin_speed/target_functions/relax_disp.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00262" href="msg00262.html">Re: r23996 - /branches/disp_spin_speed/target_functions/relax_disp.py</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Tue Jun 17 11:00:12 2014</div>  
</body>
</html>
