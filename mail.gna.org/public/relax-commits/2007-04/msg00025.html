<!-- MHonArc v2.6.16 -->
<!--X-Subject: r3268 &#45; in /branches/multi_processor: multi/ specific_fns/ -->
<!--X-From-R13: tnelgNozo.yrrqf.np.hx -->
<!--X-Date: Tue, 17 Apr 2007 14:39:56 +0200 -->
<!--X-Message-Id: E1Hdmxy&#45;0005Jy&#45;Dx@subversion.gna.org -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>r3268 - in /branches/multi_processor: multi/ specific_fns/ -- April 17, 2007 - 14:39</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />r3268 - in /branches/multi_processor: multi/ specific_fns/</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00025" class="tabs">Index by Date</a> | <a href="threads.html#00025" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00024.html">Date Prev</a>] [<a href="msg00026.html">Date Next</a>] [<a href="msg00024.html">Thread Prev</a>] [<a href="msg00026.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: relax-commits@xxxxxxx</li>
<li class="menuitem">
<em>Date</em>: Tue, 17 Apr 2007 12:39:25 -0000</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00025.html">E1Hdmxy-0005Jy-Dx@subversion.gna.org</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>garyt</strong> on April 17, 2007 - 14:39:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Author: varioustoxins
Date: Tue Apr 17 14:39:25 2007
New Revision: 3268

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=3268&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=3268&amp;view=rev</a>
Log:
almost feature complete mpi4py and uni processor versions of relax 

Modified:
    branches/multi_processor/multi/commands.py
    branches/multi_processor/multi/mpi4py_processor.py
    branches/multi_processor/multi/processor.py
    branches/multi_processor/multi/uni_processor.py
    branches/multi_processor/specific_fns/model_free.py

Modified: branches/multi_processor/multi/commands.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/multi_processor/multi/commands.py?rev=3268&amp;r1=3267&amp;r2=3268&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/multi_processor/multi/commands.py?rev=3268&amp;r1=3267&amp;r2=3268&amp;view=diff</a>
==============================================================================
--- branches/multi_processor/multi/commands.py (original)
+++ branches/multi_processor/multi/commands.py Tue Apr 17 14:39:25 2007
@@ -32,7 +32,6 @@
 
 import minimise
 import sys
-from mpi4py import  MPI
 
 from minimise.generic import set_pre_and_post_amble as 
set_generic_pre_and_post_amble
 from minimise.grid import set_pre_and_post_amble as 
set_grid_pre_and_post_amble
@@ -228,29 +227,27 @@
         processor.return_object(MF_result_command(self.memo_id,param_vector, 
func, iter, fc, gc, hc, warning,completed=False))
         
processor.return_object(Result_string(result_string,completed=completed))
 
+    def pre_command_feed_back(self,processor):
+        self.do_feedback()
+
+
     def pre_run(self,processor):
         #FIXME: move to processor startup
+
         self.save_stdout = sys.stdout
         self.save_stderr = sys.stderr
 
         # add debug flag or extra channels that output immediately
-        pre_string = processor.rank_format_string() % processor.rank()
-        sys.stdout = PrependStringIO(pre_string + ' S&gt; ')
-        sys.stderr = PrependStringIO(pre_string + ' E&gt; ')
-
-    def pre_command_feed_back(self,processor):
-        self.do_feedback()
-
-    def post_command_feedback(self,results,processor):
-        pass
-
-    def run_command(self,processor):
-        self.mf = self.build_mf()
-        return generic_minimise(func=self.mf.func, dfunc=self.mf.dfunc, 
d2func=self.mf.d2func, **self.minimise_map)
-
-
-    def process_result(self,processor):
-        self.process_results(self.results,processor,completed)
+        if processor.processor_size() &gt; 1:
+            pre_string = processor.rank_format_string() % processor.rank()
+            stderr_string = ' E&gt;'
+            stdout_string  = ' S&gt;'
+        else:
+            pre_string = ''
+            stderr_string = ''
+            stdout_string  = ''
+        sys.stdout = PrependStringIO(pre_string + stdout_string)
+        sys.stderr = PrependStringIO(pre_string + stderr_string)
 
     def post_run(self,processor):
         #FIXME: move to processor startup
@@ -258,6 +255,19 @@
         sys.stderr.close()
         sys.stdout = self.save_stdout
         sys.stderr = self.save_stderr
+
+    def post_command_feedback(self,results,processor):
+        pass
+
+    def run_command(self,processor):
+        self.mf = self.build_mf()
+        return generic_minimise(func=self.mf.func, dfunc=self.mf.dfunc, 
d2func=self.mf.d2func, **self.minimise_map)
+
+
+    def process_result(self,processor):
+        self.process_results(self.results,processor,completed)
+
+
 
     def run(self,processor, completed):
 
@@ -303,7 +313,6 @@
 #        A = self.minimise_map['A']
 #        b = self.minimise_map['b']
 #
-
 
         set_generic_pre_and_post_amble(False)
         set_grid_pre_and_post_amble(False)
@@ -450,6 +459,7 @@
         grid_size = sgm.grid_size
 
 
+
         if sgm.first_time:
 
 
@@ -478,8 +488,8 @@
 
             if print_flag and results != None:
                 if full_output:
-                    print
-                    print
+                    print ''
+                    print ''
                     print print_prefix + &quot;Parameter values: &quot; + `sgm.xk`
                     print print_prefix + &quot;Function value:   &quot; + `sgm.fk`
                     print print_prefix + &quot;Iterations:       &quot; + `sgm.k`

Modified: branches/multi_processor/multi/mpi4py_processor.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/multi_processor/multi/mpi4py_processor.py?rev=3268&amp;r1=3267&amp;r2=3268&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/multi_processor/multi/mpi4py_processor.py?rev=3268&amp;r1=3267&amp;r2=3268&amp;view=diff</a>
==============================================================================
--- branches/multi_processor/multi/mpi4py_processor.py (original)
+++ branches/multi_processor/multi/mpi4py_processor.py Tue Apr 17 14:39:25 
2007
@@ -22,7 +22,8 @@
 #                                                                            
  #
 
################################################################################
 
-#TODO clone communicators &amp; resize
+# TODO: clone communicators &amp; resize
+# TODO: check exceptiosn on master
 import sys
 import os
 import math
@@ -169,8 +170,9 @@
         result.rank=MPI.rank
         MPI.COMM_WORLD.Send(buf=result, dest=0)
 
-
-
+    #FIXME: fill out
+    def process_result(self):
+        pass
 
     def run_command_queue(self,queue):
         self.assert_on_master()
@@ -248,16 +250,10 @@
                 last_command = len(commands)-1
                 for i,command  in enumerate(commands):
                     try:
-                        completed = i == last_command
+                        completed = (i == last_command)
                         command.run(self,completed)
                         #raise Exception('dummy')
                     except Exception,e:
                         #self.return_object(e)
                         
self.return_object(Capturing_exception(rank=self.rank(),name=self.get_name()))
 
-
-
-
-
-
-

Modified: branches/multi_processor/multi/processor.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/multi_processor/multi/processor.py?rev=3268&amp;r1=3267&amp;r2=3268&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/multi_processor/multi/processor.py?rev=3268&amp;r1=3267&amp;r2=3268&amp;view=diff</a>
==============================================================================
--- branches/multi_processor/multi/processor.py (original)
+++ branches/multi_processor/multi/processor.py Tue Apr 17 14:39:25 2007
@@ -22,7 +22,8 @@
 #                                                                            
  #
 
################################################################################
 
-#FIXME better  requirement of inherited commands
+# FIXME better  requirement of inherited commands
+# TODO: check exceptiosn on master
 import time,datetime,math,sys
 from multi.PrependStringIO import  PrependStringIO,PrependOut
 import traceback,textwrap
@@ -54,6 +55,7 @@
     def get_name(self):
         raise_unimplimented(self.get_name)
 
+    # FIXME is this used?
     def exit(self):
         raise_unimplimented(self.exit)
 
@@ -68,6 +70,10 @@
 
     def processor_size(self):
         raise_unimplimented(self.processor_size())
+
+    def restore_stdio(self):
+        sys.stderr = self.save_stderr
+        sys.stdout = self.save_stdout
 
     def run_command_globally(self,command):
         queue = [command for i in range(1,MPI.size)]
@@ -84,9 +90,12 @@
 
         self.save_stdout = sys.stdout
         self.save_stderr = sys.stderr
-        pre_string = 'M'*self.rank_format_string_width()
-        sys.stdout = PrependOut(pre_string + ' S&gt; ', sys.stdout)
-        sys.stderr = PrependOut(pre_string + ' E&gt; ', sys.stderr)
+
+        if self.processor_size() &gt; 1:
+
+            pre_string = 'M'*self.rank_format_string_width()
+            sys.stdout = PrependOut(pre_string + ' S&gt; ', sys.stdout)
+            sys.stderr = PrependOut(pre_string + ' E&gt; ', sys.stderr)
 
     def get_time_delta(self,start_time,end_time):
 
@@ -101,8 +110,9 @@
             end_time = time.time()
             time_delta_str = self.get_time_delta(self.start_time,end_time)
             print 'overall runtime: ' + time_delta_str + '\n'
-        sys.stdout = self.save_stdout
-        sys.stderr = self.save_stderr
+
+        if self.processor_size() &gt; 1:
+            self.restore_stdio()
 
     def rank_format_string_width(self):
         return int(math.ceil(math.log10(self.processor_size())))

Modified: branches/multi_processor/multi/uni_processor.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/multi_processor/multi/uni_processor.py?rev=3268&amp;r1=3267&amp;r2=3268&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/multi_processor/multi/uni_processor.py?rev=3268&amp;r1=3267&amp;r2=3268&amp;view=diff</a>
==============================================================================
--- branches/multi_processor/multi/uni_processor.py (original)
+++ branches/multi_processor/multi/uni_processor.py Tue Apr 17 14:39:25 2007
@@ -22,7 +22,7 @@
 #                                                                            
  #
 
################################################################################
 import threading, Queue
-import sys
+import sys,os
 import multi
 
 from multi.processor import Processor,Result_command,Result_string
@@ -69,15 +69,13 @@
 
 #FIXME need to subclass
 class Uni_processor(Processor):
+
+
     def __init__(self,relax_instance):
         self.relax_instance= relax_instance
 
         self.command_queue=[]
         self.memo_map={}
-
-
-    def on_master(self):
-        return True
 
     def add_to_queue(self,command,memo=None):
         self.command_queue.append(command)
@@ -86,57 +84,81 @@
             self.memo_map[memo.memo_id()]=memo
 
     def run_queue(self):
-        #FIXME: need a finally here to cleanup exceptions states
+        #FIXME: need a finally here to cleanup exceptions states for windows 
etc
 
-
-        for command in self.command_queue:
-            command.run(self)
+        last_command = len(self.command_queue)-1
+        for i,command  in enumerate(self.command_queue):
+            completed = (i == last_command)
+            command.run(self,completed)
         #self.run_command_queue()
         #TODO: add cheques for empty queuese and maps if now warn
         del self.command_queue[:]
         self.memo_map.clear()
 # FIXME: remove me
 #    def run_command_queue(self):
-#              for command in self.command_queue:
-#                      command.run(self)
+#            for command in self.command_queue:
+#                command.run(self)
 
     def run(self):
 #        start_time =  time.clock()
-        self.pre_run()
-        self.relax_instance.run()
-        self.post_run()
+        try:
+            self.pre_run()
+            self.relax_instance.run()
+        finally:
+            self.post_run()
 #        end_time = time.clock()
 #        time_diff= end_time - start_time
 #        time_delta = datetime.timedelta(seconds=time_diff)
 #        print 'overall runtime: ' + time_delta.__str__() + '\n'
 
 
+    def get_name(self):
+        # FIXME may need system dependent changes
+        return '%s-%s' % (os.getenv('HOSTNAME'),os.getpid())
+
+    def exit(self):
+        sys.exit()
+
+    def on_master(self):
+        return True
+
+
+    def rank(self):
+        return 1
+
+    def processor_size(self):
+        return 1
+
+
+
 
 
 
     def return_object(self,result):
+
+        local_save_stdout = sys.stdout
+        local_save_stderr = sys.stderr
+        self.restore_stdio()
+
         if isinstance(result, Exception):
-                   #FIXME: clear command queue
+            #FIXME: clear command queue
                    #       and finalise mpi (or restart it if we can!
-                   raise result
+            raise result
+        elif isinstance(result, Result_command):
+            memo=None
+            if result.memo_id != None:
+                memo=self.memo_map[result.memo_id]
+            result.run(self.relax_instance,self,memo)
+            if result.memo_id != None and result.completed:
+                del self.memo_map[result.memo_id]
+
+        elif isinstance(result, Result_string):
+            self.save_stdout.write(result.string)
+        else:
+            message = 'Unexpected result type \n%s \nvalue%s' 
%(result.__class__.__name__,result)
+            raise Exception(message)
+        sys.stdout = local_save_stdout
+        sys.stderr = local_save_stderr
 
 
 
-        if isinstance(result, Result_command):
-            memo=None
-            if result.memo_id != None:
-                memo=self.memo_map[result.memo_id]
-                result.run(self.relax_instance,self,memo)
-            if result.memo_id != None and result.completed:
-                       del self.memo_map[result.memo_id]
-
-           elif isinstance(result, Result_string):
-               #FIXME can't cope with multiple lines
-               print result.rank,result.string
-           else:
-               message = 'Unexpected result type \n%s \nvalue%s' 
%(result.__class__.__name__,result)
-               raise Exception(message)
-
-
-
-

Modified: branches/multi_processor/specific_fns/model_free.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/multi_processor/specific_fns/model_free.py?rev=3268&amp;r1=3267&amp;r2=3268&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/multi_processor/specific_fns/model_free.py?rev=3268&amp;r1=3267&amp;r2=3268&amp;view=diff</a>
==============================================================================
--- branches/multi_processor/specific_fns/model_free.py (original)
+++ branches/multi_processor/specific_fns/model_free.py Tue Apr 17 14:39:25 
2007
@@ -2381,7 +2381,7 @@
                 res_name = self.relax.data.res[self.run][index].name
                 res_id = `res_num` + ' ' + res_name
 
-            if match('^[Gg]rid', min_algor) and self.param_set == 'all':
+            if match('^[Gg]rid', min_algor) and self.param_set == 'diff' :
                 processors = self.relax.processor.processor_size()
                 full_grid_info = Grid_info(min_options)
                 sub_grid_list = 
full_grid_info.sub_divide(self.relax.processor.processor_size())
@@ -5271,6 +5271,20 @@
                             except:
                                 ri.append(None)
                                 ri_error.append(None)
+#                    for k in xrange(self.relax.data.num_ri[self.run]):
+#                        # Find the residue specific data corresponding to k.
+#                        index = None
+#                        for l in xrange(data.num_ri):
+#                            if data.ri_labels[l] == 
self.relax.data.ri_labels[self.run][k] and 
data.frq_labels[data.remap_table[l]] == 
self.relax.data.frq_labels[self.run][self.relax.data.remap_table[self.run][k]]:
+#                                index = l
+#
+#                        # Data exists for this data type.
+#                        try:
+#                            ri.append(`data.relax_sim_data[i][index]`)
+#                            ri_error.append(`data.relax_error[index]`)
+#                        except:
+#                            ri.append(None)
+#                            ri_error.append(None)
 
                     # XH vector.
                     xh_vect = None



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Sat Apr 21 03:20:05 2007</div>  
</body>
</html>
