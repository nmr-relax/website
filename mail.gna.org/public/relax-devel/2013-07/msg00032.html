<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: numerical cpmg fit -->
<!--X-From-R13: "Sqjneq q'Ohiretar" <rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Mon, 15 Jul 2013 10:01:53 +0200 -->
<!--X-Message-Id: CAED9pY9raZ6Gx8kH8+ghtWAArD9wMUeZF4ZZz=v6fDM93TjwdQ@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 35036407&#45;39A6&#45;4B59&#45;B529&#45;7074D5F10DBA@gmx.at -->
<!--X-Reference: CAED9pY_zKf+1kML6UNezswM1NQtvZh7n7Jdz_Ss1H5Kn2cj5kw@mail.gmail.com -->
<!--X-Reference: CAED9pY9HUHQ1X6zQpY8CmPR3NFoSXJwgeP02Nme1Y447&#45;6U9RQ@mail.gmail.com -->
<!--X-Reference: CAED9pY_cN9pSyBX2F+ji1gYHN7RkwY72PwE4_&#45;8dEVNU&#45;4R1jg@mail.gmail.com -->
<!--X-Reference: 390EF589&#45;7B7E&#45;466A&#45;BE67&#45;021D16E7E12B@gmx.at -->
<!--X-Reference: CAED9pY8cqOqAhYDFxVCK+Sm8rJ7=p8GFPwKTHwdzg2U8DZsd_w@mail.gmail.com -->
<!--X-Reference: 0B2A8433&#45;C5BE&#45;4388&#45;A04C&#45;9AF1D365A60D@gmx.at -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: numerical cpmg fit -- July 15, 2013 - 10:01</title>
<link rel="stylesheet" type="text/css" href="/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="https://gna.org/images/gna.theme/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: numerical cpmg fit</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00032" class="tabs">Index by Date</a> | <a href="threads.html#00032" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00031.html">Date Prev</a>] [<a href="msg00033.html">Date Next</a>] [<a href="msg00033.html">Thread Prev</a>] [<a href="msg00034.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: Paul Schanda &lt;paul.schanda@xxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Mon, 15 Jul 2013 10:01:20 +0200</li>
<li class="menuitem">
<em>Cc</em>: mathilde lescanne &lt;mathilde.lescanne@xxxxxxxxx&gt;,	&quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113;	h=mime-version:sender:in-reply-to:references:date	:x-google-sender-auth:message-id:subject:from:to:cc:content-type	:content-transfer-encoding;	bh=6EWjQ3p1CyWWUFqMm2FFCwVvBY4Tiw6R3LZfPXvCcOA=;	b=aCQYl+FrcFFNcSPwADuFynkj/8q9hDh+fXHOhs3mi/3fAbCNhFV4OuF/oFBXTGtARw	5sSqy/o4R/gKDsyS9rqTo24np2QYjd36htCW6Trx76hQr+oTIjaRx/tDQfcxsr0ckmyZ	FYmZ6PLHGLFRc/d6dQQDpVmPBJetclELlzE/ElY7D0NhwrnLqeLc3+kNUXpmsJQ4VHnn	wqGdLTEckFXLNkMw4FDmGbmnbX+jg1x5+EnWPaEcE31naTVeceWGwXIC9Gi9KIL8Itp1	Saz/Fkt7eAYoytZMD69OPvDuEdfH4ipPFZuJvyiAeaFEwG8PtjY5MJU2NKhWLcl8C2ZF	Y66w==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00032.html">CAED9pY9raZ6Gx8kH8+ghtWAArD9wMUeZF4ZZz=v6fDM93TjwdQ@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;35036407-39A6-4B59-B529-7074D5F10DBA@xxxxxx&gt;	&lt;CAED9pY_zKf+1kML6UNezswM1NQtvZh7n7Jdz_Ss1H5Kn2cj5kw@xxxxxxxxxxxxxx&gt;	&lt;CAED9pY9HUHQ1X6zQpY8CmPR3NFoSXJwgeP02Nme1Y447-6U9RQ@xxxxxxxxxxxxxx&gt;	&lt;CAED9pY_cN9pSyBX2F+ji1gYHN7RkwY72PwE4_-8dEVNU-4R1jg@xxxxxxxxxxxxxx&gt;	&lt;390EF589-7B7E-466A-BE67-021D16E7E12B@xxxxxx&gt;	&lt;CAED9pY8cqOqAhYDFxVCK+Sm8rJ7=p8GFPwKTHwdzg2U8DZsd_w@xxxxxxxxxxxxxx&gt;	&lt;0B2A8433-C5BE-4388-A04C-9AF1D365A60D@xxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on July 15, 2013 - 10:01:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi,

</pre><blockquote class="blockquote"><pre style="margin: 0em;">fg is the frequency of the ground state (call it &quot;A&quot; or &quot;G&quot;), while fe is 
the excited state frequency.
</pre></blockquote><pre style="margin: 0em;">

Is this the chemical shift in Hz?  Or the chemical shift difference in
Hz?  The code does not use the 'fe' parameter, so how is the chemical
shift of the excited state handled?  Does this mean that chemical
shifts need to be explicitly given?  How does this work with
intermediate to fast exchange where the shift of the peak is a mixture
of the two chemical shifts?

I'm still not sure how to handle this in relax.  I may need to add a
new dispersion parameter(s) to the definitions at the start of the
Relax_disp class in specific_analyses/relax_disp/api.py.  Though very
easy to expand, this currently only supports the following parameters
for chemical shifts:

phi_ex = pA.pB.dw**2 (in ppm^2)
padw2 = pA.dw**2 (in ppm^2)
dw = (in ppm)

where dw is the chemical shift difference.  In all of the analytic
models, only dw is used.


</pre><blockquote class="blockquote"><pre style="margin: 0em;">tcpmg is the total duration of the CPMG element. At some instances this is 
called Tc instead of tcpmg.
Not to be confused with the delay before and after each pulse, which is 
tcp. I.e., between two 180deg pulses there are two delays tcp.
</pre></blockquote><pre style="margin: 0em;">

Thank you for the additional details.  I have now updated the
lib/dispersion/ns_2site_star.py file with the details
(<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.scm/18046">http://article.gmane.org/gmane.science.nmr.relax.scm/18046</a>).


</pre><blockquote class="blockquote"><pre style="margin: 0em;">I saw that you keep the convention of &quot;G&quot; and &quot;E&quot; in the functions. Is this 
also used in the existing functions, or do you use &quot;A&quot; and &quot;B&quot; there? It 
might be cleaner to have a coherent naming convention.
</pre></blockquote><pre style="margin: 0em;">

I am in the process of converting.  I think I'll use the arbitrary mapping:

G -&gt; A
E -&gt; B

This is for consistency within relax between this code and the
analytic models, as well as to minimise user confusion.  It will also
allow relax to more logically support a C state for the 3-site models.


</pre><blockquote class="blockquote"><pre style="margin: 0em;">Here are some comments to the function:


70 # Initialise some structures.
71 Rr = -1.0 * matrix([[r20b, 0.0],[0.0, r20a]])
72 Rex = -1.0 * matrix([[kge, -keg],[-kge, keg]])
73 RCS = complex(0.0, -1.0) * matrix([[0.0, 0.0],[0.0, fg]])
74 R = Rr + Rex + RCS
75 cR2 = conj(R) * 2.0
76
77 kex = kge + keg # conversion of kinetic rates
78 IGeq = keg / kex # calculate relative populations - will be used for 
generating the equilibrium magnetizations
79 IEeq = kge / kex # like preceding line, but for excited state
80 M0 = matrix([[IGeq], [IEeq]]) # This is a vector that contains the 
initial magnetizations, corresponding to ground (G) and excited (E) state 
transverse magnetizations
81
82 # Replicated calculations for faster operation.
83 inv_tcpmg = 1.0 / tcpmg
84
85 # Loop over the time points, back calculating the R2eff values.
86 for i in range(num_points):
87 # Replicated calculations for faster operation.
88 tcp = 0.25 / cpmg_frqs[i]
89 expm_R_tcp = expm(R*tcp) # This matrix is a propagator that will evolve 
the magnetization with the matrix R for a delay tcp
90
91 prop_2 = dot(dot(expm_R_tcp, expm(cR2*tcp)), expm_R_tcp) # This is the 
propagator for an element of delay tcp - 180degpulse -2 times delay tcp - 
180degpulse - delay tau, i.e. for 2 times tau-180-tau
92
93 prop_total = square_matrix_power(prop_2, cpmg_frqs[i]*tcpmg) # Now 
create the total propagator, that will evolve the magnetization under the 
CPMG train, ie. it applies the above tau-180-tau-tau-180-tau so many times 
as required for the CPMG frequency under consideration.
94
95 Moft = prop_total * M0 # now we apply the above propagator to the 
initial magnetization vector - resulting in the magnetization that remains 
after the full CPMG pulse train. It is called M of t (t is the time after 
the CPMG train
96
97 Mgx = Moft[0].real / M0[0] # This and the next line calculate the R2eff, 
using a two-point approximation, i.e. assuming that the decay is 
mono-exponential.
98 back_calc[i]= -inv_tcpmg * log(Mgx)
</pre></blockquote><pre style="margin: 0em;">

These comments are awesome!!!  It's far better than what I could have
added.  The code in lib/dispersion/ns_2site_star.py is now a perfect
teaching aid that can be shown directly to students.  It will also
allow NMR spectroscopists who are not experts to quickly learn from
the code.  I have added all of these comments and updated your
copyright notice appropriately.


</pre><blockquote class="blockquote"><pre style="margin: 0em;">Thanks for the implementation!
</pre></blockquote><pre style="margin: 0em;">

Thank you for contributing the code.  I hope this will up and running
soon and, together with the tools built into relax, that the
calculations will even be faster.

Cheers,

Edward


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00034" href="msg00034.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00010" href="msg00010.html">numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Paul Schanda</li></ul></li>
<li><strong><a name="00011" href="msg00011.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00012" href="msg00012.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00017" href="msg00017.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00018" href="msg00018.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Paul Schanda</li></ul></li>
<li><strong><a name="00025" href="msg00025.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00030" href="msg00030.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Paul Schanda</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer">You are on the <a href="http://gna.org">Gna!</a> mail server.</div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Mon Jul 15 11:00:08 2013</div>  
</body>
</html>
