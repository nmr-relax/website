<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: Regarding systemtest: ./relax &#45;s	Relax_disp.test_bug_21344_sparse_time_spinlock_acquired_r1rho_fail_relax_disp -->
<!--X-From-R13: Febryf Szgrxæe Zvaarg <gyvaargNaze&#45;erynk.pbz> -->
<!--X-Date: Thu, 27 Feb 2014 12:40:56 +0100 -->
<!--X-Message-Id: CA+CBx2Nz7qV2H&#45;CSrQ56HQYt4gGBi1_gC_MDVQr+2mnSiHf4gw@mail.gmail.com -->
<!--X-Content-Type: multipart/alternative -->
<!--X-Reference: CA+CBx2M9hCjFsxFDJyDAP6XFGPhs3yzdB3iOsA9jR9JpP_+fYA@mail.gmail.com -->
<!--X-Reference: CAED9pY9AJ&#45;QswCxhdnYLUZR2FjAJtEPvE_=QhZvUsPwJ&#45;yhb6Q@mail.gmail.com -->
<!--X-Reference: CAED9pY&#45;yVk0q7X0n0pKpu8sjuxSMks8QoMXhvHd6O&#45;Gm84S&#45;uw@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: Regarding systemtest: ./relax -s	Relax_disp.test_bug_21344_sparse_time_spinlock_acquired_r1rho_fail_relax_disp -- February 27, 2014 - 12:40</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: Regarding systemtest: ./relax -s	Relax_disp.test_bug_21344_sparse_time_spinlock_acquired_r1rho_fail_relax_disp</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00169" class="tabs">Index by Date</a> | <a href="threads.html#00169" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00168.html">Date Prev</a>] [<a href="msg00170.html">Date Next</a>] [<a href="msg00168.html">Thread Prev</a>] [<a href="msg00170.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;Edward d'Auvergne&quot; &lt;edward.dauvergne@xxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Thu, 27 Feb 2014 12:40:04 +0100</li>
<li class="menuitem">
<em>Cc</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113;	h=mime-version:sender:in-reply-to:references:from:date:message-id	:subject:to:cc:content-type;	bh=693TQjWXHptMoTqISU0cOVO/cKv56OgJnUF5PYBm0a0=;	b=YIkQ4Onlnw4PjTJOz9Es/fymxXK7xjDLdtP2NoRqLAxTvO+7TsTRo5vWJr2MbPMO+y	wLiShY9DFzzZj3w4XAPcwR/hi9lWD1Bd7+h0FQKSoFpDnvdrv720LVpdVk9doa55gkMy	1Mo8TBwJSnPJP/PDvXWqTkGgLDftUGRhYzy13dagW3DfoLPuDEWw83nmMhdekMytkR+8	dnzClK49B/L6ckAaUeOWUkytcyaIZHXIjXGqEjNZSjJYLDcMX3pj8FSlM4tzHtkCuVB3	CxgSHWcrTn8bewhOCWfmJUjPQCBpMM5zry9pHgnAgSNMBSbYLq4rhkNgm0rhge/oGx//	EQtA==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00169.html">CA+CBx2Nz7qV2H-CSrQ56HQYt4gGBi1_gC_MDVQr+2mnSiHf4gw@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;CA+CBx2M9hCjFsxFDJyDAP6XFGPhs3yzdB3iOsA9jR9JpP_+fYA@xxxxxxxxxxxxxx&gt;	&lt;CAED9pY9AJ-QswCxhdnYLUZR2FjAJtEPvE_=QhZvUsPwJ-yhb6Q@xxxxxxxxxxxxxx&gt;	&lt;CAED9pY-yVk0q7X0n0pKpu8sjuxSMks8QoMXhvHd6O-Gm84S-uw@xxxxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Troels Emtekær Linnet</strong> on February 27, 2014 - 12:40:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<div dir="ltr">That sounds perfect. :-)<br><div><br>And I say, that I now know what to do after Lunch.<br><br></div><div>Never gonna give &quot;it&quot; up... never gonna...<br></div><div><a rel="nofollow" href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">https://www.youtube.com/watch?v=dQw4w9WgXcQ</a><br>

<br></div><div>Best<br>Troels<br></div><div><br><br></div></div><div class="gmail_extra"><br><br><div class="gmail_quote">2014-02-27 12:37 GMT+01:00 Edward d&#39;Auvergne <span dir="ltr">&lt;<a rel="nofollow" href="mailto:edward.dauvergne@xxxxxxxxx" target="_blank">edward.dauvergne@xxxxxxxxx</a>&gt;</span>:<br>

<blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex">Actually, by grepping the source code:<br>
<br>
$ grep &quot;find_intensity_keys([a-z]&quot; -r . --exclude-dir=.svn<br>
<br>
I can see many places where find_intensity_keys() is incorrectly<br>
called!  I think it&#39;s obvious that this function came before<br>
R1rho-type data was supported.  Looking further, the<br>
return_intensity() function is also deficient for the offset value!<br>
Almost everywhere where find_intensity_keys() is called is incorrectly<br>
implemented (excluding the specific_analyses.relax_disp.nessy module<br>
as NESSY does not support R1rho data)!  These should all be fixed<br>
otherwise problems will appear in your analysis later on.<br>
<br>
Thinking about the problem even more, I can see that only one key is<br>
ever used when calling find_intensity_keys().  The purpose of having a<br>
list of keys has been permanently lost - I remember implementing this<br>
as a feature earlier in the relax_disp branch development but the<br>
reason for it no longer exists.  As a clean solution, I would suggest:<br>
<br>
- Renaming the function to find_intensity_key() and have it return a<br>
single value.<br>
- Have the find_intensity_key() function raise a RelaxError if more<br>
than one key is found.<br>
- Modify all of the code calling find_intensity_key() to expect and<br>
handle a single key.<br>
- Modify the return_intensity() function to be more like the<br>
average_intensity() function in that the offset argument is supported.<br>
<br>
This solution would be much more maintainable in the future.  What do you think?<br>
<br>
Regards,<br>
<br>
Edward<br>
<div class="HOEnZb"><div class="h5"><br>
On 27 February 2014 12:08, Edward d&#39;Auvergne &lt;<a rel="nofollow" href="mailto:edward.dauvergne@xxxxxxxxx">edward.dauvergne@xxxxxxxxx</a>&gt; wrote:<br>
&gt; Hi,<br>
&gt;<br>
&gt; This looks like another rather stupid typo/mistake :)  I added a print<br>
&gt; statement for the int_keys variable and ran the test.  There should<br>
&gt; only be one key for a given {exp_type, frq, offset, point, time}<br>
&gt; metadata set, but the printout shows this not to be the case.  If you<br>
&gt; carefully look at the find_intensity_keys() call, you will see that<br>
&gt; one of these 5 bits of information are not sent in as an argument ;)<br>
&gt;<br>
&gt; Regards,<br>
&gt;<br>
&gt; Edward<br>
&gt;<br>
&gt;<br>
&gt;<br>
&gt;<br>
&gt; On 27 February 2014 11:38, Troels Emtekær Linnet &lt;<a rel="nofollow" href="mailto:tlinnet@xxxxxxxxxxxxx">tlinnet@xxxxxxxxxxxxx</a>&gt; wrote:<br>
&gt;&gt; Hi Edward.<br>
&gt;&gt;<br>
&gt;&gt; When I run:<br>
&gt;&gt; ./relax -s Relax_disp.test_bug_21344_sparse_time_spinlock_acquired_r1rho_fail_relax_disp<br>
&gt;&gt;<br>
&gt;&gt; I get:<br>
&gt;&gt; -------------------<br>
&gt;&gt; Parameter values: [2.4392597217423719, 149801.17120634759]<br>
&gt;&gt; Function value:   252.36349493927844<br>
&gt;&gt; Iterations:       135<br>
&gt;&gt; Function calls:   281<br>
&gt;&gt; Gradient calls:   0<br>
&gt;&gt; Hessian calls:    0<br>
&gt;&gt; Warning:          None<br>
&gt;&gt;<br>
&gt;&gt;<br>
&gt;&gt; relax&gt; eliminate(function=None, args=None)<br>
&gt;&gt;<br>
&gt;&gt; relax&gt; monte_carlo.setup(number=5)<br>
&gt;&gt;<br>
&gt;&gt; relax&gt; monte_carlo.create_data(method=&#39;back_calc&#39;)<br>
&gt;&gt; Traceback (most recent call last):<br>
&gt;&gt;   File &quot;/sbinlab2/tlinnet/software/NMR-relax/relax_trunk/test_suite/system_tests/relax_disp.py&quot;,<br>
&gt;&gt; line 284, in test_bug_21344_sparse_time_spinlock_acquired_r1rho_fail_relax_disp<br>
&gt;&gt;     relax_disp.Relax_disp(pipe_name=&#39;base pipe&#39;,<br>
&gt;&gt; pipe_bundle=&#39;relax_disp&#39;, results_dir=self.tmpdir, models=[&#39;R2eff&#39;],<br>
&gt;&gt; grid_inc=3, mc_sim_num=5, modsel=&#39;AIC&#39;, pre_run_dir=None,<br>
&gt;&gt; insignificance=1.0, numeric_only=False, mc_sim_all_models=False,<br>
&gt;&gt; eliminate=True)<br>
&gt;&gt;   File &quot;/sbinlab2/tlinnet/software/NMR-relax/relax_trunk/auto_analyses/relax_disp.py&quot;,<br>
&gt;&gt; line 118, in __init__<br>
&gt;&gt;     self.run()<br>
&gt;&gt;   File &quot;/sbinlab2/tlinnet/software/NMR-relax/relax_trunk/auto_analyses/relax_disp.py&quot;,<br>
&gt;&gt; line 471, in run<br>
&gt;&gt;     self.optimise(model=model)<br>
&gt;&gt;   File &quot;/sbinlab2/tlinnet/software/NMR-relax/relax_trunk/auto_analyses/relax_disp.py&quot;,<br>
&gt;&gt; line 379, in optimise<br>
&gt;&gt;     self.interpreter.monte_carlo.create_data()<br>
&gt;&gt;   File &quot;/sbinlab2/tlinnet/software/NMR-relax/relax_trunk/prompt/uf_objects.py&quot;,<br>
&gt;&gt; line 221, in __call__<br>
&gt;&gt;     self._backend(*new_args, **uf_kargs)<br>
&gt;&gt;   File &quot;/sbinlab2/tlinnet/software/NMR-relax/relax_trunk/pipe_control/monte_carlo.py&quot;,<br>
&gt;&gt; line 113, in create_data<br>
&gt;&gt;     pack_sim_data(data_index, random)<br>
&gt;&gt;   File &quot;/sbinlab2/tlinnet/software/NMR-relax/relax_trunk/specific_analyses/relax_disp/api.py&quot;,<br>
&gt;&gt; line 1609, in sim_pack_data<br>
&gt;&gt;     raise RelaxError(&quot;Monte Carlo simulation data for the key &#39;%s&#39;<br>
&gt;&gt; already exists.&quot; % int_key)<br>
&gt;&gt; RelaxError: RelaxError: Monte Carlo simulation data for the key<br>
&gt;&gt; &#39;1_0_46_0&#39; already exists.<br>
&gt;&gt;<br>
&gt;&gt; ---------------------<br>
&gt;&gt;<br>
&gt;&gt; I have looked into:<br>
&gt;&gt; specific_analyses/relax_disp/api.py<br>
&gt;&gt;<br>
&gt;&gt; There it is:<br>
&gt;&gt; ----------------------------------------------<br>
&gt;&gt;     def sim_pack_data(self, data_id, sim_data):<br>
&gt;&gt;         &quot;&quot;&quot;Pack the Monte Carlo simulation data.<br>
&gt;&gt;<br>
&gt;&gt;         @param data_id:     The tuple of the spin container and the<br>
&gt;&gt; exponential curve identifying key, as yielded by the base_data_loop()<br>
&gt;&gt; generator method.<br>
&gt;&gt;         @type data_id:      SpinContainer instance and float<br>
&gt;&gt;         @param sim_data:    The Monte Carlo simulation data.<br>
&gt;&gt;         @type sim_data:     list of float<br>
&gt;&gt;         &quot;&quot;&quot;<br>
&gt;&gt;<br>
&gt;&gt;         # The R2eff model (with peak intensity base data).<br>
&gt;&gt;         if cdp.model_type == &#39;R2eff&#39;:<br>
&gt;&gt;             # Unpack the data.<br>
&gt;&gt;             spin, exp_type, frq, offset, point = data_id<br>
&gt;&gt;<br>
&gt;&gt;             # Initialise the data structure if needed.<br>
&gt;&gt;             if not hasattr(spin, &#39;intensity_sim&#39;):<br>
&gt;&gt;                 spin.intensity_sim = {}<br>
&gt;&gt;<br>
&gt;&gt;             # Loop over each time point.<br>
&gt;&gt;             ti = 0<br>
&gt;&gt;             for time in loop_time(exp_type=exp_type, frq=frq,<br>
&gt;&gt; offset=offset, point=point):<br>
&gt;&gt;                 # Get the intensity keys.<br>
&gt;&gt;                 int_keys = find_intensity_keys(exp_type=exp_type,<br>
&gt;&gt; frq=frq, point=point, time=time)<br>
&gt;&gt;<br>
&gt;&gt;                 # Loop over the intensity keys.<br>
&gt;&gt;                 for int_key in int_keys:<br>
&gt;&gt;                     # Test if the simulation data point already exists.<br>
&gt;&gt;                     if int_key in spin.intensity_sim:<br>
&gt;&gt;                         raise RelaxError(&quot;Monte Carlo simulation data<br>
&gt;&gt; for the key &#39;%s&#39; already exists.&quot; % int_key)<br>
&gt;&gt;<br>
&gt;&gt;                     # Initialise the list.<br>
&gt;&gt;                     spin.intensity_sim[int_key] = []<br>
&gt;&gt;<br>
&gt;&gt;                     # Loop over the simulations, appending the<br>
&gt;&gt; corresponding data.<br>
&gt;&gt;                     for i in range(cdp.sim_number):<br>
&gt;&gt;                         spin.intensity_sim[int_key].append(sim_data[i][ti])<br>
&gt;&gt;<br>
&gt;&gt;                 # Increment the time index.<br>
&gt;&gt;                 ti += 1<br>
&gt;&gt; ---------------------<br>
&gt;&gt;<br>
&gt;&gt; For me, this looks okay.<br>
&gt;&gt;<br>
&gt;&gt; Do you have an Idea why this is not working?<br>
&gt;&gt;<br>
&gt;&gt; Best<br>
&gt;&gt; Troels<br>
</div></div></blockquote></div><br></div>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00170" href="msg00170.html">Re: Regarding systemtest: ./relax -s	Relax_disp.test_bug_21344_sparse_time_spinlock_acquired_r1rho_fail_relax_disp</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00166" href="msg00166.html">Regarding systemtest: ./relax -s	Relax_disp.test_bug_21344_sparse_time_spinlock_acquired_r1rho_fail_relax_disp</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00167" href="msg00167.html">Re: Regarding systemtest: ./relax -s	Relax_disp.test_bug_21344_sparse_time_spinlock_acquired_r1rho_fail_relax_disp</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00168" href="msg00168.html">Re: Regarding systemtest: ./relax -s	Relax_disp.test_bug_21344_sparse_time_spinlock_acquired_r1rho_fail_relax_disp</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Thu Feb 27 13:20:08 2014</div>  
</body>
</html>
