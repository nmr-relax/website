<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: [bug #6503] Uncaught nan in xh_vect -->
<!--X-From-R13: Quevf [npDnvyq <p.n.znpenvyqNyrrqf.np.hx> -->
<!--X-Date: Wed, 09 Aug 2006 12:42:27 +0200 -->
<!--X-Message-Id: 1155120105.28764.423.camel@fbsdpcu021 -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20060802&#45;104941.sv4125.3051@gna.org -->
<!--X-Reference: 7f080ed10608040708k4738dd5cjb41e9056acd88902@mail.gmail.com -->
<!--X-Reference: 1154706350.28764.284.camel@fbsdpcu021 -->
<!--X-Reference: 44D37486.6060003@bmb.leeds.ac.uk -->
<!--X-Reference: 7f080ed10608040954n4971257diabac2c1b51f17790@mail.gmail.com -->
<!--X-Reference: 44D6F769.10204@bmb.leeds.ac.uk -->
<!--X-Reference: 7f080ed10608070240j43e47b3cif1b60924755c4fa9@mail.gmail.com -->
<!--X-Reference: 1155027991.28764.327.camel@fbsdpcu021 -->
<!--X-Reference: 7f080ed10608080336j6f601bdbk7c7a7658464cf3cd@mail.gmail.com -->
<!--X-Reference: 1155055070.28764.379.camel@fbsdpcu021 -->
<!--X-Reference: 7f080ed10608082041x6b433bb1t9266cc857135366f@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: [bug #6503] Uncaught nan in xh_vect -- August 09, 2006 - 12:42</title>
<link rel="stylesheet" type="text/css" href="/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="https://gna.org/images/gna.theme/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: [bug #6503] Uncaught nan in xh_vect</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00033" class="tabs">Index by Date</a> | <a href="threads.html#00033" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00032.html">Date Prev</a>] [<a href="msg00034.html">Date Next</a>] [<a href="msg00027.html">Thread Prev</a>] [<a href="msg00037.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: Edward d'Auvergne &lt;edward.dauvergne@xxxxxxxxx&gt;, relax-devel@xxxxxxx</li>
<li class="menuitem">
<em>Date</em>: Wed, 09 Aug 2006 11:41:45 +0100</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00033.html">1155120105.28764.423.camel@fbsdpcu021</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;20060802-104941.sv4125.3051@gna.org&gt;	&lt;<a href="msg00007.html">7f080ed10608040708k4738dd5cjb41e9056acd88902@mail.gmail.com</a>&gt;	&lt;<a href="msg00009.html">1154706350.28764.284.camel@fbsdpcu021</a>&gt;	&lt;<a href="msg00013.html">44D37486.6060003@bmb.leeds.ac.uk</a>&gt;	&lt;<a href="msg00016.html">7f080ed10608040954n4971257diabac2c1b51f17790@mail.gmail.com</a>&gt;	&lt;<a href="msg00020.html">44D6F769.10204@bmb.leeds.ac.uk</a>&gt;	&lt;<a href="msg00022.html">7f080ed10608070240j43e47b3cif1b60924755c4fa9@mail.gmail.com</a>&gt;	&lt;<a href="msg00023.html">1155027991.28764.327.camel@fbsdpcu021</a>&gt;	&lt;<a href="msg00024.html">7f080ed10608080336j6f601bdbk7c7a7658464cf3cd@mail.gmail.com</a>&gt;	&lt;<a href="msg00026.html">1155055070.28764.379.camel@fbsdpcu021</a>&gt;	&lt;<a href="msg00027.html">7f080ed10608082041x6b433bb1t9266cc857135366f@mail.gmail.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Chris MacRaild</strong> on August 09, 2006 - 12:42:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">On Wed, 2006-08-09 at 13:41 +1000, Edward d'Auvergne wrote:

</pre><blockquote class="blockquote"><pre style="margin: 0em;">


</pre><blockquote class="blockquote"><pre style="margin: 0em;">Although I'd love to be able to agree with you that NaN should never
occur, floating point maths just isn't that cooperative. Even for
'correct' inputs, it is quite possible for a minimisation to drive a
value so small that a fp underflow occurs, then division or log of that
value will result in NaN (or INF - the two are equivalent for the
purposes of this discussion). I've never seen this with your
minimisation code, but I've certainly seen it in others (probably a
tribute to the robustness of your algorithms, but not grounds for too
much complacency)
</pre></blockquote><pre style="margin: 0em;">

It's not the robustness of relax's algorithms but the construction of
the model-free problem itself.   There is a numerical stabilisation of
the model-free equations which avoids NaNs and Infs that I'll present
in my next, as of yet unpublished, paper - a preview of it is in the
relax manual.  I'll go through the model-free equations, relaxation
equations, chi-squared equation, diffusion tensor equations, etc one
by one to show exactly what can cause NaN.  The only way to generate a
NaN in these equations is:
    nan = inf - inf
    nan = inf / inf
    nan = inf * 0
Fortunately logs don't exist in these equations.

First the model-free equations.  We essentially have 2 local
parameters in these equations (S2 and te) and a couple of global
correlation times (tm and equivalent in the spheroids and ellipsoids).
 The extension by Clore et al., (1990) from the point of view of
generating a NaN is inconsequential - the form of the equation is the
same.  To generate a NaN the following combinations will do it:  {S2 =
0, tm = inf}, {S2 = 1, te = inf}, and {te = inf, tm = inf}.  In the
case of the spheroid and ellipsoid, just replace the tm value with the
appropriate correlation time tk where k is {-1, 0, 1} or {-2, -1, 0,
1, 2} respectively.  However the grid search will never search at inf
and using the default parameter limits the values of inf will never be
reached.  Even without the limits, it is impossible to use an
optimisation algorithm to get the correlation times to inf.  In the
model-free model elimination paper the way I forced the te and tm
values to go to inf was to manually tweak the parameters to get there
- the minimisers all terminated well before reaching that value due to
the curvature of the space and the iteration limits.  Therefore NaNs
will never come from the model-free equations (unless you manually set
a correlation time to inf using value.set()).

In the relaxation equations we have three places which can cause a
problem: the bond length, the CSA value, and the Rex value.  For the
CSA and Rex values to be problematic they have to be set to inf.  For
the CSA, that only occurs if the user types:
    value.set(run, float('inf'), 'csa')
Now that deserves a RelaxError!  The Rex value is limited by the R2,
specifically Rex &lt; R2.  Hence an Rex value of inf is only possible if
the measured R2 is inf.  Again this deserves a RelaxError as that is
impossible.  The bond length value on the other hand can generate an
inf (and then maybe later NaN) by the user typing:
    value.set(run, 0, 'bond length')
This is unquestionably a RelaxError.

In the chi-squared equation, NaN can be generated if the measure
relaxation value is inf and the back calculated value is also inf.  An
error of zero will generate a value of inf as well.  These are all
FATAL errors - if the user sends garbage in, then a RelaxError prior
to any calculations is justified.  The user must fix their input data
before even starting the model-free analysis.

The biggest problem is the unit vector parallel to the XH bond vector.
 This is used in the chi-squared calculation for the prolate spheroid,
oblate spheroid, and ellipsoid.  If the length of this vector is zero
- that will generate a NaN.  Only two scenarios can trigger this.  The
first is what occured in bug #6503 and that is where the X and H atoms
are set to the same PDB atom name.  This should be caught and a
RelaxError generated when this occurs.  The second is if the PDB file
is broken and the H and X atoms lie ontop of eachother.  This again
should be caught and a RelaxError thrown.  The position where to catch
this is when calculating the unit vector - just measure the length of
the XH bond vector and if zero, RelaxError:  The PDB file is corrupt.
Missing protons in an X-ray structure isn't a problem, relax already
catches this one.

These are the only points of failure within the model-free problem
whereby a NaN or Inf value can be generated.  This covers the
parameters and values of: S2, te, S2f, tf, S2s, ts, tm, Rex, CSA, and
the bond length.  It also covers the input relaxation data and the
input PDB file and corresponding X and H atoms.  Because of this, if
we catch the NaN and Inf after, as you said, the grid search and also
after minimisation, then throwing an error will stop the calculation
at the very start (not the fifth day of a week long calculation ;).
</pre></blockquote><pre style="margin: 0em;">

I'm resonably convinced by this as far as it goes - NaN in Chi2 almost
certainly reflects a serious error in the input, and will likely be
evident from the very begining of the calculation. As such I no longer
have concerns about Chi2 == NaN raising RelaxError. The only exception
would be the case of a corrupt PDB file, where not all residues are
affected. The current behaviour for missing protons is to print a
warning, deselect the affected residue, and continue. I believe a
similar approach should also apply in the case of bad proton positions.

I'm still not sure that other variables won't become NaN at some point.
One example might be internal variables in the optimisation routines. I
can't give specific examples, but concievably might become NaN or INF as
a result of under- or overflow. Clearly this means that this specific
optimisation will fail, but its not clear to me that it is necessarily a
globally fatal error. 


Chris


</pre><blockquote class="blockquote"><pre style="margin: 0em;">


</pre><blockquote class="blockquote"><blockquote class="blockquote"><pre style="margin: 0em;">To summarise my opinions:

To catch the NaN:  I think this is useful, though not necessary.
Avoiding fpconst.py as a dependency would be best.  If Numpy has a
function to catch Python native floating point values of NaN - then
migrating to Numpy is worth a go.  Otherwise migrating to Numpy isn't
an issue for this problem.
</pre></blockquote><pre style="margin: 0em;">

I believe catching NaN is necessary for defined performance of model
selection, and useful to avoid wasting an awful lot of time minimising
NaN. I think Numpy will be useful here.
</pre></blockquote><pre style="margin: 0em;">

I agree.  But because the change to Numpy is disruptive it should
occur in the 1.3 line rather than the stablised 1.2 line.


</pre><blockquote class="blockquote"><blockquote class="blockquote"><pre style="margin: 0em;">What to do when NaNs occur:  RelaxError!
</pre></blockquote><pre style="margin: 0em;">

RelaxError is appropriate when the NaN signals an unrecoverable state,
eg. if the diffusion tensor contains NaN. On the other hand an isolated
NaN should result in the relevant model/residue being deselected and a
warning to highlight the fact. Obviously this more context dependent
response involves more work, but I don't think it needs to be fully
implimented all at once - as you rightly point out this is a rare
occurence.
</pre></blockquote><pre style="margin: 0em;">

An isolated NaN will still stop the calculation at the very start, if
an error is thrown.  Then the source of the problem - garbage input -
can be fixed.  There are not many places where this can occur and we
should be able to catch and prevent them all of them.  However
catching the NaN or Inf just in case can be done after the grid search
and after minimisation.  This is relevant if someone wants to
something bizarre with the program.


</pre><blockquote class="blockquote"><pre style="margin: 0em;">Of course relax is yours, and I'm happy to recognise your benevolent
dictatorship
</pre></blockquote><pre style="margin: 0em;">

Everyone's input is appreciated - it makes the program better - and
this thread has been perfect for sorting out the numerous issues.  The
only sticking point I can still see with this discussion is whether to
throw an error or continue with the calculation.  As I outlined above,
the only way I can see this happening is if the input data is garbage.
 If there is another way that NaN can be produced and not encountered
at the start, I'm willing to change my opinion.

Although I own the copyright on may of relax's files and can have the
final say on what goes into the repository, the program belongs to
everyone and I will accept most code (unless it is problematic or
violates someone else's copyright).  Because of the GPL all developers
and all users are the real owners of the program.  It is even possible
to take the file <a  href="http://svn.gna.org/daily/relax.dump.gz">http://svn.gna.org/daily/relax.dump.gz</a> and start a
new and independent fork of relax with all the revision history
preserved (although that would be very counter-productive for end
users).  Anyway, one day I may get tired and stop developing relax.
In that situation either I could appoint someone to take over or we
could write a constitution and set up a voting system to determine who
will be the leader of the relax project.

Edward

</pre></blockquote><pre style="margin: 0em;">



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00037" href="msg00037.html">Re: [bug #6503] Uncaught nan in xh_vect</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00007" href="msg00007.html">Re: [bug #6503] Uncaught nan in xh_vect</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00009" href="msg00009.html">Re: [bug #6503] Uncaught nan in xh_vect</a></strong>
<ul><li><em>From:</em> Chris MacRaild</li></ul></li>
<li><strong><a name="00013" href="msg00013.html">Re: [bug #6503] Uncaught nan in xh_vect</a></strong>
<ul><li><em>From:</em> Gary S. Thompson</li></ul></li>
<li><strong><a name="00016" href="msg00016.html">Re: [bug #6503] Uncaught nan in xh_vect</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00020" href="msg00020.html">Re: [bug #6503] Uncaught nan in xh_vect</a></strong>
<ul><li><em>From:</em> Gary S. Thompson</li></ul></li>
<li><strong><a name="00022" href="msg00022.html">Re: [bug #6503] Uncaught nan in xh_vect</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00023" href="msg00023.html">Re: [bug #6503] Uncaught nan in xh_vect</a></strong>
<ul><li><em>From:</em> Chris MacRaild</li></ul></li>
<li><strong><a name="00024" href="msg00024.html">Re: [bug #6503] Uncaught nan in xh_vect</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00026" href="msg00026.html">Re: [bug #6503] Uncaught nan in xh_vect</a></strong>
<ul><li><em>From:</em> Chris MacRaild</li></ul></li>
<li><strong><a name="00027" href="msg00027.html">Re: [bug #6503] Uncaught nan in xh_vect</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer">You are on the <a href="http://gna.org">Gna!</a> mail server.</div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Wed Aug 09 16:40:31 2006</div>  
</body>
</html>
