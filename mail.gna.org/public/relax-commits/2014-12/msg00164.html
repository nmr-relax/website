<!-- MHonArc v2.6.18 -->
<!--X-Subject: r27041 &#45; in /branches/frame_order_cleanup: ./ auto_analyses/ data_store/ graphics/oxygen_icons/128x128/actions/ lib/software... -->
<!--X-From-R13: rqjneqNaze&#45;erynk.pbz -->
<!--X-Date: Tue, 09 Dec 2014 09:06:24 +0100 -->
<!--X-Message-Id: E1XyFoO&#45;0002YM&#45;0L@subversion.gna.org -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>r27041 - in /branches/frame_order_cleanup: ./ auto_analyses/ data_store/ graphics/oxygen_icons/128x128/actions/ lib/software... -- December 09, 2014 - 09:06</title>
<link rel="stylesheet" type="text/css" href="/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="https://gna.org/images/gna.theme/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />r27041 - in /branches/frame_order_cleanup: ./ auto_analyses/ data_store/ graphics/oxygen_icons/128x128/actions/ lib/software...</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00164" class="tabs">Index by Date</a> | <a href="threads.html#00164" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00163.html">Date Prev</a>] [<a href="msg00165.html">Date Next</a>] [<a href="msg00163.html">Thread Prev</a>] [<a href="msg00165.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: relax-commits@xxxxxxx</li>
<li class="menuitem">
<em>Date</em>: Tue, 09 Dec 2014 08:06:23 -0000</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00164.html">E1XyFoO-0002YM-0L@subversion.gna.org</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>edward</strong> on December 09, 2014 - 09:06:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Author: bugman
Date: Tue Dec  9 09:06:23 2014
New Revision: 27041

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=27041&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=27041&amp;view=rev</a>
Log:
Merged revisions 27011,27014,27035-27040 via svnmerge from 
svn+ssh://bugman@xxxxxxxxxxx/svn/relax/trunk

........
  r27011 | bugman | 2014-12-08 11:03:44 +0100 (Mon, 08 Dec 2014) | 7 lines
  
  Added a compressed EPS version of the 
128x128/actions/document-preview-archive Oxygen icon.
  
  The EPS bounding box was manually changed to 0 0 18 18 in a text editor.  
The scanline translation
  parameters were also fixed by changing them all to 18 as well.  This allows 
the icon to be used in
  the relax manual.
........
  r27014 | bugman | 2014-12-08 15:50:04 +0100 (Mon, 08 Dec 2014) | 5 lines
  
  Fix for the blacklist objects in data_store.data_classes.Element.to_xml().
  
  The class blacklist variable was not being taken into account.
........
  r27035 | bugman | 2014-12-09 08:32:31 +0100 (Tue, 09 Dec 2014) | 9 lines
  
  Added the norm_type argument to the grace.write user function.
  
  This is in response to 
<a  rel="nofollow" href="http://thread.gmane.org/gmane.science.nmr.relax.devel/7392/focus=7438">http://thread.gmane.org/gmane.science.nmr.relax.devel/7392/focus=7438</a>.
  
  This norm_type argument can either be 'first' or 'last' to allow different 
points of the plot to be
  the normalisation factor.  The default of 'first' preserves the old 
behaviour of first point
  normalisation.
........
  r27036 | bugman | 2014-12-09 08:36:47 +0100 (Tue, 09 Dec 2014) | 5 lines
  
  The relax_fit_saturation_recovery.py system test script now sets the 
norm_type argument.
  
  This is for testing out this new option for the grace.write user function.
........
  r27037 | bugman | 2014-12-09 08:41:45 +0100 (Tue, 09 Dec 2014) | 6 lines
  
  The new grace.write user function norm_type argument has been activated.
  
  The argument is now passed from pipe_control.grace.write into the 
write_xy_data() function of the
  lib.software.grace module, and is used to select which point to use for the 
normalisation.
........
  r27038 | bugman | 2014-12-09 08:47:10 +0100 (Tue, 09 Dec 2014) | 7 lines
  
  The relaxation exponential curve-fitting auto-analysis now sets the 
normalisation type.
  
  This is for the new grace.write user function.  If the model for all spins 
is set to 'sat', then the
  norm_type will be set to 'last'.  This allows for reasonable normalised 
curves for the saturation
  recovery R1 experiment types.
........
  r27039 | bugman | 2014-12-09 08:54:53 +0100 (Tue, 09 Dec 2014) | 7 lines
  
  Change for norm_type variable in the relaxation exponential curve-fitting 
auto-analysis.
  
  This is now set to 'last', not only for the saturation recovery, but now 
also for the inversion
  recovery experiment types.  This ensures that the normalisation point is 
the steady state
  magnetisation peak intensity.
........
  r27040 | bugman | 2014-12-09 09:04:20 +0100 (Tue, 09 Dec 2014) | 8 lines
  
  Cleared the list of blacklisted objects for the cdp.exp_info data structure.
  
  The data_store.exp_info.ExpInfo class blacklist variable had previously not 
been used.  But after
  recent changes, the list was now active.  As all the contents of the 
container were blacklisted, the
  container was being initialised as being empty when reading the XML 
formatted state or results
  files.  Therefore the blacklist is now set to an empty list.
........

Added:
    
branches/frame_order_cleanup/graphics/oxygen_icons/128x128/actions/document-preview-archive.eps.gz
      - copied unchanged from r27040, 
trunk/graphics/oxygen_icons/128x128/actions/document-preview-archive.eps.gz
Modified:
    branches/frame_order_cleanup/   (props changed)
    branches/frame_order_cleanup/auto_analyses/relax_fit.py
    branches/frame_order_cleanup/data_store/data_classes.py
    branches/frame_order_cleanup/data_store/exp_info.py
    branches/frame_order_cleanup/lib/software/grace.py
    branches/frame_order_cleanup/pipe_control/grace.py
    
branches/frame_order_cleanup/test_suite/system_tests/scripts/relax_fit_saturation_recovery.py
    branches/frame_order_cleanup/user_functions/grace.py

Propchange: branches/frame_order_cleanup/
------------------------------------------------------------------------------
--- svnmerge-integrated (original)
+++ svnmerge-integrated Tue Dec  9 09:06:23 2014
@@ -1 +1 @@
-/trunk:1-27009
+/trunk:1-27040

Modified: branches/frame_order_cleanup/auto_analyses/relax_fit.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/frame_order_cleanup/auto_analyses/relax_fit.py?rev=27041&amp;r1=27040&amp;r2=27041&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/frame_order_cleanup/auto_analyses/relax_fit.py?rev=27041&amp;r1=27040&amp;r2=27041&amp;view=diff</a>
==============================================================================
--- branches/frame_order_cleanup/auto_analyses/relax_fit.py     (original)
+++ branches/frame_order_cleanup/auto_analyses/relax_fit.py     Tue Dec  9 
09:06:23 2014
@@ -132,12 +132,19 @@
         # Save the results.
         self.interpreter.results.write(file='results', dir=self.results_dir, 
force=True)
 
+        # Determine the normalisation type.
+        norm_type = 'last'
+        for spin in spin_loop(skip_desel=True):
+            if spin.model not in ['sat', 'inv']:
+                norm_type = 'first'
+                break
+
         # Create Grace plots of the data.
         self.interpreter.grace.write(y_data_type='chi2', file='chi2.agr', 
dir=self.grace_dir, force=True)    # Minimised chi-squared value.
         self.interpreter.grace.write(y_data_type='i0', file='i0.agr', 
dir=self.grace_dir, force=True)    # Initial peak intensity.
         self.interpreter.grace.write(y_data_type='rx', 
file=self.file_root+'.agr', dir=self.grace_dir, force=True)    # Relaxation 
rate.
         self.interpreter.grace.write(x_data_type='relax_times', 
y_data_type='peak_intensity', file='intensities.agr', dir=self.grace_dir, 
force=True)    # Average peak intensities.
-        self.interpreter.grace.write(x_data_type='relax_times', 
y_data_type='peak_intensity', norm=True, file='intensities_norm.agr', 
dir=self.grace_dir, force=True)    # Average peak intensities (normalised).
+        self.interpreter.grace.write(x_data_type='relax_times', 
y_data_type='peak_intensity', norm_type=norm_type, norm=True, 
file='intensities_norm.agr', dir=self.grace_dir, force=True)    # Average 
peak intensities (normalised).
 
         # Write a python &quot;grace to PNG/EPS/SVG...&quot; conversion script.
         # Open the file for writing.

Modified: branches/frame_order_cleanup/data_store/data_classes.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/frame_order_cleanup/data_store/data_classes.py?rev=27041&amp;r1=27040&amp;r2=27041&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/frame_order_cleanup/data_store/data_classes.py?rev=27041&amp;r1=27040&amp;r2=27041&amp;view=diff</a>
==============================================================================
--- branches/frame_order_cleanup/data_store/data_classes.py     (original)
+++ branches/frame_order_cleanup/data_store/data_classes.py     Tue Dec  9 
09:06:23 2014
@@ -137,7 +137,7 @@
         cont_element.setAttribute('desc', self.desc)
 
         # Blacklisted objects.
-        blacklist = ['name', 'desc', 'blacklist'] + 
list(Element.__dict__.keys()) + list(self.__class__.__dict__.keys()) + 
list(object.__dict__.keys())
+        blacklist = self.blacklist + ['name', 'desc', 'blacklist'] + 
list(Element.__dict__.keys()) + list(self.__class__.__dict__.keys()) + 
list(object.__dict__.keys())
 
         # Store and blacklist the objects which have to_xml() methods.
         to_xml_list = []

Modified: branches/frame_order_cleanup/data_store/exp_info.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/frame_order_cleanup/data_store/exp_info.py?rev=27041&amp;r1=27040&amp;r2=27041&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/frame_order_cleanup/data_store/exp_info.py?rev=27041&amp;r1=27040&amp;r2=27041&amp;view=diff</a>
==============================================================================
--- branches/frame_order_cleanup/data_store/exp_info.py (original)
+++ branches/frame_order_cleanup/data_store/exp_info.py Tue Dec  9 09:06:23 
2014
@@ -40,7 +40,7 @@
         self.desc = &quot;Experimental information&quot;
 
         # Blacklisted objects.
-        self.blacklist = [&quot;citations&quot;, &quot;software&quot;, &quot;temp_calibration&quot;, 
&quot;temp_control&quot;]
+        self.blacklist = []
 
 
     def add_citation(self, cite_id=None, authors=None, doi=None, 
pubmed_id=None, full_citation=None, title=None, status=None, type=None, 
journal_abbrev=None, journal_full=None, volume=None, issue=None, 
page_first=None, page_last=None, year=None):

Modified: branches/frame_order_cleanup/lib/software/grace.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/frame_order_cleanup/lib/software/grace.py?rev=27041&amp;r1=27040&amp;r2=27041&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/frame_order_cleanup/lib/software/grace.py?rev=27041&amp;r1=27040&amp;r2=27041&amp;view=diff</a>
==============================================================================
--- branches/frame_order_cleanup/lib/software/grace.py  (original)
+++ branches/frame_order_cleanup/lib/software/grace.py  Tue Dec  9 09:06:23 
2014
@@ -25,6 +25,10 @@
 
 # Python module imports.
 from math import ceil, sqrt
+
+# relax module imports.
+from lib.errors import RelaxError
+
 
 # This script is used to batch convert the Grace *.agr files into graphics 
files using the Grace
 # program itself.
@@ -119,7 +123,7 @@
     file.write(&quot;        return_code = subprocess.call(im_args)\n&quot;)
 
 
-def write_xy_data(data, file=None, graph_type=None, norm=None, 
autoscale=True):
+def write_xy_data(data, file=None, graph_type=None, norm_type='first', 
norm=None, autoscale=True):
     &quot;&quot;&quot;Write the data into the Grace xy-scatter plot.
 
     The numerical data should be supplied as a 4 dimensional list or array 
object.  The first dimension corresponds to the graphs, Gx.  The second 
corresponds the sets of each graph, Sx.  The third corresponds to the data 
series (i.e. each data point).  The forth is a list of the information about 
each point, it is a list where the first element is the x value, the second 
is the y value, the third is the optional dx or dy error (either dx or dy 
dependent upon the graph_type arg), and the forth is the optional dy error 
when graph_type is xydxdy (the third position is then dx).
@@ -131,6 +135,8 @@
     @type file:             file object
     @keyword graph_type:    The graph type which can be one of xy, xydy, 
xydx, or xydxdy.
     @type graph_type:       str
+    @keyword norm_type:     The point to normalise to 1.  This can be 
'first' or 'last'.
+    @type norm_type:        str
     @keyword norm:          The normalisation flag which if set to True will 
cause all graphs to be normalised to 1.  The first dimension is the graph.
     @type norm:             None or list of bool
     @keyword autoscale:     A flag which if True will cause the world view 
of each graph to be autoscaled (by placing the Grace command &quot;@autoscale&quot; at 
the end of the file).  If you have supplied a world view for the header or 
the tick spacing, this argument should be set to False to prevent that world 
view from being overwritten.
@@ -164,7 +170,12 @@
             # Normalisation (to the first data point y value!).
             norm_fact = 1.0
             if norm[gi]:
-                norm_fact = data[gi][si][0][1]
+                if norm_type == 'first':
+                    norm_fact = data[gi][si][0][1]
+                elif norm_type == 'last':
+                    norm_fact = data[gi][si][-1][1]
+                else:
+                    raise RelaxError(&quot;The normalisation type '%s' must be 
one of ['first', 'last'].&quot; % norm_fact)
 
             # Loop over the data points.
             for point in data[gi][si]:

Modified: branches/frame_order_cleanup/pipe_control/grace.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/frame_order_cleanup/pipe_control/grace.py?rev=27041&amp;r1=27040&amp;r2=27041&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/frame_order_cleanup/pipe_control/grace.py?rev=27041&amp;r1=27040&amp;r2=27041&amp;view=diff</a>
==============================================================================
--- branches/frame_order_cleanup/pipe_control/grace.py  (original)
+++ branches/frame_order_cleanup/pipe_control/grace.py  Tue Dec  9 09:06:23 
2014
@@ -205,7 +205,7 @@
     system(grace_exe + &quot; \&quot;&quot; + file_path + &quot;\&quot; &amp;&quot;)
 
 
-def write(x_data_type='res_num', y_data_type=None, spin_id=None, 
plot_data='value', file=None, dir=None, force=False, norm=True):
+def write(x_data_type='res_num', y_data_type=None, spin_id=None, 
plot_data='value', norm_type='first', file=None, dir=None, force=False, 
norm=True):
     &quot;&quot;&quot;Writing data to a file.
 
     @keyword x_data_type:   The category of the X-axis data.
@@ -216,6 +216,8 @@
     @type spin_id:          str
     @keyword plot_data:     The type of the plotted data, one of 'value', 
'error', or 'sim'.
     @type plot_data:        str
+    @keyword norm_type:     The point to normalise to 1.  This can be 
'first' or 'last'.
+    @type norm_type:        str
     @keyword file:          The name of the Grace file to create.
     @type file:             str
     @keyword dir:           The optional directory to place the file into.
@@ -272,7 +274,7 @@
     write_xy_header(file=file, data_type=data_type, seq_type=seq_type, 
sets=[len(data[0])], set_names=[set_names], axis_labels=[axis_labels], 
norm=[norm])
 
     # Write the data.
-    write_xy_data(data, file=file, graph_type=graph_type, norm=[norm])
+    write_xy_data(data, file=file, graph_type=graph_type, 
norm_type=norm_type, norm=[norm])
 
     # Close the file.
     file.close()

Modified: 
branches/frame_order_cleanup/test_suite/system_tests/scripts/relax_fit_saturation_recovery.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/frame_order_cleanup/test_suite/system_tests/scripts/relax_fit_saturation_recovery.py?rev=27041&amp;r1=27040&amp;r2=27041&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/frame_order_cleanup/test_suite/system_tests/scripts/relax_fit_saturation_recovery.py?rev=27041&amp;r1=27040&amp;r2=27041&amp;view=diff</a>
==============================================================================
--- 
branches/frame_order_cleanup/test_suite/system_tests/scripts/relax_fit_saturation_recovery.py
       (original)
+++ 
branches/frame_order_cleanup/test_suite/system_tests/scripts/relax_fit_saturation_recovery.py
       Tue Dec  9 09:06:23 2014
@@ -130,7 +130,7 @@
 grace.write(y_data_type='i0', file='i0.agr', dir=ds.tmpdir, force=True)    # 
Initial peak intensity.
 grace.write(y_data_type='rx', file='rx.agr', dir=ds.tmpdir, force=True)    # 
Relaxation rate.
 grace.write(x_data_type='relax_times', y_data_type='peak_intensity', 
file='intensities.agr', dir=ds.tmpdir, force=True)    # Average peak 
intensities.
-grace.write(x_data_type='relax_times', y_data_type='peak_intensity', 
norm=True, file='intensities_norm.agr', dir=ds.tmpdir, force=True)    # 
Average peak intensities (normalised).
+grace.write(x_data_type='relax_times', y_data_type='peak_intensity', 
norm_type='last', norm=True, file='intensities_norm.agr', dir=ds.tmpdir, 
force=True)    # Average peak intensities (normalised).
 
 # Save the program state.
 state.save('devnull', force=True)

Modified: branches/frame_order_cleanup/user_functions/grace.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/frame_order_cleanup/user_functions/grace.py?rev=27041&amp;r1=27040&amp;r2=27041&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/frame_order_cleanup/user_functions/grace.py?rev=27041&amp;r1=27040&amp;r2=27041&amp;view=diff</a>
==============================================================================
--- branches/frame_order_cleanup/user_functions/grace.py        (original)
+++ branches/frame_order_cleanup/user_functions/grace.py        Tue Dec  9 
09:06:23 2014
@@ -146,6 +146,23 @@
     wiz_read_only = True
 )
 uf.add_keyarg(
+    name = &quot;norm_type&quot;,
+    default = &quot;first&quot;,
+    py_type = &quot;str&quot;,
+    desc_short = &quot;normalisation point&quot;,
+    desc = &quot;How the graph should be normalised, if the norm flag is set.&quot;,
+    wiz_element_type = &quot;combo&quot;,
+    wiz_combo_choices = [
+        &quot;First point normalisation&quot;,
+        &quot;Last point normalisation&quot;
+    ],
+    wiz_combo_data = [
+        &quot;first&quot;,
+        &quot;last&quot;
+    ],
+    wiz_read_only = True
+)
+uf.add_keyarg(
     name = &quot;file&quot;,
     py_type = &quot;str&quot;,
     arg_type = &quot;file sel&quot;,
@@ -175,7 +192,7 @@
     default = False,
     py_type = &quot;bool&quot;,
     desc_short = &quot;normalisation flag&quot;,
-    desc = &quot;A flag which, if set to True, will cause all graphs to be 
normalised to a starting value of 1.  This is for the normalisation of series 
type data.&quot;
+    desc = &quot;A flag which, if set to True, will cause all graphs to be 
normalised to 1.  This is for the normalisation of series type data.  The 
point for normalisation is set with the norm_type argument.&quot;
 )
 # Description.
 uf.desc.append(Desc_container())



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer">You are on the <a href="http://gna.org">Gna!</a> mail server.</div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Tue Dec 09 15:00:02 2014</div>  
</body>
</html>
