<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: r22427 &#45; /trunk/lib/rotating_frame.py -->
<!--X-From-R13: "Sqjneq q'Ohiretar" <rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Fri, 07 Mar 2014 15:48:31 +0100 -->
<!--X-Message-Id: CAED9pY90acatYN_j1pDcmxhsjY+deKX8YDTUtGWZbd&#45;VZhM9CA@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: E1WLsEe&#45;0004o9&#45;Lg@subversion.gna.org -->
<!--X-Reference: CAED9pY8J+P=muK3+J7nOtw6NhV1b34Dqx4H_8jyxA4Hn=7VgNg@mail.gmail.com -->
<!--X-Reference: CA+CBx2PTwO=4wpCHcOMUWLSb1cENx2mwscedOKfvNOoh96tduw@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: r22427 - /trunk/lib/rotating_frame.py -- March 07, 2014 - 15:48</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: r22427 - /trunk/lib/rotating_frame.py</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00043" class="tabs">Index by Date</a> | <a href="threads.html#00043" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00042.html">Date Prev</a>] [<a href="msg00044.html">Date Next</a>] [<a href="msg00042.html">Thread Prev</a>] [<a href="msg00047.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Fri, 7 Mar 2014 15:48:00 +0100</li>
<li class="menuitem">
<em>Cc</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113;	h=mime-version:sender:in-reply-to:references:date:message-id:subject	:from:to:cc:content-type:content-transfer-encoding;	bh=cmxutGuZ0K0cIfuvcM/N62a0dUFQNU32TQA/xVo2rIM=;	b=QEkIca06zQz4vvzyNo2SfF41EErjHLyeo8trid9eVIfQ5U4rGrWKA9kLVMCUzkTZY0	z0cox9RpEc+UyzbbKHJTCBNGyiZx8CtIdGpzubZFqHLZxR0z3XPpomY0Gr60yL5Rg/qv	kadPf891Hc+UE5KVpqxcMnG7smA+m9rHC7d4R+6jjSpHEuY34Irto9HEJAxXzGP32Dm6	IEIQspdCcbbrdDtVqtedEkPhaStKzQEiVgZ/bnV8jEbLyv1Q1dMQMXKxXY5kj9/BvA6S	RLh+CspOYnOpGaKv6t71LvNvyKlmy5h6ehXY9AAb5RSi7eb4Bcdbw3VsvHr5ElHVraRN	H/qw==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00043.html">CAED9pY90acatYN_j1pDcmxhsjY+deKX8YDTUtGWZbd-VZhM9CA@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;E1WLsEe-0004o9-Lg@xxxxxxxxxxxxxxxxxx&gt;	&lt;CAED9pY8J+P=muK3+J7nOtw6NhV1b34Dqx4H_8jyxA4Hn=7VgNg@xxxxxxxxxxxxxx&gt;	&lt;CA+CBx2PTwO=4wpCHcOMUWLSb1cENx2mwscedOKfvNOoh96tduw@xxxxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on March 07, 2014 - 15:48:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi,

I think that the value.write function is not the best for this, as
this data is too complicated.  It does not work for the dispersion
points either.  Nevertheless it can be used.  If you look at were the
value is obtained in the pipe_control.value.write_data() function, you
will see the lines:

        # Get the value and error.
        value, error = return_value(spin, param, bc=bc)

To see where return_value() comes from, look to the start of the function:

    # Get the value and error returning function parameter description
function if required.
    if not return_value:
        return_value =
specific_analyses.setup.get_specific_fn('return_value',
pipes.get_type())
    if not return_data_desc:
        return_data_desc =
specific_analyses.setup.get_specific_fn('return_data_desc',
pipes.get_type())

So this is obtaining the function from the analysis specific API.  In
this case, the code is in specific_analyses.relax_disp.api.  Don't
worry about the return_data_desc() function as this defaults to the
descriptions you give in the self.PARAMS data structure.  From the
specific_analyses.relax_disp.api.Relax_disp.__init__() method, you
will see the function aliasing:

        # Place methods into the API.
        self.data_init = self._data_init_spin
        self.model_type = self._model_type_local
        self.return_conversion_factor = self._return_no_conversion_factor
        self.return_value = self._return_value_general
        self.set_param_values = self._set_param_values_spin

So the real function is the _return_value_general() method.  This is
in the specific analysis API common module,
specific_analyses.api_common.  Have a look at that method to
understand what it is doing.

Essentially what you would need to do is to override the method.  So
in specific_analyses.relax_disp.api you would remove the alias and
create a new return_value() method.  For a new method, you start by
copying the stub method in specific_analyses.api_base and the modify
that.  This specific_analyses.api_base module defines the analysis
specific API.

In the new method you would check if the 'param' argument is one of
the 'special' auto-generated parameters.  If so, you make the call to
the specific_analyses.relax_disp.disp_data functions that you need to
obtain the values, and then return them as a dictionary.  If the
parameter is not an auto-generated parameter, then call the API common
self._return_value_general() method (this is so you don't need to
reimplement all of the method).

A different way would be to have something like the
relax_disp.plot_disp_curves, but for writing the dispersion curves to
file.  This already exists in the relax_disp.write_disp_curves, this
creates one file per spin system and can be modified to handle
offsets, tilt angles and omega_eff as well.  Or modifying this
function could be complementary.

This is rather complex!  This is probably your first time working
directly with the analysis specific API, so it might take a little
while to understand it.

Regards,

Edward

On 7 March 2014 13:33, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Edward.

How should I handle the value.write function?

I was thinking of adding w_eff and Delta_omega as parameters, like these
commits:
r22409 - /trunk/specific_analyses/relax_disp/api.py
<a  rel="nofollow" href="http://www.mail-archive.com/relax-commits@xxxxxxx/msg20031.html">http://www.mail-archive.com/relax-commits@xxxxxxx/msg20031.html</a>

r22411 - /trunk/specific_analyses/relax_disp/api.py
<a  rel="nofollow" href="http://www.mail-archive.com/relax-commits@xxxxxxx/msg20033.html">http://www.mail-archive.com/relax-commits@xxxxxxx/msg20033.html</a>

If I was about to use the value.write function, how should
I initialize a call to the function to calculate theta, Delta_omega?

Best
Troels



2014-03-07 12:26 GMT+01:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">

Hi Troels,

One consideration you need to make for the functions of the relax
library is that these are independent of the relax data store and the
pipe_control package (used to manipulate the data store) and the
specific_analyses package.  I.e. you should be able to use all
functions without the rest of relax, hence it could be distributed
with other GPL v3+ NMR software.  Here you have used a number of
pipe_control.mol_res_spin and specific_analyses.relax_disp.disp_data
functions.  Therefore this indicates that the code would be better
located in the specific_analyses.relax_disp.disp_data module.  A
calc_tilt_angle() function in the relax library would essentially need
to take all its data as arguments (spin-lock field and offset and
chemical shift) and return the tilt angle.

The other problem is the storing of theta in the spin containers.
This should not be done as the user can change the(spin-lock field,
offset, or chemical shift and hence the tilt angle theta will change.
It is much better to generate theta when needed by the
relax_disp.plot_disp_curves user function, and then not store it (so
it is destroyed automatically by Python).  Such non-permanent
parameters are used extensively throughout relax, especially in the
N-state or ensemble analysis code.

Regards,

Edward


On 7 March 2014 11:42,  &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Author: tlinnet
Date: Fri Mar  7 11:42:36 2014
New Revision: 22427

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=22427&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=22427&amp;view=rev</a>
Log:
Added lib.rotating_frame module containing functions related to rotating
frame NMR calculations.

Regarding sr #3124, (<a  rel="nofollow" href="https://gna.org/support/index.php?3124">https://gna.org/support/index.php?3124</a>) - Grace
graphs production for R1rho analysis with R2_eff as function of 
Omega_eff.

Added:
    trunk/lib/rotating_frame.py

Added: trunk/lib/rotating_frame.py
URL:
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/trunk/lib/rotating_frame.py?rev=22427&amp;view=auto">http://svn.gna.org/viewcvs/relax/trunk/lib/rotating_frame.py?rev=22427&amp;view=auto</a>

==============================================================================
--- trunk/lib/rotating_frame.py (added)
+++ trunk/lib/rotating_frame.py Fri Mar  7 11:42:36 2014
@@ -0,0 +1,77 @@

+###############################################################################
+#
#
+# Copyright (C) 2014 Troels E. Linnet
#
+#
#
+# This file is part of the program relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>).
#
+#
#
+# This program is free software: you can redistribute it and/or modify
#
+# it under the terms of the GNU General Public License as published by
#
+# the Free Software Foundation, either version 3 of the License, or
#
+# (at your option) any later version.
#
+#
#
+# This program is distributed in the hope that it will be useful,
#
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
#
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#
+# GNU General Public License for more details.
#
+#
#
+# You should have received a copy of the GNU General Public License
#
+# along with this program.  If not, see &lt;<a  rel="nofollow" href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>&gt;.
#
+#
#

+###############################################################################
+
+# Module docstring.
+&quot;&quot;&quot;Module containing functions related to rotating frame NMR
calculations.&quot;&quot;&quot;
+
+# Python module imports.
+from os import sep
+
+# relax module imports.
+from pipe_control.mol_res_spin import find_index, get_spin_ids,
index_molecule, index_residue, return_spin, spin_loop
+from specific_analyses.relax_disp.disp_data import loop_exp_frq_offset,
return_offset_data, return_param_key_from_data, return_spin_lock_nu1
+
+def calc_tilt_angle():
+    # Get the field count
+    field_count = cdp.spectrometer_frq_count
+
+    # Get the spin_lock_field points
+    spin_lock_nu1 = return_spin_lock_nu1(ref_flag=False)
+
+    # Initialize data containers
+    all_spin_ids = get_spin_ids()
+
+    # Containers for only selected spins
+    cur_spin_ids = []
+    cur_spins = []
+    for curspin_id in all_spin_ids:
+        # Get the spin
+        curspin = return_spin(curspin_id)
+
+        # Check if is selected
+        if curspin.select == True:
+            cur_spin_ids.append(curspin_id)
+            cur_spins.append(curspin)
+
+    # The offset and R1 data.
+    chemical_shifts, offsets, tilt_angles =
return_offset_data(spins=cur_spins, spin_ids=cur_spin_ids,
field_count=field_count, fields=spin_lock_nu1)
+
+    # Loop over the index of spins, then exp_type, frq, offset
+    print(&quot;Printing the following&quot;)
+    print(&quot;exp_type curspin_id frq offset{ppm}
offsets[ei][si][mi][oi]{rad/s} ei mi oi si di 
cur_spin.chemical_shift{ppm}
chemical_shifts[ei][si][mi]{rad/s} spin_lock_nu1{Hz}
tilt_angles[ei][si][mi][oi]{rad}&quot;)
+    for si in range(len(cur_spin_ids)):
+        theta_spin_dic = dict()
+        curspin_id = cur_spin_ids[si]
+        cur_spin = cur_spins[si]
+        for exp_type, frq, offset, ei, mi, oi in
loop_exp_frq_offset(return_indices=True):
+            # Loop over the dispersion points.
+            spin_lock_fields = spin_lock_nu1[ei][mi][oi]
+            for di in range(len(spin_lock_fields)):
+                print(&quot;%-8s %-10s %11.1f %8.4f %12.5f %i  %i  %i  %i
%i %7.3f %12.5f %12.5f %12.5f&quot;%(exp_type, curspin_id, frq, offset,
offsets[ei][si][mi][oi], ei, mi, oi, si, di, cur_spin.chemical_shift,
chemical_shifts[ei][si][mi], spin_lock_fields[di],
tilt_angles[ei][si][mi][oi][di]))
+                dic_key = return_param_key_from_data(exp_type=exp_type,
frq=frq, offset=offset, point=spin_lock_fields[di])
+                theta_spin_dic[&quot;%s&quot;%(dic_key)] =
tilt_angles[ei][si][mi][oi][di]
+        # Store the data
+        cur_spin.theta = theta_spin_dic
+
+    print(&quot;\nThe theta data now resides in&quot;)
+    for curspin, mol_name, res_num, res_name, spin_id in
spin_loop(full_info=True, return_id=True, skip_desel=True):
+        spin_index = find_index(selection=spin_id, global_index=False)
+        print(&quot;%s cdp.mol[%i].res[%i].spin[%i].theta&quot;%(spin_id,
spin_index[0], spin_index[1], spin_index[2]))


_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-commits mailing list
relax-commits@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="https://mail.gna.org/listinfo/relax-commits">https://mail.gna.org/listinfo/relax-commits</a>
</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-devel mailing list
relax-devel@xxxxxxx


To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="https://mail.gna.org/listinfo/relax-devel">https://mail.gna.org/listinfo/relax-devel</a>
</pre></blockquote><pre style="margin: 0em;">


</pre></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00047" href="msg00047.html">Re: r22427 - /trunk/lib/rotating_frame.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00041" href="msg00041.html">Re: r22427 - /trunk/lib/rotating_frame.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00042" href="msg00042.html">Re: r22427 - /trunk/lib/rotating_frame.py</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Fri Mar 07 16:20:13 2014</div>  
</body>
</html>
