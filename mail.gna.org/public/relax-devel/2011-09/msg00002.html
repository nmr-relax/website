<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: System test "Relax_fit.check_curve_fitting" -->
<!--X-From-R13: tnel gubzcfba <tnelg.naq.fnenuoNtznvy.pbz> -->
<!--X-Date: Fri, 16 Sep 2011 18:44:26 +0200 -->
<!--X-Message-Id: CA+PqGfW7a6+N&#45;5nQhHfQE6MjJDfDE_&#45;JM481De1VziummZu16Q@mail.gmail.com -->
<!--X-Content-Type: multipart/alternative -->
<!--X-Reference: 4E56228A.8060101@unibas.ch -->
<!--X-Reference: CAED9pY_KwQm0D_ROcUABLBo52rPpZ=c=gc2&#45;vnFQa5v1492Dog@mail.gmail.com -->
<!--X-Reference: 4E564544.7000806@bmb.leeds.ac.uk -->
<!--X-Reference: CAED9pY9B2qCT3uNOKXNN9rR3OpxyxG20foqKP5y4&#45;e8KaD7NxQ@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: System test &quot;Relax_fit.check_curve_fitting&quot; -- September 16, 2011 - 18:44</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: System test &quot;Relax_fit.check_curve_fitting&quot;</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00002" class="tabs">Index by Date</a> | <a href="threads.html#00002" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00001.html">Date Prev</a>] [<a href="msg00003.html">Date Next</a>] [<a href="msg00000.html">Thread Prev</a>] [<a href="msg00003.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;Edward d'Auvergne&quot; &lt;edward@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Fri, 16 Sep 2011 17:43:37 +0100</li>
<li class="menuitem">
<em>Cc</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=gamma;	h=mime-version:in-reply-to:references:from:date:message-id:subject:to	:cc:content-type;	bh=FfACAfR1niQUfD6d5IZ5dmWcaXcHB5CaDiAWPPag1W4=;	b=twZgWn8HjVXbI2Ssf8HQzn+Wwxki37PH/vzP25VkKlTw0qVl3eBZTjVCf4dn4kpI5J	0/JFDXwFpjEYMiydEoPzVJD3c5JH3N9MhGd5x6pONqAcCZUA+IJ+M80ERvaYVa2IpxS6	1UbiE9oooaGFK7hDzKPcfa8HRKNivBI18bxbo=</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00002.html">CA+PqGfW7a6+N-5nQhHfQE6MjJDfDE_-JM481De1VziummZu16Q@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;4E56228A.8060101@xxxxxxxxx&gt;	&lt;CAED9pY_KwQm0D_ROcUABLBo52rPpZ=c=gc2-vnFQa5v1492Dog@xxxxxxxxxxxxxx&gt;	&lt;4E564544.7000806@xxxxxxxxxxxxxxx&gt;	&lt;CAED9pY9B2qCT3uNOKXNN9rR3OpxyxG20foqKP5y4-e8KaD7NxQ@xxxxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>gary thompson</strong> on September 16, 2011 - 18:44:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
Hi Ed <div><br></div><div>I have now had a bit more of a look at this so here are some comments</div><div><br></div><div><br><br><div class="gmail_quote">On Thu, Aug 25, 2011 at 2:21 PM, Edward d&#39;Auvergne <span dir="ltr">&lt;<a rel="nofollow" href="mailto:edward@xxxxxxxxxxxxx" target="_blank">edward@xxxxxxxxxxxxx</a>&gt;</span> wrote:<br>

<blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex">
Hi,<br>
<br>
That&#39;s great that you have time, to have this working properly is<br>
quite important.  I didn&#39;t realise how much of an issue the merging of<br>
the multi-processor code and GUI code would be.  I have now merged the<br>
multi-processor branch into the main 1.3 line, as well as the new GUI<br>
branch, and that is where the problems are.  I think there are at<br>
least 2 problems currently occurring.  The first has to do with the<br>
GUI tests:<br>
<br>
$ relax --gui-test<br>
<br>
I looks like that there is a clash of the wxPython App.MainLoop() and<br>
how the master processors of the multi package interact.  There<br>
appears to be race conditions, even in the uni-processor fabric.  This<br>
only occurs in the test-suite, I have just tested manual operation of<br>
the GUI which works, so this makes things more difficult.  The problem<br>
was not existent in the gui_testing branch (svn co<br>
svn+ssh://<a rel="nofollow" href="http://bugman@xxxxxxxxxxx/svn/relax/branches/gui_testing/@14200" target="_blank">bugman@xxxxxxxxxxx/svn/relax/branches/gui_testing/@14200</a>)<br>
until after the multi-processor code was merged.<br>
<br></blockquote><div><br></div><div>I presume this problem is solved and it was due to either a deadlock or calling the wx event loop outside of its main thread. Looking at the source code there seems to be quite a bit of thread specific code(?) One of the aims of the multiprocessor frame-work was to avoid directly waiting on threads and locks etc. This is why the whole design is based round queues and callbacks as they are quite simple to deal with and don&#39;t directly expose any underlying threaded model.  If you would like me to expand on this more please do say. If there are still multi threaded issues please do say and give some details of how to cause event loop problems or deadlocks</div>

<div><br></div><div><br></div><div><br></div><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex">
<br>
The second problem is IO redirection.  This occurs in a number of<br>
places in relax.  These include:<br>
<br>
1)  The --log command line flag which causes STDOUT and STDERR to be<br>
sent to file.<br>
<br>
2)  The --tee command line flag which causes STDOUT and STDERR to be<br>
sent both to file and to the terminal.<br>
<br>
3)  The test suite.  The STDOUT and STDERR streams are caught and only<br>
sent to STDERR if there is an error or failure in a test.<br>
<br>
4)  The relax controller (part of the GUI).  This is a window to which<br>
STDOUT and STDERR are directed.  In the test-suite mode, the streams<br>
also output to the terminal.<br>
<br>
5)  The multi-processor package.  There are two parts.  The first is<br>
essentially a pre-filter which prepends certain tokens to the IO<br>
stream (i.e. the &#39;M  |&#39;, &#39;M  E|&#39;, and &#39;S 1|&#39; text).  I cannot see how<br>
we can do this as 4) is always set up after 5).  So I am considering<br>
removing this part.  It will make it more difficult with debugging,<br>
but I can see no other way.<br>
<br>
6)  The second part for the multi-processor package, which is<br>
currently non-functional, is the catching of the IO streams of the<br>
slave processes to send back to the master.  I will try to mimic the<br>
relax controller code here and store all slave text as a list with<br>
flags specifying whether it is STDOUT or STDERR.  Then the list can be<br>
returned to the master at which point the text can be sent to the two<br>
streams.<br>
<br>
The problem is that at each point here, sys.stdout and sys.stderr are<br>
replaced and the order in which this happens is impossible to change.<br>
Well 4) will always be last.<br></blockquote><div><br></div><div>I think the problem here is that the whole idea of replacing the std io streams multiple times is inflexible and painful. So I have come up with a strawman multiplexed io implimentation. The idea is that you replace stdio and stderr once and then insert IO elements to deal with the needs to block the output of io streams, record them and  create Tees etc  see what you think? Should we open a couple of new mail threads to discuss these things?</div>

<div><br></div><div>regards</div><div>gary</div><div><br></div><div>below id the multiplexed io system</div><div><div>&#39;&#39;&#39;</div><div><br></div><div>Created on 16 Sep 2011</div><div><br></div><div>@author: garyt</div>

<div>&#39;&#39;&#39;</div><div>import unittest</div><div>import sys</div><div><br></div><div>class BaseIOElement:</div><div>  </div><div>  def __init__(self,name=&quot;&quot;):</div><div>    <a rel="nofollow" href="http://self.name">self.name</a> = name</div>

<div>  </div><div>  def get_name(self):</div><div>    return <a rel="nofollow" href="http://self.name">self.name</a></div><div>  </div><div>    </div><div>class Multiplex_IO:</div><div>    def __init__(self,stream):</div><div>      self.stream = stream</div>

<div>      self.stack = []</div><div>    </div><div>    def add_stream(self,stream):</div><div>      self.stack.append(stream)</div><div>    </div><div>    def write(self, string):</div><div>      </div><div>      for stream in self.stack:</div>

<div>        string = stream.write(string)</div><div>        if string ==  None:</div><div>          break</div><div>        </div><div>      if string != None:</div><div>        self.stream.write(string)</div><div>    </div>

<div>    def get_plexers(self):</div><div>      return list(self.stack) </div><div>    </div><div>    def set_plexers(self,stack):</div><div>      self.stack =  list(stack)</div><div>      </div><div>    def flush(self):</div>

<div>      self.stream.flush()</div><div>    </div><div>    def __str__(self):</div><div>      names = [plexer.get_name() for plexer in self.stack]</div><div>      return &quot; &quot;.join(names)</div><div>      </div><div>

    </div><div>      </div><div><br></div><div>class PrependIO (BaseIOElement):</div><div>    def __init__(self, token=&quot;&quot;, name=&quot;prepend&quot;):</div><div>      </div><div>      self.token = token</div><div>

#      self.first_time =True</div><div>      </div><div>    def write(self,string):</div><div>        string = string.replace(&#39;\n&#39;, &#39;\n&#39; + self.token)</div><div><br></div><div>        # Handle the first line of output.</div>

<div>#        if self.first_time == True:</div><div>#            string = &#39;\n&#39; + self.token + string</div><div>#            self.first_time = False</div><div>        return string</div><div>      </div><div>class CaptureIO(BaseIOElement):</div>

<div>    def __init__(self,name=&quot;capture&quot;):</div><div>        self.buffer = []</div><div>    </div><div>    def write(self,string):</div><div>        self.buffer.append(string)</div><div>        return string</div>

<div>      </div><div>    def get_value(self):</div><div>      return &#39;&#39;.join(self.buffer)</div><div>    </div><div>    def clear(self):</div><div>      self.buffer = []</div><div> </div><div>class TeeIO(BaseIOElement):       </div>

<div>  def __init__(self,stream, name=&quot;tee&quot;):</div><div>    self.stream = stream</div><div>    </div><div>  def write(self,string):</div><div>    self.stream.write(string)</div><div>    return string</div><div>
    </div>
<div>class NullIO(BaseIOElement):</div><div>  </div><div>  def __init__(self):</div><div>    self.enabled = True</div><div>  </div><div>  def set_enaled(self, state):</div><div>    self.enabled = (state == True)</div><div>

    </div><div>  def write(self,string):</div><div>    return None</div><div>  </div><div>class Test:</div><div>#class Test(unittest.TestCase):</div><div><br></div><div><br></div><div>    def setUp(self):</div><div>        pass</div>

<div><br></div><div><br></div><div>    def tearDown(self):</div><div>        pass</div><div><br></div><div><br></div><div>    def testPassThru(self):</div><div>        sys.stderr = Multiplex_IO(sys.stderr)</div><div>        </div>

<div>        sys.stderr.add_stream(PrependIO(&quot;wibble&gt; &quot;))</div><div>        my_capture = CaptureIO()</div><div>        sys.stderr.add_stream(my_capture)</div><div>        </div><div>        print &gt;&gt; sys.stderr, &quot;test&quot;</div>

<div>        print &gt;&gt; sys.stderr, &quot;test 2&quot;</div><div>        </div><div>        print</div><div>        print &quot;==capture start==&quot;,</div><div>        print my_capture.get_value()</div><div>        print &quot;==capture end==&quot;</div>

<div><br></div><div>        my_capture.clear()</div><div>        print &quot;==clear capture start==&quot;,</div><div>        print my_capture.get_value()</div><div>        print &quot;==clear capture end==&quot;</div><div>

        </div><div>        my_tee = TeeIO(sys.stdout)</div><div>        sys.stderr.add_stream(my_tee)</div><div>        </div><div>        print &gt;&gt; sys.stderr, &quot;woggle&quot;</div><div>        </div><div>        sys.stderr.add_stream(NullIO())</div>

<div>        </div><div>        print &gt;&gt; sys.stderr, &quot;you shouldn&#39;t see this&quot;</div><div>        </div><div>        print sys.stderr</div><div>        </div><div>if __name__ == &quot;__main__&quot;:</div>

<div>    #import sys;sys.argv = [&#39;&#39;, &#39;Test.testName&#39;]</div><div>#    unittest.main()</div><div>    Test().testPassThru()</div></div><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex">


<br>
Regards,<br>
<font color="#888888"><br>
Edward<br>
</font><div><div></div><div><br>
<br>
On 25 August 2011 14:51, Gary Thompson &lt;<a rel="nofollow" href="mailto:garyt@xxxxxxxxxxxxxxx" target="_blank">garyt@xxxxxxxxxxxxxxx</a>&gt; wrote:<br>
&gt; On 08/25/2011 11:40 AM, Edward d&#39;Auvergne wrote:<br>
&gt;&gt;<br>
&gt;&gt; Hi,<br>
&gt;&gt;<br>
&gt;&gt; I&#39;m working on this at the moment.  Unfortunately the main 1.3 line is<br>
&gt;&gt; severely broken at the moment!  The new multi-processor package is<br>
&gt;&gt; clashing with and causing relax to die hard on the test-suite and the<br>
&gt;&gt; GUI.  The main cause is IO redirection of sys.stdout and sys.stderr.<br>
&gt;&gt; The multi-processor code (even in uni-processor mode) is hijacking the<br>
&gt;&gt; streams and the test suite and GUI do not know what to do anymore.<br>
&gt;&gt; Once I eliminate all the IO redirection of the multi package, apart<br>
&gt;&gt; from the IO capture on the slave processes which is non-functional<br>
&gt;&gt; anyway, then the test-suite should be back in order.  I noticed you<br>
&gt;&gt; performed an svnmerge, and this is likely causing the breakages in<br>
&gt;&gt; your branch.<br>
&gt;&gt;<br>
&gt;&gt; Regards,<br>
&gt;&gt;<br>
&gt;&gt; Edward<br>
&gt;&gt;<br>
&gt;&gt;<br>
&gt;<br>
&gt; Hi Ed<br>
&gt; I do at last have time to work on this, would you like me to have a look<br>
&gt; at what is going on?<br>
&gt;<br>
&gt; which branch do I need to look at? and what are the specific problems<br>
&gt; with the io redirect that need to be addressed?<br>
&gt;<br>
&gt; regards<br>
&gt; gary<br>
&gt;<br>
&gt;<br>
&gt;&gt; On 25 August 2011 12:23, Sébastien Morin&lt;<a rel="nofollow" href="mailto:sebastien.morin@xxxxxxxxx" target="_blank">sebastien.morin@xxxxxxxxx</a>&gt;<br>
&gt;&gt;  wrote:<br>
&gt;&gt;&gt;<br>
&gt;&gt;&gt; Hi Ed,<br>
&gt;&gt;&gt;<br>
&gt;&gt;&gt; While working on &quot;inversion-recovery&quot; branch, I realized that the system<br>
&gt;&gt;&gt; tests &quot;Relax_fit.check_curve_fitting__exp_2param_neg&quot; and<br>
&gt;&gt;&gt; &quot;Relax_fit.check_curve_fitting__exp_3param_inv_neg&quot; were failing. In<br>
&gt;&gt;&gt; order<br>
&gt;&gt;&gt; to pin point the problem, I checked on the main 1.3 branch (514439) and<br>
&gt;&gt;&gt; system test &quot;Relax_fit.check_curve_fitting&quot; also failed, with the same<br>
&gt;&gt;&gt; error:<br>
&gt;&gt;&gt;<br>
&gt;&gt;&gt; ==========<br>
&gt;&gt;&gt; ======================================================================<br>
&gt;&gt;&gt; ERROR: check_curve_fitting (test_suite.system_tests.relax_fit.Relax_fit)<br>
&gt;&gt;&gt; Check the results of the curve-fitting.<br>
&gt;&gt;&gt; ----------------------------------------------------------------------<br>
&gt;&gt;&gt;<br>
&gt;&gt;&gt; relax&gt;  pipe.create(pipe_name=&#39;mf&#39;, pipe_type=&#39;mf&#39;)<br>
&gt;&gt;&gt; Traceback (most recent call last):<br>
&gt;&gt;&gt;  File<br>
&gt;&gt;&gt;<br>
&gt;&gt;&gt; &quot;/Users/semor/Documents/pse-4/collaborations/relax/relax-1.3/test_suite/system_tests/relax_fit.py&quot;,<br>
&gt;&gt;&gt; line 60, in check_curve_fitting<br>
&gt;&gt;&gt;    self.assertEqual(cdp.curve_type, &#39;exp&#39;)<br>
&gt;&gt;&gt; AttributeError: &#39;PipeContainer&#39; object has no attribute &#39;curve_type&#39;<br>
&gt;&gt;&gt;<br>
&gt;&gt;&gt; ----------------------------------------------------------------------<br>
&gt;&gt;&gt; Ran 1 test in 0.001s<br>
&gt;&gt;&gt;<br>
&gt;&gt;&gt; FAILED (errors=1)<br>
&gt;&gt;&gt; ==========<br>
&gt;&gt;&gt;<br>
&gt;&gt;&gt; I tried changing the pipe type from &quot;mf&quot; to &quot;relax_fit&quot; (as it should<br>
&gt;&gt;&gt; be).<br>
&gt;&gt;&gt; This did not solve the issue...<br>
&gt;&gt;&gt;<br>
&gt;&gt;&gt; Any idea ?<br>
&gt;&gt;&gt; Thanks !<br>
&gt;&gt;&gt;<br>
&gt;&gt;&gt;<br>
&gt;&gt;&gt; Séb   :)<br>
&gt;&gt;&gt;<br>
&gt;&gt;&gt; --<br>
&gt;&gt;&gt; Sébastien Morin, Ph.D.<br>
&gt;&gt;&gt; Postdoctoral Fellow, S. Grzesiek NMR Laboratory<br>
&gt;&gt;&gt; Department of Structural Biology<br>
&gt;&gt;&gt; Biozentrum, Universität Basel<br>
&gt;&gt;&gt; Klingelbergstrasse 70<br>
&gt;&gt;&gt; 4056 Basel<br>
&gt;&gt;&gt; Switzerland<br>
&gt;&gt;&gt;<br>
&gt;&gt;&gt;<br>
&gt;&gt;&gt; _______________________________________________<br>
&gt;&gt;&gt; relax (<a rel="nofollow" href="http://nmr-relax.com" target="_blank">http://nmr-relax.com</a>)<br>
&gt;&gt;&gt;<br>
&gt;&gt;&gt; This is the relax-devel mailing list<br>
&gt;&gt;&gt; <a rel="nofollow" href="mailto:relax-devel@xxxxxxx" target="_blank">relax-devel@xxxxxxx</a><br>
&gt;&gt;&gt;<br>
&gt;&gt;&gt; To unsubscribe from this list, get a password<br>
&gt;&gt;&gt; reminder, or change your subscription options,<br>
&gt;&gt;&gt; visit the list information page at<br>
&gt;&gt;&gt; <a rel="nofollow" href="/mail.gna.org/listinfo/relax-devel" target="_blank">https://mail.gna.org/listinfo/relax-devel</a><br>
&gt;&gt;&gt;<br>
&gt;&gt; _______________________________________________<br>
&gt;&gt; relax (<a rel="nofollow" href="http://nmr-relax.com" target="_blank">http://nmr-relax.com</a>)<br>
&gt;&gt;<br>
&gt;&gt; This is the relax-devel mailing list<br>
&gt;&gt; <a rel="nofollow" href="mailto:relax-devel@xxxxxxx" target="_blank">relax-devel@xxxxxxx</a><br>
&gt;&gt;<br>
&gt;&gt; To unsubscribe from this list, get a password<br>
&gt;&gt; reminder, or change your subscription options,<br>
&gt;&gt; visit the list information page at<br>
&gt;&gt; <a rel="nofollow" href="/mail.gna.org/listinfo/relax-devel" target="_blank">https://mail.gna.org/listinfo/relax-devel</a><br>
&gt;<br>
&gt;<br>
&gt; --<br>
&gt; -------------------------------------------------------------------<br>
&gt; Dr Gary Thompson                  [Homans Lab Research Coordinator]<br>
&gt;<br>
&gt; Astbury Centre for Structural Molecular Biology,<br>
&gt; University of Leeds,<br>
&gt; Leeds, LS2 9JT, West-Yorkshire, UK             Tel. <a rel="nofollow" href="tel:%2B44-113-3433024" value="+441133433024" target="_blank">+44-113-3433024</a><br>
&gt; email: <a rel="nofollow" href="mailto:garyt@xxxxxxxxxxxxxxx" target="_blank">garyt@xxxxxxxxxxxxxxx</a>                   Fax  <a rel="nofollow" href="tel:%2B44-113-3431935" value="+441133431935" target="_blank">+44-113-3431935</a><br>
&gt; -------------------------------------------------------------------<br>
&gt;<br>
&gt;<br>
<br>
_______________________________________________<br>
relax (<a rel="nofollow" href="http://nmr-relax.com" target="_blank">http://nmr-relax.com</a>)<br>
<br>
This is the relax-devel mailing list<br>
<a rel="nofollow" href="mailto:relax-devel@xxxxxxx" target="_blank">relax-devel@xxxxxxx</a><br>
<br>
To unsubscribe from this list, get a password<br>
reminder, or change your subscription options,<br>
visit the list information page at<br>
<a rel="nofollow" href="/mail.gna.org/listinfo/relax-devel" target="_blank">https://mail.gna.org/listinfo/relax-devel</a><br>
</div></div></blockquote></div><br>
</div>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Mon Sep 19 14:40:12 2011</div>  
</body>
</html>
