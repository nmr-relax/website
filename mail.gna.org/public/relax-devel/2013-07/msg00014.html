<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: numerical cpmg fit -->
<!--X-From-R13: "Sqjneq q'Ohiretar" <rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Fri, 12 Jul 2013 09:43:06 +0200 -->
<!--X-Message-Id: CAED9pY9QPSyfPmtpCiJ5agGSEZn8oZrnRB2BukMoLAse0UAAbQ@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 35036407&#45;39A6&#45;4B59&#45;B529&#45;7074D5F10DBA@gmx.at -->
<!--X-Reference: CAED9pY_zKf+1kML6UNezswM1NQtvZh7n7Jdz_Ss1H5Kn2cj5kw@mail.gmail.com -->
<!--X-Reference: CAED9pY9HUHQ1X6zQpY8CmPR3NFoSXJwgeP02Nme1Y447&#45;6U9RQ@mail.gmail.com -->
<!--X-Reference: A1B15ABA&#45;695A&#45;4B49&#45;9855&#45;6EFFE3318C72@gmx.at -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: numerical cpmg fit -- July 12, 2013 - 09:43</title>
<link rel="stylesheet" type="text/css" href="/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="https://gna.org/images/gna.theme/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: numerical cpmg fit</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00014" class="tabs">Index by Date</a> | <a href="threads.html#00014" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00013.html">Date Prev</a>] [<a href="msg00015.html">Date Next</a>] [<a href="msg00013.html">Thread Prev</a>] [<a href="msg00017.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: Paul Schanda &lt;paul.schanda@xxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Fri, 12 Jul 2013 09:42:35 +0200</li>
<li class="menuitem">
<em>Cc</em>: mathilde lescanne &lt;mathilde.lescanne@xxxxxxxxx&gt;,	&quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113;	h=mime-version:sender:in-reply-to:references:date	:x-google-sender-auth:message-id:subject:from:to:cc:content-type	:content-transfer-encoding;	bh=Slnw+7gS20/LI6IurwQMhxQecDHmHu92TG6LHmizv2s=;	b=eKEI3aGok47OJ4K0UtASi6m3daEcJ713sIdqFLKNyVfgLNcHn3QLV9ju3knwrHA2iv	YQWr7LpCvtsxhR7FDpogPIFHkw5aKIdRqD38aIQiu84/WAiIF3NChW9oEFmp0wRsCqEZ	uuap3E0Y5eEggvhVaP8hnpxlFqrpxVQ7z81/NuYz0+Wq4OCs7r5m11n4udIc28XsrGlf	X0gnJ1vO2ZhcNpmWxHOohDN1Y+oU2oyla7jZgiO3re60S8INR7k+rkB82kzdO42QEUQL	RazVl9wlcYCPNkFPkgxp37Boy69K0hK0QYzXHuq+yohDlAul6ivkrKWCtEuPLFdxuc0L	UjTg==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00014.html">CAED9pY9QPSyfPmtpCiJ5agGSEZn8oZrnRB2BukMoLAse0UAAbQ@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;35036407-39A6-4B59-B529-7074D5F10DBA@xxxxxx&gt;	&lt;CAED9pY_zKf+1kML6UNezswM1NQtvZh7n7Jdz_Ss1H5Kn2cj5kw@xxxxxxxxxxxxxx&gt;	&lt;CAED9pY9HUHQ1X6zQpY8CmPR3NFoSXJwgeP02Nme1Y447-6U9RQ@xxxxxxxxxxxxxx&gt;	&lt;A1B15ABA-695A-4B49-9855-6EFFE3318C72@xxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on July 12, 2013 - 09:43:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Thanks!  I've updated the code with this information.  See commit
r20276 (<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.scm/18032">http://article.gmane.org/gmane.science.nmr.relax.scm/18032</a> -
this link takes some time to be generated) and the code at
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/relax_disp/lib/dispersion/ns_2site_star.py?revision=20276&amp;view=markup">http://svn.gna.org/viewcvs/relax/branches/relax_disp/lib/dispersion/ns_2site_star.py?revision=20276&amp;view=markup</a>
after clicking on 'as text' (or type 'svn up' in your checked out copy
of the relax_disp branch).

In relax, the pA parameter together with kex is used.  This is the
current convention and the reason is quite important - it due to how
relax performs optimisation for the relaxation dispersion analysis.
For optimisation, the simplex algorithm is used
(<a  rel="nofollow" href="http://en.wikipedia.org/wiki/Nelder%E2%80%93Mead_method">http://en.wikipedia.org/wiki/Nelder%E2%80%93Mead_method</a>) together
with the log-barrier constraint algorithm
(<a  rel="nofollow" href="http://en.wikipedia.org/wiki/Barrier_function#Logarithmic_barrier_function">http://en.wikipedia.org/wiki/Barrier_function#Logarithmic_barrier_function</a>).
 This allows for the fastest and most accurate optimisation possible
when gradients and Hessians cannot be derived (1st and 2nd partial
derivatives), as is the case for the numerical solutions.  I hope we
can get this model up and running soon to see how fast we can make it
run.

The important part about having pA as a parameter is that I can use
the constraints 0.5 &lt;= pA &lt;= 1.0.  The 0.5 limit cuts the optimisation
space in half.  Both sides of this limit are mirror image spaces, so
it is numerically inefficient to search both spaces.  The 1.0 limit is
also important as numerically pA will often go above 1 during
optimisation.  I have seen this in a number of cases.  Sometimes pA
comes back, but in most cases it runs off into impossibly high values
(compensated by negative pB values).  The result is incredibly slow
optimisation to a nonsensical solution for that spin cluster.  This
occurs when the model is not suitable for the data.  Without a pA
parameter, I cannot stop this behaviour.

If you could advise how to change from {kge, keg} to {pA, kex} in your
code, it would be appreciated.

Cheers,

Edward


On 12 July 2013 07:51, Paul Schanda &lt;paul.schanda@xxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Edward,

Yes, R2E and R2G are the exchange-free R2 values. Sometimes also referred to
as R20 or R2infinity. They are the Redfield-relaxation part.
Currently, the functions do not use populations (pA, pB) but they use the
two exchange rates (forward, backward), rather than one rate constant and
one population. The two different approaches are in essence the same, as
populations can be calculated from forward/backward rates in a
straightforward manner.
We can easily change this if it is more in the logic of the existing code.

paul


Hello,

Another question I have is what are the parameters of this model?  It
relates to the function arguments currently labelled as unknown in the
function docstring.  I would like to implement step 2 of the tutorial
on adding relaxation dispersion models to relax (the
relax_disp.select_model user function front end, see
<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.devel/3907">http://article.gmane.org/gmane.science.nmr.relax.devel/3907</a>), but I'm
not sure how to list the parameters of the model for the user.  Is
there a population parameter (pA or pB)?  Are R2E and R2G the same as
the R20A and R20B rates (the R2 rates in the absence of exchange for
states A and B for a fixed magnetic field strength)?

Cheers,

Edward


On 11 July 2013 16:14, Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt; wrote:

Hi Paul,

I have now incorporated this code into relax (see
<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.scm/18025">http://article.gmane.org/gmane.science.nmr.relax.scm/18025</a>).  Could
you please check the code, comments, and docstrings carefully and see
if there are any issues?  Could you also tell me if anyone else should
be included in the copyright notice?  It would be useful to replace
the 'Unknown' elements in the function docstring with basic
descriptions of the parameter and its Python object type.  And any
suggestions for comments describing in basic NMR terms what the code
is doing (the physics of the propagations, for example) would also be
appreciated.

You can get the new code by typing the following in the base directory
of the checked out copy of the relax_disp branch:

$ svn up

There was an indentation problem that I have tried to solve.  Also I
cannot determine where the mpower() function comes from - it appears
not to be part of numpy or scipy.  Is this an outside function you
wrote?  I have also made a number of significant speed ups of the code
(see article.gmane.org/gmane.science.nmr.relax.scm/18029).  Note that
this cannot be selected as a model in the dispersion analysis yet.

Cheers,

Edward




On 11 July 2013 13:47, Paul Schanda &lt;paul.schanda@xxxxxx&gt; wrote:


Hi Edward,

Here is a function that does a numerical fit of CPMG. It uses an explicit
matrix that contains relaxation, exchange and chemical shift terms. It does
the 180deg pulses in the CPMG train with conjugate complex matrices.
It returns calculated R2eff values, so it can be used for numerical fitting
of CPMG.
It is an addition to the functions that I previously sent to you.
The approach of Bloch-McConnell can be found in chapter 3.1 of Palmer, A. G.
Chem Rev 2004, 104, 3623â€“3640.
I wrote this function (initially in MATLAB) in 2010.
I agree that this code is released under the GPL3 or higher licence.

Paul


def func1(R2E,R2G,fg,kge,keg, cpmgfreq,tcpmg):
       kex=kge+keg
       Rcalc_array=np.zeros(len(cpmgfreq))
       Rr  = -1.*np.matrix([[R2G, 0.],[0., R2E]])
       Rex = -1.*np.matrix([[kge,-keg],[-kge, keg]])
       RCS = complex(0.,-1.)*np.matrix([[0. ,0.],[0.,fg]])
       R = Rr + Rex + RCS
       cR = np.conj(R)


       IGeq=keg/kex; IEeq=kge/kex
       M0=np.matrix([[IGeq],[IEeq]])

       for k in range(len(cpmgfreq)):
               tcp=1./(4.*cpmgfreq[k])
               prop_2
=np.dot(np.dot(sci.expm(R*tcp),sci.expm(cR*2.*tcp)),sci.expm(R*tcp))
       prop_total =mpower(prop_2,cpmgfreq[k]*tcpmg)

       Moft = prop_total*M0

               Mgx=Moft[0].real/M0[0]
               Rcalc=-(1./tcpmg)*math.log(Mgx);
               Rcalc_array[k]=Rcalc
       return Rcalc_array




_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-devel mailing list
relax-devel@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="https://mail.gna.org/listinfo/relax-devel">https://mail.gna.org/listinfo/relax-devel</a>




***************************

Paul Schanda
paul.schanda@xxxxxx





_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-devel mailing list
relax-devel@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="https://mail.gna.org/listinfo/relax-devel">https://mail.gna.org/listinfo/relax-devel</a>

</pre></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00010" href="msg00010.html">numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Paul Schanda</li></ul></li>
<li><strong><a name="00011" href="msg00011.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00012" href="msg00012.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00013" href="msg00013.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Paul Schanda</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer">You are on the <a href="http://gna.org">Gna!</a> mail server.</div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Fri Jul 12 11:40:07 2013</div>  
</body>
</html>
