<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: r23834 &#45; /branches/disp_spin_speed/lib/dispersion/cr72.py -->
<!--X-From-R13: "Sqjneq q'Ohiretar" &#60;rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Wed, 11 Jun 2014 15:10:08 +0200 -->
<!--X-Message-Id: CAED9pY_E8V1EUkzvJ81yi9dsog262fu5czK9=CVz+aQuGwxHNQ@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: E1Wui34&#45;0004K4&#45;JB@subversion.gna.org -->
<!--X-Reference: CAED9pY_Rhdagfc=iGbPqckKXx+e55=QzPa5iq0oiBoe30nJdRQ@mail.gmail.com -->
<!--X-Reference: CA+CBx2N9iGH2EQs=PtgxmPBjvm7GiY1UePQjkU_u6pu_&#45;COwBA@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: r23834 - /branches/disp_spin_speed/lib/dispersion/cr72.py -- June 11, 2014 - 15:10</title>
<link rel="stylesheet" type="text/css" href="/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="https://gna.org/images/gna.theme/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: r23834 - /branches/disp_spin_speed/lib/dispersion/cr72.py</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00161" class="tabs">Index by Date</a> | <a href="threads.html#00161" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00160.html">Date Prev</a>] [<a href="msg00162.html">Date Next</a>] [<a href="msg00160.html">Thread Prev</a>] [<a href="msg00159.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Wed, 11 Jun 2014 15:09:37 +0200</li>
<li class="menuitem">
<em>Cc</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:date:message-id:subject :from:to:cc:content-type:content-transfer-encoding; bh=qlQMAU+bmPVcmUEChX3fwMm98UUf9GgqyM3SlUfkmgY=; b=pl1l6Vc8ZMK1JapLXf9rnl4TlXeJHwoHBiPZFs5A22m9AvpZwxdYljvObauP0XTLow tqNMBN1BI1NyqjWbkILNObvmTm4iuDvUtw/FyV8IELguPI1l7km2hdkRHoqiYKW9y0/a 1MtD6WEUDC+Po4/LRNetU71vTpvV0siBhb8cv2wFQM2hOmRjEntQaQr3WGtCTl31gKpL +yRk/3w/pAgVJAp+3DKzNWvmfroSqvIzwOu/Bx5GkfTI9C/s+mnHaB3K6jRox66UKSTF gg6kFooqdKUw8uGMMtvcwAU+rDkvT6qNuMTr2/mdNeE7bh5EMBDxQ2/kJ/z+J6bSOvBx CQSw==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;CAED9pY_E8V1EUkzvJ81yi9dsog262fu5czK9=CVz+aQuGwxHNQ@mail.gmail.com&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;E1Wui34-0004K4-JB@subversion.gna.org&gt; &lt;CAED9pY_Rhdagfc=iGbPqckKXx+e55=QzPa5iq0oiBoe30nJdRQ@mail.gmail.com&gt; &lt;CA+CBx2N9iGH2EQs=PtgxmPBjvm7GiY1UePQjkU_u6pu_-COwBA@mail.gmail.com&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on June 11, 2014 - 15:10:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi,

We should really convert the unit tests to input the higher order
structures.  There is no need to have extra code to handle these
cases, and we do not need backwards compatibility here.  It's better
to change completely and delete the old code for speed.  If a user
would like to directly use the relax library functions, then they can
read the function docstring and work out that dw, R20A, and R20B need
to be higher order structures.

Regards,

Edward



On 11 June 2014 15:06, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Edward.

It is the unit tests, which fail.

But I can change those.

It is the choice of backwards compatibility and easy import of lib
function, and easy use of input, that weights higher.
With those few tests, the function becomes easy to use in 1d all multi d 
cases.

What do you think?

Best
Troels

2014-06-11 15:00 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Troels,

For such changes, do you need to test for r20a being a float?  It is
defined as being a numpy array of floats in the docstring, and so it
should always be.  Not checking for a value which should never be
supplied will simplify the code.

Regards,

Edward

On 11 June 2014 14:54,  &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Author: tlinnet
Date: Wed Jun 11 14:54:37 2014
New Revision: 23834

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=23834&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=23834&amp;view=rev</a>
Log:
Implemented masked replacement if fact is less that 1.0.

Task #7807 (<a  rel="nofollow" href="https://gna.org/task/index.php?7807">https://gna.org/task/index.php?7807</a>): Speed-up of dispersion 
models for Clustered analysis.

Modified:
    branches/disp_spin_speed/lib/dispersion/cr72.py

Modified: branches/disp_spin_speed/lib/dispersion/cr72.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/disp_spin_speed/lib/dispersion/cr72.py?rev=23834&amp;r1=23833&amp;r2=23834&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/disp_spin_speed/lib/dispersion/cr72.py?rev=23834&amp;r1=23833&amp;r2=23834&amp;view=diff</a>
==============================================================================
--- branches/disp_spin_speed/lib/dispersion/cr72.py     (original)
+++ branches/disp_spin_speed/lib/dispersion/cr72.py     Wed Jun 11 
14:54:37 2014
@@ -93,7 +93,7 @@

 # Python module imports.
 from numpy import allclose, arccosh, array, cos, cosh, isfinite, isnan, 
fabs, min, max, ndarray, ones, sqrt, sum, zeros
-from numpy.ma import masked_greater_equal, masked_where
+from numpy.ma import masked_greater_equal, masked_less, masked_where

 # Repetitive calculations (to speed up calculations).
 eta_scale = 2.0**(-3.0/2.0)
@@ -125,6 +125,7 @@
     # Flag to tell if values should be replaced if max_etapos in cosh 
function is violated.
     t_dw_zero = False
     t_max_etapos = False
+    t_min_fact = False

     # Catch parameter values that will result in no exchange, returning 
flat R2eff = R20 lines (when kex = 0.0, k_AB = 0.0).
     # Test if pA or kex is zero.
@@ -182,13 +183,16 @@
     # The arccosh argument - catch invalid values.
     fact = Dpos * cosh(etapos) - Dneg * cos(etaneg)
     if min(fact) &lt; 1.0:
-        back_calc[:] = r20_kex
-        return
+        t_min_fact = True
+        mask_min_fact = masked_less(fact, 1.0)
+        # To prevent math errors, set fact to 1.
+        fact[mask_min_etapos.mask] = 1.0

     # Calculate R2eff.
     R2eff = r20_kex - cpmg_frqs * arccosh( fact )

     # Replace data in array.
+    # If dw is zero.
     if t_dw_zero:
         if isinstance(r20a, float):
             back_calc[:] = array([r20a]*num_points)
@@ -196,12 +200,21 @@
         else:
             R2eff[mask_dw_zero.mask] = r20a[mask_dw_zero.mask]

+    # If eta_pos above 700.
     if t_max_etapos:
         if isinstance(r20a, float):
             back_calc[:] = array([r20a]*num_points)
             return
         else:
             R2eff[mask_max_etapos.mask] = r20a[mask_max_etapos.mask]
+
+    # If fact &lt; 1.0
+    if t_min_fact:
+        if isinstance(r20a, float):
+            back_calc[:] = array([r20a]*num_points)
+            return
+        else:
+            R2eff[mask_min_fact.mask] = r20a[mask_min_fact.mask]

     # Catch errors, taking a sum over array is the fastest way to check 
for
     # +/- inf (infinity) and nan (not a number).


_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-commits mailing list
relax-commits@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="https://mail.gna.org/listinfo/relax-commits">https://mail.gna.org/listinfo/relax-commits</a>
</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-devel mailing list
relax-devel@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="https://mail.gna.org/listinfo/relax-devel">https://mail.gna.org/listinfo/relax-devel</a>
</pre></blockquote></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00158" href="msg00158.html">Re: r23834 - /branches/disp_spin_speed/lib/dispersion/cr72.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00160" href="msg00160.html">Re: r23834 - /branches/disp_spin_speed/lib/dispersion/cr72.py</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer">You are on the <a href="http://gna.org">Gna!</a> mail server.</div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Wed Jun 11 15:20:12 2014</div>  
</body>
</html>
