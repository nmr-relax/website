<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: [task #7822] Implement user function to estimate R2eff and associated errors for exponential curve fitting. -->
<!--X-From-R13: "Sqjneq q'Ohiretar" &#60;rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Mon, 25 Aug 2014 09:33:20 +0200 -->
<!--X-Message-Id: CAED9pY89Y241v+dWvCup61pJF&#45;i3txAepy0h9kp&#45;161F=2Fiiw@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20140824&#45;155636.sv20529.53107@gna.org -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: [task #7822] Implement user function to estimate R2eff and associated errors for exponential curve fitting. -- August 25, 2014 - 09:33</title>
<link rel="stylesheet" type="text/css" href="/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="https://gna.org/images/gna.theme/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: [task #7822] Implement user function to estimate R2eff and associated errors for exponential curve fitting.</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00255" class="tabs">Index by Date</a> | <a href="threads.html#00255" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00254.html">Date Prev</a>] [<a href="msg00256.html">Date Next</a>] [<a href="msg00254.html">Thread Prev</a>] [<a href="msg00257.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;Troels E. Linnet&quot; &lt;NO-REPLY.INVALID-ADDRESS@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Mon, 25 Aug 2014 09:32:49 +0200</li>
<li class="menuitem">
<em>Cc</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:date:message-id:subject :from:to:cc:content-type; bh=6QoDBl45vcYNTKrystT/sHyDRTHV5NnU8tDplFX72II=; b=k8FoCQ6l9+aal6Q7+OYwhetUCfLaVXn8iQKmZ8f7HeYJxDQisDc9sY6UQusynERcSv qxbgp1RprkZjER7rH6LGLiMRDKVcrpiskfFkpBQVmH5ppr8mbmhQFcTVPbfBDxMjCzCt 4IWcQR4ta3KvQ8ZvCFc0Ppf9JUHCRopwaOAsbE+1Fou92TjDO9nuzklP2IibyUgG/PK6 exFevdTfofj2gp1x/34hq9WKn9tWwwmTDQpOCADkV/7klfbmqsNsdGOJpL5qSmdNVyUR QnZgonQi5XimKcbw5i7s2SxGR+4L9cHErJC7HkjZxHR2wd198Pte+zsgpWKLRLZ7a+XC pcRw==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;CAED9pY89Y241v+dWvCup61pJF-i3txAepy0h9kp-161F=2Fiiw@mail.gmail.com&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;<a href="msg00254.html">20140824-155636.sv20529.53107@gna.org</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on August 25, 2014 - 09:33:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi Troels,

We should probably discuss how you would like to implement this in
relax, prior to writing too much code.  That way we can develop the
code in the best direction from the start and save a -lot- of time.
The way I see it is that there are two separate parts to this task:

1)  Optimisation algorithm.

2)  Error estimation algorithm.

In this thread, I'll cover 1) and then write a second message about 2).

For the scipy.optimize.leastsq() function, the Levenberg-Marquardt
optimisation algorithm is being used.  See
<a  rel="nofollow" href="https://en.wikipedia.org/wiki/Levenberg%E2%80%93Marquardt_algorithm">https://en.wikipedia.org/wiki/Levenberg%E2%80%93Marquardt_algorithm</a>,
though this Wikipedia description is terrible at the moment and a
better reference would be the book Numerical Recipes in
C/Fortran/Pascal/etc.  This algorithm is also available in minfx
<a  rel="nofollow" href="http://home.gna.org/minfx/minfx.levenberg_marquardt-module.html">http://home.gna.org/minfx/minfx.levenberg_marquardt-module.html</a>.  For
the algorithm, gradients are required.  These are converted into a
special matrix known as the Jacobian.  You can see this as the Dfun
argument to the scipy.optimise.leastsq() function.  If you do not
supply Dfun, then the algorithm uses a much, much, much slower
technique - the numeric approximation of the gradient.  As from the
docs:

    Dfun : callable
        A function or method to compute the Jacobian of func with derivatives
        across the rows. If this is None, the Jacobian will be estimated.

So, if you derive the gradient equations and add these to the relax C
module, you will have a much greater speed up as estimating the
gradients will be the majority of the computation time for this
algorithm as you are currently using it.  These equations are
incredibly basic - just take the partial derivative of the exponential
equation with respect to each parameter.  The floating point value for
each parameter derivative is them packed into an array with the same
dimensions as the parameter vector.  This is the gradient.  As an
aside, the Hessian is similar but is second partial derivatives in a
matrix form, and using this together with the even faster Newton
algorithm is really the absolute ultimate solution (this powerful
algorithm should probably only need 2-3 steps of optimisation to solve
this simple problem).

The key part that is missing from minfx is the numerical gradient
approximation.  However deriving the gradient is usually such a basic
exercise, in this case it is ridiculously simple, that gives so much
more speed that I've never bothered with numerical approximations in
minfx.  I also did not derive or implement the gradient for the
exponential curve-fitting as the code was fast enough for my purposes.
To use gradient functions with minfx, there are the dchi2_func and
dfunc arguments which then constructs the Jacobian form for you that
the Dfun scipy argument expects.

Anyway, that was just the background to all of this.  How do you see
this being implemented in relax?  All of the optimisation is via minfx
(<a  rel="nofollow" href="https://gna.org/projects/minfx/">https://gna.org/projects/minfx/</a>), so maybe you should sign up to that
Gna! project as well.  Remember that minfx was just a normal relax
package that I separated into its own project, just like bmrblib
(<a  rel="nofollow" href="https://gna.org/projects/bmrblib/">https://gna.org/projects/bmrblib/</a>).

Regards,

Edward


On 24 August 2014 17:56, Troels E. Linnet
&lt;NO-REPLY.INVALID-ADDRESS@xxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">URL:
  &lt;<a  rel="nofollow" href="http://gna.org/task/?7822">http://gna.org/task/?7822</a>&gt;

                 Summary: Implement user function to estimate R2eff and
associated errors for exponential curve fitting.
                 Project: relax
            Submitted by: tlinnet
            Submitted on: Sun 24 Aug 2014 03:56:36 PM UTC
         Should Start On: Sun 24 Aug 2014 12:00:00 AM UTC
   Should be Finished on: Sun 24 Aug 2014 12:00:00 AM UTC
                Category: relax's source code
                Priority: 5 - Normal
                  Status: In Progress
        Percent Complete: 0%
             Assigned to: tlinnet
             Open/Closed: Open
         Discussion Lock: Any
                  Effort: 0.00

    _______________________________________________________

Details:

A verification script, showed that using scipy.optimize.leastsq reaches the
exact same parameters as minfx for exponential curve fitting.

The verification script is in:
test_suite/shared_data/curve_fitting/profiling/profiling_relax_fit.py
test_suite/shared_data/curve_fitting/profiling/verify_error.py

The profiling script shows that a 10 X increase in speed can be reached by
removing
the linear constraints when using minfx.

The profiling also shows that scipy.optimize.leastsq is 10X as fast as using
minfx, even without linear constraints.

scipy.optimize.leastsq is a wrapper around wrapper around MINPACK's lmdif 
and
lmder algorithms.

MINPACK is a FORTRAN90 library which solves systems of nonlinear equations, 
or
carries out the least squares minimization of the residual of a set of 
linear
or nonlinear equations.

 The verification script also shows, that a very heavy and time consuming
monte carlo simulation of 2000 steps, reaches the same errors as the errors
reported by scipy.optimize.leastsq.

The return from scipy.optimize.leastsq, gives the estimated co-variance.
Taking the square root of the co-variance corresponds with 2X error reported
by minfx after 2000 Monte-Carlo simulations.

This could be an extremely time saving step, when performing model fitting 
in
R1rho, where the errors of the R2eff values, are estimated by Monte-Carlo
simulations.

The following setup illustrates the problem.
This was analysed on a: MacBook Pro, 13-inch, Late 2011.
With no multi-core setup.

Script running is:
test_suite/shared_data/dispersion/Kjaergaard_et_al_2013/2_pre_run_r2eff.py

This script analyses just the R2eff values for 15 residues.
It estimates the errors of R2eff based on 2000 Monte Carlo simulations.
For each residues, there is 14 exponential graphs.

The script was broken after 35 simulations.
This was measured to 20 minutes.
So 500 simulations would take about 4.8 Hours.

The R2eff values and errors can by scipy.optimize.leastsq can instead be
calculated in: 15 residues * 0.02 seconds = 0.3 seconds.




    _______________________________________________________

Reply to this item at:

  &lt;<a  rel="nofollow" href="http://gna.org/task/?7822">http://gna.org/task/?7822</a>&gt;

_______________________________________________
  Message sent via/by Gna!
  <a  rel="nofollow" href="http://gna.org/">http://gna.org/</a>


_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-devel mailing list
relax-devel@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="https://mail.gna.org/listinfo/relax-devel">https://mail.gna.org/listinfo/relax-devel</a>
</pre></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00257" href="msg00257.html">Re: [task #7822] Implement user function to estimate R2eff and associated errors for exponential curve fitting.</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00254" href="msg00254.html">[task #7822] Implement user function to estimate R2eff and associated errors for exponential curve fitting.</a></strong>
<ul><li><em>From:</em> Troels E. Linnet</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer">You are on the <a href="http://gna.org">Gna!</a> mail server.</div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Mon Aug 25 10:20:17 2014</div>  
</body>
</html>
