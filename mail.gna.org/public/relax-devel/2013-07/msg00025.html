<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: numerical cpmg fit -->
<!--X-From-R13: "Sqjneq q'Ohiretar" <rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Fri, 12 Jul 2013 16:39:46 +0200 -->
<!--X-Message-Id: CAED9pY8cqOqAhYDFxVCK+Sm8rJ7=p8GFPwKTHwdzg2U8DZsd_w@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 35036407&#45;39A6&#45;4B59&#45;B529&#45;7074D5F10DBA@gmx.at -->
<!--X-Reference: CAED9pY_zKf+1kML6UNezswM1NQtvZh7n7Jdz_Ss1H5Kn2cj5kw@mail.gmail.com -->
<!--X-Reference: CAED9pY9HUHQ1X6zQpY8CmPR3NFoSXJwgeP02Nme1Y447&#45;6U9RQ@mail.gmail.com -->
<!--X-Reference: CAED9pY_cN9pSyBX2F+ji1gYHN7RkwY72PwE4_&#45;8dEVNU&#45;4R1jg@mail.gmail.com -->
<!--X-Reference: 390EF589&#45;7B7E&#45;466A&#45;BE67&#45;021D16E7E12B@gmx.at -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: numerical cpmg fit -- July 12, 2013 - 16:39</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: numerical cpmg fit</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00025" class="tabs">Index by Date</a> | <a href="threads.html#00025" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00024.html">Date Prev</a>] [<a href="msg00026.html">Date Next</a>] [<a href="msg00018.html">Thread Prev</a>] [<a href="msg00030.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: Paul Schanda &lt;paul.schanda@xxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Fri, 12 Jul 2013 16:39:16 +0200</li>
<li class="menuitem">
<em>Cc</em>: mathilde lescanne &lt;mathilde.lescanne@xxxxxxxxx&gt;,	&quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113;	h=mime-version:sender:in-reply-to:references:date	:x-google-sender-auth:message-id:subject:from:to:cc:content-type	:content-transfer-encoding;	bh=K9BGzoqezXOFvXJBZTqq2X1dvU4i5QZO3DqPgwemcLk=;	b=lbDc/y4b6HWHWPtpLNbbGhO07iOWlvsqmA4aPIDfzOfcu6QhK7yVKyCYChvAkHr3on	uhXgaoN3j8K/HcXQklZGBWPbLBu1p4Yjd8bksNDaTamiwrX9lF8I/aVb+HN6cQ5UVXbj	/voAbYo/FvTlwnL+LF2Z1IGnAkZdXqabGmerfSUD/yK+svIOvyhFMVi2Lbst258ETf1G	djIgeBijsWw6QgrBm54FWvpaXwFkKAFyyY66duCvNtTjIHfdM16vgePCTpKEB3EUkTOd	w9E5IhxKywlRqCduA36HpJmM5lHtEep/W0RXoQImEtNpGOAdnxqHOM2xNc5tRJUA6JGx	0kJA==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00025.html">CAED9pY8cqOqAhYDFxVCK+Sm8rJ7=p8GFPwKTHwdzg2U8DZsd_w@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;35036407-39A6-4B59-B529-7074D5F10DBA@xxxxxx&gt;	&lt;CAED9pY_zKf+1kML6UNezswM1NQtvZh7n7Jdz_Ss1H5Kn2cj5kw@xxxxxxxxxxxxxx&gt;	&lt;CAED9pY9HUHQ1X6zQpY8CmPR3NFoSXJwgeP02Nme1Y447-6U9RQ@xxxxxxxxxxxxxx&gt;	&lt;CAED9pY_cN9pSyBX2F+ji1gYHN7RkwY72PwE4_-8dEVNU-4R1jg@xxxxxxxxxxxxxx&gt;	&lt;390EF589-7B7E-466A-BE67-021D16E7E12B@xxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on July 12, 2013 - 16:39:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi Paul and Mathilde,

I have attached this file to the task report #7712
(<a  rel="nofollow" href="https://gna.org/task/?7712">https://gna.org/task/?7712</a>) as a permanent reference
(<a  rel="nofollow" href="https://gna.org/support/download.php?file_id=18263">https://gna.org/support/download.php?file_id=18263</a>).  For new files
it would be appreciated if they were attached to this same task with
comments rather than sent to the public mailing list, as this avoids
unnecessary strain on the open source infrastructure, and does not
require a Gna! login.  Cheers.

I have now added the parameter conversions in that file to the
func_ns_2site_star() function of the target_functions/relax_disp.py
file, instead of in the r2eff_ns_2site_star() function of
lib/dispersion/ns_2site_star.py.  This is to minimise the mathematical
operations for faster code.  You can see it in revision r20284.  I may
do this for kex, IGeq, IEeq and M0 as well once the code is
functional.  This will cause large speed ups if large clusters of
spins are used or data at many magnetic field strengths are collected.

I still have two problems - the 'fg' and 'tcpmg' parameters.  Could
you explain these?  I'm pretty sure I know what they are, but it would
be good to confirm.  Another thing that would be nice to add to the
code in lib/dispersion/ns_2site_star.py would be a short description
of the matrices and what the operations are.  I.e. a simple comment
for what each data structure is.

I have seen that the mpower() function is in this file, so I'll just
copy that directly somewhere into the relax library.

Regards,

Edward



On 12 July 2013 12:09, Paul Schanda &lt;paul.schanda@xxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Edward,

I understand your point of fitting pA and kex instead of keg and kge (or
kAB/kBA).
Please find attached a program with the convention of kex and pB. The states
A and B are called G and E (ground/excited), so the parameters are generally
associated with E and G instead of A and B.



You will find in the attached program six different implementations, that
can be chosen with the variable a set to 1-6.
In practice, however, we are using only the &quot;2D complex&quot; numerical approach
(a=6), or the Maple-derived approach (a=5). The latter is faster, and is
most-often used. It has not been published, though.
The numerical Bloch-McConnell treatment is described in many introductory
NMR  books, and also in e.g.
McConnell, H. J Chem Phys 1958, 28, 430–431. (the original reference)
Palmer, A. G. Chem Rev 2004, 104, 3623–3640.
Palmer, A. G.; Massi, F. Chem Rev 2006, 106, 1700–1719.
Baldwin, A. J.; Kay, L. E. J Biomol NMR 2013.
The latter two are R1rho, but the formalism of Bloch-McConnell is the same.

Paul



Hi Paul,

I have now implemented step 2 of the tutorial for adding relaxation
dispersion models
(<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.devel/3907">http://article.gmane.org/gmane.science.nmr.relax.devel/3907</a>, in the
commit r20277 at
<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.scm/18033">http://article.gmane.org/gmane.science.nmr.relax.scm/18033</a>).  This is
one aspect that the relax user sees.  I have assumed that 'dw' is a
parameter of this model - i.e. the Delta_omega chemical shift
difference between states A and B.  But I am not sure if this is used
in your code and if it relates to the fg parameter.  Would you know
the relationship?

Cheers,

Edward


On 11 July 2013 18:23, Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt; wrote:

Hello,

Another question I have is what are the parameters of this model?  It
relates to the function arguments currently labelled as unknown in the
function docstring.  I would like to implement step 2 of the tutorial
on adding relaxation dispersion models to relax (the
relax_disp.select_model user function front end, see
<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.devel/3907">http://article.gmane.org/gmane.science.nmr.relax.devel/3907</a>), but I'm
not sure how to list the parameters of the model for the user.  Is
there a population parameter (pA or pB)?  Are R2E and R2G the same as
the R20A and R20B rates (the R2 rates in the absence of exchange for
states A and B for a fixed magnetic field strength)?

Cheers,

Edward


On 11 July 2013 16:14, Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt; wrote:

Hi Paul,

I have now incorporated this code into relax (see
<a  rel="nofollow" href="http://article.gmane.org/gmane.science.nmr.relax.scm/18025">http://article.gmane.org/gmane.science.nmr.relax.scm/18025</a>).  Could
you please check the code, comments, and docstrings carefully and see
if there are any issues?  Could you also tell me if anyone else should
be included in the copyright notice?  It would be useful to replace
the 'Unknown' elements in the function docstring with basic
descriptions of the parameter and its Python object type.  And any
suggestions for comments describing in basic NMR terms what the code
is doing (the physics of the propagations, for example) would also be
appreciated.

You can get the new code by typing the following in the base directory
of the checked out copy of the relax_disp branch:

$ svn up

There was an indentation problem that I have tried to solve.  Also I
cannot determine where the mpower() function comes from - it appears
not to be part of numpy or scipy.  Is this an outside function you
wrote?  I have also made a number of significant speed ups of the code
(see article.gmane.org/gmane.science.nmr.relax.scm/18029).  Note that
this cannot be selected as a model in the dispersion analysis yet.

Cheers,

Edward




On 11 July 2013 13:47, Paul Schanda &lt;paul.schanda@xxxxxx&gt; wrote:


Hi Edward,

Here is a function that does a numerical fit of CPMG. It uses an explicit
matrix that contains relaxation, exchange and chemical shift terms. It does
the 180deg pulses in the CPMG train with conjugate complex matrices.
It returns calculated R2eff values, so it can be used for numerical fitting
of CPMG.
It is an addition to the functions that I previously sent to you.
The approach of Bloch-McConnell can be found in chapter 3.1 of Palmer, A. G.
Chem Rev 2004, 104, 3623–3640.
I wrote this function (initially in MATLAB) in 2010.
I agree that this code is released under the GPL3 or higher licence.

Paul


def func1(R2E,R2G,fg,kge,keg, cpmgfreq,tcpmg):
       kex=kge+keg
       Rcalc_array=np.zeros(len(cpmgfreq))
       Rr  = -1.*np.matrix([[R2G, 0.],[0., R2E]])
       Rex = -1.*np.matrix([[kge,-keg],[-kge, keg]])
       RCS = complex(0.,-1.)*np.matrix([[0. ,0.],[0.,fg]])
       R = Rr + Rex + RCS
       cR = np.conj(R)


       IGeq=keg/kex; IEeq=kge/kex
       M0=np.matrix([[IGeq],[IEeq]])

       for k in range(len(cpmgfreq)):
               tcp=1./(4.*cpmgfreq[k])
               prop_2
=np.dot(np.dot(sci.expm(R*tcp),sci.expm(cR*2.*tcp)),sci.expm(R*tcp))
       prop_total =mpower(prop_2,cpmgfreq[k]*tcpmg)

       Moft = prop_total*M0

               Mgx=Moft[0].real/M0[0]
               Rcalc=-(1./tcpmg)*math.log(Mgx);
               Rcalc_array[k]=Rcalc
       return Rcalc_array




_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-devel mailing list
relax-devel@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="https://mail.gna.org/listinfo/relax-devel">https://mail.gna.org/listinfo/relax-devel</a>




</pre></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00030" href="msg00030.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Paul Schanda</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00010" href="msg00010.html">numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Paul Schanda</li></ul></li>
<li><strong><a name="00011" href="msg00011.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00012" href="msg00012.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00017" href="msg00017.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00018" href="msg00018.html">Re: numerical cpmg fit</a></strong>
<ul><li><em>From:</em> Paul Schanda</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Sun Jul 14 08:20:14 2013</div>  
</body>
</html>
