<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: r25411 &#45; in /trunk: specific_analyses/relax_disp/ test_suite/system_tests/ user_functions/ -->
<!--X-From-R13: Febryf Szgrxæe Zvaarg &#60;gyvaargNaze&#45;erynk.pbz> -->
<!--X-Date: Fri, 29 Aug 2014 15:20:19 +0200 -->
<!--X-Message-Id: CA+CBx2PNhbL8j5v5XXYLvWyA8wrNirqx4G01MVUjKTAnuBh_Pg@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: E1XN5bF&#45;0000Sw&#45;Me@subversion.gna.org -->
<!--X-Reference: CAED9pY8QfVfKjPAMRMhUtuHLyLFFOE8Xo8oG1Ya0mXipdAEPHg@mail.gmail.com -->
<!--X-Reference: CA+CBx2NnVQucBXxpmqfuK4cuzZz6vr9wZGKR5aisq_L81MK4zQ@mail.gmail.com -->
<!--X-Reference: CAED9pY8oXErFgnj5EkYVES7ZEbFjcnSgVF8h&#45;hxuE&#45;bskyT+gQ@mail.gmail.com -->
<!--X-Reference: CA+CBx2Or6U5TXo0kb_&#45;REarK_wz58Hw+_G7YkBPaqHv8tRvwsg@mail.gmail.com -->
<!--X-Reference: CA+CBx2Ok1_sjquM_=hgGs2ev_1C1LjsWDyAmoirLjDRLLNAErQ@mail.gmail.com -->
<!--X-Reference: CAED9pY8sO3HhEHiUSD1YpMvAgkg+fuVKdpVjks7nNWtSFFVJ3A@mail.gmail.com -->
<!--X-Reference: CA+CBx2MQx0FUdoRy0p8p&#45;7+ME44Tsa0MojHRikq_d9GmpzvZzA@mail.gmail.com -->
<!--X-Reference: CAED9pY8r7DTFV5xDJpsexWJrg=aD5fMzY6&#45;9cTJfsZk&#45;tUwj6Q@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: r25411 - in /trunk: specific_analyses/relax_disp/ test_suite/system_tests/ user_functions/ -- August 29, 2014 - 15:20</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: r25411 - in /trunk: specific_analyses/relax_disp/ test_suite/system_tests/ user_functions/</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00373" class="tabs">Index by Date</a> | <a href="threads.html#00373" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00372.html">Date Prev</a>] [<a href="msg00374.html">Date Next</a>] [<a href="msg00372.html">Thread Prev</a>] [<a href="msg00366.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;Edward d'Auvergne&quot; &lt;edward@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Fri, 29 Aug 2014 15:19:24 +0200</li>
<li class="menuitem">
<em>Cc</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:from:date:message-id :subject:to:cc:content-type:content-transfer-encoding; bh=BWRL9wp5nZh8RmuCmeH9V10jjQnmhIRwkJz9uq6CAzE=; b=zfwSnE6mvQjtqUDfzyrcZv6YyGx9qv5D2d1eAN5MZkH2Xmnft7xm215C8FgTYcp3St l2Dj/m4mWFPXCgCsl7BfsVx8wJfRaCSBcEQci9CK4uPKvUPdDxBTlX87OkeJptaBw42C JJ0UOOUl8rudnu1sITgGhRxNa/1DtrCaEz/k241g5lPXHIgjkVvA50dPEcI2rs5SfRJy EyxFdFWNI5ciFyRQQtNYz1Y8+eSqZ5zIlEc1+gc4zjNye8H/3okysVetXDZDi6u6b8A4 G3hBqmSmRYGF39aPEjsS+VL01BG0nnu3yeCMM/MeLOJA5mU7f0MAp+jlFdhcjS2dRqAr p2tg==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00373.html">CA+CBx2PNhbL8j5v5XXYLvWyA8wrNirqx4G01MVUjKTAnuBh_Pg@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;E1XN5bF-0000Sw-Me@subversion.gna.org&gt; &lt;<a href="msg00360.html">CAED9pY8QfVfKjPAMRMhUtuHLyLFFOE8Xo8oG1Ya0mXipdAEPHg@mail.gmail.com</a>&gt; &lt;<a href="msg00361.html">CA+CBx2NnVQucBXxpmqfuK4cuzZz6vr9wZGKR5aisq_L81MK4zQ@mail.gmail.com</a>&gt; &lt;<a href="msg00363.html">CAED9pY8oXErFgnj5EkYVES7ZEbFjcnSgVF8h-hxuE-bskyT+gQ@mail.gmail.com</a>&gt; &lt;<a href="msg00365.html">CA+CBx2Or6U5TXo0kb_-REarK_wz58Hw+_G7YkBPaqHv8tRvwsg@mail.gmail.com</a>&gt; &lt;CA+CBx2Ok1_sjquM_=hgGs2ev_1C1LjsWDyAmoirLjDRLLNAErQ@mail.gmail.com&gt; &lt;<a href="msg00369.html">CAED9pY8sO3HhEHiUSD1YpMvAgkg+fuVKdpVjks7nNWtSFFVJ3A@mail.gmail.com</a>&gt; &lt;<a href="msg00370.html">CA+CBx2MQx0FUdoRy0p8p-7+ME44Tsa0MojHRikq_d9GmpzvZzA@mail.gmail.com</a>&gt; &lt;CAED9pY8r7DTFV5xDJpsexWJrg=aD5fMzY6-9cTJfsZk-tUwj6Q@mail.gmail.com&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Troels Emtekær Linnet</strong> on August 29, 2014 - 15:20:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Yes.

They are equal.

This is fixed.


2014-08-29 14:41 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,

Is this fixed?  How does this compare now?

Cheers,

Edward



On 29 August 2014 12:19, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt; 
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Ugh.

This must be a weighting issue.

I will fix it.

Best
Troels

2014-08-29 12:08 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">I also don't understand the printout from this system test:

&quot;&quot;&quot;
Fitting with minfx to: 52V @N
-----------------------------

min_algor='Newton', c_code=True, constraints=False, chi2_jacobian?=False
------------------------------------------------------------------------

R1rho at 799.8 MHz, for offset=118.078 ppm and dispersion point 431.0,
with 4 time points. r2eff=8.646 r2eff_err=37.6189, i0=202664.2,
i0_err=912343.8776, chi2=3.758.
R1rho at 799.8 MHz, for offset=118.078 ppm and dispersion point 651.2,
with 5 time points. r2eff=10.377 r2eff_err=17.2901, i0=206049.6,
i0_err=145291.5784, chi2=27.291.
R1rho at 799.8 MHz, for offset=118.078 ppm and dispersion point 800.5,
with 5 time points. r2eff=10.506 r2eff_err=25.6159, i0=202586.3,
i0_err=563484.3693, chi2=13.357.
R1rho at 799.8 MHz, for offset=118.078 ppm and dispersion point 984.0,
with 5 time points. r2eff=10.903 r2eff_err=16.0355, i0=203455.0,
i0_err=157857.4220, chi2=33.632.
R1rho at 799.8 MHz, for offset=118.078 ppm and dispersion point
1341.1, with 5 time points. r2eff=10.684 r2eff_err=16.1640,
i0=218670.4, i0_err=143374.0758, chi2=35.818.
R1rho at 799.8 MHz, for offset=118.078 ppm and dispersion point
1648.5, with 5 time points. r2eff=10.501 r2eff_err=32.8259,
i0=206502.5, i0_err=267820.8718, chi2=7.356.
R1rho at 799.8 MHz, for offset=124.247 ppm and dispersion point
1341.1, with 5 time points. r2eff=11.118 r2eff_err=22.9196,
i0=216447.2, i0_err=202909.6970, chi2=15.587.
R1rho at 799.8 MHz, for offset=130.416 ppm and dispersion point 800.5,
with 5 time points. r2eff=7.866 r2eff_err=21.4617, i0=211869.7,
i0_err=215319.4005, chi2=14.585.
R1rho at 799.8 MHz, for offset=130.416 ppm and dispersion point
1341.1, with 5 time points. r2eff=9.259 r2eff_err=7.7769, i0=217703.2,
i0_err=65512.4065, chi2=79.498.
R1rho at 799.8 MHz, for offset=130.416 ppm and dispersion point
1648.5, with 5 time points. r2eff=9.565 r2eff_err=145.3091,
i0=211988.9, i0_err=1935377.4765, chi2=0.447.
R1rho at 799.8 MHz, for offset=142.754 ppm and dispersion point 800.5,
with 5 time points. r2eff=3.240 r2eff_err=36.8835, i0=214417.4,
i0_err=479401.1539, chi2=1.681.
R1rho at 799.8 MHz, for offset=142.754 ppm and dispersion point
1341.1, with 5 time points. r2eff=5.084 r2eff_err=9.1163, i0=226358.7,
i0_err=96611.2513, chi2=23.170.
R1rho at 799.8 MHz, for offset=179.768 ppm and dispersion point
1341.1, with 5 time points. r2eff=2.208 r2eff_err=6.1992, i0=228620.6,
i0_err=163754.5521, chi2=7.794.
R1rho at 799.8 MHz, for offset=241.459 ppm and dispersion point
1341.1, with 5 time points. r2eff=1.711 r2eff_err=7.0183, i0=224087.5,
i0_err=124876.2539, chi2=21.230.


Fitting with minfx to: 52V @N
-----------------------------

min_algor='BFGS', c_code=False, constraints=False, chi2_jacobian?=True
----------------------------------------------------------------------

R1rho at 799.8 MHz, for offset=118.078 ppm and dispersion point 431.0,
with 4 time points. r2eff=8.646 r2eff_err=0.0524, i0=202664.2,
i0_err=1239.0827, chi2=3.758.
R1rho at 799.8 MHz, for offset=118.078 ppm and dispersion point 651.2,
with 5 time points. r2eff=10.377 r2eff_err=0.0228, i0=206049.6,
i0_err=178.1907, chi2=27.291.
R1rho at 799.8 MHz, for offset=118.078 ppm and dispersion point 800.5,
with 5 time points. r2eff=10.506 r2eff_err=0.0345, i0=202586.3,
i0_err=705.7630, chi2=13.357.
R1rho at 799.8 MHz, for offset=118.078 ppm and dispersion point 984.0,
with 5 time points. r2eff=10.903 r2eff_err=0.0206, i0=203455.0,
i0_err=186.0857, chi2=33.632.
R1rho at 799.8 MHz, for offset=118.078 ppm and dispersion point
1341.1, with 5 time points. r2eff=10.684 r2eff_err=0.0198,
i0=218670.4, i0_err=165.0420, chi2=35.818.
R1rho at 799.8 MHz, for offset=118.078 ppm and dispersion point
1648.5, with 5 time points. r2eff=10.501 r2eff_err=0.0407,
i0=206502.5, i0_err=321.3685, chi2=7.356.
R1rho at 799.8 MHz, for offset=124.247 ppm and dispersion point
1341.1, with 5 time points. r2eff=11.118 r2eff_err=0.0301,
i0=216447.2, i0_err=248.9394, chi2=15.587.
R1rho at 799.8 MHz, for offset=130.416 ppm and dispersion point 800.5,
with 5 time points. r2eff=7.866 r2eff_err=0.0280, i0=211869.7,
i0_err=259.8845, chi2=14.585.
R1rho at 799.8 MHz, for offset=130.416 ppm and dispersion point
1341.1, with 5 time points. r2eff=9.259 r2eff_err=0.0108, i0=217703.2,
i0_err=88.1514, chi2=79.498.
R1rho at 799.8 MHz, for offset=130.416 ppm and dispersion point
1648.5, with 5 time points. r2eff=9.565 r2eff_err=0.1630, i0=211988.9,
i0_err=2054.6615, chi2=0.447.
R1rho at 799.8 MHz, for offset=142.754 ppm and dispersion point 800.5,
with 5 time points. r2eff=3.240 r2eff_err=0.0485, i0=214417.4,
i0_err=611.7573, chi2=1.681.
R1rho at 799.8 MHz, for offset=142.754 ppm and dispersion point
1341.1, with 5 time points. r2eff=5.084 r2eff_err=0.0124, i0=226358.7,
i0_err=122.7341, chi2=23.170.
R1rho at 799.8 MHz, for offset=179.768 ppm and dispersion point
1341.1, with 5 time points. r2eff=2.208 r2eff_err=0.0086, i0=228620.6,
i0_err=219.4208, chi2=7.794.
R1rho at 799.8 MHz, for offset=241.459 ppm and dispersion point
1341.1, with 5 time points. r2eff=1.711 r2eff_err=0.0101, i0=224087.5,
i0_err=166.9081, chi2=21.230.
&quot;&quot;&quot;


Obviously the errors in the top one are too big.  But I don't know
what they should be.  The bottom one has &quot;chi2_jacobian?=True&quot;, so I
guess that this is activating your func_exp_chi2_grad() function.
However if you look at the code in the C module, you will see that it
is exactly the same as the func_exp_chi2_grad() function.  Therefore
they should return identical errors.  I'm quite confused as to why the
numbers are not identical in the top and bottom printouts!

Regards,

Edward



On 29 August 2014 11:59, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt; 
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">You may want to look here:

relax -s Relax_disp.test_estimate_r2eff_err_methods -d

2014-08-29 11:57 GMT+02:00 Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Edward.

There is something totally wrong with the C, Jacobian.
Errors are estimated to:

37.619 17.290 25.616 16.036 16.164 32.826 22.920 21.462 7.777 145.309
36.884 9.116 6.199 7.018 sum= 402.235

Which is much different to:
0.041 0.040 0.040 0.054 0.041 0.044 0.042 0.037 0.034 0.043 0.013
0.018 0.007 0.010 sum= 0.462

You can see how the error estimation develops in:
verify_estimate_r2eff_err_compare_mc

You will see, that just 50 monte carlo simulations is better than 
estimating.

Best
Troels


2014-08-29 11:51 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,

I saw the results from that 'hidden' system test and was wondering
what was happening?  The Jacobian of the chi-squared function should
remove the factor of 2, as it has a factor of minus two.  But it also
includes the difference between the measured and back-calculated peak
intensities divided by the variance as well.  So why does this
Jacobian, which is much closer to the 2000 MC simulations, not work?
I cannot understand this as it is totally illogical.  If your error
estimate is closer to the real thing, then you should get closer to
the real optimisation results.

Do you have a log file somewhere which contains the results from the
2000 MC simulations?  It might be worth creating a file which compares
this, or even more simulations, 100,000 for example, to the covariance
technique.  Once the error estimate technique is functional and
debugged, then we can work out why the models are optimisating
differently.  These two problems need to be separated and solved
independently, otherwise you can encounter the common yet fatal coding
problem of two opposing bugs partially cancelling out their effects.

Regards,

Edward

On 29 August 2014 11:01, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt; 
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Edward.

Would it be possible to have both?

The exponential Jacobian, and the chi2 Jacobian.

My tests last night showed something weird.

Using the chi2 Jacobian, the errors come closer to the ones reported
my MC calculations.
The direct jacobian would have double error on R2eff.

But when fitting for R1rho models, using the errors from the direct
jacobian, was much better in agreement with
MC error fitting.

The parameters from chi2 Jacobian, was worse.

See verify_r1rho_kjaergaard_missing_r1() in systemtest for comparison.

Look at the 'kex' parameter!

# Compare values.
if spin_id == ':52@N':
    if param == 'r1':
        if model == MODEL_NOREX:
            if r2eff_estimate == 'direct':
                self.assertAlmostEqual(value, 1.46138805)
            elif r2eff_estimate == 'MC2000':
                self.assertAlmostEqual(value, 1.46328102)
            elif r2eff_estimate == 'chi2':
                self.assertAlmostEqual(value, 1.43820629)
        elif model == MODEL_DPL94:
            if r2eff_estimate == 'direct':
                self.assertAlmostEqual(value, 1.44845742)
            elif r2eff_estimate == 'MC2000':
                self.assertAlmostEqual(value, 1.45019848)
            elif r2eff_estimate == 'chi2':
                self.assertAlmostEqual(value, 1.44666512)
        elif model == MODEL_TP02:
            if r2eff_estimate == 'direct':
                self.assertAlmostEqual(value, 1.54354392)
            elif r2eff_estimate == 'MC2000':
                self.assertAlmostEqual(value, 1.54352369)
            elif r2eff_estimate == 'chi2':
                self.assertAlmostEqual(value, 1.55964020)
        elif model == MODEL_TAP03:
            if r2eff_estimate == 'direct':
                self.assertAlmostEqual(value, 1.54356410)
            elif r2eff_estimate == 'MC2000':
                self.assertAlmostEqual(value, 1.54354367)
            elif r2eff_estimate == 'chi2':
                self.assertAlmostEqual(value, 1.55967157)
        elif model == MODEL_MP05:
            if r2eff_estimate == 'direct':
                self.assertAlmostEqual(value, 1.54356416)
            elif r2eff_estimate == 'MC2000':
                self.assertAlmostEqual(value, 1.54354372)
            elif r2eff_estimate == 'chi2':
                self.assertAlmostEqual(value, 1.55967163)
        elif model == MODEL_NS_R1RHO_2SITE:
            if r2eff_estimate == 'direct':
                self.assertAlmostEqual(value, 1.41359221, 5)
            elif r2eff_estimate == 'MC2000':
                self.assertAlmostEqual(value, 1.41321968, 5)
            elif r2eff_estimate == 'chi2':
                self.assertAlmostEqual(value, 1.36303129, 5)

    elif param == 'r2':
        if model == MODEL_NOREX:
            if r2eff_estimate == 'direct':
                self.assertAlmostEqual(value, 11.48392439)
            elif r2eff_estimate == 'MC2000':
                self.assertAlmostEqual(value, 11.48040934)
            elif r2eff_estimate == 'chi2':
                self.assertAlmostEqual(value, 11.47224488)
        elif model == MODEL_DPL94:
            if r2eff_estimate == 'direct':
                self.assertAlmostEqual(value, 10.15688372, 6)
            elif r2eff_estimate == 'MC2000':
                self.assertAlmostEqual(value, 10.16304887, 6)
            elif r2eff_estimate == 'chi2':
                self.assertAlmostEqual(value, 9.20037797, 6)
        elif model == MODEL_TP02:
            if r2eff_estimate == 'direct':
                self.assertAlmostEqual(value, 9.72654896, 6)
            elif r2eff_estimate == 'MC2000':
                self.assertAlmostEqual(value, 9.72772726, 6)
            elif r2eff_estimate == 'chi2':
                self.assertAlmostEqual(value, 9.53948340, 6)
        elif model == MODEL_TAP03:
            if r2eff_estimate == 'direct':
                self.assertAlmostEqual(value, 9.72641887, 6)
            elif r2eff_estimate == 'MC2000':
                self.assertAlmostEqual(value, 9.72759374, 6)
            elif r2eff_estimate == 'chi2':
                self.assertAlmostEqual(value, 9.53926913, 6)
        elif model == MODEL_MP05:
            if r2eff_estimate == 'direct':
                self.assertAlmostEqual(value, 9.72641723, 6)
            elif r2eff_estimate == 'MC2000':
                self.assertAlmostEqual(value, 9.72759220, 6)
            elif r2eff_estimate == 'chi2':
                self.assertAlmostEqual(value, 9.53926778, 6)
        elif model == MODEL_NS_R1RHO_2SITE:
            if r2eff_estimate == 'direct':
                self.assertAlmostEqual(value, 9.34531535, 5)
            elif r2eff_estimate == 'MC2000':
                self.assertAlmostEqual(value, 9.34602793, 5)
            elif r2eff_estimate == 'chi2':
                self.assertAlmostEqual(value, 9.17631409, 5)

# For all other parameters.
else:
# Get the value.
value = getattr(cur_spin, param)

# Print value.
print(&quot;%-10s %-6s %-6s %3.8f&quot; % (&quot;Parameter:&quot;, param, &quot;Value:&quot;, 
value))

# Compare values.
if spin_id == ':52@N':
if param == 'phi_ex':
    if model == MODEL_DPL94:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 0.07599563)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 0.07561937)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 0.12946061)

elif param == 'pA':
    if model == MODEL_TP02:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 0.88827040)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 0.88807487)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 0.87746233)
    elif model == MODEL_TAP03:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 0.88828922)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 0.88809318)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 0.87747558)
    elif model == MODEL_MP05:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 0.88828924)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 0.88809321)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 0.87747562)
    elif model == MODEL_NS_R1RHO_2SITE:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 0.94504369, 6)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 0.94496541, 6)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 0.92084707, 6)

elif param == 'dw':
    if model == MODEL_TP02:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 1.08875840, 6)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 1.08765638, 6)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 1.09753230, 6)
    elif model == MODEL_TAP03:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 1.08837238, 6)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 1.08726698, 6)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 1.09708821, 6)
    elif model == MODEL_MP05:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 1.08837241, 6)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 1.08726706, 6)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 1.09708832, 6)
    elif model == MODEL_NS_R1RHO_2SITE:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 1.56001812, 5)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 1.55833321, 5)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 1.36406712, 5)

elif param == 'kex':
    if model == MODEL_DPL94:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 4460.43711569, 2)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 4419.03917195, 2)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 6790.22736344, 2)
    elif model == MODEL_TP02:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 4921.28602757, 3)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 4904.70144883, 3)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 5146.20306591, 3)
    elif model == MODEL_TAP03:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 4926.42963491, 3)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 4909.86877150, 3)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 5152.51105814, 3)
    elif model == MODEL_MP05:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 4926.44236315, 3)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 4909.88110195, 3)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 5152.52097111, 3)
    elif model == MODEL_NS_R1RHO_2SITE:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 5628.66061488, 2)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 5610.20221435, 2)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 5643.34067090, 2)

elif param == 'chi2':
    if model == MODEL_NOREX:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 848.42016907, 5)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 3363.95829122, 5)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 5976.49946726, 5)
    elif model == MODEL_DPL94:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 179.47041241)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 710.24767560)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 612.72616697, 5)
    elif model == MODEL_TP02:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 29.33882530, 6)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 114.47142772, 6)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 250.50838162, 5)
    elif model == MODEL_TAP03:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 29.29050673, 6)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 114.27987534)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 250.04050719, 5)
    elif model == MODEL_MP05:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 29.29054301, 6)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 114.28002272)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 250.04077478, 5)
    elif model == MODEL_NS_R1RHO_2SITE:
        if r2eff_estimate == 'direct':
            self.assertAlmostEqual(value, 34.44010543, 6)
        elif r2eff_estimate == 'MC2000':
            self.assertAlmostEqual(value, 134.14368365)
        elif r2eff_estimate == 'chi2':
            self.assertAlmostEqual(value, 278.55121388, 5)

2014-08-29 9:49 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Troels,

I've now converted the target_functions.relax_fit.jacobian() function
to be the Jacobian of the chi-squared function rather than the
Jacobian of the exponential function.  This should match your
specific_analyses.relax_disp.estimate_r2eff.func_exp_chi2_grad()
function.  I mixed up the two because the Levenberg-Marquardt
algorithm in minfx requires the Jacobian of the exponential, and it's
been 8 years since I last derived and implemented a Jacobian.

Regards,

Edward



On 28 August 2014 21:43,  &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Author: tlinnet
Date: Thu Aug 28 21:43:13 2014
New Revision: 25411

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=25411&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=25411&amp;view=rev</a>
Log:
Reverted the logic, that the chi2 Jacobian should be used.

Instead, the direct Jacobian exponential is used instead.

When fitting with the estimated errors from the Direct Jacobian, 
the results are MUCH better, and comparable
to 2000 Monte-Carlo simulations.

task #7822(<a  rel="nofollow" href="https://web.archive.org/web/https://gna.org/task/index.php?7822">https://gna.org/task/index.php?7822</a>): Implement user 
function to estimate R2eff and associated errors for exponential 
curve fitting.

Modified:
    trunk/specific_analyses/relax_disp/estimate_r2eff.py
    trunk/test_suite/system_tests/relax_disp.py
    trunk/user_functions/relax_disp.py

Modified: trunk/specific_analyses/relax_disp/estimate_r2eff.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/trunk/specific_analyses/relax_disp/estimate_r2eff.py?rev=25411&amp;r1=25410&amp;r2=25411&amp;view=diff">http://svn.gna.org/viewcvs/relax/trunk/specific_analyses/relax_disp/estimate_r2eff.py?rev=25411&amp;r1=25410&amp;r2=25411&amp;view=diff</a>
==============================================================================
--- trunk/specific_analyses/relax_disp/estimate_r2eff.py        
(original)
+++ trunk/specific_analyses/relax_disp/estimate_r2eff.py        Thu 
Aug 28 21:43:13 2014
@@ -90,7 +90,7 @@
     return jacobian_matrix_exp_chi2


-def estimate_r2eff_err(chi2_jacobian=True, spin_id=None, 
epsrel=0.0, verbosity=1):
+def estimate_r2eff_err(chi2_jacobian=False, spin_id=None, 
epsrel=0.0, verbosity=1):
     &quot;&quot;&quot;This will estimate the R2eff and i0 errors from the 
covariance matrix Qxx.  Qxx is calculated from the Jacobian matrix 
and the optimised parameters.

     @keyword chi2_jacobian: If the Jacobian derived from the chi2 
function, should be used instead of the Jacobian from the 
exponential function.

Modified: trunk/test_suite/system_tests/relax_disp.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/trunk/test_suite/system_tests/relax_disp.py?rev=25411&amp;r1=25410&amp;r2=25411&amp;view=diff">http://svn.gna.org/viewcvs/relax/trunk/test_suite/system_tests/relax_disp.py?rev=25411&amp;r1=25410&amp;r2=25411&amp;view=diff</a>
==============================================================================
--- trunk/test_suite/system_tests/relax_disp.py (original)
+++ trunk/test_suite/system_tests/relax_disp.py Thu Aug 28 21:43:13 
2014
@@ -2744,13 +2744,13 @@
         self.interpreter.minimise.execute(min_algor='Newton', 
constraints=False, verbosity=1)

         # Estimate R2eff errors.
-        
self.interpreter.relax_disp.r2eff_err_estimate(chi2_jacobian=False)
+        
self.interpreter.relax_disp.r2eff_err_estimate(chi2_jacobian=True)

         # Run the analysis.
         relax_disp.Relax_disp(pipe_name=ds.pipe_name, 
pipe_bundle=ds.pipe_bundle, results_dir=result_dir_name, 
models=MODELS, grid_inc=GRID_INC, mc_sim_num=MC_NUM, modsel=MODSEL)

         # Verify the data.
-        self.verify_r1rho_kjaergaard_missing_r1(models=MODELS, 
result_dir_name=result_dir_name, r2eff_estimate='direct')
+        self.verify_r1rho_kjaergaard_missing_r1(models=MODELS, 
result_dir_name=result_dir_name, r2eff_estimate='chi2')


     def test_estimate_r2eff_err_auto(self):
@@ -2849,7 +2849,7 @@
         relax_disp.Relax_disp(pipe_name=pipe_name, 
pipe_bundle=pipe_bundle, results_dir=result_dir_name, 
models=MODELS, grid_inc=GRID_INC, mc_sim_num=MC_NUM, 
exp_mc_sim_num=EXP_MC_NUM, modsel=MODSEL, r1_fit=r1_fit)

         # Verify the data.
-        self.verify_r1rho_kjaergaard_missing_r1(models=MODELS, 
result_dir_name=result_dir_name, r2eff_estimate='chi2')
+        self.verify_r1rho_kjaergaard_missing_r1(models=MODELS, 
result_dir_name=result_dir_name, r2eff_estimate='direct')


     def test_estimate_r2eff_err_methods(self):

Modified: trunk/user_functions/relax_disp.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/trunk/user_functions/relax_disp.py?rev=25411&amp;r1=25410&amp;r2=25411&amp;view=diff">http://svn.gna.org/viewcvs/relax/trunk/user_functions/relax_disp.py?rev=25411&amp;r1=25410&amp;r2=25411&amp;view=diff</a>
==============================================================================
--- trunk/user_functions/relax_disp.py  (original)
+++ trunk/user_functions/relax_disp.py  Thu Aug 28 21:43:13 2014
@@ -636,7 +636,7 @@
 uf.title_short = &quot;Estimate R2eff errors.&quot;
 uf.add_keyarg(
     name = &quot;chi2_jacobian&quot;,
-    default = True,
+    default = False,
     py_type = &quot;bool&quot;,
     desc_short = &quot;use of chi2 Jacobian&quot;,
     desc = &quot;If the Jacobian derived from the chi2 function, should 
be used instead of the Jacobian from the exponential function.&quot;


_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-commits mailing list
relax-commits@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="https://mail.gna.org/listinfo/relax-commits">https://mail.gna.org/listinfo/relax-commits</a>
</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-devel mailing list
relax-devel@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="https://mail.gna.org/listinfo/relax-devel">https://mail.gna.org/listinfo/relax-devel</a>
</pre></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00360" href="msg00360.html">Re: r25411 - in /trunk: specific_analyses/relax_disp/ test_suite/system_tests/ user_functions/</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00361" href="msg00361.html">Re: r25411 - in /trunk: specific_analyses/relax_disp/ test_suite/system_tests/ user_functions/</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00363" href="msg00363.html">Re: r25411 - in /trunk: specific_analyses/relax_disp/ test_suite/system_tests/ user_functions/</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00365" href="msg00365.html">Re: r25411 - in /trunk: specific_analyses/relax_disp/ test_suite/system_tests/ user_functions/</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00367" href="msg00367.html">Re: r25411 - in /trunk: specific_analyses/relax_disp/ test_suite/system_tests/ user_functions/</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00369" href="msg00369.html">Re: r25411 - in /trunk: specific_analyses/relax_disp/ test_suite/system_tests/ user_functions/</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00370" href="msg00370.html">Re: r25411 - in /trunk: specific_analyses/relax_disp/ test_suite/system_tests/ user_functions/</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00372" href="msg00372.html">Re: r25411 - in /trunk: specific_analyses/relax_disp/ test_suite/system_tests/ user_functions/</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Fri Aug 29 15:40:16 2014</div>  
</body>
</html>
