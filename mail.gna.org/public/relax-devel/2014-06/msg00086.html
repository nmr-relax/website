<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: r23729 &#45; /branches/disp_spin_speed/target_functions/relax_disp.py -->
<!--X-From-R13: "Sqjneq q'Ohiretar" &#60;rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Tue, 10 Jun 2014 11:39:23 +0200 -->
<!--X-Message-Id: CAED9pY_Od=RzJJ35CyPfEvwmF79V9GSu1KFLh6ekninU51tt9A@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: E1Wtb3d&#45;0007qe&#45;Ai@subversion.gna.org -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: r23729 - /branches/disp_spin_speed/target_functions/relax_disp.py -- June 10, 2014 - 11:39</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: r23729 - /branches/disp_spin_speed/target_functions/relax_disp.py</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00086" class="tabs">Index by Date</a> | <a href="threads.html#00086" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00085.html">Date Prev</a>] [<a href="msg00087.html">Date Next</a>] [<a href="msg00085.html">Thread Prev</a>] [<a href="msg00089.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;, Andrew Baldwin &lt;andrew.baldwin@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Tue, 10 Jun 2014 11:38:52 +0200</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:date:message-id:subject :from:to:content-type; bh=rOwCQ/dvSvuV1xiZFj9YPDcmMW7ElykyFVELiBr0c4k=; b=xM6gREydZitKRqHrfNmpcoI9Djtk8+UmpSJETRX7yhQzGq1zCZXFS6j+UJXh+qj5O8 Q2Zt2NhisQcnDRWm83dJni99lMZCW9WjCPuypwtAKdtvCqPy4sSGKlsaC3f83K+4TfvG HatI/VK9lwjMKgHt+AX3AFdZwK45lJYIlyd/ooKoNIR9KXxrzPpoENefv4s7UBha6CzR k4+LUC6zwAmoXT4hGBhqJoQqrHYxPN1n35zXVzsUV8VWnC9vVvcNlTr3vP433jTfu7j3 133PvHA/Ghh0T7pur0z5Kr16t3yBBvVWpGX+me/C6qNapL6GO7beUcAlGdDjmLtHnWsW 7hlw==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;CAED9pY_Od=RzJJ35CyPfEvwmF79V9GSu1KFLh6ekninU51tt9A@mail.gmail.com&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;E1Wtb3d-0007qe-Ai@subversion.gna.org&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on June 10, 2014 - 11:39:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi Troels,

You should note that the offset loop is important to have in the
future.  When the handling of offsets in CPMG data is added to relax
(the first point in the TODO list of the dispersion chapter of the
manual 
<a  rel="nofollow" href="/manual/do_dispersion_features_yet_be_implemented.html">http://www.nmr-relax.com/manual/do_dispersion_features_yet_be_implemented.html</a>,
and as mentioned by Andy Baldwin as being very important), the offset
loop will be used.  Although rare, there will be users who centre
their heteronuclear hard pulses at different ppm values and hence have
CPMG data sets with different offsets.

Regards,

Edward



On 8 June 2014 13:14,  &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Author: tlinnet
Date: Sun Jun  8 13:14:36 2014
New Revision: 23729

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=23729&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=23729&amp;view=rev</a>
Log:
Removing looping over exp and offset indicies in calc_chi2. They are always 
0 anyway.

This brings a little speed.

Task #7807 (<a  rel="nofollow" href="https://web.archive.org/web/https://gna.org/task/index.php?7807">https://gna.org/task/index.php?7807</a>): Speed-up of dispersion 
models for Clustered analysis.

----
Profiling.

1000 iterations
100 spins
3 sfrq
('sfrq: ', 600000000.0, 'number of cpmg frq', 15, array([  2.,   6.,  10.,  
14.,  18.,  22.,  26.,  30.,  34.,  38.,  42.,
        46.,  50.,  54.,  58.]))
('sfrq: ', 800000000.0, 'number of cpmg frq', 20, array([  2.,   6.,  10.,  
14.,  18.,  22.,  26.,  30.,  34.,  38.,  42.,
        46.,  50.,  54.,  58.,  62.,  66.,  70.,  74.,  78.]))
('sfrq: ', 900000000.0, 'number of cpmg frq', 22, array([  2.,   6.,  10.,  
14.,  18.,  22.,  26.,  30.,  34.,  38.,  42.,
        46.,  50.,  54.,  58.,  62.,  66.,  70.,  74.,  78.,  82.,  86.]))
('chi2 cluster:', 0.0)

TRUNK
   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
     1000    5.221    0.005   53.578    0.054 
relax_disp.py:456(calc_CR72_chi2)

BEFORE
   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
     1000   14.871    0.015   43.084    0.043 
relax_disp.py:494(calc_CR72_chi2)

AFTER removing looping over exp and offset indicies. They are always 0.
   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
     1000   12.831    0.013   38.248    0.038 
relax_disp.py:494(calc_CR72_chi2)

Modified:
    branches/disp_spin_speed/target_functions/relax_disp.py

Modified: branches/disp_spin_speed/target_functions/relax_disp.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/disp_spin_speed/target_functions/relax_disp.py?rev=23729&amp;r1=23728&amp;r2=23729&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/disp_spin_speed/target_functions/relax_disp.py?rev=23729&amp;r1=23728&amp;r2=23729&amp;view=diff</a>
==============================================================================
--- branches/disp_spin_speed/target_functions/relax_disp.py     (original)
+++ branches/disp_spin_speed/target_functions/relax_disp.py     Sun Jun  8 
13:14:36 2014
@@ -508,33 +508,29 @@
         @rtype:         float
         &quot;&quot;&quot;

-        # Loop over the experiment types.
-        for ei in range(self.num_exp):
-            # Loop over the spins.
-            for si in range(self.num_spins):
-                # Loop over the spectrometer frequencies.
-                for mi in range(self.num_frq):
-                    # Loop over the offsets.
-                    for oi in range(self.num_offsets[ei][si][mi]):
-                        # Extract number of dispersion points.
-                        num_disp_points = 
self.num_disp_points[ei][si][mi][oi]
-
-                         # The R20 index.
-                        r20_index = mi + si*self.num_frq
-
-                        # Store r20a and r20b values per disp point.
-                        self.R20A_a[ei][si][mi][oi] = np.array( 
[R20A[r20_index]] * self.max_num_disp_points, float64)
-                        self.R20B_a[ei][si][mi][oi]  = np.array( 
[R20B[r20_index]] * self.max_num_disp_points, float64)
-
-                        # Convert dw from ppm to rad/s.
-                        dw_frq = dw[si] * self.frqs[ei][si][mi]
-
-                        # Store dw_frq per disp point.
-                        self.dw_frq_a[ei][si][mi][oi] = np.array( [dw_frq] 
* self.max_num_disp_points, float64)
-
-                        # Store pA and kex per disp point.
-                        self.pA_a[ei][si][mi][oi] = np.array( [pA] * 
self.max_num_disp_points, float64)
-                        self.kex_a[ei][si][mi][oi] = np.array( [kex] * 
self.max_num_disp_points, float64)
+        # Loop over the spins.
+        for si in range(self.num_spins):
+            # Loop over the spectrometer frequencies.
+            for mi in range(self.num_frq):
+                # Extract number of dispersion points.
+                num_disp_points = self.num_disp_points[0][si][mi][0]
+
+                 # The R20 index.
+                r20_index = mi + si*self.num_frq
+
+                # Store r20a and r20b values per disp point.
+                self.R20A_a[0][si][mi][0] = np.array( [R20A[r20_index]] * 
self.max_num_disp_points, float64)
+                self.R20B_a[0][si][mi][0]  = np.array( [R20B[r20_index]] * 
self.max_num_disp_points, float64)
+
+                # Convert dw from ppm to rad/s.
+                dw_frq = dw[si] * self.frqs[0][si][mi]
+
+                # Store dw_frq per disp point.
+                self.dw_frq_a[0][si][mi][0] = np.array( [dw_frq] * 
self.max_num_disp_points, float64)
+
+                # Store pA and kex per disp point.
+                self.pA_a[0][si][mi][0] = np.array( [pA] * 
self.max_num_disp_points, float64)
+                self.kex_a[0][si][mi][0] = np.array( [kex] * 
self.max_num_disp_points, float64)

         ## Back calculate the R2eff values.
         r2eff_CR72(r20a=self.R20A_a, r20b=self.R20B_a, pA=self.pA_a, 
dw=self.dw_frq_a, kex=self.kex_a, cpmg_frqs=self.cpmg_frqs_a, 
back_calc=self.back_calc_a, num_points=self.num_disp_points_a)
@@ -544,26 +540,22 @@

         # Now return the values back to the structure of self.back_calc 
object.
         ## For all missing data points, set the back-calculated value to 
the measured values so that it has no effect on the chi-squared value.
-        # Loop over the experiment types.
-        for ei in range(self.num_exp):
-            # Loop over the spins.
-            for si in range(self.num_spins):
-                # Loop over the spectrometer frequencies.
-                for mi in range(self.num_frq):
-                    # Loop over the offsets.
-                    for oi in range(self.num_offsets[ei][si][mi]):
-                        # Extract number of dispersion points.
-                        num_disp_points = 
self.num_disp_points[ei][si][mi][oi]
-
-                        self.back_calc[ei][si][mi][oi] = 
self.back_calc_a[ei][si][mi][oi][:num_disp_points]
-
-
-                        for di in 
range(self.num_disp_points[ei][si][mi][oi]):
-                            if self.missing[ei][si][mi][oi][di]:
-                                self.back_calc[ei][si][mi][oi][di] = 
self.values[ei][si][mi][oi][di]
-
-                        ## Calculate and return the chi-squared value.
-                        chi2_sum += chi2(self.values[ei][si][mi][oi], 
self.back_calc[ei][si][mi][oi], self.errors[ei][si][mi][oi])
+        # Loop over the spins.
+        for si in range(self.num_spins):
+            # Loop over the spectrometer frequencies.
+            for mi in range(self.num_frq):
+                # Extract number of dispersion points.
+                num_disp_points = self.num_disp_points[0][si][mi][0]
+
+                self.back_calc[0][si][mi][0] = 
self.back_calc_a[0][si][mi][0][:num_disp_points]
+
+
+                for di in range(self.num_disp_points[0][si][mi][0]):
+                    if self.missing[0][si][mi][0][di]:
+                        self.back_calc[0][si][mi][0][di] = 
self.values[0][si][mi][0][di]
+
+                ## Calculate and return the chi-squared value.
+                chi2_sum += chi2(self.values[0][si][mi][0], 
self.back_calc[0][si][mi][0], self.errors[0][si][mi][0])

         # Return the total chi-squared value.
         return chi2_sum


_______________________________________________
relax (<a  rel="nofollow" href="/">http://www.nmr-relax.com</a>)

This is the relax-commits mailing list
relax-commits@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="/mail.gna.org/listinfo/relax-commits">https://mail.gna.org/listinfo/relax-commits</a>
</pre></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00089" href="msg00089.html">Re: r23729 - /branches/disp_spin_speed/target_functions/relax_disp.py</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Tue Jun 10 15:00:11 2014</div>  
</body>
</html>
