<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: CST branch -->
<!--X-From-R13: Bniry Ynqrenirx <cniry.xnqrenirxNtznvy.pbz> -->
<!--X-Date: Wed, 27 Oct 2010 20:46:36 +0200 -->
<!--X-Message-Id: AANLkTikXiEtqtDWOycdJdyYSG+KfxAARiXhtDwrQm_v+@mail.gmail.com -->
<!--X-Content-Type: multipart/alternative -->
<!--X-Reference: p2l6052a51004080823g94a64268lf8af8d3e332c2a03@mail.gmail.com -->
<!--X-Reference: j2i7f080ed11004120000r80bba9bch9556be67b0c1707@mail.gmail.com -->
<!--X-Reference: g2v6052a51004131048sb5c01509sfc9a77045ad33310@mail.gmail.com -->
<!--X-Reference: r2g7f080ed11004131113mb209905eh63ff1eb61c171fee@mail.gmail.com -->
<!--X-Reference: l2q6052a51004301221h9ad09886ha016465129beb516@mail.gmail.com -->
<!--X-Reference: g2m7f080ed11005050153y2ad8b4bfjb4eb8191b0efd0cc@mail.gmail.com -->
<!--X-Reference: AANLkTin4nzkkOCxs94vUKCpT00R7ak22gLaL5rK&#45;VjPN@mail.gmail.com -->
<!--X-Reference: AANLkTinF4yNXoJQS&#45;rd81VBi3keRURUNeb&#45;_GdkxqqsG@mail.gmail.com -->
<!--X-Reference: AANLkTinibyBQvsoG1&#45;0vmzOXFmRJxD95VMF3eGxzSMMB@mail.gmail.com -->
<!--X-Reference: AANLkTimFT0&#45;Kbgdz_U5LeOW5Ln22mPBZBC8FL68n6CeF@mail.gmail.com -->
<!--X-Reference: AANLkTikhknBoHTc7B7GCRULkrEnxSx+PpqPP=x6KrDOH@mail.gmail.com -->
<!--X-Reference: AANLkTim0B&#45;E6kMW9Nn47o+u+atxrm38540u1Xhaoe6j0@mail.gmail.com -->
<!--X-Reference: AANLkTi=m5S08Nd1F5VDnMGTOu2s+j2Euz1t&#45;ytw0zOAf@mail.gmail.com -->
<!--X-Reference: AANLkTinxUWLu2N19dc3eaPgh22igv_SGy=6qmVnJN=Qj@mail.gmail.com -->
<!--X-Reference: AANLkTik0K3B7huKE8hJtAkXL_yzJmNa9BFxfczu8Sfx9@mail.gmail.com -->
<!--X-Reference: AANLkTin1JfUtMoVqR4c&#45;5dRHTf58N&#45;FAcv4_bc=LpH2b@mail.gmail.com -->
<!--X-Reference: AANLkTimBsSm504qysJd8&#45;e0O_thUdcwvciKrNhMTdoQW@mail.gmail.com -->
<!--X-Reference: AANLkTikf&#45;g23EPV+R2&#45;7inSpXbT5fqv5vDO8nL+DZrwA@mail.gmail.com -->
<!--X-Reference: AANLkTikNh5FTMmeQPqkSiX8ieG5oUw5UcuG83k8PeAiM@mail.gmail.com -->
<!--X-Reference: AANLkTimADCpNAJG4Pg02_UukH5hFW5eQfr&#45;SymzqXrc=@mail.gmail.com -->
<!--X-Reference: AANLkTi=8_288HiMhVQDwpFUCqMp+aBotECez44s44q7z@mail.gmail.com -->
<!--X-Reference: AANLkTi=vSTA2B&#45;jpTzShJab84W=&#45;z1YBzvhW10wTXg_P@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: CST branch -- October 27, 2010 - 20:46</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: CST branch</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00016" class="tabs">Index by Date</a> | <a href="threads.html#00016" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00015.html">Date Prev</a>] [<a href="msg00017.html">Date Next</a>] [<a href="msg00015.html">Thread Prev</a>] [<a href="msg00008.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;Edward d'Auvergne&quot; &lt;edward@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Wed, 27 Oct 2010 20:45:59 +0200</li>
<li class="menuitem">
<em>Cc</em>: relax-devel@xxxxxxx</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00016.html">AANLkTikXiEtqtDWOycdJdyYSG+KfxAARiXhtDwrQm_v+@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;p2l6052a51004080823g94a64268lf8af8d3e332c2a03@xxxxxxxxxxxxxx&gt;	&lt;j2i7f080ed11004120000r80bba9bch9556be67b0c1707@xxxxxxxxxxxxxx&gt;	&lt;g2v6052a51004131048sb5c01509sfc9a77045ad33310@xxxxxxxxxxxxxx&gt;	&lt;r2g7f080ed11004131113mb209905eh63ff1eb61c171fee@xxxxxxxxxxxxxx&gt;	&lt;l2q6052a51004301221h9ad09886ha016465129beb516@xxxxxxxxxxxxxx&gt;	&lt;g2m7f080ed11005050153y2ad8b4bfjb4eb8191b0efd0cc@xxxxxxxxxxxxxx&gt;	&lt;AANLkTin4nzkkOCxs94vUKCpT00R7ak22gLaL5rK-VjPN@xxxxxxxxxxxxxx&gt;	&lt;AANLkTinF4yNXoJQS-rd81VBi3keRURUNeb-_GdkxqqsG@xxxxxxxxxxxxxx&gt;	&lt;AANLkTinibyBQvsoG1-0vmzOXFmRJxD95VMF3eGxzSMMB@xxxxxxxxxxxxxx&gt;	&lt;AANLkTimFT0-Kbgdz_U5LeOW5Ln22mPBZBC8FL68n6CeF@xxxxxxxxxxxxxx&gt;	&lt;AANLkTikhknBoHTc7B7GCRULkrEnxSx+PpqPP=x6KrDOH@xxxxxxxxxxxxxx&gt;	&lt;AANLkTim0B-E6kMW9Nn47o+u+atxrm38540u1Xhaoe6j0@xxxxxxxxxxxxxx&gt;	&lt;AANLkTi=m5S08Nd1F5VDnMGTOu2s+j2Euz1t-ytw0zOAf@xxxxxxxxxxxxxx&gt;	&lt;AANLkTinxUWLu2N19dc3eaPgh22igv_SGy=6qmVnJN=Qj@xxxxxxxxxxxxxx&gt;	&lt;AANLkTik0K3B7huKE8hJtAkXL_yzJmNa9BFxfczu8Sfx9@xxxxxxxxxxxxxx&gt;	&lt;AANLkTin1JfUtMoVqR4c-5dRHTf58N-FAcv4_bc=LpH2b@xxxxxxxxxxxxxx&gt;	&lt;AANLkTimBsSm504qysJd8-e0O_thUdcwvciKrNhMTdoQW@xxxxxxxxxxxxxx&gt;	&lt;AANLkTikf-g23EPV+R2-7inSpXbT5fqv5vDO8nL+DZrwA@xxxxxxxxxxxxxx&gt;	&lt;AANLkTikNh5FTMmeQPqkSiX8ieG5oUw5UcuG83k8PeAiM@xxxxxxxxxxxxxx&gt;	&lt;AANLkTimADCpNAJG4Pg02_UukH5hFW5eQfr-SymzqXrc=@xxxxxxxxxxxxxx&gt;	&lt;AANLkTi=8_288HiMhVQDwpFUCqMp+aBotECez44s44q7z@xxxxxxxxxxxxxx&gt;	&lt;AANLkTi=vSTA2B-jpTzShJab84W=-z1YBzvhW10wTXg_P@xxxxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Pavel Kaderavek</strong> on October 27, 2010 - 20:46:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
Hi,<br>sorry for a late response. Your suggestions seem reasonable. I would add just a two comments.<br>1) We should keep as before not only ri_prime but probably also chi2, dchi2 and d2chi2 as well.<br>.<br>
2)The consideration of Rex as an additional interaction is a one of the
suitable approaches and it fits the general idea. We have to consider
that it requires to add new interaction into the list of the
interactions ( __init__ function in class Mf, file maths_fns/mf.py). <br>
It might be done just within the __init__ function (class Mf, file
maths_fns/mf.py). It will be based on the presence of Rex term within the loaded
variable param_types. The other possibility is to do it before calling this __init__ function (number of interactions is one of its arguments). <br><br>Then
I address to discussion one additional problem related to the patch in
the preparation. Within the  functions related to the derivations:
dfunc_mf, dfunc_local_tm, dfunc_all, dfunc_diff (class Mf,
maths_fns/mf.py) there is a small complication. It will be illustrated using  &quot;dfunc_mf&quot; function as an example. The original code is
following:<br><br>
        data = ""><br>        # Calculate the spectral density gradient components.<br>        if data.calc_djw_comps:<br>            data.calc_djw_comps(data, params)<br><br>        # Diffusion tensor correlation times.<br>

        self.diff_data.calc_dti(data, self.diff_data)<br><br>        # Loop over the gradient.<br>        for j in xrange(data.total_num_params):<br>            # Calculate the spectral density gradients.<br>            if data.calc_djw[j]:<br>

                data.djw = data.calc_djw[j](data, params, j)<br>            else:<br>                data.djw = data.djw * 0.0<br><br>            # Calculate the relaxation gradient components.<br>            data.create_dri_comps(data, params)<br>

<br>            # Calculate the R1, R2, and sigma_noe gradients.<br>            data.dri_prime[j] = data.create_dri_prime[j](data)<br><br>            # Loop over the relaxation values and modify the NOE gradients.<br>            data.dri[j] = data.dri_prime[j]<br>

            for m in xrange(data.num_ri):<br>                if data.create_dri[m]:<br>                    data.create_dri[m](data, m, data.remap_table[m], data.get_dr1, params, j)<br><br>            # Calculate the chi-squared gradient.<br>

            data.dchi2[j] = dchi2_element(data.relax_data, data.ri, data.dri[j], data.errors)<br><br>If  the loop over interactions is incorporated, it is necessary to do it before
&quot;data.calc_djw_comps&quot; is calculated. However then we get into the
conflict with calculation of &quot;modification of NOE gradients&quot; and also
calculation of &quot;dchi2&quot;. These quantities can be calculated only when
contributions from all interactions has been already evaluated (it is similar to already discussed ri_prime). In this case it is complicated by the presence of loop over fitted
parameters. The possible solution would be to make the loop over the
interactions the inner one. However this seems to require repeating the loop over
interactions twice within the code:<br>
<br>        data = ""><br>        # Loop over the interactions<br>        for k in xrange(self.num_interactions[0]):<br><div id=":1dt">            # Calculate the spectral density gradient components.<br>
            if data[k].calc_djw_comps:<br>
                data[k].calc_djw_comps(data[k], params)<br>
<br>
            # Diffusion tensor correlation times.<br>
            self.diff_data.calc_dti(data[k], self.diff_data)<br>
<br>
        # Loop over the gradient.<br>
        for j in xrange(data.total_num_params):<br>            # Loop over the interactions<br>            for k in xrange(self.num_interactions[0])<br>
                # Calculate the spectral density gradients.<br>
                if data[k].calc_djw[j]:<br>
                    data[k].djw = data[k].calc_djw[j](data[k], params, j)<br>
                else:<br>
                    data[k].djw = data[k].djw * 0.0<br>
<br>
                    # Calculate the relaxation gradient components.<br>
                    data[k].create_dri_comps(data[k], params)<br>
<br>
                # Calculate the R1, R2, and sigma_noe gradients.<br>
                data[k].dri_prime[j] = data[k].create_dri_prime[j](data[k])                              # later data[k].dri_prime[j] will be replaced by data.dri_prime[j]<br> 
                                                                       
                                                     # but you suggest not to include both changes into the following patch together<br>

<br><br>
            # Loop over the relaxation values and modify the NOE gradients.<br>
            data.dri[j] = data.dri_prime[j]<br>
            for m in xrange(data.num_ri):<br>
                if data.create_dri[m]:<br>
                    data.create_dri[m](data, m, data.remap_table[m], data.get_dr1, params, j)<br>
<br>
                # Calculate the chi-squared gradient.<br>
                data.dchi2[j] = dchi2_element(data.relax_data, data.ri, data.dri[j], data.errors)<br><br>Additionally I would notify that variable &quot;total_num_params&quot; needs to
be kept at the position self.data[0] (similar to your suggestion in
your last
mail, concerning ri_prime)<br>What do you think about this?<br>Regards<br><font color="#888888">Pavel</font></div><br><br><div class="gmail_quote">On 22 October 2010 19:46, Edward d&#39;Auvergne <span dir="ltr">&lt;<a rel="nofollow" href="mailto:edward@xxxxxxxxxxxxx">edward@xxxxxxxxxxxxx</a>&gt;</span> wrote:<br>
<blockquote class="gmail_quote" style="border-left: 1px solid rgb(204, 204, 204); margin: 0pt 0pt 0pt 0.8ex; padding-left: 1ex;">Hi,<br>
<br>
This is a good idea.  First I would suggest putting this into 2<br>
patches, as this is easier to check and apply.  Don&#39;t worry about<br>
breaking the code at this point - it is in your own special branch so<br>
as long as it works in the end, you can smash it into a million pieces<br>
and put it back together again if you like.  Commits to the repository<br>
are better when they are many small ones, as they can be more easily<br>
managed.  For example if something is found to be designed not<br>
ideally, or there is a fatal bug, that patch/commit can be reverted<br>
and then new code can be worked on.  And small patches make it much<br>
easier for the other relax developers to read and catch potential<br>
hidden bugs or design issues.<br>
<br>
This is an intriguing problem, as the data flow hits a fork here.<br>
ri_prime is the correct target for the merging of the data from all<br>
the interactions, as this needs to occur before the calculation of the<br>
NOE using sigma_noe and the R1.  The relaxation rates R1, R2, and<br>
sigma_noe add.  However the NOE does not.  I just thought I&#39;d explain<br>
the logic for others to follow ;)<br>
<br>
I would suggest we store ri_prime somewhere else.  What I can do is to<br>
apply a patch for the first change to accommodate for the multiple<br>
relaxation interactions.  Then I could make a change myself, creating<br>
a special Python object for &#39;data[i]&#39;.  We can store the ri_prime data<br>
this special object.  Essentially, it will be like the current code<br>
base.  We could have specific interaction data in say:<br>
<br>
self.data[10][0].jw  (or self.data[0].jw if data = "">
<br>
This is new.  But as before we could have:<br>
<br>
self.data[10].ri_prime (or data.ri_prime if data = "">
<br>
So the forking can all be managed within the self.data[i] data<br>
structures.  What do you think?  Also, we will have to work out how to<br>
modify or replace func_ri_prime and func_ri_prime_rex in the<br>
maths_fns.ri_prime module.  This is where the merging of data streams<br>
currently occurs.  Maybe Rex needs to be considered as its own<br>
interaction, as this is added to produce ri_prime?<br>
<br>
Regards,<br>
<br>
Edward<br>
<br>
<br>
P. S.  I just talked to Kathleen Hall and she seemed very interested<br>
in what you are doing here!<br>
<div><div></div><div class="h5"><br>
<br>
<br>
On 22 October 2010 18:26, Pavel Kaderavek &lt;<a rel="nofollow" href="mailto:pavel.kaderavek@xxxxxxxxx">pavel.kaderavek@xxxxxxxxx</a>&gt; wrote:<br>
&gt; Hi,<br>
&gt; I am continuing in the discussion started in my post<br>
&gt; <a rel="nofollow" href="https://mail.gna.org/public/relax-devel/2010-09/msg00020.html" target="_blank">https://mail.gna.org/public/relax-devel/2010-09/msg00020.html</a><br>
&gt; It covers changes of functions func_mf.py, func_local_tm , func_diff,<br>
&gt; func_all and their equivalents for a first and second derivatives (class Mf,<br>
&gt; file maths_fns/mf.py).<br>
&gt;<br>
&gt; I would like to include into next patch also treatment of the fact, that it<br>
&gt; is necessary to sum together contributions of all interactions. It seems to<br>
&gt; me that the most suitable way is to do that by the modification just revised<br>
&gt; functions (func_mf.py, func_local_tm ...)<br>
&gt; I would suggest to initialize ri_prime before loop over interactions and<br>
&gt; then step by step add the contributions into the ri_prime:<br>
&gt;<br>
&gt;         data = ""                                # the cases<br>
&gt; when `i` is replaced by `0` were discussed in your last mail<br>
&gt;         ri_prime=0<br>
&gt;<br>
&gt;<br>
&gt;         for j in xrange(self.num_interactions[i]):<br>
&gt;<br>
&gt;               ...<br>
&gt;               ...<br>
&gt;<br>
&gt;               # Calculate the R1, R2, and sigma_noe values.<br>
&gt;               ri_prime = ri_prime + data[j].create_ri_prime(data[j])<br>
&gt;<br>
&gt;          data[0].ri_prime = ri_prime<br>
&gt;<br>
&gt;<br>
&gt; When the loop over interactions is finished the accumulated relaxation rate<br>
&gt; is copied into the data storage of the first interaction. Then it is<br>
&gt; possible to call functions, where total ri_prime is needed:<br>
&gt;<br>
&gt;         # Calculate the NOE values.<br>
&gt;         data[0].ri = data[0].ri_prime * 1.0<br>
&gt;         for m in xrange(data[0].num_ri):<br>
&gt;             if data[0].create_ri[m]:<br>
&gt;                 data[0].create_ri[m](data[0], m, data[0].remap_table[m],<br>
&gt; data[0].get_r1, params)<br>
&gt;<br>
&gt;         # Calculate the chi-squared value.<br>
&gt;         data[0].chi2 = chi2(data[0].relax_data, data[0].ri, data[0].errors)<br>
&gt;<br>
&gt; Regards,<br>
&gt; Pavel<br>
&gt;<br>
&gt; On 19 October 2010 13:49, Edward d&#39;Auvergne &lt;<a rel="nofollow" href="mailto:edward@xxxxxxxxxxxxx">edward@xxxxxxxxxxxxx</a>&gt; wrote:<br>
&gt;&gt;<br>
&gt;&gt; Hi,<br>
&gt;&gt;<br>
&gt;&gt; Sorry for the delay, I just came back from a 2 week holiday.  This is<br>
&gt;&gt; correct, the func_mf, func_local_tm, etc. methods are working on a<br>
&gt;&gt; single spin.  This is stored in self.data[0].  The other functions<br>
&gt;&gt; work on multiple spin data located in self.data[0], self.data[1], etc.<br>
&gt;&gt;<br>
&gt;&gt; Regards,<br>
&gt;&gt;<br>
&gt;&gt; Edward<br>
&gt;&gt;<br>
&gt;&gt;<br>
&gt;&gt;<br>
&gt;&gt; On 14 October 2010 19:38, Pavel Kaderavek &lt;<a rel="nofollow" href="mailto:pavel.kaderavek@xxxxxxxxx">pavel.kaderavek@xxxxxxxxx</a>&gt;<br>
&gt;&gt; wrote:<br>
&gt;&gt; &gt; Hi,<br>
&gt;&gt; &gt;<br>
&gt;&gt; &gt; I would like to announce a small clarification of my previous mail about<br>
&gt;&gt; &gt; changes in functions func_mf, func_local_tm, func_diff, func_all, and<br>
&gt;&gt; &gt; their<br>
&gt;&gt; &gt; derivatives (class Mf, file maths_fns/mf.py). Loop suggested in my last<br>
&gt;&gt; &gt; post:<br>
&gt;&gt; &gt;<br>
&gt;&gt; &gt; <a rel="nofollow" href="https://mail.gna.org/public/relax-devel/2010-09/msg00020.html" target="_blank">https://mail.gna.org/public/relax-devel/2010-09/msg00020.html</a><br>
&gt;&gt; &gt;<br>
&gt;&gt; &gt; is valid just for the functions func_diff, func_all, and their<br>
&gt;&gt; &gt; equivalents<br>
&gt;&gt; &gt; for a first and second derivatives.<br>
&gt;&gt; &gt; While for the functions  func_mf, func_local_tm, and corresponding<br>
&gt;&gt; &gt; derivatives the index of self.num_interactions should be set to `0`<br>
&gt;&gt; &gt; instead<br>
&gt;&gt; &gt; of index `i`<br>
&gt;&gt; &gt;<br>
&gt;&gt; &gt;         for j in xrange(self.num_interactions[0]):<br>
&gt;&gt; &gt;<br>
&gt;&gt; &gt; (The rest of the loop remains the same)<br>
&gt;&gt; &gt; That comes from the fact that these functions (func_mf, func_local_tm,<br>
&gt;&gt; &gt; ...<br>
&gt;&gt; &gt; ) are called for each spin separately. As it is indicated by the<br>
&gt;&gt; &gt; preceding<br>
&gt;&gt; &gt; statement:<br>
&gt;&gt; &gt;<br>
&gt;&gt; &gt;         data = "">
&gt;&gt; &gt;<br>
&gt;&gt; &gt; Regards,<br>
&gt;&gt; &gt; Pavel<br>
&gt;&gt; &gt;<br>
&gt;&gt; &gt; On 29 September 2010 10:53, Edward d&#39;Auvergne &lt;<a rel="nofollow" href="mailto:edward@xxxxxxxxxxxxx">edward@xxxxxxxxxxxxx</a>&gt;<br>
&gt;&gt; &gt; wrote:<br>
&gt;&gt; &gt;&gt;<br>
&gt;&gt; &gt;&gt; Hi,<br>
&gt;&gt; &gt;&gt;<br>
&gt;&gt; &gt;&gt; This is the perfect approach.  It will abstract the calculations so<br>
&gt;&gt; &gt;&gt; that we will not need to touch many of maths_fns modules.  With this<br>
&gt;&gt; &gt;&gt; code in place, I would aim at then making the test suite pass again by<br>
&gt;&gt; &gt;&gt; having the correct data structures pass into maths_fns.mf.  The last<br>
&gt;&gt; &gt;&gt; step would be to input CSA tensors and the multi-dipole interactions<br>
&gt;&gt; &gt;&gt; via user functions.  If you make a patch for all of the func_*(),<br>
&gt;&gt; &gt;&gt; dfunc_*(), and d2func_*() methods, I can check and apply it quickly.<br>
&gt;&gt; &gt;&gt;<br>
&gt;&gt; &gt;&gt; Regards,<br>
&gt;&gt; &gt;&gt;<br>
&gt;&gt; &gt;&gt; Edward<br>
&gt;&gt; &gt;&gt;<br>
&gt;&gt; &gt;&gt;<br>
&gt;&gt; &gt;&gt; On 28 September 2010 12:07, Pavel Kaderavek &lt;<a rel="nofollow" href="mailto:pavel.kaderavek@xxxxxxxxx">pavel.kaderavek@xxxxxxxxx</a>&gt;<br>
&gt;&gt; &gt;&gt; wrote:<br>
&gt;&gt; &gt;&gt; &gt; Hi,<br>
&gt;&gt; &gt;&gt; &gt; we were thinking about next necessary changes in the CST branch.<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt; Now we need to break through the problem, which implies the fact we<br>
&gt;&gt; &gt;&gt; &gt; split<br>
&gt;&gt; &gt;&gt; &gt; the relaxation rate calculation into contributions of individual<br>
&gt;&gt; &gt;&gt; &gt; interactions. Each of them has its own data class to store its<br>
&gt;&gt; &gt;&gt; &gt; parameters<br>
&gt;&gt; &gt;&gt; &gt; (so far called data[i][j], where the [i] was a spin index and [j] was<br>
&gt;&gt; &gt;&gt; &gt; the<br>
&gt;&gt; &gt;&gt; &gt; interaction index).<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt; It seems to us, that it the best way to deal with it is to edit<br>
&gt;&gt; &gt;&gt; &gt; functions:<br>
&gt;&gt; &gt;&gt; &gt; func_mf, func_local_tm , func_diff, func_all and their equivalents<br>
&gt;&gt; &gt;&gt; &gt; for a<br>
&gt;&gt; &gt;&gt; &gt; first and second derivatives (defined in mf.py file).<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt; Within these functions the calculations of direction cosines,<br>
&gt;&gt; &gt;&gt; &gt; diffusion<br>
&gt;&gt; &gt;&gt; &gt; tensor weight calculations, components of the spectral densities and<br>
&gt;&gt; &gt;&gt; &gt; so<br>
&gt;&gt; &gt;&gt; &gt; on<br>
&gt;&gt; &gt;&gt; &gt; are performed. All these must be calculated for each interaction<br>
&gt;&gt; &gt;&gt; &gt; separately,<br>
&gt;&gt; &gt;&gt; &gt; because each interaction has its own data storage (which replaced<br>
&gt;&gt; &gt;&gt; &gt; previously<br>
&gt;&gt; &gt;&gt; &gt; used one data class container for the whole IS spin system).<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt; Instead of:<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;         # Direction cosine calculations.<br>
&gt;&gt; &gt;&gt; &gt;         if self.diff_data.calc_di:<br>
&gt;&gt; &gt;&gt; &gt;             self.diff_data.calc_di(data, self.diff_data)<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;         # Diffusion tensor weight calculations.<br>
&gt;&gt; &gt;&gt; &gt;         self.diff_data.calc_ci(data, self.diff_data)<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;         # Diffusion tensor correlation times.<br>
&gt;&gt; &gt;&gt; &gt;         self.diff_data.calc_ti(data, self.diff_data)<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;         # Calculate the components of the spectral densities.<br>
&gt;&gt; &gt;&gt; &gt;         if data.calc_jw_comps:<br>
&gt;&gt; &gt;&gt; &gt;             data.calc_jw_comps(data, params)<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;         # Calculate the R1, R2, and sigma_noe values.<br>
&gt;&gt; &gt;&gt; &gt;         data.ri_prime = data.create_ri_prime(data)<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt; we would suggest to introduce a loop over interacations<br>
&gt;&gt; &gt;&gt; &gt;         for j in xrange(self.num_interactions[i]):<br>
&gt;&gt; &gt;&gt; &gt;             # Direction cosine calculations.<br>
&gt;&gt; &gt;&gt; &gt;             if self.diff_data.calc_di:<br>
&gt;&gt; &gt;&gt; &gt;                 self.diff_data.calc_di(data[j], self.diff_data)<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;             # Diffusion tensor weight calculations.<br>
&gt;&gt; &gt;&gt; &gt;             self.diff_data.calc_ci(data[j], self.diff_data)<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;             # Diffusion tensor correlation times.<br>
&gt;&gt; &gt;&gt; &gt;             self.diff_data.calc_ti(data[j], self.diff_data)<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;             # Calculate the components of the spectral densities.<br>
&gt;&gt; &gt;&gt; &gt;             if data.calc_jw_comps:<br>
&gt;&gt; &gt;&gt; &gt;                 data.calc_jw_comps(data[j], params)<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;             # Calculate the R1, R2, and sigma_noe components.<br>
&gt;&gt; &gt;&gt; &gt;             data.ri_prime = data.create_ri_prime(data[j])<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt; It must be accompanied in the next step by a change the ri_prime<br>
&gt;&gt; &gt;&gt; &gt; function so<br>
&gt;&gt; &gt;&gt; &gt; that it just calculate only a product of specific interaction<br>
&gt;&gt; &gt;&gt; &gt; constant<br>
&gt;&gt; &gt;&gt; &gt; and<br>
&gt;&gt; &gt;&gt; &gt; corresponding linear combination of spectral densities. While the<br>
&gt;&gt; &gt;&gt; &gt; final<br>
&gt;&gt; &gt;&gt; &gt; sumation over all interactions should be done in a separate step.<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt; Moreover it will be also necessary to distinguish within the function<br>
&gt;&gt; &gt;&gt; &gt; setup_equation the type of equation used for contribution of<br>
&gt;&gt; &gt;&gt; &gt; individual<br>
&gt;&gt; &gt;&gt; &gt; interactions according to their type.<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt; Best<br>
&gt;&gt; &gt;&gt; &gt; Pavel<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt; On 10 September 2010 15:43, Edward d&#39;Auvergne &lt;<a rel="nofollow" href="mailto:edward@xxxxxxxxxxxxx">edward@xxxxxxxxxxxxx</a>&gt;<br>
&gt;&gt; &gt;&gt; &gt; wrote:<br>
&gt;&gt; &gt;&gt; &gt;&gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; Hi Pavel,<br>
&gt;&gt; &gt;&gt; &gt;&gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; I missed it in the patches, but there were tab characters &#39;\t&#39;<br>
&gt;&gt; &gt;&gt; &gt;&gt; causing<br>
&gt;&gt; &gt;&gt; &gt;&gt; problems.  These are now fixed.  relax requires that a tab is<br>
&gt;&gt; &gt;&gt; &gt;&gt; replaced<br>
&gt;&gt; &gt;&gt; &gt;&gt; by 4 spaces.  I have also added you to the copyright notices<br>
&gt;&gt; &gt;&gt; &gt;&gt; (<a rel="nofollow" href="http://svn.gna.org/viewcvs/relax?view=rev&amp;revision=11543" target="_blank">http://svn.gna.org/viewcvs/relax?view=rev&amp;revision=11543</a>) of the<br>
&gt;&gt; &gt;&gt; &gt;&gt; files you have modified.<br>
&gt;&gt; &gt;&gt; &gt;&gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; Regards,<br>
&gt;&gt; &gt;&gt; &gt;&gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; Edward<br>
&gt;&gt; &gt;&gt; &gt;&gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; On 10 September 2010 15:36, Edward d&#39;Auvergne &lt;<a rel="nofollow" href="mailto:edward@xxxxxxxxxxxxx">edward@xxxxxxxxxxxxx</a>&gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; wrote:<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt; Hi,<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt; I&#39;ve carefully checked the patches and committed them with the<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt; messages you wrote.  Sorry again for the delays.  It should be<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt; faster<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt; now that I am no longer in the tropical wilderness of far north<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt; Australia.<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt; Regards,<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt; Edward<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt; On 6 September 2010 13:23, Edward d&#39;Auvergne<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt; &lt;<a rel="nofollow" href="mailto:edward@xxxxxxxxxxxxx">edward@xxxxxxxxxxxxx</a>&gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt; wrote:<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt; Hi Pavel,<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt; Sorry for the delayed response.  I was at the ICMRBS conference<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt; in<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt; Australia and then travelled through the tropical north end of<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt; Australia afterwards.  I came back yesterday out of the remote<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt; wilderness and can soon start looking at this patches.<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt; Regards,<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt; Edward<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt; On 31 August 2010 18:00, Pavel Kaderavek<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt; &lt;<a rel="nofollow" href="mailto:pavel.kaderavek@xxxxxxxxx">pavel.kaderavek@xxxxxxxxx</a>&gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt; wrote:<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt; Hi,<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt; some time ago, we submitted two patches regarding CST branch. We<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt; are<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt; not<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt; sure if we should wait for some additional comment from your<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt; side,<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt; or<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt; we can<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt; continue with introducing further changes in the code.<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt; Next step would be a splitting of the relaxation equation so<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt; that<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt; contribution to the relaxation due to the individual types of<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt; interaction<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt; (dipole-dipole, CSA) can be calculated separately.<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt; Regars,<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt; Pavel, Petr<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;&gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;&gt;<br>
&gt;&gt; &gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;&gt; &gt;<br>
&gt;&gt; &gt;<br>
&gt;&gt; &gt;<br>
&gt;<br>
&gt;<br>
</div></div></blockquote></div><br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00005" href="msg00005.html">Re: CST branch</a></strong>
<ul><li><em>From:</em> Pavel Kaderavek</li></ul></li>
<li><strong><a name="00007" href="msg00007.html">Re: CST branch</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00014" href="msg00014.html">Re: CST branch</a></strong>
<ul><li><em>From:</em> Pavel Kaderavek</li></ul></li>
<li><strong><a name="00015" href="msg00015.html">Re: CST branch</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Fri Oct 29 00:00:09 2010</div>  
</body>
</html>
