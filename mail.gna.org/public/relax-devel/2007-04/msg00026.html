<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: r3253 &#45; in /branches/multi_processor: multi/mpi4py_processor.py	multi/processor.py multi/uni_processor.py relax -->
<!--X-From-R13: "Sqjneq q'Ohiretar" <rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Fri, 30 Mar 2007 11:46:46 +0200 -->
<!--X-Message-Id: 7f080ed10703300239g880ca8eq9f3f41fb5f323295@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: E1HXCvv&#45;0001oH&#45;50@subversion.gna.org -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: r3253 - in /branches/multi_processor: multi/mpi4py_processor.py	multi/processor.py multi/uni_processor.py relax -- March 30, 2007 - 11:46</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: r3253 - in /branches/multi_processor: multi/mpi4py_processor.py	multi/processor.py multi/uni_processor.py relax</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00026" class="tabs">Index by Date</a> | <a href="threads.html#00026" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00025.html">Date Prev</a>] [<a href="msg00027.html">Date Next</a>] [<a href="msg00020.html">Thread Prev</a>] [<a href="msg00028.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;garyt@xxxxxxxxxxxxxxx&quot; &lt;garyt@xxxxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Fri, 30 Mar 2007 19:39:15 +1000</li>
<li class="menuitem">
<em>Cc</em>: relax-devel@xxxxxxx</li>
<li class="menuitem">
<em>Dkim-signature</em>: a=rsa-sha1; c=relaxed/relaxed; d=gmail.com; s=beta;	h=domainkey-signature:received:received:message-id:date:from:sender:to:subject:cc:in-reply-to:mime-version:content-type:content-transfer-encoding:content-disposition:references:x-google-sender-auth;	b=ALKJKQEXbfFoTIW6Nvw87u+8NUI/o5eq1z/wtG4yqbutUupM0Q5BPgshEzoJLRCrVhF03spQp8b20RwFhaWHvNj173107KURdOdcceQmGbp79WeCZL22KfEpo7fJUwTymFrQPff0oT2Qto4B5rKiAIaDCJxJziDK0Q3B7N8f2PM=</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00026.html">7f080ed10703300239g880ca8eq9f3f41fb5f323295@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;E1HXCvv-0001oH-50@subversion.gna.org&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on March 30, 2007 - 11:46:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi,</pre><br>
<pre style="margin: 0em;">I think that with the number of functions and methods in the 'multi'
directory (71 as of r3254), writing unit tests will significantly help
in debugging.  With the unit test framework you have set up Gary,
writing these tests is very easy.  I've actually started to use the
framework to write the tests before I even implement the code.  That's
what I did with the tokenise() and parse_token() functions in the 1.3
line and as soon as all tests pass, I knew that the problem was
solved.  Using the script 'svnmerge.py' you should be able to easily
port just the revisions relating to the unit test framework in the 1.3
line and then have access to the framework to make your life easier :)</pre><br>
<pre style="margin: 0em;">Cheers,</pre><br>
<pre style="margin: 0em;">Edward</pre><br>
<pre style="margin: 0em;"><br></pre><br>
<tt>On 3/30/07, garyt@xxxxxxxxxxxxxxx &lt;garyt@xxxxxxxxxxxxxxx&gt; wrote:
</tt><blockquote class="blockquote"><pre style="margin: 0em;">Author: varioustoxins
Date: Fri Mar 30 10:58:03 2007
New Revision: 3253</pre><br>
<pre style="margin: 0em;">URL: <a  href="http://svn.gna.org/viewcvs/relax?rev=3253&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=3253&amp;view=rev</a>
Log:
'classification' of Processor classes</pre><br>
<pre style="margin: 0em;">Modified:
    branches/multi_processor/multi/mpi4py_processor.py
    branches/multi_processor/multi/processor.py
    branches/multi_processor/multi/uni_processor.py
    branches/multi_processor/relax</pre><br>
<pre style="margin: 0em;">Modified: branches/multi_processor/multi/mpi4py_processor.py
URL: 
<a  href="http://svn.gna.org/viewcvs/relax/branches/multi_processor/multi/mpi4py_processor.py?rev=3253&amp;r1=3252&amp;r2=3253&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/multi_processor/multi/mpi4py_processor.py?rev=3253&amp;r1=3252&amp;r2=3253&amp;view=diff</a>
==============================================================================
--- branches/multi_processor/multi/mpi4py_processor.py (original)
+++ branches/multi_processor/multi/mpi4py_processor.py Fri Mar 30 10:58:03 
2007
@@ -26,12 +26,12 @@
 import sys
 import os
 import math
-import time,datetime
 import textwrap</pre><br>
<pre style="margin: 0em;">-from multi.processor import Memo,Slave_command
+from multi.processor import Processor,Memo,Slave_command
 from multi.processor import Result,Result_command,Result_string
 from multi.commands import Exit_command
+</pre><br>
<pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;">@@ -95,7 +95,7 @@</pre><br>
<pre style="margin: 0em;"><br> #FIXME do some inheritance
-class Mpi4py_processor:
+class Mpi4py_processor(Processor):</pre><br>
<pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;">@@ -124,7 +124,7 @@
          self.memo_map.clear()</pre><br>
<pre style="margin: 0em;">     def assert_on_master(self):
-        if MPI.rank != 0:
+        if self.on_slave():
             msg = 'running on slave when expected master with MPI.rank == 0, 
rank was %d'% MPI.rank
             raise Exception(msg)</pre><br>
<pre style="margin: 0em;">@@ -141,9 +141,7 @@</pre><br>
<pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;">-    def run_command_globally(self,command):
-        queue = [command for i in range(1,MPI.size)]
-        self.run_command_queue(queue)
+</pre><br>
<pre style="margin: 0em;">     def run_command_queue(self,queue):
         self.assert_on_master()
@@ -191,23 +189,19 @@
                         raise Exception(message)</pre><br>
<pre style="margin: 0em;"><br>-    def pre_run(self):
-        self.start_time =  time.time()
-
-    def post_run(self):
-        end_time = time.time()
-        time_diff= end_time - start_time
-        time_delta = datetime.timedelta(seconds=time_diff)
-        time_delta_str = time_delta.__str__()
-        (time_delta_str,millis) = time_delta_str.rsplit(sep='.',maxsplit=1)
-        print 'overall runtime: ' + time_delta_str + '\n'
+
+    def on_master(self):
+        result = False
+        if MPI.rank ==0:
+            result = True
+        return result</pre><br>
<pre style="margin: 0em;"><br>     def run(self):</pre><br>
<pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;">-        if MPI.rank ==0:
+        if self.on_master():
             self.pre_run()
             self.relax_instance.run()
             self.post_run()</pre><br>
<pre style="margin: 0em;">Modified: branches/multi_processor/multi/processor.py
URL: 
<a  href="http://svn.gna.org/viewcvs/relax/branches/multi_processor/multi/processor.py?rev=3253&amp;r1=3252&amp;r2=3253&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/multi_processor/multi/processor.py?rev=3253&amp;r1=3252&amp;r2=3253&amp;view=diff</a>
==============================================================================
--- branches/multi_processor/multi/processor.py (original)
+++ branches/multi_processor/multi/processor.py Fri Mar 30 10:58:03 2007
@@ -21,6 +21,67 @@
 # Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA  
  #
 #                                                                            
  #
 
################################################################################
+
+#FIXME better  requirement of inherited commands
+import time,datetime
+
+
+
+def raise_unimplimented(method):
+    raise NotImplementedError(&quot;Attempt to invoke unimplemented abstract method 
%s&quot;) % method.__name__
+
+#requires 2.4 decorators@abstract
+#def abstract(f):
+#    raise_unimplimented(f)
+#    return f
+
+class Processor(object):
+
+    def add_to_queue(self,command,memo=None):
+         raise_unimplimented(self.add_to_queue)
+
+    def run_queue(self):
+        raise_unimplimented(self.run_queue)
+
+    def run(self):
+        raise_unimplimented(self.run)
+
+    def return_object(self,result):
+        raise_unimplimented(self.return_object)
+
+    def get_name(self):
+        raise_unimplimented(self.get_name)
+
+    def exit(self):
+        raise_unimplimented(self.exit)
+
+    def on_master(self):
+        raise_unimplimented(self.on_master)
+
+    def on_slave(self):
+        return not self.on_master()
+
+    def run_command_globally(self,command):
+        queue = [command for i in range(1,MPI.size)]
+        self.run_command_queue(queue)
+
+    def pre_run(self):
+        if self.on_master():
+            self.start_time =  time.time()
+
+    def get_time_delta(self,start_time,end_time):
+
+        time_diff= end_time - start_time
+        time_delta = datetime.timedelta(seconds=time_diff)
+        time_delta_str = time_delta.__str__()
+        (time_delta_str,millis) = time_delta_str.split('.',1)
+        return time_delta_str
+
+    def post_run(self):
+        if self.on_master():
+            end_time = time.time()
+            time_delta_str = self.get_time_delta(self.start_time,end_time)
+            print 'overall runtime: ' + time_delta_str + '\n'</pre><br>
<pre style="margin: 0em;"> class Result(object):
     def __init__(self,completed):</pre><br>
<pre style="margin: 0em;">Modified: branches/multi_processor/multi/uni_processor.py
URL: 
<a  href="http://svn.gna.org/viewcvs/relax/branches/multi_processor/multi/uni_processor.py?rev=3253&amp;r1=3252&amp;r2=3253&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/multi_processor/multi/uni_processor.py?rev=3253&amp;r1=3252&amp;r2=3253&amp;view=diff</a>
==============================================================================
--- branches/multi_processor/multi/uni_processor.py (original)
+++ branches/multi_processor/multi/uni_processor.py Fri Mar 30 10:58:03 2007
@@ -26,10 +26,50 @@
 import multi
 import time,datetime</pre><br>
<pre style="margin: 0em;">-from multi.processor import Result_command,Result_string
+from multi.processor import Processor,Result_command,Result_string
+#class Processor(object):
+#    def add_to_queue(self,command,memo=None):
+#        pass
+#    def run_queue(self):
+#        pass
+#    def run(self):
+#        pass
+#    def return_object(self,result):
+#        pass
+#    def get_name(self):
+#        pass
+#    def exit(self):
+#        pass
+#
+#    def on_master(self):
+#        pass
+#
+#    def on_slave(self):
+#        return not self.on_master()
+#
+#    def run_command_globally(self,command):
+#        queue = [command for i in range(1,MPI.size)]
+#        self.run_command_queue(queue)
+#
+#    def pre_run(self):
+#        if self.on_master():
+#            self.start_time =  time.time()
+#
+#    def get_time_delta(self,start_time,end_time):
+#        end_time = time.time()
+#        time_diff= end_time - self.start_time
+#        time_delta = datetime.timedelta(seconds=time_diff)
+#        time_delta_str = time_delta.__str__()
+#        (time_delta_str,millis) = time_delta_str.rsplit(sep='.',maxsplit=1)
+#        return time_delta
+#
+#    def post_run(self):
+#        if self.on_master():
+#
+#            print 'overall runtime: ' + time_delta_str + '\n'</pre><br>
<pre style="margin: 0em;"> #FIXME need to subclass
-class Uni_processor(object):
+class Uni_processor(Processor):
     def __init__(self,relax_instance):
         self.relax_instance= relax_instance</pre><br>
<pre style="margin: 0em;">@@ -37,6 +77,8 @@
         self.memo_map={}</pre><br>
<pre style="margin: 0em;"><br>+    def on_master(self):
+        return True</pre><br>
<pre style="margin: 0em;">     def add_to_queue(self,command,memo=None):
         self.command_queue.append(command)
@@ -46,26 +88,28 @@</pre><br>
<pre style="margin: 0em;">     def run_queue(self):
         #FIXME: need a finally here to cleanup exceptions states
-        for command in self.command_queue:
-            print command</pre><br>
<pre style="margin: 0em;"><br>-        self.run_command_queue()
+        for command in self.command_queue:
+            command.run(self)
+        #self.run_command_queue()
         #TODO: add cheques for empty queuese and maps if now warn
         del self.command_queue[:]
         self.memo_map.clear()
-
-    def run_command_queue(self):
-               for command in self.command_queue:
-                       command.run(self)
+# FIXME: remove me
+#    def run_command_queue(self):
+#              for command in self.command_queue:
+#                      command.run(self)</pre><br>
<pre style="margin: 0em;">     def run(self):
-        start_time =  time.clock()
+#        start_time =  time.clock()
+        self.pre_run()
         self.relax_instance.run()
-        end_time = time.clock()
-        time_diff= end_time - start_time
-        time_delta = datetime.timedelta(seconds=time_diff)
-        print 'overall runtime: ' + time_delta.__str__() + '\n'
+        self.post_run()
+#        end_time = time.clock()
+#        time_diff= end_time - start_time
+#        time_delta = datetime.timedelta(seconds=time_diff)
+#        print 'overall runtime: ' + time_delta.__str__() + '\n'</pre><br>
<pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;">@@ -96,7 +140,4 @@</pre><br>
<pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;">-if __name__ == '__main__':
-    test =Uni_processor(None)
-    print test</pre><br>
<pre style="margin: 0em;"><br>Modified: branches/multi_processor/relax
URL: 
<a  href="http://svn.gna.org/viewcvs/relax/branches/multi_processor/relax?rev=3253&amp;r1=3252&amp;r2=3253&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/multi_processor/relax?rev=3253&amp;r1=3252&amp;r2=3253&amp;view=diff</a>
==============================================================================
--- branches/multi_processor/relax (original)
+++ branches/multi_processor/relax Fri Mar 30 10:58:03 2007
@@ -554,6 +554,9 @@
     return result</pre><br>
<pre style="margin: 0em;"> #FIXME: mode not required should be an instance variable of relax?
+#FIXME error checking for if module require not found
+#FIXME move module loading to processor
+#FIXME module loading code needs to be in a util module
 def load_multiprocessor(relax_instance):</pre><br>
<pre style="margin: 0em;">     processor_name = relax_instance.multiprocessor_type + '_processor'</pre><br>
<pre style="margin: 0em;"><br>_______________________________________________
relax (<a  href="http://nmr-relax.com">http://nmr-relax.com</a>)</pre><br>
<pre style="margin: 0em;">This is the relax-commits mailing list
relax-commits@xxxxxxx</pre><br>
<pre style="margin: 0em;">To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  href="http://www.nmr-relax.com/mail.gna.org/listinfo/relax-commits">https://mail.gna.org/listinfo/relax-commits</a></pre><br>
</blockquote><pre style="margin: 0em;"><br></pre><br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Tue Apr 10 12:40:36 2007</div>  
</body>
</html>
