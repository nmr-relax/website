<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: Regarding systemtest: ./relax &#45;s	Relax_disp.test_bug_21344_sparse_time_spinlock_acquired_r1rho_fail_relax_disp -->
<!--X-From-R13: "Sqjneq q'Ohiretar" <rqjneq.qnhiretarNtznvy.pbz> -->
<!--X-Date: Thu, 27 Feb 2014 17:04:15 +0100 -->
<!--X-Message-Id: CAED9pY_o4bKMtB_vQ8VPb&#45;kyz+QSrAy4kHnN429v2A7kfUyh6Q@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: CA+CBx2M9hCjFsxFDJyDAP6XFGPhs3yzdB3iOsA9jR9JpP_+fYA@mail.gmail.com -->
<!--X-Reference: CAED9pY9AJ&#45;QswCxhdnYLUZR2FjAJtEPvE_=QhZvUsPwJ&#45;yhb6Q@mail.gmail.com -->
<!--X-Reference: CAED9pY&#45;yVk0q7X0n0pKpu8sjuxSMks8QoMXhvHd6O&#45;Gm84S&#45;uw@mail.gmail.com -->
<!--X-Reference: CA+CBx2Nz7qV2H&#45;CSrQ56HQYt4gGBi1_gC_MDVQr+2mnSiHf4gw@mail.gmail.com -->
<!--X-Reference: CAED9pY_b5hcWGnNSKuGn+JZ&#45;O728BgHJCoaY&#45;LEK1YLcas1fgQ@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: Regarding systemtest: ./relax -s	Relax_disp.test_bug_21344_sparse_time_spinlock_acquired_r1rho_fail_relax_disp -- February 27, 2014 - 17:04</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: Regarding systemtest: ./relax -s	Relax_disp.test_bug_21344_sparse_time_spinlock_acquired_r1rho_fail_relax_disp</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00173" class="tabs">Index by Date</a> | <a href="threads.html#00173" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00172.html">Date Prev</a>] [<a href="msg00174.html">Date Next</a>] [<a href="msg00170.html">Thread Prev</a>] [<a href="msg00171.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Thu, 27 Feb 2014 17:03:44 +0100</li>
<li class="menuitem">
<em>Cc</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113;	h=mime-version:in-reply-to:references:date:message-id:subject:from:to	:cc:content-type:content-transfer-encoding;	bh=8Mfa1BeZ/rMDVRY1BRyBl/pPox2vvD8lCuyLUB63PoI=;	b=Fnk9EQSE2sb5QHUsyzZ8tWV6c5An7lg8Az1OYHt3kCyMfRzla2PBPdkw6hCWjqEoNW	psi1ARDrt3DX3TBvl69m2XhzLfY2a3Hl3YST38vvvGFPfv0Jwf2jP4ZCq0knD2He/y4S	b/FkQASY8OUDCLLzGC68djnspeObw8XuX0c7aQ0K3ar8TOvk5MzpWyb01AsnVBA15Sm9	cWe6otRnp5vIjUdKGhvoUjxe7wDp6pCEcnODldhxmse3yqj3gZaiJScxy9ZoNvne2BcR	PnLVWLHRdhQMOTK5/4w3kX4iSqhQcEpgbN9PosPYXa39SRqIlAQ5jfy11HJDQWcTZ581	qbig==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00173.html">CAED9pY_o4bKMtB_vQ8VPb-kyz+QSrAy4kHnN429v2A7kfUyh6Q@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;CA+CBx2M9hCjFsxFDJyDAP6XFGPhs3yzdB3iOsA9jR9JpP_+fYA@xxxxxxxxxxxxxx&gt;	&lt;CAED9pY9AJ-QswCxhdnYLUZR2FjAJtEPvE_=QhZvUsPwJ-yhb6Q@xxxxxxxxxxxxxx&gt;	&lt;CAED9pY-yVk0q7X0n0pKpu8sjuxSMks8QoMXhvHd6O-Gm84S-uw@xxxxxxxxxxxxxx&gt;	&lt;CA+CBx2Nz7qV2H-CSrQ56HQYt4gGBi1_gC_MDVQr+2mnSiHf4gw@xxxxxxxxxxxxxx&gt;	&lt;CAED9pY_b5hcWGnNSKuGn+JZ-O728BgHJCoaY-LEK1YLcas1fgQ@xxxxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on February 27, 2014 - 17:04:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi Troels,

I may have made a mistake about the find_intensity_keys() function!  I
was looking at why a number of the system tests now fail, and I
realised that there is a case were multiple IDs exist for the same
{exp_type, frq, offset, point, time} set - replicated spectra!  For
one metadata set, there can be multiple peak intensity values.  I
don't know why I forgot about this.  That is why there was an 's' at
the end of the function name and why it returns a list.  It might be
worth reverting commits {r22357, r22358, r22360}, but leaving {r22359,
r22361, r22362}.  Sorry for the inconvenience.

I've also looked at the return_intensity() function and can see that
its logic is plain wrong.  It returns the first intensity of the list
of replicates returned by find_intensity_keys() (or previously the
'key' variable which did not exist).  This makes no sense.  But is
also not called anywhere within relax.  I guess it has been 100%
replaced by the average_intensity() function.  Instead of having a
unit test for it, maybe it would be best to remove the function.  The
function looks like old, unused code, so removing it is a good idea.

Cheers,

Edward



On 27 February 2014 13:09, Edward d'Auvergne &lt;edward.dauvergne@xxxxxxxxx&gt; 
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">:)  I'm looking through the functions of the disp_data module and have
found one other place where the offset should be supported - the
loop_spectrum_ids() function.  As the test suite now passes, it might
be a good idea to create a quick unit test for each function you
change.  This is just to be certain that each function is functioning
as you would expect.  Using your CPMG and R1rho data saved states, the
function could be tested on both to make sure that all data types
operate correctly.

Note that in the future, relax many support offset effects in the CPMG
as well.  This is currently the major benefit of using Flemming
Hansen's CATIA software.  Such support would be quite easy to add, as
relax already handles the offset concept for R1rho data and the use of
R1 data.  It would simply require a new user function for inputting
hard pulse information and a new numeric model which uses the correct
matrices.  This information is just for future reference, there is no
need for an implementation at the moment.  Therefore this is listed in
the TODO section of the dispersion chapter in the manual
(<a  rel="nofollow" href="/manual/do_dispersion_features_yet_be_implemented.html">http://www.nmr-relax.com/manual/do_dispersion_features_yet_be_implemented.html</a>)

Cheers,

Edward


On 27 February 2014 12:40, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt; 
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">That sounds perfect. :-)

And I say, that I now know what to do after Lunch.

Never gonna give &quot;it&quot; up... never gonna...
<a  rel="nofollow" href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">https://www.youtube.com/watch?v=dQw4w9WgXcQ</a>

Best
Troels




2014-02-27 12:37 GMT+01:00 Edward d'Auvergne &lt;edward.dauvergne@xxxxxxxxx&gt;:

</pre><blockquote class="blockquote"><pre style="margin: 0em;">Actually, by grepping the source code:

$ grep &quot;find_intensity_keys([a-z]&quot; -r . --exclude-dir=.svn

I can see many places where find_intensity_keys() is incorrectly
called!  I think it's obvious that this function came before
R1rho-type data was supported.  Looking further, the
return_intensity() function is also deficient for the offset value!
Almost everywhere where find_intensity_keys() is called is incorrectly
implemented (excluding the specific_analyses.relax_disp.nessy module
as NESSY does not support R1rho data)!  These should all be fixed
otherwise problems will appear in your analysis later on.

Thinking about the problem even more, I can see that only one key is
ever used when calling find_intensity_keys().  The purpose of having a
list of keys has been permanently lost - I remember implementing this
as a feature earlier in the relax_disp branch development but the
reason for it no longer exists.  As a clean solution, I would suggest:

- Renaming the function to find_intensity_key() and have it return a
single value.
- Have the find_intensity_key() function raise a RelaxError if more
than one key is found.
- Modify all of the code calling find_intensity_key() to expect and
handle a single key.
- Modify the return_intensity() function to be more like the
average_intensity() function in that the offset argument is supported.

This solution would be much more maintainable in the future.  What do you
think?

Regards,

Edward

On 27 February 2014 12:08, Edward d'Auvergne &lt;edward.dauvergne@xxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,

This looks like another rather stupid typo/mistake :)  I added a print
statement for the int_keys variable and ran the test.  There should
only be one key for a given {exp_type, frq, offset, point, time}
metadata set, but the printout shows this not to be the case.  If you
carefully look at the find_intensity_keys() call, you will see that
one of these 5 bits of information are not sent in as an argument ;)

Regards,

Edward




On 27 February 2014 11:38, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt;
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Edward.

When I run:
./relax -s
Relax_disp.test_bug_21344_sparse_time_spinlock_acquired_r1rho_fail_relax_disp

I get:
-------------------
Parameter values: [2.4392597217423719, 149801.17120634759]
Function value:   252.36349493927844
Iterations:       135
Function calls:   281
Gradient calls:   0
Hessian calls:    0
Warning:          None


relax&gt; eliminate(function=None, args=None)

relax&gt; monte_carlo.setup(number=5)

relax&gt; monte_carlo.create_data(method='back_calc')
Traceback (most recent call last):
  File
&quot;/sbinlab2/tlinnet/software/NMR-relax/relax_trunk/test_suite/system_tests/relax_disp.py&quot;,
line 284, in
test_bug_21344_sparse_time_spinlock_acquired_r1rho_fail_relax_disp
    relax_disp.Relax_disp(pipe_name='base pipe',
pipe_bundle='relax_disp', results_dir=self.tmpdir, models=['R2eff'],
grid_inc=3, mc_sim_num=5, modsel='AIC', pre_run_dir=None,
insignificance=1.0, numeric_only=False, mc_sim_all_models=False,
eliminate=True)
  File
&quot;/sbinlab2/tlinnet/software/NMR-relax/relax_trunk/auto_analyses/relax_disp.py&quot;,
line 118, in __init__
    self.run()
  File
&quot;/sbinlab2/tlinnet/software/NMR-relax/relax_trunk/auto_analyses/relax_disp.py&quot;,
line 471, in run
    self.optimise(model=model)
  File
&quot;/sbinlab2/tlinnet/software/NMR-relax/relax_trunk/auto_analyses/relax_disp.py&quot;,
line 379, in optimise
    self.interpreter.monte_carlo.create_data()
  File
&quot;/sbinlab2/tlinnet/software/NMR-relax/relax_trunk/prompt/uf_objects.py&quot;,
line 221, in __call__
    self._backend(*new_args, **uf_kargs)
  File
&quot;/sbinlab2/tlinnet/software/NMR-relax/relax_trunk/pipe_control/monte_carlo.py&quot;,
line 113, in create_data
    pack_sim_data(data_index, random)
  File
&quot;/sbinlab2/tlinnet/software/NMR-relax/relax_trunk/specific_analyses/relax_disp/api.py&quot;,
line 1609, in sim_pack_data
    raise RelaxError(&quot;Monte Carlo simulation data for the key '%s'
already exists.&quot; % int_key)
RelaxError: RelaxError: Monte Carlo simulation data for the key
'1_0_46_0' already exists.

---------------------

I have looked into:
specific_analyses/relax_disp/api.py

There it is:
----------------------------------------------
    def sim_pack_data(self, data_id, sim_data):
        &quot;&quot;&quot;Pack the Monte Carlo simulation data.

        @param data_id:     The tuple of the spin container and the
exponential curve identifying key, as yielded by the base_data_loop()
generator method.
        @type data_id:      SpinContainer instance and float
        @param sim_data:    The Monte Carlo simulation data.
        @type sim_data:     list of float
        &quot;&quot;&quot;

        # The R2eff model (with peak intensity base data).
        if cdp.model_type == 'R2eff':
            # Unpack the data.
            spin, exp_type, frq, offset, point = data_id

            # Initialise the data structure if needed.
            if not hasattr(spin, 'intensity_sim'):
                spin.intensity_sim = {}

            # Loop over each time point.
            ti = 0
            for time in loop_time(exp_type=exp_type, frq=frq,
offset=offset, point=point):
                # Get the intensity keys.
                int_keys = find_intensity_keys(exp_type=exp_type,
frq=frq, point=point, time=time)

                # Loop over the intensity keys.
                for int_key in int_keys:
                    # Test if the simulation data point already exists.
                    if int_key in spin.intensity_sim:
                        raise RelaxError(&quot;Monte Carlo simulation data
for the key '%s' already exists.&quot; % int_key)

                    # Initialise the list.
                    spin.intensity_sim[int_key] = []

                    # Loop over the simulations, appending the
corresponding data.
                    for i in range(cdp.sim_number):

spin.intensity_sim[int_key].append(sim_data[i][ti])

                # Increment the time index.
                ti += 1
---------------------

For me, this looks okay.

Do you have an Idea why this is not working?

Best
Troels
</pre></blockquote></blockquote></blockquote><pre style="margin: 0em;">


</pre></blockquote></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00166" href="msg00166.html">Regarding systemtest: ./relax -s	Relax_disp.test_bug_21344_sparse_time_spinlock_acquired_r1rho_fail_relax_disp</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00167" href="msg00167.html">Re: Regarding systemtest: ./relax -s	Relax_disp.test_bug_21344_sparse_time_spinlock_acquired_r1rho_fail_relax_disp</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00168" href="msg00168.html">Re: Regarding systemtest: ./relax -s	Relax_disp.test_bug_21344_sparse_time_spinlock_acquired_r1rho_fail_relax_disp</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00169" href="msg00169.html">Re: Regarding systemtest: ./relax -s	Relax_disp.test_bug_21344_sparse_time_spinlock_acquired_r1rho_fail_relax_disp</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00170" href="msg00170.html">Re: Regarding systemtest: ./relax -s	Relax_disp.test_bug_21344_sparse_time_spinlock_acquired_r1rho_fail_relax_disp</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Thu Feb 27 17:20:11 2014</div>  
</body>
</html>
