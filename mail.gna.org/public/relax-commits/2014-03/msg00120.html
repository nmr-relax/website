<!-- MHonArc v2.6.18 -->
<!--X-Subject: r22510 &#45; in /branches/double_rotor: ./ lib/structure/internal/ test_suite/shared_data/structures/ test_suite/system_tests/ -->
<!--X-From-R13: rqjneqNaze&#45;erynk.pbz -->
<!--X-Date: Wed, 19 Mar 2014 08:54:25 +0100 -->
<!--X-Message-Id: E1WQBKS&#45;0000tn&#45;V4@subversion.gna.org -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>r22510 - in /branches/double_rotor: ./ lib/structure/internal/ test_suite/shared_data/structures/ test_suite/system_tests/ -- March 19, 2014 - 08:54</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />r22510 - in /branches/double_rotor: ./ lib/structure/internal/ test_suite/shared_data/structures/ test_suite/system_tests/</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00120" class="tabs">Index by Date</a> | <a href="threads.html#00120" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00119.html">Date Prev</a>] [<a href="msg00121.html">Date Next</a>] [<a href="msg00119.html">Thread Prev</a>] [<a href="msg00121.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: relax-commits@xxxxxxx</li>
<li class="menuitem">
<em>Date</em>: Wed, 19 Mar 2014 07:54:24 -0000</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00120.html">E1WQBKS-0000tn-V4@subversion.gna.org</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>edward</strong> on March 19, 2014 - 08:54:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Author: bugman
Date: Wed Mar 19 08:54:24 2014
New Revision: 22510

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=22510&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=22510&amp;view=rev</a>
Log:
Merged revisions 22508-22509 via svnmerge from 
svn+ssh://bugman@xxxxxxxxxxx/svn/relax/trunk

........
  r22508 | bugman | 2014-03-19 08:37:35 +0100 (Wed, 19 Mar 2014) | 7 lines
  
  Created the Structure.test_bug_21814_pdb_no_80_space_padding system test.
  
  This is for catching bug #21814 (<a  rel="nofollow" href="https://gna.org/bugs/?21814">https://gna.org/bugs/?21814</a>), the PDB 
reading failure when the PDB
  records are not padded to 80 spaces.  The PDB file used for the test is the 
same file as attached to
  the bug report.
........
  r22509 | bugman | 2014-03-19 08:53:20 +0100 (Wed, 19 Mar 2014) | 9 lines
  
  Fix for bug #21814 (<a  rel="nofollow" href="https://gna.org/bugs/?21814">https://gna.org/bugs/?21814</a>).
  
  This is the PDB reading failure when the PDB records are not padded to 80 
spaces.  The fix is
  simple, all PDB records are pre-validated.  This includes removing all 
newline characters and
  padding each PDB record to 80 spaces when needed.  This will however add an 
overhead cost -- the
  internal PDB reader will now be slower.  However corrupted PDB files, 
produced by MODELLER for
  example, not padded to 80 spaces will now be better supported.
........

Added:
    
branches/double_rotor/test_suite/shared_data/structures/SpUreE_dimer_H_new.pdb.bz2
      - copied unchanged from r22509, 
trunk/test_suite/shared_data/structures/SpUreE_dimer_H_new.pdb.bz2
Modified:
    branches/double_rotor/   (props changed)
    branches/double_rotor/lib/structure/internal/object.py
    branches/double_rotor/test_suite/system_tests/structure.py

Propchange: branches/double_rotor/
------------------------------------------------------------------------------
--- svnmerge-integrated (original)
+++ svnmerge-integrated Wed Mar 19 08:54:24 2014
@@ -1 +1 @@
-/trunk:1-22506
+/trunk:1-22509

Modified: branches/double_rotor/lib/structure/internal/object.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/double_rotor/lib/structure/internal/object.py?rev=22510&amp;r1=22509&amp;r2=22510&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/double_rotor/lib/structure/internal/object.py?rev=22510&amp;r1=22509&amp;r2=22510&amp;view=diff</a>
==============================================================================
--- branches/double_rotor/lib/structure/internal/object.py      (original)
+++ branches/double_rotor/lib/structure/internal/object.py      Wed Mar 19 
08:54:24 2014
@@ -760,6 +760,31 @@
         # Check the other lengths.
         if len(struct.bonded) != num and len(struct.chain_id) != num and 
len(struct.element) != num and len(struct.pdb_record) != num and 
len(struct.res_name) != num and len(struct.res_num) != num and 
len(struct.seg_id) != num and len(struct.x) != num and len(struct.y) != num 
and len(struct.z) != num:
             raise RelaxError(&quot;The structural data is invalid.&quot;)
+
+
+    def _validate_records(self, lines):
+        &quot;&quot;&quot;Make sure all PDB records are 80 char in length, padding with 
whitespace when needed.
+
+        All newline characters are stripped from the records as well.
+
+
+        @param lines:       All lines of the PDB file.
+        @type lines:        list of str
+        @return:            The padded PDB lines.
+        @rtype:             list of str
+        &quot;&quot;&quot;
+
+        # Loop over the lines.
+        for i in range(len(lines)):
+            # Strip the newline character.
+            lines[i] = lines[i].rstrip('\r\n')
+
+            # Pad if needed.
+            if len(lines[i]) != 80:
+                lines[i] = &quot;%-80s&quot; % lines[i]
+
+        # Return the fixed lines.
+        return lines
 
 
     def _mol_type(self, mol):
@@ -1806,6 +1831,9 @@
         if pdb_lines == []:
             raise RelaxError(&quot;The PDB file is empty.&quot;)
 
+        # Pre-process the lines, fixing PDB violations.
+        pdb_lines = self._validate_records(pdb_lines)
+
         # Process the different sections.
         pdb_lines = self._parse_pdb_title(pdb_lines)
         pdb_lines = self._parse_pdb_prim_struct(pdb_lines)

Modified: branches/double_rotor/test_suite/system_tests/structure.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/double_rotor/test_suite/system_tests/structure.py?rev=22510&amp;r1=22509&amp;r2=22510&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/double_rotor/test_suite/system_tests/structure.py?rev=22510&amp;r1=22509&amp;r2=22510&amp;view=diff</a>
==============================================================================
--- branches/double_rotor/test_suite/system_tests/structure.py  (original)
+++ branches/double_rotor/test_suite/system_tests/structure.py  Wed Mar 19 
08:54:24 2014
@@ -132,6 +132,16 @@
         lines = file.readlines()
         for i in range(len(lines)):
             self.assertEqual(contents[i], lines[i])
+
+
+    def test_bug_21814_pdb_no_80_space_padding(self):
+        &quot;&quot;&quot;Catch U{bug #21814&lt;<a  rel="nofollow" href="https://gna.org/bugs/?21814">https://gna.org/bugs/?21814</a>&gt;}, the PDB reading 
failure when not padded to 80 spaces.&quot;&quot;&quot;
+
+        # Path of the structure file.
+        path = status.install_path + 
sep+'test_suite'+sep+'shared_data'+sep+'structures'
+
+        # Load the file.
+        self.interpreter.structure.read_pdb('SpUreE_dimer_H_new', dir=path)
 
 
     def test_delete_empty(self):



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Wed Mar 19 11:00:02 2014</div>  
</body>
</html>
