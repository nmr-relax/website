<!-- MHonArc v2.6.19+ -->
<!--X-Subject: Re: r28082 &#45; /trunk/specific_analyses/relax_disp/data.py -->
<!--X-From-R13: "Sqjneq q'Ohiretar" &#60;rqjneqNaze&#45;erynk.pbz> -->
<!--X-Date: Mon, 23 Nov 2015 12:26:38 +0100 -->
<!--X-Message-Id: CAED9pY9jNZGg2YEXqmDdjMAPMcf9kCKeH68RpnM0fSNtpvkfRQ@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: E1a0WA6&#45;0004gP&#45;Kx@subversion.gna.org -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: r28082 - /trunk/specific_analyses/relax_disp/data.py -- November 23, 2015 - 12:26</title>
<link rel="stylesheet" type="text/css" href="/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="https://gna.org/images/gna.theme/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: r28082 - /trunk/specific_analyses/relax_disp/data.py</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00010" class="tabs">Index by Date</a> | <a href="threads.html#00010" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00009.html">Date Prev</a>] [<a href="msg00011.html">Date Next</a>] [<a href="msg00006.html">Thread Prev</a>] [<a href="msg00011.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Mon, 23 Nov 2015 12:26:08 +0100</li>
<li class="menuitem">
<em>Cc</em>: Paul Schanda &lt;paul.schanda@xxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:date:message-id:subject :from:to:cc:content-type; bh=7QPgS6qWZbO6u7uO6hOcWEypz6ZzhzJ/8ikBvRbzr48=; b=YlaPEUNRQmuLeJQvQRnXZohMpT4imepscFqZij/zbEtX7jFNfti6U4ec/bFrdQ/Hm7 UYf14SDbeYjo7X/rIMYGnhFV2Akm7aL4b5obowrQG1k2hnE1sbL4aWU7B60aRb2rQbFN 8AGrlbCQ8BGEUzJKSBfNsOSwDzxc0+1MwE3VZLIUlDKZJEUnArVOyRDJOeuLbsLyl1Mk SJoZ2jhklaVO6m6/xHo1Xjody2Ivht4lW5yKgT61yflqny23aWT6P2lu4oCnSzhvTtBv epJz1pgkzLLXc1KbG5ZE56WtC5akBIxLrJ1jDTge2GYeFI8TFZmkyACkt9twAxonwitv muzQ==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00010.html">CAED9pY9jNZGg2YEXqmDdjMAPMcf9kCKeH68RpnM0fSNtpvkfRQ@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;E1a0WA6-0004gP-Kx@subversion.gna.org&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on November 23, 2015 - 12:26:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">On 22 November 2015 at 16:02,  &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Author: tlinnet
Date: Sun Nov 22 16:02:42 2015
New Revision: 28082

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=28082&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=28082&amp;view=rev</a>
Log:
In the function of r2eff_read, in data module of the dispersion, added the 
possibilities to read
r2eff values which are replicated.

This is done first checking if the dispersion key exists in the r2eff 
dictionary.
If it exists, continue add 0.001 to the frequency until a new possibility 
exists.

This should help handle multiple R2eff points, as separate values and not 
taking any decision to average them.

Modified:
    trunk/specific_analyses/relax_disp/data.py

Modified: trunk/specific_analyses/relax_disp/data.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/trunk/specific_analyses/relax_disp/data.py?rev=28082&amp;r1=28081&amp;r2=28082&amp;view=diff">http://svn.gna.org/viewcvs/relax/trunk/specific_analyses/relax_disp/data.py?rev=28082&amp;r1=28081&amp;r2=28082&amp;view=diff</a>
==============================================================================
--- trunk/specific_analyses/relax_disp/data.py  (original)
+++ trunk/specific_analyses/relax_disp/data.py  Sun Nov 22 16:02:42 2015
@@ -2383,14 +2383,35 @@
         # The dispersion point key.
         point_key = return_param_key_from_data(exp_type=exp_type, frq=frq, 
offset=offset, point=disp_frq)

+        # Store the infinitesimal small change instead ?
+        store_infinitesimal = False
+
         # Store the R2eff data.
         if data_col:
             # Initialise if necessary.
             if not hasattr(spin, 'r2eff'):
                 spin.r2eff = {}

-            # Store.
-            spin.r2eff[point_key] = value
+            # First check that a replicate does not exists. And it if 
exists, find a new id with infinitesimal small change.
+            if point_key in spin.r2eff:
+                warn(RelaxWarning(&quot;The r2eff value key: %s already exists. 
\nAn infinitesimal small change to the dispersion frequency is performed, 
until a new point can be stored.&quot;%(point_key)))
+
+                # Store the current values.
+                disp_frq_infinitesimal = disp_frq
+                point_key_infinitesimal = point_key
+
+                # Continue until found
+                while point_key_infinitesimal == point_key:
+                    disp_frq_infinitesimal += 0.001
+                    point_key_infinitesimal = 
return_param_key_from_data(exp_type=exp_type, frq=frq, offset=offset, 
point=disp_frq_infinitesimal)
+
+                warn(RelaxWarning(&quot;The dispersion point is changed from 
%.3f to %.3f, and hhe new key: %s&quot;%(disp_frq, disp_frq_infinitesimal, 
point_key_infinitesimal)))
+                spin.r2eff[point_key_infinitesimal] = value
+                store_infinitesimal = True
+
+            # Else store.
+            else:
+                spin.r2eff[point_key] = value

         # Store the R2eff error.
         if error_col:
@@ -2398,8 +2419,26 @@
             if not hasattr(spin, 'r2eff_err'):
                 spin.r2eff_err = {}

-            # Store.
-            spin.r2eff_err[point_key] = error
+            # First check that a replicate does not exists. And it if 
exists, find a new id with infinitesimal small change.
+            if point_key in spin.r2eff_err:
+                warn(RelaxWarning(&quot;The r2eff error key: %s already exists. 
\nAn infinitesimal small change to the dispersion frequency is performed, 
until a new point can be stored.&quot;%(point_key)))
+
+                # Store the current values.
+                disp_frq_infinitesimal = disp_frq
+                point_key_infinitesimal = point_key
+
+                # Continue until found
+                while point_key_infinitesimal == point_key:
+                    disp_frq_infinitesimal += 0.001
+                    point_key_infinitesimal = 
return_param_key_from_data(exp_type=exp_type, frq=frq, offset=offset, 
point=disp_frq_infinitesimal)
+
+                warn(RelaxWarning(&quot;The dispersion point is changed from 
%.3f to %.3f, and hhe new key: %s\n&quot;%(disp_frq, disp_frq_infinitesimal, 
point_key_infinitesimal)))
+                spin.r2eff_err[point_key_infinitesimal] = error
+                store_infinitesimal = True
+
+            # Else store.
+            else:
+                spin.r2eff_err[point_key] = error

         # Data added.
         data_flag = True
@@ -2420,9 +2459,15 @@
     if data_flag:
         # Set the dispersion point frequency.
         if exp_type in EXP_TYPE_LIST_CPMG:
-            cpmg_setup(spectrum_id=id, cpmg_frq=disp_frq)
+            if store_infinitesimal:
+                cpmg_setup(spectrum_id=id, cpmg_frq=disp_frq_infinitesimal)
+            else:
+                cpmg_setup(spectrum_id=id, cpmg_frq=disp_frq)
         else:
-            spin_lock_field(spectrum_id=id, field=disp_frq)
+            if store_infinitesimal:
+                spin_lock_field(spectrum_id=id, 
field=disp_frq_infinitesimal)
+            else:
+                spin_lock_field(spectrum_id=id, field=disp_frq)
</pre></blockquote><pre style="margin: 0em;">

Hi Troels,

These changes look good!  The RelaxWarning given should make it
sufficiently clear to the user what is happening.  And the results
from an analysis should be reasonable.  Only one point though, you
should check the spelling (the word &quot;hhe&quot;).

Cheers,

Edward


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer">You are on the <a href="http://gna.org">Gna!</a> mail server.</div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Mon Nov 23 13:00:10 2015</div>  
</body>
</html>
