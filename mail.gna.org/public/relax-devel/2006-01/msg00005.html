<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: [Relax&#45;devel] handling of relaxation data in results files -->
<!--X-From-R13: Sqjneq q'Ohiretar <rqjneq.qnhiretarNtznvy.pbz> -->
<!--X-Date: Wed, 11 Jan 2006 10:52:20 +0100 -->
<!--X-Message-Id: 7f080ed10601110150qb829eb0n@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 7f080ed10601082043y67df1186r@mail.gmail.com -->
<!--X-Reference: 1136915697.8207.160.camel@bmbpcu338.leeds.ac.uk -->
<!--X-Reference: 7f080ed10601101831j45bdc89dl@mail.gmail.com -->
<!--X-Reference: 1136975811.8207.171.camel@bmbpcu338.leeds.ac.uk -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<title>Re: [Relax-devel] handling of relaxation data in results files -- January 11, 2006 - 10:52</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/style.css"> 
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h1>Re: [Relax-devel] handling of relaxation data in results files (January 11, 2006 - 10:52)</h1>
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00005" class="tabs">Index by Date</a> | <a href="threads.html#00005" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00004.html">Date Prev</a>] [<a href="msg00006.html">Date Next</a>] [<a href="msg00004.html">Thread Prev</a>] [<a href="msg00001.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<div class="boxtitle">Headers</div>
<div class="boxitemalt">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: <a href="mailto:relax-devel@DOMAIN.HIDDEN">relax-devel@xxxxxxx</a></li>
<li><em>Subject</em>: Re: [Relax-devel] handling of relaxation data in results files</li>
<li><em>From</em>: Edward d'Auvergne &lt;<a href="mailto:edward.dauvergne@DOMAIN.HIDDEN">edward.dauvergne@xxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Wed, 11 Jan 2006 20:50:47 +1100</li>
<li><em>Domainkey-signature</em>: a=rsa-sha1; q=dns; c=nofws; s=beta; d=gmail.com;	h=received:message-id:date:from:to:subject:in-reply-to:mime-version:content-type:content-transfer-encoding:content-disposition:references;	b=khavpe+72E+czDkM/ajXsJvm20Z5beu5Kpcw8s3P1q+SvunnNc0Y/0pi3tOHDIU7XzzY6+Oh9QMvpfKl68Eu4m27ySz+web7J/t1lhzpJtXz17sm0MwALQ72VvANaG8LIZV+efmQ5Rhp6Zx8HMNle8/0L8xCmMR0Vfg7e3+c+8w=</li>
<li><em>Message-id</em>: &lt;<a href="msg00005.html">7f080ed10601110150qb829eb0n@mail.gmail.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg00000.html">7f080ed10601082043y67df1186r@mail.gmail.com</a>&gt;	&lt;<a href="msg00003.html">1136915697.8207.160.camel@bmbpcu338.leeds.ac.uk</a>&gt;	&lt;<a href="msg00004.html">7f080ed10601101831j45bdc89dl@mail.gmail.com</a>&gt;	&lt;1136975811.8207.171.camel@bmbpcu338.leeds.ac.uk&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<p>&nbsp;</p>
<div class="data">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>It might be worth storing these emails on the relax-devel mailing
list.  Hitting reply wil,l by default, put the email address of the
sender rather than the mailing list.  Your last email (below) didn't
make it to the list.

The fix to the problem shouldn't be too difficult.  I'm quite busy
coding the relaxation curve fitting C modules at the moment but, if
you would like, I could fix the problem for you.

If you want to make a large number of changes to rip out the global
structures, I would recommend working with the 1.1 branch as the
changes are so big that it will be very difficult to migrate the
changes from 1.0 to 1.1.  A private branch can be created in the
repository directory 'branches/' which is a copy of 1.1.  The command
you can type would be something like:

svn cp svn+ssh://macraild@xxxxxxxxxxx/svn/relax/1.0
svn+ssh://macraild@xxxxxxxxxxx/svn/relax/branches/macraild

You can then checkout and hack this branch to bits (committing any
changes you make).  If the global structures can be successfully
removed, your private branch can then be merged back into the main 1.1
development branch.  If the hacking goes nowhere, you can remove the
branch.  Don't worry about damaging the repository, every action in
SVN can be reverted.  The private branch also means that your changes
won't effect anyone else who has checked out the head of the main
line.


On 11 Jan 2006 10:36:51 +0000, Chris MacRaild &lt;c.a.macraild@xxxxxxxxxxx&gt; wrote:
&gt; I'm working from the head of the 1.0 branch. I will make the quick fix
&gt; of data structure creation that you suggest - probably as easy to code
&gt; it from scratch as to go searching in the repository for your old fix. I
&gt; might also look a bit more deeply at the possibility of removing the
&gt; global data structures if I have a chance. Like I said, I think this is
&gt; the best prospect for a robust solution to the problem.
&gt;
&gt;
&gt; On Wed, 2006-01-11 at 02:31, Edward d'Auvergne wrote:
&gt; &gt; I think I know the exact problem.  I though I had written and properly
&gt; &gt; debugged the code to handle this situation.  The reason for having a
&gt; &gt; global set of data structures as well as residue specific structures
&gt; &gt; relating to the relaxation data is two fold.  That the global
&gt; &gt; structures keep track of all data which has been loaded into relax and
&gt; &gt; are used for internal accounting.  The residue specific structures
&gt; &gt; relate the actual data to it's field strength and data type (NOE, R1,
&gt; &gt; or R2) independently of which complete data sets were collected.
&gt; &gt;
&gt; &gt; In the results file, I found that recreating the global structures was
&gt; &gt; very difficult when each residue had a different number of data
&gt; &gt; points.  Rare ambiguities could even arise if there are no residues
&gt; &gt; which posses every possible data point.  Therefore I decided that the
&gt; &gt; global structures would be printed in the results file and if any data
&gt; &gt; (and error) points were missing, to replace it with None.  In reading
&gt; &gt; the file back in, relax should first recreate the global structures
&gt; &gt; using the data of the first 'selected' residue and then for each
&gt; &gt; residue when 'None' is encountered, recreate the residue specific data
&gt; &gt; structures appropriately.  I.e. drop the corresponding entries in the
&gt; &gt; 'remap_table', 'relax_data', etc.  The 'num_ri' should then be
&gt; &gt; calculated correctly and the contents of 'self.relax.data' for the run
&gt; &gt; should be identical to that prior to saving the results and
&gt; &gt; terminating the program.
&gt; &gt;
&gt; &gt; Two options are possible in fixing the bug.  The first would be to
&gt; &gt; destroy and abandon the global data structures.  This may, however,
&gt; &gt; have a few unintended consequences that would require a bit of
&gt; &gt; recoding.  The second option would be to fix the data structure
&gt; &gt; recreation - which would probably be less disruptive.
&gt; &gt;
&gt; &gt; I thought I had fixed this exact same problem quite a while back by
&gt; &gt; changing the recreation of the residue specific structures.  The code
&gt; &gt; could have been lost though.  Before I imported relax into the
&gt; &gt; subversion database, I think I accidentally overwrote a large number
&gt; &gt; of fixes I made to relax with an earlier version.  The code is
&gt; &gt; probably hidden somewhere deep inside the relax SVN database, but I
&gt; &gt; don't know where it is or what exactly was lost.  Keeping track of
&gt; &gt; code is quite error prone if a versioning system is not used!
&gt; &gt;
&gt; &gt; Oh, which code base are you working from?  Are you using one of the
&gt; &gt; stable 1.0.x releases, have you checked out the head of the 1.0
&gt; &gt; branch, or are you working with the brand new 1.1 development branch
&gt; &gt; I've created for the large number of changes I'm currently making?
&gt; &gt; I'll probably try to get the fix merged into both 1.0 and 1.1, and
&gt; &gt; then possibly release stable version 1.0.10 as a branch off the 1.0
&gt; &gt; line.  I've stabilised the 1.1 line so that any problems in the
&gt; &gt; relaxation curve fitting C modules I'm writing should not affect the
&gt; &gt; model-free code.
&gt; &gt;
&gt; &gt;
&gt; &gt; On 10 Jan 2006 17:54:57 +0000, Chris MacRaild &lt;c.a.macraild@xxxxxxxxxxx&gt; wrote:
&gt; &gt; &gt; Hi,
&gt; &gt; &gt;
&gt; &gt; &gt; For a while now I have been using relax with a dataset where not all
&gt; &gt; &gt; residues have the same same number of relaxation values (I have data at
&gt; &gt; &gt; 3 fields, but the quality varies significantly, and some of the
&gt; &gt; &gt; relaxation decay fits I am not happy with, so I have excluded the
&gt; &gt; &gt; corresponding data). This has caused no obvious problems in most cases,
&gt; &gt; &gt; except that results file io fails in some interesting ways. I've had a
&gt; &gt; &gt; bit of a poke in the code to try and fix this, but it has raised a few
&gt; &gt; &gt; issues that I thought I should run past you before I hack too hard.
&gt; &gt; &gt;
&gt; &gt; &gt; Of course when I load this data from the original data files, the
&gt; &gt; &gt; relevant residue data structures all behave correctly -
&gt; &gt; &gt; self.relax.data.res[runName][res].num_ri is correct for each residue, as
&gt; &gt; &gt; are the residue specific remap_table, ri_labels, etc.
&gt; &gt; &gt;
&gt; &gt; &gt; When I do a results.write(), things change in the results file: all
&gt; &gt; &gt; residues now have the same remap_table, etc, and missing Ri values and
&gt; &gt; &gt; errors are given the value None. This in itself makes some sense in the
&gt; &gt; &gt; context of the tabular file format, but is inconsistent with the way
&gt; &gt; &gt; things are handled in the data structures above.
&gt; &gt; &gt;
&gt; &gt; &gt; Just in case I'm not being clear, an example. Lets say residue 1 has all
&gt; &gt; &gt; 9 data points, but residue 2 is missing the first data point, so only
&gt; &gt; &gt; has 8. On initially loading the data files, I have:
&gt; &gt; &gt; self.relax.data.res[runName][1].num_ri = 9
&gt; &gt; &gt; self.relax.data.res[runName][1].remap_table = [0,1,2,0,1,2,0,1,2]
&gt; &gt; &gt; self.relax.data.res[runName][1].relax_data = [1.214, 0.896, 0.6817,
&gt; &gt; &gt; 18.64, 20.48, 21.89, 0.769, 0.858, 0.893]
&gt; &gt; &gt;
&gt; &gt; &gt; self.relax.data.res[runName][2].num_ri = 8
&gt; &gt; &gt; self.relax.data.res[runName][2].remap_table = [1,2,0,1,2,0,1,2]
&gt; &gt; &gt; self.relax.data.res[runName][2].relax_data = [0.896, 0.6817, 18.64,
&gt; &gt; &gt; 20.48, 21.89, 0.769, 0.858, 0.893]
&gt; &gt; &gt;
&gt; &gt; &gt; But the results file looks like:
&gt; &gt; &gt; Res  ...    remap_table   ...     relax_data
&gt; &gt; &gt; 1           [0,1,2,0,1,2,0,1,2]   [1.214, 0.896, 0.6817, 18.64, 20.48,
&gt; &gt; &gt; 21.89, 0.769, 0.858, 0.893]
&gt; &gt; &gt; 2           [0,1,2,0,1,2,0,1,2]   [None, 0.896, 0.6817, 18.64, 20.48,
&gt; &gt; &gt; 21.89, 0.769, 0.858, 0.893]
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; This inconsistency comes back to haunt us on results.read(). The first
&gt; &gt; &gt; problem is that Ri values and errors get read in as None. This causes
&gt; &gt; &gt; subsequent minimisation to fail (by some wonder of python's implicit
&gt; &gt; &gt; type conversions, None &lt; 0.0 evaluates as True so minimisation fails
&gt; &gt; &gt; with negative errors!). The second problem relates to the fact that
&gt; &gt; &gt; ri_labels, remap_table, etc are defined twice in the relax data
&gt; &gt; &gt; structures, once at self.relax.data.res[runName][res].ri_labels, and
&gt; &gt; &gt; again at self.relax.data.ri_labels[runName].
&gt; &gt; &gt;
&gt; &gt; &gt; read_columnar_relax_data() tries to set data.ri_labels[runName], etc.
&gt; &gt; &gt; from the first line that is read from the results file. Then we have:
&gt; &gt; &gt;
&gt; &gt; &gt;     # Test if the relaxation data is consistent.
&gt; &gt; &gt;     if self.ri_labels != eval(self.file_line[self.col['ri_labels']]) or
&gt; &gt; &gt; self.remap_table != eval(self.file_line[self.col['remap_table']]) or
&gt; &gt; &gt; self.frq_labels != eval(self.file_line[self.col['frq_labels']]) or
&gt; &gt; &gt; self.frq != eval(self.file_line[self.col['frq']]):
&gt; &gt; &gt;         raise RelaxError, &quot;The relaxation data is not consistent for all
&gt; &gt; &gt; residues.&quot;
&gt; &gt; &gt;
&gt; &gt; &gt; This checks that the ri_labels, etc, for each line of the results file
&gt; &gt; &gt; is the same as that from the first line read. This exception is never
&gt; &gt; &gt; raised, because these values are always consistent in the results file,
&gt; &gt; &gt; even if they weren't in the original data, as I've outlined above. It
&gt; &gt; &gt; does, however, seem to be an attempt to stop me using data where not all
&gt; &gt; &gt; residues have the same same number of relaxation values. It might be
&gt; &gt; &gt; that I'm missing something, but I can see no good reason why I should be
&gt; &gt; &gt; stopped, and indeed using this type of data has caused me no other
&gt; &gt; &gt; problems that I can see.
&gt; &gt; &gt;
&gt; &gt; &gt; So, the 'big issues' for your consideration:
&gt; &gt; &gt;  - Is there any good reason for having ri_labels, etc defined at both
&gt; &gt; &gt; the level of the run (at data.ri_labels[runName]) and at the level of
&gt; &gt; &gt; the residue (at data.res[runName][res].ri_labels)? We have seen other
&gt; &gt; &gt; bugs associated with these duplications, and it does seem to be asking
&gt; &gt; &gt; for trouble.
&gt; &gt; &gt;  - A decision needs to be made about which of these parameters are
&gt; &gt; &gt; expected to be constant across all residues in a run, and which are
&gt; &gt; &gt; potentially allowed to vary. Ideally, it seems to me, those which are
&gt; &gt; &gt; constant across the run will be defined only at
&gt; &gt; &gt; data.param_name[runName], and those that might vary from one residue to
&gt; &gt; &gt; another will be at data.res[runName][res].param_name (and only there).
&gt; &gt; &gt; Again, in my opinion, what ever convention is adopted in the internal
&gt; &gt; &gt; data structures of relax should also be reflected in the way the
&gt; &gt; &gt; parameter values are output to the results file.
&gt; &gt; &gt;
&gt; &gt; &gt; Anyway, let me know what you think.  I'm happy to have a hack at
&gt; &gt; &gt; resolving these issues which ever way you decide.
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; Chris
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; _______________________________________________
&gt; &gt; &gt; Relax-devel mailing list
&gt; &gt; &gt; Relax-devel@xxxxxxx
&gt; &gt; &gt; <a  href="/mail.gna.org/listinfo/relax-devel">https://mail.gna.org/listinfo/relax-devel</a>
&gt; &gt; &gt;
&gt; &gt;
&gt; &gt; _______________________________________________
&gt; &gt; Relax-devel mailing list
&gt; &gt; Relax-devel@xxxxxxx
&gt; &gt; <a  href="/mail.gna.org/listinfo/relax-devel">https://mail.gna.org/listinfo/relax-devel</a>
&gt; &gt;
&gt;
&gt;


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00000" href="msg00000.html">[Relax-devel] Creation of an unstable development fork from 1.0	called 1.1.</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00003" href="msg00003.html">[Relax-devel] handling of relaxation data in results files</a></strong>
<ul><li><em>From:</em> Chris MacRaild</li></ul></li>
<li><strong><a name="00004" href="msg00004.html">Re: [Relax-devel] handling of relaxation data in results files</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<div class="boxtitle">Related Mails</div>
<div class="boxitemalt">
<ul>
<li>Prev by Date:
<strong><a href="msg00004.html">Re: [Relax-devel] handling of relaxation data in results files</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00006.html">[Relax-devel] Relaxation data structure bug fix.</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00004.html">Re: [Relax-devel] handling of relaxation data in results files</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00001.html">[Relax-devel] Re: python to c++</a></strong>
</li>

</ul>
</div>
<br /><br /><br />

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Thu Jan 12 05:40:21 2006</div>  
</body>
</html>
