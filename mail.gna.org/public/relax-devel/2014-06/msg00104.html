<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: r23737 &#45; /branches/disp_spin_speed/lib/dispersion/cr72.py -->
<!--X-From-R13: Febryf Szgrxæe Zvaarg &#60;gyvaargNaze&#45;erynk.pbz> -->
<!--X-Date: Tue, 10 Jun 2014 14:30:11 +0200 -->
<!--X-Message-Id: CA+CBx2MqHUgOEp=En9W7M8EU30fUMsSFLsRSvnmH1YmbfMe+JQ@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: E1WthCt&#45;0008Lo&#45;SN@subversion.gna.org -->
<!--X-Reference: CAED9pY9DyFPjwh00o+XQUqdjHTf+DeF3OvXp3gKi=mkLv81c2w@mail.gmail.com -->
<!--X-Reference: CA+CBx2PEcWMnMTQKzSTOg3cCr5obhT_V32HuceUEr6QbEkbScA@mail.gmail.com -->
<!--X-Reference: CA+CBx2PewfTQR&#45;WQTWXC24zGXm8rFEtq2erWuRtOra=7NUZUfA@mail.gmail.com -->
<!--X-Reference: CAED9pY_7j+Ps8FmXJ_yG_q9a0+7=d4xh4WzViO1+1NDHMD4qcQ@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: r23737 - /branches/disp_spin_speed/lib/dispersion/cr72.py -- June 10, 2014 - 14:30</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: r23737 - /branches/disp_spin_speed/lib/dispersion/cr72.py</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00104" class="tabs">Index by Date</a> | <a href="threads.html#00104" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00103.html">Date Prev</a>] [<a href="msg00105.html">Date Next</a>] [<a href="msg00097.html">Thread Prev</a>] [<a href="msg00110.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;Edward d'Auvergne&quot; &lt;edward@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Tue, 10 Jun 2014 14:29:21 +0200</li>
<li class="menuitem">
<em>Cc</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:from:date:message-id :subject:to:cc:content-type:content-transfer-encoding; bh=NXxvJuiGYEhVrCzswtZIvnwqUsyMOtxAZQFMIVMBXzg=; b=LQEgh0/X857Uc3C1XYoT+t7vaFcPNV5RGUDDKkeeOimOjEMK9KO9ggcQpT1OJ4jlGw 6xFJZ52VQ8lF9VBVTohjQB3auHe7sNuosT+eqT0PlnYHTflcx9DVqtuDCjKlvsTx0VvM y/EIdPkePTVa4DE/TLr/n0rVUXPDgGjBMV6n3rGdLoxZ6hoGYmU4JT53AEmJNlN/M3g4 bX/YhoEmgT/Vkdq1gQ8OyJDakTK2vItLx6ChqH9+R2fl1zJ5B8GbaJ09/uko1e3lATRF EoG09/uJdphXXI66IZiRnxZT376oYOJLh8I2aayvqpsTykTbDeQSHlV4OQZ93BjByvSP u2Vw==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;CA+CBx2MqHUgOEp=En9W7M8EU30fUMsSFLsRSvnmH1YmbfMe+JQ@mail.gmail.com&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;E1WthCt-0008Lo-SN@subversion.gna.org&gt; &lt;CAED9pY9DyFPjwh00o+XQUqdjHTf+DeF3OvXp3gKi=mkLv81c2w@mail.gmail.com&gt; &lt;<a href="msg00091.html">CA+CBx2PEcWMnMTQKzSTOg3cCr5obhT_V32HuceUEr6QbEkbScA@mail.gmail.com</a>&gt; &lt;CA+CBx2PewfTQR-WQTWXC24zGXm8rFEtq2erWuRtOra=7NUZUfA@mail.gmail.com&gt; &lt;CAED9pY_7j+Ps8FmXJ_yG_q9a0+7=d4xh4WzViO1+1NDHMD4qcQ@mail.gmail.com&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Troels Emtekær Linnet</strong> on June 10, 2014 - 14:30:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi Edward.

There is a very very smart trick for that.
Masked arrays!

One can:
mask_dw_t = False
# Test if dw is zero.
if allclose(dw, zeros(dw.shape)):
    mask_dw_t = True
    mask_dw = ma.masked_values(dw, 0.0)

# Calculate R2eff.
R2eff = r20_kex - cpmg_frqs * arccosh( fact )

# Replace data in array.
if mask_dw_t:
    R2eff[mask_dw] = r20a

back_calc[:] = R2eff



2014-06-10 13:52 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,

I think the 'no Rex' tests and what R2eff is set to needs to be
thought out carefully.  We have two cases:

    - The spin independent parameters pA and kex.  These will affect
the R2eff values for all spins of the cluster.

    - The spin dependent parameter dw.  This will effect the R2eff
values for individual spins, and catching this and dealing with it
correctly might be much harder for a spin cluster.

The first case is simplest, catch single pA and kex values.  So numpy
operations are not needed there.  For the second, I'm not sure how we
handle that.  But more importantly we also need to work out what to do
with the R2eff values in that case.  How do we catch dw = 0.0 for one
spin but not the others, and then set the R2eff values to R20 for just
that spin?  But also let the R2eff values be calculated for all other
spins.  Maybe it is better to not catch dw values and to deal with
that value later in the lib.dispersion functions?

Regards,

Edward




On 10 June 2014 12:05, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Here are some hints:

<a  rel="nofollow" href="http://stackoverflow.com/questions/10580676/comparing-two-numpy-arrays-for-equality">http://stackoverflow.com/questions/10580676/comparing-two-numpy-arrays-for-equality</a>

It would be the timing of:

numpy.allclose
<a  rel="nofollow" href="http://docs.scipy.org/doc/numpy/reference/generated/numpy.allclose.html">http://docs.scipy.org/doc/numpy/reference/generated/numpy.allclose.html</a>

numpy.isclose
<a  rel="nofollow" href="http://docs.scipy.org/doc/numpy/reference/generated/numpy.isclose.html#numpy.isclose">http://docs.scipy.org/doc/numpy/reference/generated/numpy.isclose.html#numpy.isclose</a>

numpy.ma
<a  rel="nofollow" href="http://docs.scipy.org/doc/numpy/reference/generated/numpy.ma.masked_values.html#numpy.ma.masked_values">http://docs.scipy.org/doc/numpy/reference/generated/numpy.ma.masked_values.html#numpy.ma.masked_values</a>


2014-06-10 11:57 GMT+02:00 Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Edward.

I thought the same.

One could send in a ones and zeros numpy array in function.
Set them to standard to None.

If they are None, then create them.

One can see on the timings, that
r2eff_CR72
numeric.py:2056(allclose)

are the most time consuming.
Maybe there is a faster way for allclose.
Masking ???


        1    0.000    0.000    2.084    2.084 &lt;string&gt;:1(&lt;module&gt;)
        1    0.002    0.002    2.084    2.084 
profiling_cr72.py:441(cluster)
     1000    0.002    0.000    2.005    0.002 profiling_cr72.py:405(calc)
     1000    0.034    0.000    2.003    0.002
relax_disp.py:995(func_CR72_full)
     1000    0.141    0.000    1.960    0.002
relax_disp.py:524(calc_CR72_chi2)
     1300    1.100    0.001    1.676    0.001 cr72.py:101(r2eff_CR72)
     4300    0.245    0.000    0.507    0.000 numeric.py:2056(allclose)
     3000    0.037    0.000    0.164    0.000 shape_base.py:761(tile)
    17828    0.126    0.000    0.126    0.000 {method 'reduce' of
'numpy.ufunc' objects}
     4000    0.110    0.000    0.110    0.000 {method 'repeat' of
'numpy.ndarray' objects}
     8609    0.011    0.000    0.086    0.000 fromnumeric.py:1762(any)





2014-06-10 11:44 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:

</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Troels,

For speed, maybe you should send in the single value parameters
together with the array versions into the lib.dispersion modules?  The
check:

+        if np.allclose(dw, np.zeros(dw.shape)) or np.allclose(pA,
np.ones(dw.shape)) or np.allclose(kex, np.zeros(dw.shape)):

will be very expensive.

Regards,

Edward



On 8 June 2014 19:48,  &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Author: tlinnet
Date: Sun Jun  8 19:48:35 2014
New Revision: 23737

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=23737&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=23737&amp;view=rev</a>
Log:
Re-implemented safety checks in lib/dispersion/cr72.py.

This is now implemented for both rank-1 float array and of higher
dimensions.

This makes the unit tests pass for multi dimensional computing.

Task #7807 (<a  rel="nofollow" href="https://web.archive.org/web/https://gna.org/task/index.php?7807">https://gna.org/task/index.php?7807</a>): Speed-up of 
dispersion
models for Clustered analysis.

Modified:
    branches/disp_spin_speed/lib/dispersion/cr72.py

Modified: branches/disp_spin_speed/lib/dispersion/cr72.py
URL:
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/disp_spin_speed/lib/dispersion/cr72.py?rev=23737&amp;r1=23736&amp;r2=23737&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/disp_spin_speed/lib/dispersion/cr72.py?rev=23737&amp;r1=23736&amp;r2=23737&amp;view=diff</a>

==============================================================================
--- branches/disp_spin_speed/lib/dispersion/cr72.py     (original)
+++ branches/disp_spin_speed/lib/dispersion/cr72.py     Sun Jun  8
19:48:35 2014
@@ -128,9 +128,15 @@
         rank_1 = False

     # Catch parameter values that will result in no exchange, 
returning
flat R2eff = R20 lines (when kex = 0.0, k_AB = 0.0).
+    # For rank-1 float array.
     if rank_1:
         if dw == 0.0 or pA == 1.0 or kex == 0.0:
             back_calc[:] = array([r20a]*num_points)
+            return
+    # For higher dimensions, return same structure.
+    else:
+        if np.allclose(dw, np.zeros(dw.shape)) or np.allclose(pA,
np.ones(dw.shape)) or np.allclose(kex, np.zeros(dw.shape)):
+            back_calc[:] = r20a
             return

     # The B population.
@@ -165,16 +171,23 @@

     # Catch math domain error of cosh(val &gt; 710).
     # This is when etapos &gt; 710.
-    if rank_1:
-        if max(etapos) &gt; 700:
+    if max(etapos) &gt; 700:
+        if rank_1:
             back_calc[:] = array([r20a]*num_points)
+            return
+        # For higher dimensions, return same structure.
+        else:
+            back_calc[:] = r20a
             return

     # The arccosh argument - catch invalid values.
     fact = Dpos * cosh(etapos) - Dneg * cos(etaneg)
-    if rank_1:
-        if min(fact) &lt; 1.0:
+    if min(fact) &lt; 1.0:
+        if rank_1:
             back_calc[:] = array([r20_kex]*num_points)
+            return
+        else:
+            back_calc[:] = r20_kex
             return

     # Calculate R2eff.
@@ -182,8 +195,10 @@

     # Catch errors, taking a sum over array is the fastest way to 
check
for
     # +/- inf (infinity) and nan (not a number).
-    if rank_1:
-        if not isfinite(sum(R2eff)):
+    if not isfinite(sum(R2eff)):
+        if rank_1:
             R2eff = array([1e100]*num_points)
+        else:
+            R2eff = np.ones(R2eff.shape) * 1e100

     back_calc[:] = R2eff


_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-commits mailing list
relax-commits@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="http://www.nmr-relax.com/mail.gna.org/listinfo/relax-commits">https://mail.gna.org/listinfo/relax-commits</a>
</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-devel mailing list
relax-devel@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="http://www.nmr-relax.com/mail.gna.org/listinfo/relax-devel">https://mail.gna.org/listinfo/relax-devel</a>
</pre></blockquote><pre style="margin: 0em;">


</pre></blockquote></blockquote></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00110" href="msg00110.html">Re: r23737 - /branches/disp_spin_speed/lib/dispersion/cr72.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00087" href="msg00087.html">Re: r23737 - /branches/disp_spin_speed/lib/dispersion/cr72.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00091" href="msg00091.html">Re: r23737 - /branches/disp_spin_speed/lib/dispersion/cr72.py</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00093" href="msg00093.html">Re: r23737 - /branches/disp_spin_speed/lib/dispersion/cr72.py</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00097" href="msg00097.html">Re: r23737 - /branches/disp_spin_speed/lib/dispersion/cr72.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Tue Jun 10 15:00:11 2014</div>  
</body>
</html>
