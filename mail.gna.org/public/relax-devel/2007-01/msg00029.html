<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: Redesign of the relax data model: 2. A new run concept -->
<!--X-From-R13: "Sqjneq q'Ohiretar" <rqjneq.qnhiretarNtznvy.pbz> -->
<!--X-Date: Mon, 15 Jan 2007 07:44:49 +0100 -->
<!--X-Message-Id: 7f080ed10701142244ne7d107bl84582ce604d1888e@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: f001463a0701071314i61276e67hde685fe3afb8fe42@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: Redesign of the relax data model: 2. A new run concept -- January 15, 2007 - 07:44</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: Redesign of the relax data model: 2. A new run concept</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00029" class="tabs">Index by Date</a> | <a href="threads.html#00029" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00028.html">Date Prev</a>] [<a href="msg00030.html">Date Next</a>] [<a href="msg00023.html">Thread Prev</a>] [<a href="msg00035.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;gary thompson&quot; &lt;garyt@xxxxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Mon, 15 Jan 2007 17:44:08 +1100</li>
<li class="menuitem">
<em>Cc</em>: relax-devel@xxxxxxx</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00029.html">7f080ed10701142244ne7d107bl84582ce604d1888e@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;<a href="msg00013.html">f001463a0701071314i61276e67hde685fe3afb8fe42@mail.gmail.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Edward d'Auvergne</strong> on January 15, 2007 - 07:44:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<tt>On 1/8/07, gary thompson &lt;garyt@xxxxxxxxxxxxxxx&gt; wrote:
</tt><blockquote class="blockquote"><pre style="margin: 0em;">Sorry for the delay in replying but this needed some uninterrupted
time for me to sort through it
</pre></blockquote><pre style="margin: 0em;"><br>Sorry for my delays.  The proposed changes of the redesign are quite
drastic.  Your timing isn't too late though and the ideas in your
three posts are very useful:</pre><br>
<pre style="margin: 0em;">* re: Redesign of the relax data model: 2. A new run concept;
<a  href="https://mail.gna.org/public/relax-devel/2007-01/msg00013.html">https://mail.gna.org/public/relax-devel/2007-01/msg00013.html</a>
(Message-id: &lt;f001463a0701071314i61276e67hde685fe3afb8fe42@xxxxxxxxxxxxxx&gt;)</pre><br>
<pre style="margin: 0em;">* re: Redesign of the relax data model: 3. Molecules, residues, and
spins; <a  href="https://mail.gna.org/public/relax-devel/2007-01/msg00014.html">https://mail.gna.org/public/relax-devel/2007-01/msg00014.html</a>
(Message-id: &lt;f001463a0701071417w6bd7927cp8fdd052e698575ec@xxxxxxxxxxxxxx&gt;)</pre><br>
<pre style="margin: 0em;">* Re: redesign of the relax data model: 1. Why change?;
<a  href="https://mail.gna.org/public/relax-devel/2007-01/msg00015.html">https://mail.gna.org/public/relax-devel/2007-01/msg00015.html</a>
(Message-id: &lt;f001463a0701071445i6a2a4e3bid302bb515a40de3c@xxxxxxxxxxxxxx&gt;)</pre><br>
<pre style="margin: 0em;">What I'll do is try to break the ideas into those which can be
incorporated into the proposed redesign and those which can be part of
their own subsequent redesign and sanitising of the relax internals.
As I have no formal training as a programmer, your input about design
patterns and anti-patterns is much appreciated (Wikipedia is very
useful for learning about these concepts).  As some of your
suggestions involve drastic changes as well, I think that incremental
changes to the internals would be better than doing it all in one hit.
As part of the redesign, I'm planning on moving through the code
function by function rewriting the function docstrings, writing unit
tests, and removing  'self.run' (see the file
'docs/data_model_redesign' in the 1.3 line for more details).  If we
had unit test for all functions and methods in relax, then one massive
refactorisation of all the internals would make more sense.  Therefore
a lot of the removal of poor design choices (anti-patterns) could
occur after a comprehensive unit test framework has been implemented.</pre><br>
<br>
<blockquote class="blockquote"><pre style="margin: 0em;">&gt;   Posted by Edward d'Auvergne on October 11, 2006 - 10:32:
&gt;
&gt;   On Wed, 2006-10-11 at 17:02 +1000, Edward d'Auvergne wrote:
&gt;
&gt;       This post is proposal for the redesign the relax data model.  This 
will
&gt;       affect how data is input into the program, how data is selected, how
&gt;       molecular structures are handled, how spin systems are handled, and 
how
&gt;       many other parts of relax function.  Importantly the internal 
structure
&gt;       of 'self.relax.data' will completely change.  These modifications will
&gt;       essentially break every part of relax (the isolated code in the
&gt;       directories 'minimise', 'maths_fns', and 'docs' will be safe from the
&gt;       carnage, as will a few files in the base directory).  If you have any
&gt;       ideas for extending or improving the proposed data model, can see any
&gt;       short-comings, deficiencies, or flaws, are familiar with the PDB
&gt;       conventions, etc., your input is very much sought after.  The changes
&gt;       should occur in the 1.3 line of the repository.  1.2 versions will be
&gt;       unaffected - scripts will remain compatible and the 1.2 line will
&gt;       continue to be supported with bug fixes, etc.
&gt;
&gt;       I have to apologise in advance for the size of this proposal, to
&gt;       simplify it I have divided the text into numbered sections.  Once this
&gt;       initial parent message has been sent I will respond to it with the 
text
&gt;       of the 4 major sections.  This will allow 4 major threads to branch 
off
&gt;       from this message on the mailing list archive
&gt;       (<a  href="https://mail.gna.org/public/relax-devel">https://mail.gna.org/public/relax-devel</a>).  If you have an opinion,
&gt;       idea, etc. about a specific section, could you please post a separate
&gt;       message in response to the relevant major section post?  Also if you
&gt;       have unrelated ideas for one of these sections, could you post these 
as
&gt;       separate messages as well?  For example if you have separate points
&gt;       about sections 3.1 and 3.5.1, two different posts responding to the
&gt;       parent Section 3 post would be appreciated.  Thanks.  This will help 
to
&gt;       focus each discussion point into specific threads.
&gt;
&gt;       Edward
&gt;
&gt;
&gt;
&gt;       Redesign of the relax data model
&gt;
&gt;       Index:
&gt;       1.  Why change?
&gt;           1.1  The runs
&gt;           1.2  The molecules
&gt;           1.3  The residues
&gt;           1.4  The spins
&gt;       2.  A new run concept
&gt;           2.1  Parcelling up an abstract space
&gt;           2.2  The run data model
&gt;           2.3  The pipe concept
&gt;       3.  Molecules, residues, and spins
&gt;           3.1  The spin data model
&gt;           3.2  The data selection concept - identifying spin systems
&gt;               3.2.1  Function arguments
&gt;               3.2.2  NH data of a single protein macromolecule
&gt;               3.2.3  A single organic molecule (non-polymeric)
&gt;               3.2.4  A single RNA or DNA macromolecule
&gt;               3.2.5  Complexes
&gt;           3.3  Regular expression
&gt;           3.4  The spin loop
&gt;           3.5  Molecule, sequence, and spin user function classes
&gt;               3.5.1  The 'molecule' user function class
&gt;               3.5.2  The 'sequence' user function class
&gt;               3.5.3  The 'spin' user function class
&gt;           3.6  The input and output files
&gt;       4.  Conclusion
&gt;
&gt;
&gt;
&gt;   Before reading this post, please read the previous posts:
&gt;
&gt;   * The parent message 'Redesign of the relax data model:  A HOWTO for
&gt;   breaking relax.' located at
&gt;   <a  href="https://mail.gna.org/public/relax-devel/2006-10/msg00053.html">https://mail.gna.org/public/relax-devel/2006-10/msg00053.html</a>
&gt;   (Message-id:
&gt;   &lt;1160550133.9523.54.camel@xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&gt;).
&gt;
&gt;   * Section 1 'Redesign of the relax data model:  1.  Why change?' located
&gt;   at <a  href="https://mail.gna.org/public/relax-devel/2006-10/msg00054.html">https://mail.gna.org/public/relax-devel/2006-10/msg00054.html</a>
&gt;   (Message-id:
&gt;   &lt;1160551172.9523.60.camel@xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&gt;).
&gt;
&gt;
&gt;
&gt;   2.  A new run concept
&gt;
&gt;   2.1  Parcelling up an abstract space
&gt;
&gt;   The general idea is to further increase the prominence of the 'run'.
&gt;   Rather than relax executing in an abstract space where the 'run' is
&gt;   passed into each user function as necessary, the idea is that relax
&gt;   executes within a space dedicated to a certain 'run'.  So if at the
&gt;   relax prompt, you could type a user function such as:
&gt;
&gt;   relax&gt; run.current()
&gt;   'm8'
&gt;
&gt;   By working in the 'm8' run space, each user function can be executed
&gt;   without the need for the 'run' argument.  Other user functions, such as
&gt;   'run.switch()', can be used to change between runs.</pre><br>
<pre style="margin: 0em;">I agree that carrying the run argument throughout the data structure
is an annoying problem and I like the solution but here is an
extension to it that may enegender more felxibility</pre><br>
<pre style="margin: 0em;">There is an interesting parallel here... basically the proposal
consists of the proposal that there should always be a current run
(much in the same way that most shells have a present working
directory). However, it is worth noting that many unix tools take a
directory argument which overrides the current working directory and
this engenders both simplicity and flexibility as to which 'context' a
command runs in.
</pre></blockquote><pre style="margin: 0em;"><br>This is analogous to Chris' idea of the 'runs' keyword argument for
all user functions
(<a  href="https://mail.gna.org/public/relax-devel/2006-10/msg00060.html">https://mail.gna.org/public/relax-devel/2006-10/msg00060.html</a>,
Message-id: &lt;1160562239.14487.98.camel@mrspell&gt;).  By default, not
supplying the 'runs' argument will cause the user function will
operate on the current run whereas supplying the argument will cause
the user function to operate on one or more alternative runs.</pre><br>
<br>
<blockquote class="blockquote"><pre style="margin: 0em;">&gt;   2.2  The run data model
&gt;
&gt;   The current run name could be stored in the single data structure
&gt;   'self.relax.run'.  The relax data structure could then be accessed by
&gt;   typing 'self.relax.data[self.relax.run]'.  I.e. 'self.relax.data' is a
&gt;   DictType object (it has key-value pairs) in which the run name key is
&gt;   associated with a specific data container.  As most data structures in
&gt;   the current relax data model are associated with a run (e.g.
&gt;   'self.relax.data.diff[self.run]', 'self.relax.data.res[self.run]',
&gt;   'self.relax.data.pdb[self.run]', etc), the data model significantly
&gt;   simplifies.</pre><br>
<pre style="margin: 0em;">now following on from the comment above I would suggest that a data
structure  containing a stack of runs be a good idea.. consider a
command that took a run parameter:</pre><br>
<pre style="margin: 0em;">def command(run=None):
   self.relax.run.push(run)
   ... do something
   self.relax.run.pop()
</pre></blockquote><pre style="margin: 0em;"><br>Is this stack idea a suggestion for the UI design (i.e. the end user
sees it) or is it an internal implementation suggestion for Chris'
runs argument idea?</pre><br>
<br>
<blockquote class="blockquote"><pre style="margin: 0em;">now there are some intrinsic problems with this setup (basically it is
far too easy to pop and then degugging really does become a
nightmare.... However, python actually has at least three solutions to
this(not all ow which are available in version 2.4 the with solution
requires 2.5)</pre><br>
<pre style="margin: 0em;">1. decorators (python 2.4)
   @relax_command
   def command():
      ...do something</pre><br>
<pre style="margin: 0em;">   @relax_command then wraps command in a self.relax.run.push/pop(run) pair</pre><br>
<pre style="margin: 0em;"><br>2. define relax_command as a functor and then have a default
relax_command functor that wraps around with a push and a pop</pre><br>
<pre style="margin: 0em;">   class relax_command():
      def __init__(self,function):
          self.function=function
      def __call__(self,*args):
        #find run arg and save in local variable and remove from args
        self.relax.push()
        self.function(args)
        self.relax.pop()</pre><br>
<pre style="margin: 0em;">3. the with statement (python 2.5)
see 
<a  href="http://www.dalkescientific.com/writings/diary/archive/2006/08/23/with_statement.html">http://www.dalkescientific.com/writings/diary/archive/2006/08/23/with_statement.html</a></pre><br>
<pre style="margin: 0em;">Some asides</pre><br>
<pre style="margin: 0em;">A.  I believe the runs that are passed around in relax are strings
which are then used to lookup data in a map. Why not just have
(runs/pipes) as objects... Then for example the call</pre><br>
<pre style="margin: 0em;">self.relax.data[self.relax.run]</pre><br>
<pre style="margin: 0em;">above becomes</pre><br>
<tt>self.relax.run.data a much more object orientated and encapsulated structure
</tt></blockquote><pre style="margin: 0em;"><br>You still need a list (array) or dictionary (hash) type structure to
store multiple run objects.  'self.relax.data' would be a dictionary
type object with key-value pairs, the key being the run name and the
value being a standard class instance object containing all the data
associated with the run as objects.  The dictionary would be more
logical than an array in this case.</pre><br>
<br>
<blockquote class="blockquote"><pre style="margin: 0em;">B. There is a twist here, if relax is a global variable referenced by
everything if you want to run relax in a threaded manner
(multiprocessor machines are becoming more and more popular) then
self.relax poses a problem as we may need a different relax variable
for each processor so the relax variable needs to be acessed from
thread local storage cf
(<a  href="http://aspn.activestate.com/ASPN/Cookbook/Python/Recipe/302088">http://aspn.activestate.com/ASPN/Cookbook/Python/Recipe/302088</a>)
</pre></blockquote><pre style="margin: 0em;"><br>This is a good idea which should be developed a bit more.  Instead of
passing 'self.relax' to each class in relax and then realiasing the
argument to 'self.relax' (i.e. creating lots of pointers) the object
'self.relax' could be placed into '__builtin__' as 'relax'.  Is this
how you would do this in Java?</pre><br>
<pre style="margin: 0em;">As for threading problems if the threads simply pass the calculated
data back to the parent thread, then race conditions in the
modification of the data structures in 'self.relax.data' can be
avoided.  Anyway, the threading code in relax is currently broken.  My
implementation is poorly designed grid computing whereby a separate
relax process is launched on the target machine (which could be a
second CPU on the current machine).  The parent process sends minimal
data to the slave process which does the calculation and returns the
results.  Ideally I would like to separate the threading from the grid
computing so that three different usages could one day be supported:
   One relax process with multiple threads.
   Grid computing.
   Clustering (see the MPI thread starting at
<a  href="https://mail.gna.org/public/relax-devel/2006-04/msg00023.html">https://mail.gna.org/public/relax-devel/2006-04/msg00023.html</a>,
Message-id: &lt;443E3032.8040907@xxxxxxxxxxxxxxx&gt;.  The thread continues
into the next month as well:
<a  href="https://mail.gna.org/public/relax-devel/2006-05/threads.html">https://mail.gna.org/public/relax-devel/2006-05/threads.html</a>).</pre><br>
<pre style="margin: 0em;">The threading issues can be dealt with later though.</pre><br>
<br>
<blockquote class="blockquote"><pre style="margin: 0em;">&gt;   More information about the data model change is given in the message at
&gt;   located at <a  href="https://mail.gna.org/public/relax-devel/2006-05/msg00008.html">https://mail.gna.org/public/relax-devel/2006-05/msg00008.html</a>
&gt;   (Message-id:
&gt;   &lt;7f080ed10605232038j5036278dg39136d75a05a9904@xxxxxxxxxxxxxx&gt;) and the
&gt;   response located at
&gt;   <a  href="https://mail.gna.org/public/relax-devel/2006-05/msg00010.html">https://mail.gna.org/public/relax-devel/2006-05/msg00010.html</a>
&gt;   (Message-id:
&gt;   &lt;7f080ed10605241912i7c35f574i94f139588c5fa16b@xxxxxxxxxxxxxx&gt;).
&gt;
&gt;
&gt;   2.3  The pipe concept
&gt;
&gt;   A single run can be thought of as a pipe where data is input, processed,
&gt;   or output as user functions are called.  There are different types of
&gt;   pipe for different analyses, e.g. a reduced spectral density mapping
&gt;   pipe, a model-free pipe, an exponential curve-fitting pipe, etc.  When
&gt;   running relax you choose which run (or pipe) you are currently in and
&gt;   the 'run.switch()' user function allows you to jump between multiple
&gt;   runs (or pipes).  The modification of user functions in which runs are
&gt;   combined or branched (which can be thought of as the pipes merging or
&gt;   splitting) would be straight forward.  For example the
&gt;   'model_selection()' user function currently accepts the following
&gt;   arguments:
&gt;
&gt;   model_selection(self, method=None, modsel_run=None, runs=None)
&gt;
&gt;   In this case the 'modsel_run' can be dropped and the results of model
&gt;   selection placed into the current run (or pipe).  The 'run' user
&gt;   function class could contain the following user functions for pipe
&gt;   manipulation:
&gt;
&gt;   run.copy()    # Create a new run (or pipe) with the current contents of
&gt;   another run (or pipe).
&gt;   run.create()    # Create a new run (or pipe).  Switch to this pipe by
&gt;   default.
&gt;   run.current()    # Print the current run (or pipe).
&gt;   run.delete()    # Delete the given run (or pipe).
&gt;   run.delete_all()    # Delete all runs.  Essentially deleting
&gt;   'self.relax.data'.</pre><br>
<pre style="margin: 0em;">you might want to consider a nullObject here so that if all runs are
deleted you don't crash just raise error messages...
</pre></blockquote><pre style="margin: 0em;"><br>The proposed behaviour would be an empty dictionary type object
'self.relax.data' which hence contains no runs.  Each of these user
functions currently check for the existence of the runs and throw a
RelaxError if the user tells relax to access a non-existent run.
Having 'self.relax.data' set to None rather than an empty but
modifiable dictionary like container wouldn't be necessary.</pre><br>
<br>
<blockquote class="blockquote"><pre style="margin: 0em;">&gt;   run.hybridise()    # Fuse two runs (or pipes) into the current run (or
&gt;   pipe).  Overlapping data in the two runs must be identical!
&gt;   run.list()    # Print all runs (or pipes).
&gt;   run.switch()    # Switch to another run (or pipe).</pre><br>
<pre style="margin: 0em;">Now here is a further comment if run were an object that contained its
own data many of these processes could be dealt with using pythons own
semantics</pre><br>
<pre style="margin: 0em;">e.g.</pre><br>
<pre style="margin: 0em;">run.copy():</pre><br>
<pre style="margin: 0em;">        from copy import copy</pre><br>
<tt>        new_run=copy(run)
</tt></blockquote><pre style="margin: 0em;"><br>That's exactly the idea, each run in the 'self.relax.data' dictionary
would have it's own class instance acting as a data container.  The
function deepcopy would be better in this case.</pre><br>
<br>
<blockquote class="blockquote"><pre style="margin: 0em;">run.create():
        new_run = Run()</pre><br>
<pre style="margin: 0em;">run.delete():
        new_run = Run()
        new_run =  None # run dissapears due to grbage collection/ref counts
</pre></blockquote><pre style="margin: 0em;"><br>How about:</pre><br>
<pre style="margin: 0em;">run.delete():
   del self.relax.data['name']</pre><br>
<br>
<blockquote class="blockquote"><pre style="margin: 0em;">&gt;   One evolutionary path of the run concept which could be followed with
&gt;   this set of proposed changes is to completely replace it with the pipe
&gt;   concept.  All instances of 'run' in relax would be renamed to 'pipe'.
&gt;   For example 'run.create()' will become 'pipe.create()',
&gt;   'self.relax.data[self.relax.run]' will become
&gt;   'self.relax.data[self.relax.pipe]', etc.  I believe that the name 'pipe'
&gt;   is a better representation of the run concept than 'run'.  What do you
&gt;   think of the idea?</pre><br>
<tt>another name would be processor or command
</tt></blockquote><pre style="margin: 0em;"><br>I'm not sure if these names encapsulate the UI concept that well.
Essentially the run corresponds to a data pipe.  A command would be
more synonymous with the user functions, many of which can operate
sequentially on the data pipe.  The run or data pipe refers to the
data rather than any actions, and the name processor implies an
action.</pre><br>
<pre style="margin: 0em;">Cheers,</pre><br>
<pre style="margin: 0em;">Edward</pre><br>
<br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00035" href="msg00035.html">Re: Redesign of the relax data model: 2. A new run concept</a></strong>
<ul><li><em>From:</em> Chris MacRaild</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00013" href="msg00013.html">re: Redesign of the relax data model: 2. A new run concept</a></strong>
<ul><li><em>From:</em> gary thompson</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Mon Jan 15 16:20:17 2007</div>  
</body>
</html>
