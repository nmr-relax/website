<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: r23735 &#45; /branches/disp_spin_speed/target_functions/relax_disp.py -->
<!--X-From-R13: Febryf Szgrxæe Zvaarg &#60;gyvaargNaze&#45;erynk.pbz> -->
<!--X-Date: Tue, 10 Jun 2014 15:40:24 +0200 -->
<!--X-Message-Id: CA+CBx2P8dvNVLkjmyntE2nLiefiyMu+aFeyEHDJa&#45;oBOXM9czg@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: E1WthCq&#45;0008Ks&#45;3U@subversion.gna.org -->
<!--X-Reference: CAED9pY85vVgXxxNy6zFtWE8&#45;UHSuaogC9gn7KS5TgvjXfrXDOg@mail.gmail.com -->
<!--X-Reference: CA+CBx2NTPw8J+ries2M_vx2kNZztdkL+QP7ObOPHVtMs+_8nPg@mail.gmail.com -->
<!--X-Reference: CAED9pY9H1K1=OSD+9WzfTHHQnRc0o9Pc8J5V4Xe1ek3_iz7kuw@mail.gmail.com -->
<!--X-Reference: CA+CBx2OfCXqTH=Zio0dR0fWFUzt5pT_GmyjL31uwjZS+be3C=A@mail.gmail.com -->
<!--X-Reference: CAED9pY&#45;tsxf5OXetrMcjToFKy=uvVea8NmkXN8uzT=LW+VZMEQ@mail.gmail.com -->
<!--X-Reference: CA+CBx2PKp584P2BZCE8uoAYhZ1TBTWhAiXjNgU_edzxXFK67VQ@mail.gmail.com -->
<!--X-Reference: CAED9pY_temvBhSVxeAkjeWYU3jK=1ATM93oNcfscLgef0fUjvA@mail.gmail.com -->
<!--X-Reference: CA+CBx2M_c56p4YkU10s6zBnx&#45;JnDm64=Q1tnA_77YhiGXM74YA@mail.gmail.com -->
<!--X-Reference: CAED9pY9LKsCyKUyEfU0pmgRcKwvvrYfyCjMzUNmgP11WPU3mMg@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: r23735 - /branches/disp_spin_speed/target_functions/relax_disp.py -- June 10, 2014 - 15:40</title>
<link rel="stylesheet" type="text/css" href="/mail.gna.org/archives-color-gna.css"> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<h2><img src="/mail.gna.org/images/mail.orig.png" width="48" height="48"
alt="mail" class="pageicon" />Re: r23735 - /branches/disp_spin_speed/target_functions/relax_disp.py</h2>
<br />
<div class="topmenu">
<a href="../" class="tabs">Others Months</a> | <a href="index.html#00116" class="tabs">Index by Date</a> | <a href="threads.html#00116" class="tabs">Thread Index</a><br />
<span class="smaller">&gt;&gt;&nbsp;&nbsp;
[<a href="msg00115.html">Date Prev</a>] [<a href="msg00117.html">Date Next</a>] [<a href="msg00115.html">Thread Prev</a>] [<a href="msg00114.html">Thread Next</a>]
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h3><a name="header" href="#header">Header</a></h3>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul class="headdata">
<li class="menuitem">
<em>To</em>: &quot;Edward d'Auvergne&quot; &lt;edward@xxxxxxxxxxxxx&gt;</li>
<li class="menuitem">
<em>Date</em>: Tue, 10 Jun 2014 15:39:32 +0200</li>
<li class="menuitem">
<em>Cc</em>: &quot;relax-devel@xxxxxxx&quot; &lt;relax-devel@xxxxxxx&gt;</li>
<li class="menuitem">
<em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:sender:in-reply-to:references:from:date:message-id :subject:to:cc:content-type:content-transfer-encoding; bh=+tSH6Hk7UFiJkiakT4gnrFsFvoTrGQGh3vz1yYukEO8=; b=TMznzvYJ0kU10dWhTv5/m3hKID+jVDkuRlv//9FgG5mLaWJEuLdAUAm4JsENNRVk2T LPWvMT2+hKw+vHfOxLnqIiKiQZfF0w+mnRg5yTyZUmi+ncJorWLUJDcRh4nlJXThdk7p nk1ZGq5UHrQL5947lAXsrHRNlN7rkJ7THkGGCHgupgtOLHKt2hH+hh9yWSB/6pq3fdc9 fpsLflgimICplglZ+UDt524bwVXg+NbZRlhf+thAJ6mw2O5uCHqKPV/UN8/d9GUYPkbu u91v4480PqIinrv9N1xSLnmRqxNeXf2f4yaIRiKbWjuaKQKuPZzHRXK5HOFgC9eg+2tq 8cAg==</li>
<li class="menuitem">
<em>Message-id</em>: &lt;<a href="msg00116.html">CA+CBx2P8dvNVLkjmyntE2nLiefiyMu+aFeyEHDJa-oBOXM9czg@mail.gmail.com</a>&gt;</li>
<li class="menuitem">
<em>References</em>: &lt;E1WthCq-0008Ks-3U@subversion.gna.org&gt; &lt;<a href="msg00090.html">CAED9pY85vVgXxxNy6zFtWE8-UHSuaogC9gn7KS5TgvjXfrXDOg@mail.gmail.com</a>&gt; &lt;<a href="msg00094.html">CA+CBx2NTPw8J+ries2M_vx2kNZztdkL+QP7ObOPHVtMs+_8nPg@mail.gmail.com</a>&gt; &lt;CAED9pY9H1K1=OSD+9WzfTHHQnRc0o9Pc8J5V4Xe1ek3_iz7kuw@mail.gmail.com&gt; &lt;CA+CBx2OfCXqTH=Zio0dR0fWFUzt5pT_GmyjL31uwjZS+be3C=A@mail.gmail.com&gt; &lt;CAED9pY-tsxf5OXetrMcjToFKy=uvVea8NmkXN8uzT=LW+VZMEQ@mail.gmail.com&gt; &lt;<a href="msg00109.html">CA+CBx2PKp584P2BZCE8uoAYhZ1TBTWhAiXjNgU_edzxXFK67VQ@mail.gmail.com</a>&gt; &lt;CAED9pY_temvBhSVxeAkjeWYU3jK=1ATM93oNcfscLgef0fUjvA@mail.gmail.com&gt; &lt;CA+CBx2M_c56p4YkU10s6zBnx-JnDm64=Q1tnA_77YhiGXM74YA@mail.gmail.com&gt; &lt;<a href="msg00115.html">CAED9pY9LKsCyKUyEfU0pmgRcKwvvrYfyCjMzUNmgP11WPU3mMg@mail.gmail.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div><!-- end headdata -->
<br />
<h3><a name="content" href="#content">Content</a></h3>
<div class="postedby">Posted by <strong>Troels Emtekær Linnet</strong> on June 10, 2014 - 15:40:</div>
<div class="msgdata">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Well!

Of course!

It is essential just one value, with no dimensions.

Cheers!

2014-06-10 15:21 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">I have the end target_functions/relax_disp.py file from the
'disp_spin_speed' branch open as I make the comments.  The elimination
of pA_arr still holds.  I changed the line:

        ## Back calculate the R2eff values.
        r2eff_CR72(r20a=R20A_axis, r20b=R20B_axis, pA=pA_arr,
dw=dw_frq_a, kex=kex_arr, cpmg_frqs=self.cpmg_frqs_a,
back_calc=self.back_calc_a, num_points=self.num_disp_points_a)

to:

        ## Back calculate the R2eff values.
        r2eff_CR72(r20a=R20A_axis, r20b=R20B_axis, pA=pA, dw=dw_frq_a,
kex=kex_arr, cpmg_frqs=self.cpmg_frqs_a, back_calc=self.back_calc_a,
num_points=self.num_disp_points_a)

Then changed the pA test in lib.dispersion.cr72 to be 'pA == 1.0'.
And deleted the line creating pA_arr.  Running the
Relax_disp.test_cpmg_synthetic_ns3d_to_cr72_noise_cluster system test
changes from 11.6 seconds to 10.2.  The test passes before and after
the test.  I then did the same thing for kex, and the test dropped to
8.9 seconds and still passed.  There is no reason, that I can
currently see, why it needs to be an array where all elements are the
same pA value.  This will be a big speed up and simplification.

Regards,

Edward

On 10 June 2014 15:12, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Ed.

Lets take this again, when you are near the end.

I don't these tests applies to the end result?

Best
troels

2014-06-10 15:05 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Removing the pA_arr and kex_arr structures will make this even faster:

$ python -m timeit -n 100000 'import numpy as np; X = np.ones(100,
np.float64); pA = 0.9; pA*X'
100000 loops, best of 3: 6.39 usec per loop
$ python -m timeit -n 100000 'import numpy as np; X = np.ones(100,
np.float64); pA = 0.9; pA_arr = np.array([pA]*100, np.float64); pA*X'
100000 loops, best of 3: 14.2 usec per loop
$ python -m timeit -n 100000 'import numpy as np; X = np.ones(100,
np.float64); pA = 0.9; pA_arr = np.array([pA]*100, np.float64);
pA_arr*X'
100000 loops, best of 3: 13.9 usec per loop

So the first one where pA_arr is not created is more than half the
speed of the others.  This will remove some of the overhead that makes
the single spin calculations slower.  I'm getting close to the end of
the list of your changes now :)

Regards,

Edward

On 10 June 2014 14:37, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt; 
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Edward.

When you have digged your way through, you will see that I end up with:
<a  rel="nofollow" href="https://web.archive.org/web/https://gna.org/task/?7807#comment56">https://gna.org/task/?7807#comment56</a>

Going from 32.247 seconds to 2 second for a 100 clustered calculation.

! BUM!

2014-06-10 14:33 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,

Maybe self.spins_a could be renamed as self.ones_array?  And
self.not_spins_a could be self.zeros_array?  Or maybe self.ones_struct
and self.zeros_struct?  The spin part is only one dimension of 5, so
the name is confusing.  The name needs to have something to do with
the ones and zeros, as well as the entire [ei][si][mi][oi][di]
structure.

Anyway, I can now see that pA_arr is most definitely not needed ;)
Its removal will make the code much faster.  Try and see what happens!

Regards,

Edward

On 10 June 2014 14:25, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt; 
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Edward.

spins_a is the multi dimensional numpy array
Of dimension [ei][si][mi][oi][di].
It consists of 1.0 on all places, where there are dispersion points.

pA is just the float.

So, I think we agree?

The pA values has to end up in a multi dimensional array.

All multiplications in the target functions has to broadcast to the 
same size.

Numpy multiplication is elements vise.
In all dimensions.



2014-06-10 13:45 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi,

I don't think you even need the pA array.  What is the variable
self.spins_a?  Simply try using pA directly.  Here is a demo:

&quot;&quot;&quot;
from numpy import array, float64, ones

a = ones(3)
pA = 0.9
pA_array = pA * a

b = array([1, 2, 3], float64)

print(&quot;\nFloat times array:&quot;)
print(repr(pA * b))
print(&quot;\nArray times array:&quot;)
print(repr(pA_array * b))
&quot;&quot;&quot;

If you run this, you will obtain the same result for both operations.
Is there a good reason, that I cannot see, why the second option is
required in the target functions?

Cheers,

Edward





On 10 June 2014 12:09, Troels Emtekær Linnet &lt;tlinnet@xxxxxxxxxxxxx&gt; 
wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">You are Correct !!!

The final version is:
pA_arr = pA*self.spins_a

The &quot;trick&quot; was to make a numpy multi dimensional spin array in the
__init__ function of the class.

That is filled with 1.0 where there are dispersion points.

This array essential replace the spin looping!

Best
Troels




2014-06-10 11:56 GMT+02:00 Edward d'Auvergne &lt;edward@xxxxxxxxxxxxx&gt;:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Hi Troels,

From the dispersion equations, to me it looks like that you can keep
pA as a single value.  Why have you converted it to an array
structure?  You will have no problems as you can multiply any numpy
array with a single float.  This should be the same for all model
parameters, excluding dw and R20.  If you can use single values, 
that
should be much quicker for the target functions.

Regards,

Edward



On 8 June 2014 19:48,  &lt;tlinnet@xxxxxxxxxxxxx&gt; wrote:
</pre><blockquote class="blockquote"><pre style="margin: 0em;">Author: tlinnet
Date: Sun Jun  8 19:48:31 2014
New Revision: 23735

URL: <a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax?rev=23735&amp;view=rev">http://svn.gna.org/viewcvs/relax?rev=23735&amp;view=rev</a>
Log:
Important fix for the creation of the multi dimensional pA numpy 
array.

It should be created as numpy.zeros([ei][si][mi][oi]) instead of 
numpy.ones([ei][si][mi][oi]).

This allows for rapid testing of all dimensions with 
np.allclose(pA, numpy.ones(dw.shape)).
pA can have missing filled out values, when the number of 
dispersion points are different
per spectrometer frequency.

Task #7807 (<a  rel="nofollow" href="https://web.archive.org/web/https://gna.org/task/index.php?7807">https://gna.org/task/index.php?7807</a>): Speed-up of 
dispersion models for Clustered analysis.

Modified:
    branches/disp_spin_speed/target_functions/relax_disp.py

Modified: branches/disp_spin_speed/target_functions/relax_disp.py
URL: 
<a  rel="nofollow" href="http://svn.gna.org/viewcvs/relax/branches/disp_spin_speed/target_functions/relax_disp.py?rev=23735&amp;r1=23734&amp;r2=23735&amp;view=diff">http://svn.gna.org/viewcvs/relax/branches/disp_spin_speed/target_functions/relax_disp.py?rev=23735&amp;r1=23734&amp;r2=23735&amp;view=diff</a>
==============================================================================
--- branches/disp_spin_speed/target_functions/relax_disp.py     
(original)
+++ branches/disp_spin_speed/target_functions/relax_disp.py     
Sun Jun  8 19:48:31 2014
@@ -411,7 +411,7 @@
             # The number of disp point can change per 
spectrometer, so we make the maximum size.
             self.R20A_a = np.ones(back_calc_shape + 
[self.max_num_disp_points])
             self.R20B_a = np.ones(back_calc_shape + 
[self.max_num_disp_points])
-            self.pA_a = np.ones(back_calc_shape + 
[self.max_num_disp_points])
+            self.pA_a = np.zeros(back_calc_shape + 
[self.max_num_disp_points])
             self.dw_frq_a = np.ones(back_calc_shape + 
[self.max_num_disp_points])
             self.kex_a = np.ones(back_calc_shape + 
[self.max_num_disp_points])
             self.cpmg_frqs_a = np.ones(back_calc_shape + 
[self.max_num_disp_points])


_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-commits mailing list
relax-commits@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="https://mail.gna.org/listinfo/relax-commits">https://mail.gna.org/listinfo/relax-commits</a>
</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
relax (<a  rel="nofollow" href="http://www.nmr-relax.com">http://www.nmr-relax.com</a>)

This is the relax-devel mailing list
relax-devel@xxxxxxx

To unsubscribe from this list, get a password
reminder, or change your subscription options,
visit the list information page at
<a  rel="nofollow" href="https://mail.gna.org/listinfo/relax-devel">https://mail.gna.org/listinfo/relax-devel</a>
</pre></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div><!-- end msgdata -->
<br />
<h3><a name="related" href="#related">Related Messages</a></h3>
<div class="relateddata">
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00090" href="msg00090.html">Re: r23735 - /branches/disp_spin_speed/target_functions/relax_disp.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00094" href="msg00094.html">Re: r23735 - /branches/disp_spin_speed/target_functions/relax_disp.py</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00096" href="msg00096.html">Re: r23735 - /branches/disp_spin_speed/target_functions/relax_disp.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00103" href="msg00103.html">Re: r23735 - /branches/disp_spin_speed/target_functions/relax_disp.py</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00107" href="msg00107.html">Re: r23735 - /branches/disp_spin_speed/target_functions/relax_disp.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00109" href="msg00109.html">Re: r23735 - /branches/disp_spin_speed/target_functions/relax_disp.py</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00112" href="msg00112.html">Re: r23735 - /branches/disp_spin_speed/target_functions/relax_disp.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
<li><strong><a name="00113" href="msg00113.html">Re: r23735 - /branches/disp_spin_speed/target_functions/relax_disp.py</a></strong>
<ul><li><em>From:</em> Troels Emtekær Linnet</li></ul></li>
<li><strong><a name="00115" href="msg00115.html">Re: r23735 - /branches/disp_spin_speed/target_functions/relax_disp.py</a></strong>
<ul><li><em>From:</em> Edward d'Auvergne</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
</div><!-- end relateddata -->
<!-- NoBotLinksApartFromRelatedMessages -->

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<div class="footer"></div><br />
<div class="right">Powered by <a href="http://www.mhonarc.org">MHonArc</a>, Updated Tue Jun 10 16:00:13 2014</div>  
</body>
</html>
